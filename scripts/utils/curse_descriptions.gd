class_name CurseDescriptions
extends RefCounted

## 刻印名 → 説明文の定数辞書
## info panel等で刻印[名前] → 刻印[名前]{説明} に自動展開するために使用
const DESCRIPTIONS: Dictionary = {
	# === ステータス系 ===
	"暁光": "戦闘中、AP&HP+20",
	"衰月": "戦闘中、AP&HP-20",
	"狂星": "戦闘中、AP&HP=10～70",
	"昇華": "レベルアップか地形変化でMHP+20",
	"重結界": "結界と堅守を持つ",
	"硬化": "無効化[通常攻撃]を得て、防具使用不可",
	"堅牢": "HP減少効果無効",
	# === 行動制限系 ===
	"消沈": "戦闘行動不可",
	"錯乱": "スキル無効",
	"停滞": "1度だけ拘束",
	"枷": "移動不可",
	"禁呪": "次R、スペルを使用できない",
	"奮闘": "ダウン状態にならない",
	# === 通行料・EP系 ===
	"通行料1.5倍": "通行料が1.5倍になる",
	"通行料200": "3R間、通行料は200EPになる",
	"免罪": "通行料を取れない",
	"徴収": "他のセプターが得た通行料の50%を得る",
	"焦土": "停止セプターはEP40%を失い、クリーチャーのHP-20",
	# === 移動・ダイス系 ===
	"反転": "歩行方向逆転",
	"天駆": "離れた空地にも移動できる",
	"巡礼": "ダイスを2回、2～4にし、50EPを得る",
	"ダイス1": "次のダイスを1にする",
	"ダイス3": "次のダイスを3にする",
	"ダイス5": "次のダイスを5にする",
	"ダイス6": "次のダイスを6にする",
	"ダイス8": "次のダイスを8にする",
	"ダイス6～8": "2R間、ダイスを6～8にする",
	# === 防御・保護系 ===
	"祝福": "スペルの対象に選べない",
	"安寧": "侵略を受けず、通行料は0EP",
	"休戦": "侵略できない",
	"天使": "クリーチャーとアイテム0EP、スペルは無効化され刻印は消える",
	"祭壇": "無効化[通常攻撃]、敵にEP100を与える",
	"解放": "アイテム制限と配置制限を無視",
	# === ダメージ・破壊系 ===
	"崩壊": "戦闘終了時に破壊",
	"衰弱": "戦闘終了時、HP-MHPの1/2",
	"賞金": "移動・交換不可、武器で破壊した場合30EP獲得",
	"暗転": "地形効果無効",
	# === アルカナアーツ付与系 ===
	"零落": "アルカナアーツ[EP50・対象クリーチャー1体のMHP-10]",
	"吸魔": "アルカナアーツ[EP20・対象敵セプターからEPの10%を奪う]",
	"快足": "アルカナアーツ[EP50・対象セプターに刻印[ダイス5]]",
	# === 世界刻印系 ===
	"太陽": "カード使用EPは袋1.5倍、冠袋2倍",
	"恋人": "火と地、水と風が連鎖",
	"皇帝": "全ドミニオは領土守護",
	"女教皇": "刻印のついた全クリーチャーは結界",
	"愚者": "クリーチャー配置時、EP以外のコストは無視される",
	"節制": "順位が下のセプターのドミニオに侵略できない",
	"女帝": "全セプターはスペルの対象に選べない",
	"隠者": "同クリーチャー2体配置なら戦闘時破壊",
	"吊人": "アルカナアーツ、自破壊時、戦闘終了時は発動しない",
}


## テキスト内の 刻印[名前] を 刻印[名前]{説明} に自動展開する
## 既に {説明} が付いているものはスキップ
static func expand_curse_text(text: String) -> String:
	if "刻印[" not in text:
		return text

	var regex := RegEx.new()
	regex.compile("刻印\\[([^\\]]+)\\](?!\\{)")

	var result := text
	var offset := 0

	for m in regex.search_all(text):
		var curse_name: String = m.get_string(1)
		if curse_name in DESCRIPTIONS:
			var desc: String = DESCRIPTIONS[curse_name]
			var original: String = m.get_string()
			var replacement: String = "刻印[%s]{%s}" % [curse_name, desc]
			var pos: int = result.find(original, offset)
			if pos >= 0:
				result = result.substr(0, pos) + replacement + result.substr(pos + original.length())
				offset = pos + replacement.length()
			else:
				offset = m.get_end() + offset - text.length() + result.length()

	return result
