# Step 1: フェーズ管理システム - 完全仕様書

## 📋 目次
1. [ゲームフロー全体像](#ゲームフロー全体像)
2. [フェーズ定義](#フェーズ定義)
3. [ダウン状態システム](#ダウン状態システム)
4. [スペルフェーズ](#スペルフェーズ)
5. [領地コマンドシステム](#領地コマンドシステム)
6. [バトルフロー](#バトルフロー)
7. [レベルアップシステム](#レベルアップシステム)
8. [クリーチャー移動システム](#クリーチャー移動システム)
9. [クリーチャー交換システム](#クリーチャー交換システム)
10. [アイテム/巻物システム](#アイテム巻物システム)
11. [実装計画](#実装計画)

---

## ゲームフロー全体像

### ターン全体の流れ
```
【ターン開始】
    ↓
┌─────────────────────┐
│ 1. スペルフェーズ    │ スペルor秘術を1回 or パス（戻れない）
└──────┬──────────────┘
       ↓
┌─────────────────────┐
│ 2. ダイスフェーズ    │ サイコロを振る（戻れない）
└──────┬──────────────┘
       ↓
┌─────────────────────┐
│ 3. 移動フェーズ      │ 自動移動
└──────┬──────────────┘
       ↓
┌─────────────────────┐
│ 4. 到着地点の行動    │ 以下のいずれか1つのみ
│  A. 召喚/バトル      │
│  B. レベルアップ     │
│  C. クリーチャー移動 │
│  D. クリーチャー交換 │
└──────┬──────────────┘
       ↓
【ターン終了】
```

### 重要な制約
- ✅ **1ターンに1行動のみ**（召喚と領地コマンドは排他）
- ✅ **フェーズは一方通行**（戻れない）
- ✅ **領地コマンドも1回のみ**（複数の土地を操作できない）
- ✅ **タイムリミット**: 各フェーズ最大15秒（PVP時、後回し実装）

---

## フェーズ定義

```gdscript
enum GamePhase {
    SETUP,           # ゲーム準備
    SPELL_PHASE,     # スペル使用（新規）
    DICE_ROLL,       # ダイス
    MOVING,          # 移動中
    LAND_ACTION,     # 到着地点での行動（召喚/領地コマンド）
    BATTLE_PREP,     # バトル準備（アイテム/巻物選択）
    BATTLE,          # バトル実行
    END_TURN         # ターン終了
}
```

---

## ダウン状態システム

### 概要
土地（クリーチャー）は「ダウン状態」を持ち、**ダウン状態では領地コマンドを受け付けない**。

### ダウン状態になるタイミング
```
✓ クリーチャー配置直後（侵略成功/召喚）
✓ 領地コマンド実行後（レベルアップ/移動/交換）
✓ クリーチャー移動の移動先（移動してきたクリーチャー）
```

### ダウン状態にならない場合
```
✓ 侵略されて防衛成功した土地（攻撃されてバトルしたが、相手の行動なのでダウンしない）
✓ 「不屈」スキル持ちクリーチャー（常に活動可能）
```

### ダウン状態の解除
```
✓ 中継ポイントに停止した時（各中継ポイント）
  ※ 将来的に中継ポイントを増やす予定
```

### 1周ボーナス
マップを1周して**スタート地点（中継ポイント）に戻った時**に以下を獲得：
1. **魔力獲得**
2. **ダメージを負った自分のクリーチャーHP+10回復**
3. **ダウン状態解除**（中継ポイント停止による解除と同じ）

### データ構造
```gdscript
# BaseTile / 土地データに追加
var down_state: bool = false  # ダウン状態フラグ
var has_unyielding: bool = false  # 不屈スキル（将来対応）

# チェック関数
func can_use_land_command() -> bool:
    if has_unyielding:
        return true
    return not down_state
```

### UI表示
- ダウン状態の土地: グレーアウト（選択不可）
- 活動可能な土地: ハイライト表示

---

## スペルフェーズ

### 行動内容
```
1. スペルカード使用
2. 秘術使用
3. パス
```

### 制約
- ✅ **1ターンに1回のみ**（スペルと秘術は同じカウント）
- ✅ **コスト**: 魔力 + カード消費
- ✅ **パス後は戻れない**（即座にダイスフェーズへ）

### ターゲット種類
```
- 自プレイヤー
- 敵プレイヤー（選択）
- 全プレイヤー
- 単体クリーチャー（選択）
- 全クリーチャー
- 属性指定クリーチャー（例: 火属性全て）
- 土地（クリーチャー）
```

### UI設計

#### 単体効果スペル
```
1. スペル選択
2. ターゲットリスト表示
3. ターゲット選択
4. 決定
```

#### 全体効果スペル
```
1. スペル選択
2. 効果範囲リスト表示（確認のみ）
3. 上下キーで各ターゲット確認
4. カメラがそのターゲットに移動
5. 決定
```

**全体効果の注意点**:
- 条件に入ったら自動的に範囲に含まれる
- プレイヤーは確認のみで除外選択はできない

### 現時点の実装
- **Phase 1**: パス機能のみ実装
- **Phase 2**: 実際のスペル効果実装

---

## 領地コマンドシステム

### 到着地点による分岐

#### 【空き地到着】
デフォルト画面（カード選択可能）
```
├─ カード選択 → 召喚 → ターン終了
├─ 📍領地コマンド → 他の土地操作 → ターン終了
└─ 終了ボタン → ターン終了
```

#### 【敵の土地到着】
デフォルト画面（カード選択可能）
```
├─ カード選択 → アイテム選択 → バトル → ターン終了
├─ 📍領地コマンド → 他の土地操作 → ターン終了（通行料支払い）
└─ 召喚しない → 通行料支払い → ターン終了
```

#### 【自分の土地到着】
デフォルト画面（カード選択可能）
```
├─ カード選択 → 召喚（交換扱い） → ターン終了
├─ 📍領地コマンド → この土地 or 他の土地操作 → ターン終了
└─ 終了ボタン → ターン終了
```

### 領地コマンドの選択肢
到着地点に関わらず、以下から1つ選択：
```
1. レベルアップ
2. クリーチャー移動
3. クリーチャー交換
```

### UI設計（重要な制約）

#### デフォルト画面（既存UI - 変更禁止）
```
┌──────────────────────────┐
│ 📍← 左上に小さいアイコン  │
│                          │
│ [🎴][🎴][🎴][🎴][🎴]    │← 変更禁止
│                          │
│ [召喚しない]              │← 変更禁止
└──────────────────────────┘
```

**絶対に変更してはいけない要素**:
- カード表示の位置・サイズ
- 「召喚しない」ボタンの位置

**追加する要素**:
- 左上に「📍領地コマンド」アイコン
- 自分の土地到着時: 「召喚しない」→「終了」に変更

#### 領地選択モード
```
1. 「📍領地コマンド」クリック
2. カーソルが3D画面に表示
3. 選択可能な土地がハイライト
   - 活動可能: 明るく光る
   - ダウン状態: グレーアウト（選択不可）
4. 土地をクリック
5. アクション選択画面へ
```

#### アクション選択画面
```
┌──────────────────────┐
│ 選択: 火の土地(Lv2)  │
│                      │
│ [レベルアップ]       │
│ [クリーチャー移動]   │
│ [クリーチャー交換]   │
│ [⬅️ 戻る]           │← 土地選択に戻る
└──────────────────────┘
```

### 召喚と領地コマンドの行き来
```
デフォルト画面（カード選択）
  ↕️ 自由に行き来可能
領地選択モード

※ ただし、どちらか1つを実行したらターン終了
```

---

## バトルフロー

### 新しいバトルフロー
```
【敵の土地に到着】
    ↓
【クリーチャー選択（召喚）】
    ↓
【アイテム/巻物選択】← ★新規追加
    ↓
【バトル画面表示】
    ↓
【バトル実行】← 既存システム（変更なし）
    ↓
【結果処理】
```

### 詳細フロー

#### 1. クリーチャー選択
```
既存のカード選択画面
↓
カード選択 or 召喚しない
↓
- 召喚しない → 通行料支払い → ターン終了
- カード選択 → 次のステップへ
```

#### 2. アイテム/巻物選択（新規）
```
もう一度カード表示画面（既存UI流用）
↓
アイテムまたは巻物を1つ選択 or 使わない
↓
【重要】戻れない（バトル確定）
```

**選択方式**:
- 侵略側が選択（7秒以内）
- 防御側が選択（7秒以内）
- **両者の選択は非公開**
- 両者選択完了後に公開
- バトル開始

**防御側の操作**:
- 防御側クリーチャーの**所有プレイヤーが操作**
- 敵プレイヤーの操作はできない

#### 3. バトル実行
```
既存のBattleSystem.execute_3d_battle()を実行
※ 変更なし
```

### 既存システムとの統合

**方針**: 既存のバトルロジックは一切変更しない

```gdscript
# 新規追加: アイテム適用込みのバトル実行ラッパー
func execute_3d_battle_with_preparation(
    attacker_index: int, 
    card_index: int, 
    tile_info: Dictionary,
    attacker_item: Dictionary = {},  # ← 追加
    defender_item: Dictionary = {}   # ← 追加
) -> void:
    
    # 1. 既存の準備処理（変更なし）
    var participants = _prepare_participants(...)
    var attacker = participants["attacker"]
    var defender = participants["defender"]
    
    # 2. アイテム効果適用（新規追加）
    if not attacker_item.is_empty():
        _apply_item_to_participant(attacker, attacker_item)
    
    if not defender_item.is_empty():
        _apply_item_to_participant(defender, defender_item)
    
    # 3. 既存のバトル処理を実行（変更なし）
    _apply_pre_battle_skills(...)
    var attack_order = _determine_attack_order(...)
    _execute_attack_sequence(...)
    var result = _resolve_battle_result(...)
    _apply_post_battle_effects(...)

# 新規追加: アイテム効果適用
func _apply_item_to_participant(participant: BattleParticipant, item: Dictionary):
    if item.get("grants_first_strike", false):
        participant.apply_item_first_strike()
    
    if item.has("hp_bonus"):
        participant.item_bonus_hp = item["hp_bonus"]
        participant.update_current_hp()
    
    if item.has("ap_bonus"):
        participant.current_ap += item["ap_bonus"]
```

---

## レベルアップシステム

### 新仕様
- ✅ **全ての自領地から選択可能**（到着地点に限らない）
- ✅ **一度に複数レベルアップ可能**（Lv1 → Lv5など）
- ✅ **ダウン状態の土地は選択不可**

### コスト体系
```
レベル1→2:    80G
レベル2→3:   240G
レベル3→4:   620G
レベル4→5:  1200G
```

**重要**: 各レベルの**絶対コスト**（そのレベルに到達するための総コスト）

**レベルアップのコスト計算**:
```
現在のレベルから目標レベルまでの差額を支払う

例1: Lv1 → Lv3
コスト = 240G - 0G = 240G

例2: Lv2 → Lv5
コスト = 1200G - 240G = 960G

例3: Lv1 → Lv5
コスト = 1200G - 0G = 1200G

例4: Lv3 → Lv4
コスト = 620G - 240G = 380G
```

**計算式**:
```gdscript
# 各レベルの絶対コスト
const LEVEL_COSTS = {
    0: 0,
    1: 0,
    2: 80,
    3: 240,
    4: 620,
    5: 1200
}

# レベルアップコスト計算
func calculate_level_up_cost(current_level: int, target_level: int) -> int:
    return LEVEL_COSTS[target_level] - LEVEL_COSTS[current_level]
```

### UI設計

#### レベル選択画面
```
┌──────────────────────┐
│ 火の土地 (現在: Lv2) │
│                      │
│ [Lv3]   240G        │← 240G - 240G = 0G... 表示は240G
│ [Lv4]   380G        │← 620G - 240G = 380G
│ [Lv5]   960G        │← 1200G - 240G = 960G
│                      │
│ 所持魔力: 1500G      │
│ [⬅️ 戻る]           │
└──────────────────────┘
```

**表示方法**:
```
現在Lv2の場合:
- Lv3: 240G (0Gだが、わかりやすく240Gと表示)
- Lv4: 380G (620G - 240G)
- Lv5: 960G (1200G - 240G)
```

### 実行後の処理
```
1. レベルアップ実行
2. 魔力消費
3. その土地がダウン状態になる
4. ターン終了
```

---

## クリーチャー移動システム

### 移動範囲
- ✅ **移動元**: 全ての自領地から選択可能
- ✅ **移動先**: 1マス先（基本）
- ✅ **特殊スキル**:
  - 「移動+2」: 2マス移動可能
  - 「風/水の土地ならどこへでも」: テレポート移動

### 移動可能な場所
```
✓ 空き地
✓ 敵の土地
```

### 移動処理
```
1. 移動元の土地を選択
2. 移動先を選択
3. 移動実行
   - 移動元: 空き地になる
   - 移動先: クリーチャー配置 + ダウン状態
```

### 移動先での処理

#### 空き地に移動
```
→ 土地獲得
→ ダウン状態になる
→ ターン終了
```

#### 敵の土地に移動
```
→ バトル発生
→ アイテム/巻物選択
→ バトル実行
→ ターン終了
```

---

## クリーチャー交換システム

### 概要
既存のクリーチャーを手札に戻し、新しいクリーチャーを配置する。

### 選択範囲
- ✅ **全ての自領地から選択可能**
- ✅ **ダウン状態の土地は選択不可**

### 交換フロー
```
1. 交換対象の土地を選択
2. 既存クリーチャーを手札に戻す
3. 新しいクリーチャーを選択（カード選択画面）
4. 召喚コストを支払う
5. 新しいクリーチャーを配置
   - 土地ボーナスを受け取る
   - 土地レベルは引き継ぐ
   - ダウン状態になる
6. ターン終了
```

### コスト
- ✅ **交換自体のコスト**: なし
- ✅ **召喚コスト**: 通常通り必要
- ✅ **魔力以外の必要コスト**: 通常通り必要

### 注意点
- 元のクリーチャーは手札に戻る
- 新しいクリーチャーは即ダウン状態
- 土地のレベル・属性は変わらない

---

## アイテム/巻物システム

### 使用タイミング
```
バトル前のみ（バトル準備フェーズ）
```

### 使用可能数
```
アイテムまたは巻物、どちらか1つのみ
```

### 選択方式
```
1. 侵略側が選択（7秒以内）
2. 防御側が選択（7秒以内）
3. 両者の選択は非公開
4. 選択完了後に公開
5. バトル開始
```

### 両者使用可能
```
✓ 侵略側: 使用可能
✓ 防御側: 使用可能（所有プレイヤーが操作）
```

### データ構造（例）
```gdscript
# アイテムデータ
{
    "id": 1001,
    "name": "先制の巻物",
    "type": "scroll",
    "effect": "grant_first_strike",
    "target": "self",
    "cost": 200
}

# プレイヤーの所持品
player_inventory = {
    0: [  # プレイヤー0
        {"id": 1001, "quantity": 2},
        {"id": 1002, "quantity": 1}
    ],
    1: [...]
}
```

---

## 実装計画

### Phase 1-A: 基盤整備（5日）

**Day 1-2: フェーズ管理構造**
```
□ PhaseManager作成
  - フェーズ定義（SPELL, DICE, MOVING, LAND_ACTION, END_TURN）
  - フェーズ遷移管理
  
□ ダウン状態システム
  - BaseTileにdown_stateフラグ追加
  - 1周ボーナス処理（魔力, HP回復, ダウン解除）
  - 不屈スキル対応の設計（フラグのみ、効果は後回し）
```

**Day 3-4: 領地コマンドUI基盤**
```
□ デフォルト画面に「📍領地コマンド」アイコン追加（左上）
□ 土地選択モード（選択可能な土地をハイライト）
□ ダウン状態チェック（選択不可の表示）
□ アクション選択UI（レベルアップ/移動/交換/戻る）
```

**Day 5: 既存システム統合**
```
□ SpellPhaseHandler（パスのみ実装）
□ LandCommandHandlerに既存の召喚/バトル処理を統合
□ 既存のGameFlowManagerを新構造に移行
```

---

### Phase 1-B: レベルアップ改善（2日）

**Day 6: レベル選択UI**
```
□ 全自領地から選択可能に
□ 目標レベル選択画面（Lv2, 3, 4, 5）
□ 累計コスト表示・計算
□ 魔力不足チェック
```

**Day 7: 実行処理**
```
□ 複数レベルアップ処理
□ 魔力消費
□ ダウン状態への変更
□ UI更新
```

---

### Phase 1-C: クリーチャー移動（3日）

**Day 8-9: 移動基本機能**
```
□ 移動元選択（全自領地、ダウン状態除外）
□ 移動先選択（1マス先の空き地/敵地）
□ 移動実行処理
  - 移動元: 空き地化
  - 移動先: クリーチャー配置 + ダウン状態
```

**Day 10: 移動後の処理**
```
□ 空き地移動: 土地獲得 + ターン終了
□ 敵地移動: バトル発生（アイテム選択込み）
```

---

### Phase 1-D: クリーチャー交換（2日）

**Day 11-12:**
```
□ 交換対象土地選択（全自領地、ダウン状態除外）
□ 既存クリーチャーを手札に戻す
□ 新クリーチャー選択（カード選択画面）
□ 召喚コスト支払い
□ 新クリーチャー配置
  - 土地ボーナス適用
  - 土地レベル継承
  - ダウン状態設定
```

---

### Phase 1-E: バトルフロー改善（3日）

**Day 13-14: アイテム/巻物選択UI**
```
□ カード選択後にアイテム選択画面表示
□ アイテム/巻物のカード表示（既存UI流用）
□ 選択完了処理
□ 防御側の選択（所有プレイヤーが操作）
□ 同時選択の仕組み（非公開 → 公開）
□ 7秒タイマー（タイムアップで「使わない」）
```

**Day 15: バトルシステム統合**
```
□ execute_3d_battle_with_preparation()実装
□ _apply_item_to_participant()実装
□ 既存バトルフローとの統合テスト
```

---

### Phase 2: アイテム・スペル実装（10日）

**Week 3: アイテムシステム**
```
□ ItemSystem基盤
□ Inventory（所持品管理）
□ アイテムデータ定義（JSON）
□ アイテム効果実装
  - 先制付与
  - HP/AP増加
  - その他
□ 巻物システム
```

**Week 4: スペルシステム**
```
□ SpellSystem基盤
□ スペルデータ定義（JSON）
□ スペル効果実装
□ ターゲット選択UI
  - 単体選択
  - 全体効果の確認UI
  - カメラ移動
□ 秘術システム
```

---

## 将来対応事項（設計のみ）

### 2vs2チーム戦
```
player_team_id = [0, 0, 1, 1]  # P0,P1=Team0, P2,P3=Team1

func get_allied_lands(player_id: int) -> Array:
    var team_id = player_team_id[player_id]
    # チームメイトの土地も含める
    # クリーチャー交換・レベルアップ可能
```

### タイムリミット（PVP用）
```
- 各フェーズ: 最大15秒
- アイテム選択: 7秒
- CPU: 即座に判断（待機なし）
```

### 不屈スキル
```
down_state判定時に不屈チェック
→ 常に領地コマンド使用可能
```

### 移動スキル
```
- 移動+2: 2マス移動可能
- 風/水テレポート: 該当属性の土地ならどこへでも移動
```

---

## 注意事項

### 既存システムの保護
以下は**絶対に変更しない**:
- ✅ カード表示の位置・サイズ
- ✅ 「召喚しない」ボタンの位置・機能
- ✅ BattleSystemの内部ロジック
- ✅ 既存のスキルシステム

### 追加のみ
- ✅ 左上に「📍領地コマンド」アイコン追加
- ✅ バトル前のアイテム選択画面追加
- ✅ 新しいフェーズハンドラー追加

---

## まとめ

この仕様書に基づいて、**Phase 1-A から順番に実装**を進めます。

**次のステップ**: Phase 1-Aの詳細設計とファイル構成の確定

---

**作成日**: 2025年1月  
**ステータス**: 確定（実装開始可能）
