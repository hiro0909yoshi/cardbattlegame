# 📋 カルドセプト風カードバトルゲーム - タスク管理

## 目次
1. [実装済み機能](#実装済み機能)
2. [進行中のタスク](#進行中のタスク)
3. [未実装機能（優先度順）](#未実装機能優先度順)
4. [技術的改善項目](#技術的改善項目)
5. [完了したマイルストーン](#完了したマイルストーン)

---

## 実装済み機能

### ✅ コアゲームシステム（完成度: 75%）

#### ボードシステム（3D専用）
- [x] 菱形20マス配置（1辺5マス）- 3D空間
- [x] タイル所有権管理
- [x] 特殊マス実装
  - [x] スタート地点（0番）
  - [x] チェックポイント（5, 10, 15番）
  - [x] ワープゲート
  - [x] カードマス
- [x] z-indexによる奥行き表現
- [x] タイル画像表示（火/水/風/土/中立）

#### 属性連鎖システム
- [x] 同属性土地の連鎖判定（隣接チェック）
- [x] 通行料倍率計算
  - [x] 2個連鎖: 1.5倍
  - [x] 3個連鎖: 2.5倍
  - [x] 4個以上: 4.0倍（上限）
- [x] HPボーナス計算
  - [x] 1個: +10
  - [x] 2個: +20
  - [x] 3個: +30
  - [x] 4個以上: +40

#### カードシステム
- [x] デッキ管理（GameData連携）
- [x] 選択デッキの読み込み
- [x] 手札管理（最大6枚）
- [x] カードドロー処理
- [x] 捨て札→デッキシャッフル
- [x] カードUI表示（プレイヤー1のみ）
- [x] カード使用処理
- [x] コスト計算（mp × 10G）
- [x] 統一捨て札関数（discard_card）
- [x] ターン終了時の手札調整
  - [x] 人間プレイヤー: 手動選択
  - [x] CPU: 自動捨て札
- [x] 手札表示の動的スケール（画面80%対応）
- [x] 捨て札理由の分類（use/discard/forced/destroy）

#### バトルシステム
- [x] 先制攻撃システム
- [x] 属性相性判定（火→風→土→水→火）**← 削除予定**
- [x] 地形ボーナス（HP）
- [x] 属性連鎖ボーナス（HP）
- [x] 戦闘結果判定
  - [x] 攻撃側勝利
  - [x] 防御側勝利
  - [x] 相討ち（土地獲得）
  - [x] 膠着（決着つかず）
- [x] スキルシステム統合
  - [x] 強打（条件判定・効果適用）
  - [x] ability_parsed解析

#### プレイヤーシステム
- [x] 4人対応
- [x] 魔力管理（初期3000G）
- [x] 通行料処理
- [x] スタート通過ボーナス（200G）
- [x] ターン管理
- [x] 勝利条件判定（魔力8000G）

#### UIシステム
- [x] PlayerInfoPanel（魔力・土地数表示）
- [x] CardSelectionUI（カード選択モーダル）
- [x] LevelUpUI（土地レベルアップ）
- [x] DebugPanel（デバッグ情報）
- [x] 手札表示（240x350px）
- [x] 手札配置（中央揃え、自動リサイズ）

#### データ管理
- [x] CardLoader（Autoload）
- [x] GameData（セーブデータ管理）
- [x] JSONカードデータ読み込み
  - [x] fire.json（火属性）
  - [x] water.json（水属性）
  - [x] wind.json（風属性）
  - [x] earth.json（土属性）
  - [x] neutral.json（中立）
- [x] デッキデータ保存/読込

#### スキルシステム
- [x] ConditionChecker（条件判定）
- [x] EffectCombat（効果適用）
- [x] バトルコンテキスト構築
- [x] 強打スキル実装
- [x] 無効化スキル実装
  - [x] 属性無効化（element）
  - [x] MHP以上/以下無効化（mhp_above/mhp_below）
  - [x] ST以上/以下無効化（st_above/st_below）
  - [x] 全攻撃無効化（all_attacks）
  - [x] 能力持ち無効化（has_ability）
  - [x] 巻物攻撃無効化（scroll_attack）
  - [x] 通常攻撃無効化（normal_attack）
  - [ ] 条件付き無効化（item_equipped, land_level_check）**← 未実装**
- [x] 巻物攻撃システム実装
  - [x] is_using_scroll フラグ管理
  - [x] 巻物攻撃判定ロジック
- [x] プレイヤー土地情報取得
- [x] 応援スキルシステム
  - [x] 盤面全体の応援持ちクリーチャー検索
  - [x] 属性条件による応援判定
  - [x] 味方条件による応援判定
  - [x] 移動侵略時の応援除外（is_movingフラグ）

---

## 進行中のタスク

### ✅ Phase 1-A 完全完了: 領地コマンドシステム（完了: 2025/10/16）

#### 完了内容
- [x] 領地コマンドUI基盤
  - [x] 領地コマンドボタン（左上配置）
  - [x] 土地選択モード
  - [x] アクションメニューパネル（中央配置）
  - [x] レベル選択パネル（中央配置）
- [x] レベルアップ機能
  - [x] 全自領地から選択可能
  - [x] 複数レベル一括アップ
  - [x] 累計コスト計算
  - [x] ダウン状態設定
- [x] **クリーチャー移動機能**（2025/10/16完了）
  - [x] 移動元選択（全自領地、ダウン除外）
  - [x] 移動先選択（↑↓キーで切り替え）
  - [x] 選択マーカーシステム（回転アニメーション付き）
  - [x] TileNeighborSystemとの統合
  - [x] 移動元の空き地化
  - [x] 空き地への移動（土地獲得）
  - [x] 敵地への移動（バトル統合）
  - [x] バトル完了後のダウン状態設定
- [x] **クリーチャー交換機能**（2025/10/16完了）
  - [x] 交換対象土地選択（全自領地、ダウン除外）
  - [x] 召喚条件チェック（手札にクリーチャーカードがあるか）
  - [x] 元のクリーチャーを手札に戻す
  - [x] 新しいクリーチャー選択（カード選択UI）
  - [x] 召喚コスト支払い
  - [x] 新しいクリーチャー配置
	- 土地ボーナス適用
	- 土地レベル継承
	- ダウン状態設定
  - [x] ターン終了処理
- [x] バグ修正
  - [x] アクション処理フラグの整合性問題（BUG-004 / TECH-002）
  - [x] 次プレイヤーが召喚できない問題

**Phase 1-A 完全完了**: レベルアップ・移動・交換の3つの領地コマンドが全て利用可能

---

### 🚧 Phase 2: 通行料システム実装（進行中: 2025/11/23）

#### タスク内容
- [x] **支払い処理の一本化**
  - [x] 仕様決定: end_turn()に敵地判定を一本化
  - [x] シグナル不要（end_turn()は必ず呼ばれる）
  - [x] ドキュメント更新完了
- [ ] **実装**
  - [ ] `game_flow_manager.gd` に `check_and_pay_toll_on_enemy_land()` 新規作成
    - 敵地判定ロジック
    - 支払い処理（board_system.calculate_toll() + player_system.pay_toll()）
  - [ ] `game_flow_manager.end_turn()` の **手札調整後に呼び出し追加**
    - `await check_and_discard_excess_cards()` の後
  - [ ] `tile_action_processor.on_action_pass()` から支払い処理削除
    - 敵地判定と支払いロジックを削除
    - `_complete_action()` のみ残す
  - [ ] `battle_system.gd` の `pay_toll_3d()` 関数削除
    - 関数定義削除
    - 4箇所の呼び出し削除（Line 95, 100, 112, 131付近）
- [ ] **テスト・検証**
  - [ ] パスボタン押下後の支払い確認
  - [ ] 敗北後（DEFENDER_WIN/ATTACKER_SURVIVED）の支払い確認
  - [ ] 勝利時（ATTACKER_WIN）の支払いなし確認
  - [ ] 相打ち時（BOTH_DEFEATED）の支払いなし確認
  - [ ] 敵地に留まらない場合の支払いなし確認

**目標完了日**: 2025年11月30日  
**難易度**: 低～中（ロジック単純、デバッグ簡単）

---

### 🚧 現在作業中

#### 0. バトルテストツール実装 ★追加
**優先度**: 高  
**担当**: 開発者  
**進捗**: 17% (Phase 1 完了)

**目的**: スペル・アイテム・スキルの効果を網羅的にテストし、バランス調整とバグ検出を支援

**Phase進捗**:
- [x] Phase 1: 設計・仕様策定 (100%)
- [ ] Phase 2: データ構造実装 (0%)
- [ ] Phase 3: UI実装 (0%)
- [ ] Phase 4: バトルロジック統合 (0%)
  - [ ] アイテムによるスキル付与実装 ★重要
  - [ ] スペルによるスキル付与実装（将来）
- [ ] Phase 5: 結果表示実装 (0%)
- [ ] Phase 6: テスト・デバッグ (0%)

**主要機能**:
- ID入力式の選択UI
- プリセット機能（火水風地・先制・強打・無効化）
- 土地保有数・バトル土地属性の設定
- **アイテム・スペルによるスキル付与機能** ★追加
- テーブル形式での結果表示（付与スキル情報含む）
- 統計サマリー・CSV出力

**関連ドキュメント**:
- [battle_test_tool_design.md](../design/battle_test_tool_design.md)
- [battle_test_tool_spec.md](../specs/battle_test_tool_spec.md)
- [battle_test_tool_progress.md](../progress/battle_test_tool_progress.md)

**次のステップ**:
1. Phase 2: データ構造実装（見積もり: 1時間）
2. Phase 3: UI実装（見積もり: 2.5時間）

---

#### 1. スキルシステムの拡張
**優先度**: 高  
**担当**: 開発者  
**進捗**: 50%

- [x] 強打（power_strike）実装
- [ ] 感応（elemental_resonance）実装
- [x] 無効化（nullify）実装 ✅ **完了: 2025/10/20**
  - [x] 基本無効化タイプ実装
	- [x] 属性無効化（element）
	- [x] MHP以上/以下無効化（mhp_above/mhp_below）
	- [x] ST以上/以下無効化（st_above/st_below）
	- [x] 全攻撃無効化（all_attacks）
	- [x] 能力持ち無効化（has_ability）
	- [x] 巻物攻撃無効化（scroll_attack）
	- [x] 通常攻撃無効化（normal_attack）
  - [x] 条件付き無効化 ✅ **完了: 2025/10/20**
	- [ ] `item_equipped` 条件 (例: ID 103 アクアデューク - 防具使用時) ← 未実装
	- [x] `land_level_check` 条件 (例: ID 106 アブサス - 戦闘地レベル3以上)
  - [x] 無効化持ちクリーチャーデータ整備（26体）
- [x] 巻物攻撃システム実装 ✅ **完了: 2025/10/20**
  - [x] is_using_scroll フラグ管理
  - [x] 巻物攻撃判定ロジック
  - [x] 無効化システムとの統合
- [ ] 先制攻撃キーワード
- [ ] その他キーワード能力

**次のステップ**:
1. **優先**: `item_equipped` 条件タイプの実装（`land_level_check`は完了）
2. 感応（elemental_resonance）実装
3. ability_parsedの自動生成ツール作成
4. 既存カードデータへのability_parsed追加
5. スキルテストケース作成

#### 2. グラフィック改善
**優先度**: 中  
**担当**: 開発者  
**進捗**: 40%

- [x] タイル画像実装（64x64px）
- [x] ColorRect → TextureRect変更
- [ ] マップ背景実装
- [ ] クリーチャーアイコン表示
- [ ] バトルエフェクト

**次のステップ**:
1. Bing Image Creatorで背景画像生成
2. game.gd 50行目付近に背景表示コード追加
3. クリーチャーアイコン素材準備（64x64px推奨）

#### 3. CPU AI改善
**優先度**: 中  
**担当**: 開発者  
**進捗**: 60%

- [x] 基本的な意思決定
- [x] 召喚判定（90%確率）
- [x] 侵略判定（80%確率）
- [ ] 戦略的土地選択
- [ ] カード選択の最適化
- [ ] リスク評価システム

---

## 未実装機能（優先度順）

### 🔴 優先度: 高

#### 1. スペルカード実装
**目標**: 2週間  
**難易度**: 中

タスク:
- [ ] スペルカードデータ構造定義
- [ ] 即時効果の実装
- [ ] 永続効果の実装
- [ ] 対象選択UI
- [ ] 世界呪（全体効果）実装

設計案:
```gdscript
# スペルカード例
{
  "type": "spell",
  "effect_type": "damage",
  "target": "enemy_creature",
  "value": 20,
  "timing": "instant"
}
```

#### 2. アイテムシステム
**目標**: 2週間  
**難易度**: 中

タスク:
- [ ] アイテムデータ構造
- [ ] 装備システム
- [ ] アイテム効果適用
- [ ] ショップ実装
- [ ] インベントリUI

アイテム種類案:
- 武器（ST上昇）
- 防具（HP上昇）
- アクセサリ（特殊効果）

#### 3. デッキ編集UI改善
**目標**: 1週間  
**難易度**: 低

タスク:
- [ ] カード検索機能
- [ ] フィルタリング（属性・コスト）
- [ ] ソート機能
- [ ] デッキ枚数制限チェック
- [ ] カードプレビュー拡大表示

---

### 🟡 優先度: 中

#### 4. マップ分岐システム
**目標**: 2週間  
**難易度**: 中

タスク:
- [ ] タイル接続データ構造設計
- [ ] 十字路・T字路判定ロジック
- [ ] 分岐選択UI実装
- [ ] 非ループマップ対応
- [ ] マップエディタープロトタイプ

設計案:
```gdscript
# タイル接続情報
{
  "connections": [4, 6, 12],  # 接続先
  "junction_type": "T-junction",
  "branch_choice": true  # 選択が必要か
}
```

#### 5. カメラシステム改善
**目標**: 3日  
**難易度**: 低

タスク:
- [ ] ズーム機能（ホイール）
- [ ] パン機能（ドラッグ）
- [ ] プレイヤー位置へ自動フォーカス
- [ ] アニメーション遷移

#### 5. バトルアニメーション
**目標**: 1週間  
**難易度**: 中

タスク:
- [ ] 攻撃エフェクト
- [ ] ダメージ表示
- [ ] HPバー減少アニメーション
- [ ] 勝敗演出
- [ ] サウンドエフェクト

#### 6. チュートリアル
**目標**: 1週間  
**難易度**: 低

タスク:
- [ ] 基本操作説明
- [ ] バトルチュートリアル
- [ ] 属性相性説明
- [ ] 連鎖システム説明
- [ ] スキップ機能

---

### 🟢 優先度: 低

#### 7. マルチプレイヤー（ローカル）
**目標**: 3週間  
**難易度**: 高

タスク:
- [ ] ホットシート対戦
- [ ] プレイヤー入力待機
- [ ] 手札非表示機能
- [ ] ターン切り替え演出

#### 8. キャンペーンモード
**目標**: 1ヶ月  
**難易度**: 高

タスク:
- [ ] ストーリー設計
- [ ] ステージ選択画面
- [ ] ボス戦実装
- [ ] 報酬システム
- [ ] 進行度セーブ

#### 9. オンライン対戦
**目標**: 2ヶ月  
**難易度**: 非常に高

タスク:
- [ ] ネットワーク設計
- [ ] サーバー構築
- [ ] 同期システム
- [ ] マッチメイキング
- [ ] チート対策

---

## 技術的改善項目

### コード品質

#### リファクタリング
- [ ] game_flow_manager.gdの分割（500行超）
- [ ] board_system.gdの最適化
- [ ] 重複コードの削除
- [ ] 命名規則の統一

#### ✅ TECH-002: アクション処理フラグの統一（完了）
- **関連**: BUG-004
- **完了日**: 2025/10/16
- **採用案**: 案1（TileActionProcessorに統一）
- **実装内容**:
  - `BoardSystem3D.is_waiting_for_action` を削除
  - `TileActionProcessor.complete_action()` 公開メソッド追加
  - `LandCommandHandler` の3箇所を修正
- **結果**: 
  - 状態管理の責任が明確化
  - バグの温床を根本解決
  - 保守性・拡張性が向上
- **ステータス**: ✅ 完了

#### テスト
- [ ] ユニットテスト導入
- [ ] バトルシステムのテストケース
- [ ] カードシステムのテストケース
- [ ] 属性連鎖の検証テスト

#### ドキュメント
- [x] design.md作成
- [x] tasks.md作成
- [x] issues.md作成
- [ ] requirements.md作成
- [ ] API仕様書作成
- [ ] コードコメント追加

### パフォーマンス

#### 最適化
- [ ] ノード数削減
- [ ] テクスチャ圧縮
- [ ] シグナル接続の最適化
- [ ] メモリプロファイリング

#### 描画
- [ ] z-indexの見直し
- [ ] カード表示の最適化
- [ ] アニメーション最適化

---

## 完了したマイルストーン

### Milestone 1: コアシステム構築 ✅
**完了日**: 2025年1月5日

- ボードシステム基礎
- カードシステム基礎
- バトルシステム基礎
- 基本的なゲームループ

### Milestone 2: 属性連鎖実装 ✅
**完了日**: 2025年1月8日

- 属性連鎖判定ロジック
- 通行料倍率計算
- HPボーナス適用
- デバッグ機能追加

### Milestone 3: グラフィック追加 ✅
**完了日**: 2025年1月9日

- タイル画像実装
- ColorRect → TextureRect
- 画像パス設定
- サイズ調整

### Milestone 4: スキルシステム基礎 ✅
**完了日**: 2025年1月10日

- ConditionChecker実装
- EffectCombat実装
- 強打スキル実装
- ability_parsed構造定義

### Milestone 5: カードシステム拡張 ✅
**完了日**: 2025年1月11日

- 統一された捨て札システム実装
- discard_card()関数の設計・実装
- ターン終了時の手札調整処理
- 手動/自動捨て札の実装
- 手札表示の動的スケール（画面80%対応）
- 2D版コード完全削除

### Milestone 6: 無効化・巻物攻撃システム実装 ✅
**完了日**: 2025年10月20日

- 無効化スキル完全実装
  - 属性無効化（element）
  - MHP/ST条件無効化（mhp_above/below, st_above/below）
  - 全攻撃無効化（all_attacks）
  - 能力持ち無効化（has_ability）
  - 巻物/通常攻撃無効化（scroll_attack/normal_attack）
- 巻物攻撃システム実装
  - is_using_scrollフラグ管理
  - 無効化システムとの統合
- 無効化持ちクリーチャーデータ整備（26体）
- JSONデータ修正（アンドロギア、ギアリオン、ミゴール、グレムリン）

### バグ修正・機能改善 (2025/12/05) ✅

- **ロードオブペイン秘術修正**
  - 単体選択→盤面全体対象に変更
  - spell_mystic.jsonのtarget_type修正
  - spell_mystic_arts.gdでSpellCurseStatへの委譲追加
- **移動侵略時の応援スキル除外**
  - 移動中クリーチャーは応援効果を発揮しない
  - board_system.remove_creature()でスキルインデックスから削除
  - is_movingフラグによる二重保護
- **魔力獲得系秘術実装（3体）**
  - ドゥームデボラー（ID:23）: MHP×G2獲得、ST&MHP-10
  - ヘルバイロン（ID:43）: 破壊数×G30獲得、カウントリセット
  - ウィッチ（ID:302）: 対象スペル数×G40を奪取
- **ダウン付与秘術実装（1体）**
  - アルプ（ID:108）: 対象敵クリーチャーをダウン状態に
- **ブック操作秘術実装（1体）**
  - コアトリクエ（ID:214）: 対象ブックの上1枚を破壊
- **移動侵略無効スキル実装（2体）**
  - グルイースラッグ（ID:120）、ランドアーチン（ID:243）
  - SpellCurseTollに判定メソッド追加、3箇所でチェック
- **スペル破壊時の死亡効果（2体）**
  - コーンフォーク（ID:315）: 遺産[G200]
  - ジャッカロープ（ID:217）: グレートタスカーに変身
  - spell_damage.gdに死亡効果チェック追加
- **攻撃成功時能力システム（2体+無効化3種）**
  - ショッカー（ID:18）: 攻撃成功時ダウン
  - ブラックナイト（ID:235）: 攻撃成功時能力無効化
  - スキュラ（ID:124）: 攻撃成功時能力無効化
  - スクイドマントル（ID:1017）: 攻撃成功時能力無効化（アイテム）
  - trigger形式（on_attack_success）を導入、nullify_triggersで無効化
  - skill_land_effects.gd新規作成
  - 既存のスカラベンドラ、バインドウィップ、ムーンシミターもtrigger形式に対応
- **戦闘終了時効果システム（4体+世界呪い）**
  - ルナティックヘア（ID:443）: 敵のAP⇔MHP交換
  - スキュラ（ID:124）: 敵に呪い"通行料無効"
  - サムハイン（ID:317）: 敵のMHP-自分の基本AP
  - レーシィ（ID:245）: 戦闘地レベル+1
  - ナチュラルワールド（ID:2064）: 世界呪い（秘術・死亡時・戦闘終了時を無効化）
  - trigger形式（on_battle_end）を導入
  - skill_battle_end_effects.gd新規作成
  - SpellWorldCurse.is_trigger_disabled()で無効化チェック統一
  - ロックタイタン、トリトン、マイコロン、ブルガサリもtrigger形式に対応（JSON設定済み）

---

## 次の2週間の計画

### Week 1 (1/11 - 1/17)
1. **月曜**: スペルカード設計
2. **火曜**: スペルカードデータ構造実装
3. **水曜**: 即時効果実装
4. **木曜**: 永続効果実装
5. **金曜**: スペルUI実装
6. **週末**: テスト・バグ修正

### Week 2 (1/18 - 1/24)
1. **月曜**: アイテムシステム設計
2. **火曜**: アイテムデータ実装
3. **水曜**: 装備システム実装
4. **木曜**: ショップUI実装
5. **金曜**: 統合テスト
6. **週末**: グラフィック改善

---

## 長期ロードマップ（3ヶ月）

### 1月（基礎機能拡張）
- ✅ Week 1-2: コアシステム完成
- 🚧 Week 3: スペルカード実装
- 🚧 Week 4: アイテムシステム実装

### 2月（コンテンツ追加）
- Week 1-2: カード50種類追加
- Week 3: チュートリアル実装
- Week 4: バランス調整

### 3月（仕上げ）
- Week 1-2: UI/UX改善
- Week 3: バグ修正・最適化
- Week 4: リリース準備

---

## タスク管理ルール

### ラベル
- `🔴 高優先度`: 2週間以内に対応
- `🟡 中優先度`: 1ヶ月以内に対応
- `🟢 低優先度`: 3ヶ月以内に対応
- `🚧 進行中`: 現在作業中
- `✅ 完了`: 実装済み

### 見積もり基準
- **難易度: 低** = 1-3日
- **難易度: 中** = 1-2週間
- **難易度: 高** = 3週間-1ヶ月
- **難易度: 非常に高** = 1ヶ月以上

---

**最終更新**: 2025年12月5日
