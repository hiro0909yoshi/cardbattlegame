# 📋 カルドセプト風カードバトルゲーム - タスク管理

## 目次
1. [実装済み機能](#実装済み機能)
2. [進行中のタスク](#進行中のタスク)
3. [未実装機能（優先度順）](#未実装機能優先度順)
4. [技術的改善項目](#技術的改善項目)
5. [完了したマイルストーン](#完了したマイルストーン)

---

## 実装済み機能

### ✅ コアゲームシステム（完成度: 75%）

#### ボードシステム（3D専用）
- [x] 菱形20マス配置（1辺5マス）- 3D空間
- [x] タイル所有権管理
- [x] 特殊マス実装
  - [x] スタート地点（0番）
  - [x] チェックポイント（5, 10, 15番）
  - [x] ワープゲート
  - [x] カードマス
- [x] z-indexによる奥行き表現
- [x] タイル画像表示（火/水/風/土/中立）

#### 属性連鎖システム
- [x] 同属性土地の連鎖判定（隣接チェック）
- [x] 通行料倍率計算
  - [x] 2個連鎖: 1.5倍
  - [x] 3個連鎖: 2.5倍
  - [x] 4個以上: 4.0倍（上限）
- [x] HPボーナス計算
  - [x] 1個: +10
  - [x] 2個: +20
  - [x] 3個: +30
  - [x] 4個以上: +40

#### カードシステム
- [x] デッキ管理（GameData連携）
- [x] 選択デッキの読み込み
- [x] 手札管理（最大6枚）
- [x] カードドロー処理
- [x] 捨て札→デッキシャッフル
- [x] カードUI表示（プレイヤー1のみ）
- [x] カード使用処理
- [x] コスト計算（mp × 10G）
- [x] 統一捨て札関数（discard_card）
- [x] ターン終了時の手札調整
  - [x] 人間プレイヤー: 手動選択
  - [x] CPU: 自動捨て札
- [x] 手札表示の動的スケール（画面80%対応）
- [x] 捨て札理由の分類（use/discard/forced/destroy）

#### バトルシステム
- [x] 先制攻撃システム
- [x] 属性相性判定（火→風→土→水→火）**← 削除予定**
- [x] 地形ボーナス（HP）
- [x] 属性連鎖ボーナス（HP）
- [x] 戦闘結果判定
  - [x] 攻撃側勝利
  - [x] 防御側勝利
  - [x] 相討ち（土地獲得）
  - [x] 膠着（決着つかず）
- [x] スキルシステム統合
  - [x] 強打（条件判定・効果適用）
  - [x] ability_parsed解析

#### プレイヤーシステム
- [x] 4人対応
- [x] 魔力管理（初期3000G）
- [x] 通行料処理
- [x] スタート通過ボーナス（200G）
- [x] ターン管理
- [x] 勝利条件判定（魔力8000G）

#### UIシステム
- [x] PlayerInfoPanel（魔力・土地数表示）
- [x] CardSelectionUI（カード選択モーダル）
- [x] LevelUpUI（土地レベルアップ）
- [x] DebugPanel（デバッグ情報）
- [x] 手札表示（240x350px）
- [x] 手札配置（中央揃え、自動リサイズ）

#### データ管理
- [x] CardLoader（Autoload）
- [x] GameData（セーブデータ管理）
- [x] JSONカードデータ読み込み
  - [x] fire.json（火属性）
  - [x] water.json（水属性）
  - [x] wind.json（風属性）
  - [x] earth.json（土属性）
  - [x] neutral.json（中立）
- [x] デッキデータ保存/読込

#### スキルシステム（部分実装）
- [x] ConditionChecker（条件判定）
- [x] EffectCombat（効果適用）
- [x] バトルコンテキスト構築
- [x] 強打スキル実装
- [x] プレイヤー土地情報取得

---

## 進行中のタスク

### 🚧 現在作業中

#### 1. スキルシステムの拡張
**優先度**: 高  
**担当**: 開発者  
**進捗**: 30%

- [x] 強打（power_strike）実装
- [ ] 感応（elemental_resonance）実装
- [ ] 無効化（nullify）実装
- [ ] 先制攻撃キーワード
- [ ] その他キーワード能力

**次のステップ**:
1. ability_parsedの自動生成ツール作成
2. 既存カードデータへのability_parsed追加
3. スキルテストケース作成

#### 2. グラフィック改善
**優先度**: 中  
**担当**: 開発者  
**進捗**: 40%

- [x] タイル画像実装（64x64px）
- [x] ColorRect → TextureRect変更
- [ ] マップ背景実装
- [ ] クリーチャーアイコン表示
- [ ] バトルエフェクト

**次のステップ**:
1. Bing Image Creatorで背景画像生成
2. game.gd 50行目付近に背景表示コード追加
3. クリーチャーアイコン素材準備（64x64px推奨）

#### 3. CPU AI改善
**優先度**: 中  
**担当**: 開発者  
**進捗**: 60%

- [x] 基本的な意思決定
- [x] 召喚判定（90%確率）
- [x] 侵略判定（80%確率）
- [ ] 戦略的土地選択
- [ ] カード選択の最適化
- [ ] リスク評価システム

---

## 未実装機能（優先度順）

### 🔴 優先度: 高

#### 1. スペルカード実装
**目標**: 2週間  
**難易度**: 中

タスク:
- [ ] スペルカードデータ構造定義
- [ ] 即時効果の実装
- [ ] 永続効果の実装
- [ ] 対象選択UI
- [ ] 世界呪（全体効果）実装

設計案:
```gdscript
# スペルカード例
{
  "type": "spell",
  "effect_type": "damage",
  "target": "enemy_creature",
  "value": 20,
  "timing": "instant"
}
```

#### 2. アイテムシステム
**目標**: 2週間  
**難易度**: 中

タスク:
- [ ] アイテムデータ構造
- [ ] 装備システム
- [ ] アイテム効果適用
- [ ] ショップ実装
- [ ] インベントリUI

アイテム種類案:
- 武器（ST上昇）
- 防具（HP上昇）
- アクセサリ（特殊効果）

#### 3. デッキ編集UI改善
**目標**: 1週間  
**難易度**: 低

タスク:
- [ ] カード検索機能
- [ ] フィルタリング（属性・コスト）
- [ ] ソート機能
- [ ] デッキ枚数制限チェック
- [ ] カードプレビュー拡大表示

---

### 🟡 優先度: 中

#### 4. マップ分岐システム
**目標**: 2週間  
**難易度**: 中

タスク:
- [ ] タイル接続データ構造設計
- [ ] 十字路・T字路判定ロジック
- [ ] 分岐選択UI実装
- [ ] 非ループマップ対応
- [ ] マップエディタープロトタイプ

設計案:
```gdscript
# タイル接続情報
{
  "connections": [4, 6, 12],  # 接続先
  "junction_type": "T-junction",
  "branch_choice": true  # 選択が必要か
}
```

#### 5. カメラシステム改善
**目標**: 3日  
**難易度**: 低

タスク:
- [ ] ズーム機能（ホイール）
- [ ] パン機能（ドラッグ）
- [ ] プレイヤー位置へ自動フォーカス
- [ ] アニメーション遷移

#### 5. バトルアニメーション
**目標**: 1週間  
**難易度**: 中

タスク:
- [ ] 攻撃エフェクト
- [ ] ダメージ表示
- [ ] HPバー減少アニメーション
- [ ] 勝敗演出
- [ ] サウンドエフェクト

#### 6. チュートリアル
**目標**: 1週間  
**難易度**: 低

タスク:
- [ ] 基本操作説明
- [ ] バトルチュートリアル
- [ ] 属性相性説明
- [ ] 連鎖システム説明
- [ ] スキップ機能

---

### 🟢 優先度: 低

#### 7. マルチプレイヤー（ローカル）
**目標**: 3週間  
**難易度**: 高

タスク:
- [ ] ホットシート対戦
- [ ] プレイヤー入力待機
- [ ] 手札非表示機能
- [ ] ターン切り替え演出

#### 8. キャンペーンモード
**目標**: 1ヶ月  
**難易度**: 高

タスク:
- [ ] ストーリー設計
- [ ] ステージ選択画面
- [ ] ボス戦実装
- [ ] 報酬システム
- [ ] 進行度セーブ

#### 9. オンライン対戦
**目標**: 2ヶ月  
**難易度**: 非常に高

タスク:
- [ ] ネットワーク設計
- [ ] サーバー構築
- [ ] 同期システム
- [ ] マッチメイキング
- [ ] チート対策

---

## 技術的改善項目

### コード品質

#### リファクタリング
- [ ] game_flow_manager.gdの分割（500行超）
- [ ] board_system.gdの最適化
- [ ] 重複コードの削除
- [ ] 命名規則の統一

#### TECH-002: アクション処理フラグの統一
- **関連**: BUG-004
- **現状**: 
  - `BoardSystem3D.is_waiting_for_action`
  - `TileActionProcessor.is_action_processing`
  - 2箇所でフラグ管理、整合性が取れなくなる問題
- **目標**: フラグを1箇所に統一
- **提案案**:
  - **案1**: TileActionProcessorに統一、BoardSystem3Dは参照のみ
  - **案2**: 新規TurnManagerクラスを作成し、そこで一元管理
  - **案3**: BoardSystem3Dに統一、TileActionProcessorは通知のみ
- **優先度**: 🔴 High（バグの温床）
- **ステータス**: 📋 設計待ち

#### テスト
- [ ] ユニットテスト導入
- [ ] バトルシステムのテストケース
- [ ] カードシステムのテストケース
- [ ] 属性連鎖の検証テスト

#### ドキュメント
- [x] design.md作成
- [x] tasks.md作成
- [x] issues.md作成
- [ ] requirements.md作成
- [ ] API仕様書作成
- [ ] コードコメント追加

### パフォーマンス

#### 最適化
- [ ] ノード数削減
- [ ] テクスチャ圧縮
- [ ] シグナル接続の最適化
- [ ] メモリプロファイリング

#### 描画
- [ ] z-indexの見直し
- [ ] カード表示の最適化
- [ ] アニメーション最適化

---

## 完了したマイルストーン

### Milestone 1: コアシステム構築 ✅
**完了日**: 2025年1月5日

- ボードシステム基礎
- カードシステム基礎
- バトルシステム基礎
- 基本的なゲームループ

### Milestone 2: 属性連鎖実装 ✅
**完了日**: 2025年1月8日

- 属性連鎖判定ロジック
- 通行料倍率計算
- HPボーナス適用
- デバッグ機能追加

### Milestone 3: グラフィック追加 ✅
**完了日**: 2025年1月9日

- タイル画像実装
- ColorRect → TextureRect
- 画像パス設定
- サイズ調整

### Milestone 4: スキルシステム基礎 ✅
**完了日**: 2025年1月10日

- ConditionChecker実装
- EffectCombat実装
- 強打スキル実装
- ability_parsed構造定義

### Milestone 5: カードシステム拡張 ✅
**完了日**: 2025年1月11日

- 統一された捨て札システム実装
- discard_card()関数の設計・実装
- ターン終了時の手札調整処理
- 手動/自動捨て札の実装
- 手札表示の動的スケール（画面80%対応）
- 2D版コード完全削除

---

## 次の2週間の計画

### Week 1 (1/11 - 1/17)
1. **月曜**: スペルカード設計
2. **火曜**: スペルカードデータ構造実装
3. **水曜**: 即時効果実装
4. **木曜**: 永続効果実装
5. **金曜**: スペルUI実装
6. **週末**: テスト・バグ修正

### Week 2 (1/18 - 1/24)
1. **月曜**: アイテムシステム設計
2. **火曜**: アイテムデータ実装
3. **水曜**: 装備システム実装
4. **木曜**: ショップUI実装
5. **金曜**: 統合テスト
6. **週末**: グラフィック改善

---

## 長期ロードマップ（3ヶ月）

### 1月（基礎機能拡張）
- ✅ Week 1-2: コアシステム完成
- 🚧 Week 3: スペルカード実装
- 🚧 Week 4: アイテムシステム実装

### 2月（コンテンツ追加）
- Week 1-2: カード50種類追加
- Week 3: チュートリアル実装
- Week 4: バランス調整

### 3月（仕上げ）
- Week 1-2: UI/UX改善
- Week 3: バグ修正・最適化
- Week 4: リリース準備

---

## タスク管理ルール

### ラベル
- `🔴 高優先度`: 2週間以内に対応
- `🟡 中優先度`: 1ヶ月以内に対応
- `🟢 低優先度`: 3ヶ月以内に対応
- `🚧 進行中`: 現在作業中
- `✅ 完了`: 実装済み

### 見積もり基準
- **難易度: 低** = 1-3日
- **難易度: 中** = 1-2週間
- **難易度: 高** = 3週間-1ヶ月
- **難易度: 非常に高** = 1ヶ月以上

---

**最終更新**: 2025年1月11日
