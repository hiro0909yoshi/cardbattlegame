# CPU スペル/ミスティックアーツ AI 仕様書

**作成日**: 2025-12-31
**ステータス**: 設計中

---

## 概要

CPUがスペルフェーズでスペルカードまたはミスティックアーツを使用するかを判断し、適切なターゲットを選択するシステム。

### 基本制約

- **排他的使用**: 1ターンにスペルカードまたはミスティックアーツのどちらか1つのみ使用可能
- **UI使用**: 既存のターゲット選択UIを使用（プレイヤーと同じ見た目）
- **コスト**: 魔力を消費

---

## アーキテクチャ

```
scripts/cpu_ai/
├── cpu_spell_ai.gd           # スペルカード使用判断
├── cpu_mystic_arts_ai.gd     # ミスティックアーツ使用判断  
└── cpu_spell_evaluator.gd    # 効果評価（共通ロジック）

scripts/game_flow/
└── spell_phase_handler.gd    # CPU判断を呼び出し、UIを制御
```

### クラス責務

| クラス | 責務 |
|--------|------|
| `CPUSpellAI` | 手札のスペルカードを評価し、使用すべきか判断 |
| `CPUMysticArtsAI` | 配置済みクリーチャーの秘術を評価し、使用すべきか判断 |
| `CPUSpellEvaluator` | 効果の有用性を評価（共通ロジック） |

---

## 判断フロー

```
スペルフェーズ開始
    │
    ├─ 1. スペル使用可能かチェック
    │      └─ 手札にスペルがあるか、コスト支払えるか
    │
    ├─ 2. ミスティックアーツ使用可能かチェック
    │      └─ 配置クリーチャーが秘術を持っているか、コスト支払えるか
    │
    ├─ 3. 両方使用可能な場合の選択
    │      ├─ 手札が逼迫（6枚以上）→ スペル優先
    │      ├─ 魔力が少ない → コストが低い方を優先
    │      └─ 効果の有用性で判断
    │
    ├─ 4. 使用するスペル/秘術の選択
    │      └─ 効果カテゴリ別に優先度評価
    │
    ├─ 5. ターゲット選択
    │      └─ 既存UIを使用、CPU自動選択
    │
    └─ 6. 実行または見送り
```

---

## 効果カテゴリと優先度

### Phase 1: 基本実装

| 優先度 | カテゴリ | 判断基準 | 対応effect_type |
|--------|----------|----------|-----------------|
| 1 | ダメージ系 | 敵クリーチャーを倒せる | `damage` |
| 2 | 回復系 | 自クリーチャーがダメージを受けている | `heal` |
| 3 | 魔力獲得 | 魔力が一定以下 | `gain_magic`, `drain_magic` |
| 4 | ドロー系 | 手札が少ない | `draw`, `draw_until` |
| 5 | 呪い系 | 有効なターゲットがいる | `creature_curse`, `player_curse` |

### Phase 2: 拡張実装

| 優先度 | カテゴリ | 判断基準 | 対応effect_type |
|--------|----------|----------|-----------------|
| - | ダイス操作 | 特定マスに止まりたい | `dice_fixed`, `dice_range` |
| - | 土地操作 | 土地状況の改善 | `change_element`, `level_change` |
| - | 移動系 | 戦略的移動 | `move_creature`, `swap_creature` |
| - | ステータス変更 | 長期的有利 | `permanent_ap_change`, `permanent_hp_change` |

---

## ダメージ系判断ロジック

### 基本判断（Phase 1）

```
1. ダメージスペル/秘術を抽出
2. 各ターゲット候補について:
   a. ダメージ値 >= ターゲットの現在HP → 倒せる
   b. 倒せるターゲットがいれば使用
3. 倒せるターゲットが複数いる場合:
   a. 土地レベルが高い順
   b. クリーチャーのコストが高い順
```

### 拡張判断（Phase 2）

```
倒した後の土地価値を考慮:
- 空いた土地を自分が占領できるか
- 連鎖ボーナスへの影響
- 敵の総資産への影響
```

---

## ターゲット選択

### UI連携フロー

```
CPUSpellAI.decide_spell()
    │
    ├─ 使用するスペル決定
    ├─ 最適ターゲット決定
    │
    └─ SpellPhaseHandler に通知
           │
           ├─ ターゲット選択UI表示
           ├─ CPU自動選択（ディレイ付き）
           └─ 確定・実行
```

### ターゲットタイプ別処理

| target_type | 選択方法 |
|-------------|----------|
| `creature` | CPUSpellEvaluator で最適クリーチャー選択 |
| `land` | CPUSpellEvaluator で最適土地選択 |
| `player` | 敵プレイヤー or 自分（効果による） |
| `all_creatures` | 自動適用（選択不要） |
| `self` | 自動適用（選択不要） |
| `none` | 選択不要 |

---

## スペル vs ミスティックアーツ 選択基準

| 条件 | 選択 |
|------|------|
| 手札が6枚以上 | スペル優先（手札消費） |
| 手札が3枚以下 | ミスティックアーツ優先 |
| スペルのみ有効 | スペル |
| 秘術のみ有効 | ミスティックアーツ |
| 両方有効 | 効果の有用性スコアで比較 |
| コスト差が大きい | 低コスト優先 |

---

## 実装計画

### Phase 1: 基本実装
- [ ] `cpu_spell_evaluator.gd` - 効果評価基盤
- [ ] `cpu_spell_ai.gd` - スペルカード判断
- [ ] `cpu_mystic_arts_ai.gd` - ミスティックアーツ判断
- [ ] `spell_phase_handler.gd` 修正 - CPU連携

### Phase 2: 効果別実装
- [ ] ダメージ系評価
- [ ] 回復系評価
- [ ] 魔力獲得系評価
- [ ] ドロー系評価
- [ ] 呪い系評価

### Phase 3: 高度な判断
- [ ] 土地価値を考慮したダメージ判断
- [ ] ダイス操作の戦略的使用
- [ ] 移動系の戦略的使用

---

## 関連ファイル

- `scripts/game_flow/spell_phase_handler.gd` - スペルフェーズ制御
- `scripts/cpu_ai/cpu_turn_processor.gd` - 現在のCPUスペル処理（簡易版）
- `scripts/spells/spell_mystic_arts.gd` - ミスティックアーツ実行
- `data/spell_mystic.json` - ミスティックアーツデータ
- `docs/design/spells_design.md` - スペルシステム設計書

---

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-31 | 初版作成 |
