# バトルテストツール機能仕様書

**プロジェクト**: カルドセプト風カードバトルゲーム  
**作成日**: 2025年10月18日  
**完成日**: 2025年10月20日  
**対象ユーザー**: 開発者・テスター  
**ステータス**: 基本機能実装完了（スペル効果とCSV出力は未実装）

---

## ⚠️ 重要な注意事項

**この仕様書は新規作成されたものです。実装を進める中で機能の変更や追加が発生する可能性があります。**

- 実装中に仕様の不備や矛盾を発見した場合は、このドキュメントを更新してください
- ユーザーからのフィードバックを反映して仕様を改善してください
- 変更履歴を必ず記録してください

---

## 📋 目次

1. [概要](#概要)
2. [機能一覧](#機能一覧)
3. [画面仕様](#画面仕様)
4. [操作フロー](#操作フロー)
5. [入力値仕様](#入力値仕様)
6. [出力仕様](#出力仕様)
7. [スキル付与機能](#スキル付与機能)
8. [エラーハンドリング](#エラーハンドリング)
9. [制限事項](#制限事項)

---

## 概要

### 目的
スペル・アイテム・スキルの効果を網羅的にテストし、バランス調整とバグ検出を支援する。

### 利用シーン
1. **新スキル実装後**: 正しく動作するか確認
2. **新アイテム・スペル実装後**: スキル付与が正しく機能するか確認 ★追加
3. **バランス調整前**: 各クリーチャーの強さを数値化
4. **リファクタリング後**: 既存機能が壊れていないか確認
5. **バグ報告時**: 再現条件を特定

---

## 機能一覧

### F1. クリーチャー選択
- **機能ID**: F1
- **説明**: テストするクリーチャーをID入力で選択
- **入力**: クリーチャーID（整数）
- **出力**: クリーチャー名表示
- **制約**: 最大10体まで選択可能

### F2. アイテム選択
- **機能ID**: F2
- **説明**: テストするアイテムをID入力で選択
- **入力**: アイテムID（整数）または「なし」
- **出力**: アイテム名表示
- **制約**: 複数選択可能、1つずつテスト実行
- **スキル付与**: アイテムによってスキルが付与される場合がある ★追加

### F3. スペル選択
- **機能ID**: F3
- **説明**: テストするスペルをID入力で選択
- **入力**: スペルID（整数）または「なし」
- **出力**: スペル名表示
- **制約**: 1つのみ選択可能
- **スキル付与**: スペルによってスキルが付与される場合がある（将来実装） ★追加

### F4. 土地条件設定
- **機能ID**: F4
- **説明**: 保有土地数とバトル発生土地を設定
- **入力**: 
  - 火水地風の保有数（0-10）
  - バトル発生土地の属性（火/水/地/風/中立）
- **出力**: 設定値の表示

### F5. 隣接条件設定
- **機能ID**: F5
- **説明**: 隣接味方領地の有無を設定
- **入力**: チェックボックス（ON/OFF）
- **出力**: 設定状態の表示

### F6. プリセット選択
- **機能ID**: F6
- **説明**: 事前定義された組み合わせを選択
- **入力**: プリセット名（ドロップダウン）
- **出力**: 自動的にID入力欄に反映
- **プリセット種類**:
  - 火属性、水属性、風属性、地属性
  - 先制攻撃持ち、強打持ち、無効化持ち

### F7. 攻撃⇔防御入れ替え
- **機能ID**: F7
- **説明**: 攻撃側と防御側の設定を入れ替え
- **入力**: ボタンクリック
- **出力**: 設定が入れ替わる

### F8. ID参照パネル
- **機能ID**: F8
- **説明**: 全カードのID一覧を表示
- **入力**: 検索ワード（オプション）
- **出力**: フィルターされたカードリスト
- **機能**: 
  - 折りたたみ式
  - タブ切り替え（クリーチャー/アイテム/スペル）
  - 検索フィルター
  - アイテム・スペルの付与スキル表示 ★追加

### F9. バトル実行
- **機能ID**: F9
- **説明**: 設定に基づいて全バトルを実行
- **入力**: 実行ボタンクリック
- **出力**: 
  - プログレスバー表示
  - 結果データ生成（付与スキル情報含む） ★追加
- **処理時間**: 約6-7分（40,000バトル）

### F10. 結果表示（テーブル）
- **機能ID**: F10
- **説明**: バトル結果を一覧表示
- **表示項目**:
  - バトルID、攻撃側、防御側、勝者
  - 残HP、最終AP、発動スキル
  - **付与スキル** ★追加
- **機能**:
  - ページネーション（20件/ページ）
  - ソート（各カラムクリック）
  - フィルター（勝者、クリーチャー名、付与スキル等） ★追加

### F11. 結果表示（詳細）
- **機能ID**: F11
- **説明**: 選択したバトルの詳細を表示
- **表示項目**:
  - 基本ステータス、最終ステータス
  - アイテム、スペル、発動スキル
  - **付与スキルの詳細（アイテム/スペル由来の明記）** ★追加
  - バトル条件、ダメージ詳細
- **起動**: テーブルの行をクリック

### F12. 統計サマリー
- **機能ID**: F12
- **説明**: 全体統計を表示
- **表示項目**:
  - 総バトル数、実行時間
  - 勝率、クリーチャー別勝率
  - スキル発動率
  - **スキル付与統計（アイテム/スペル別）** ★追加
- **機能**: 折りたたみ式

### F13. CSV出力
- **機能ID**: F13
- **説明**: 結果をCSVファイルで出力
- **出力項目**: 全バトル結果データ（付与スキル情報含む） ★追加
- **ファイル名**: `battle_test_results_YYYYMMDD_HHMMSS.csv`
- **エンコード**: UTF-8

---

## 画面仕様

### メイン画面レイアウト
```
┌─────────────────────────────────────────┐
│  バトルテストツール                       │
├─────────────────────────────────────────┤
│                                         │
│ ┌─ 攻撃側設定 ─────────────────────┐    │
│ │ (F1-F5の入力UI)                  │    │
│ └──────────────────────────────────┘    │
│                                         │
│ ┌─ 防御側設定 ─────────────────────┐    │
│ │ (F1-F5の入力UI)                  │    │
│ └──────────────────────────────────┘    │
│                                         │
│ [攻撃⇔防御入れ替え(F7)] [実行(F9)]      │
│                                         │
│ ┌─ ID参照パネル(F8) [▼展開] ──────┐    │
│ │ (折りたたみ可能)                  │    │
│ │ ※アイテム・スペルの付与スキル表示 │    │
│ └──────────────────────────────────┘    │
│                                         │
│ ┌─ 実行状況 ───────────────────────┐    │
│ │ プログレスバー                    │    │
│ └──────────────────────────────────┘    │
│                                         │
│ ┌─ 結果表示 ───────────────────────┐    │
│ │ [統計(F12)][テーブル(F10)][詳細]  │    │
│ │ (タブ切り替え)                    │    │
│ └──────────────────────────────────┘    │
│                                         │
│ [CSV出力(F13)]                          │
└─────────────────────────────────────────┘
```

### 色・スタイル仕様

| 要素 | 色 | 用途 |
|------|---|------|
| 有効なID | 緑 | 正しく認識されたID |
| 無効なID | 赤 | 存在しないID |
| 攻撃側勝利行 | 薄緑背景 | テーブル表示 |
| 防御側勝利行 | 薄赤背景 | テーブル表示 |
| 発動スキル | 黄色文字 | 強調表示 |
| 付与スキル | 青色文字 | 強調表示 ★追加 |
| アイテム由来 | (I)マーク | 付与元の識別 ★追加 |
| スペル由来 | (S)マーク | 付与元の識別 ★追加 |

---

## 操作フロー

### 基本操作フロー
```
1. ツール起動
   ↓
2. 攻撃側設定
   ├─ クリーチャーID入力 (F1)
   ├─ アイテムID入力 (F2) ★スキル付与の可能性
   ├─ スペルID入力 (F3) ★スキル付与の可能性
   ├─ 土地条件設定 (F4)
   └─ 隣接条件設定 (F5)
   ↓
3. 防御側設定（同様）
   ↓
4. 設定確認
   └─ 必要に応じて入れ替え (F7)
   ↓
5. 実行 (F9)
   ├─ プログレスバー表示
   ├─ アイテム・スペル効果適用 ★スキル付与含む
   └─ 結果生成
   ↓
6. 結果確認
   ├─ 統計サマリー確認 (F12) ★付与スキル統計含む
   ├─ テーブルで一覧 (F10) ★付与スキル列あり
   └─ 詳細確認 (F11) ★付与スキル詳細あり
   ↓
7. CSV出力 (F13)（オプション）
```

---

## 入力値仕様

### クリーチャーID (F1)

| 項目 | 仕様 |
|------|------|
| 型 | 整数 |
| 範囲 | 1-9999 |
| 必須 | はい（最低1つ） |
| 最大個数 | 10個 |
| 特殊値 | なし |
| バリデーション | CardLoaderで存在確認 |

### アイテムID (F2)

| 項目 | 仕様 |
|------|------|
| 型 | 整数 または 文字列 |
| 範囲 | 3000-3999 |
| 必須 | いいえ |
| 最大個数 | 無制限 |
| 特殊値 | "なし", "none", "-1" |
| バリデーション | CardLoaderで存在確認 |
| スキル付与 | ability_parsed内のgrant_skill effectを確認 ★追加 |

### スペルID (F3)

| 項目 | 仕様 |
|------|------|
| 型 | 整数 または 文字列 |
| 範囲 | 2000-2999 |
| 必須 | いいえ |
| 最大個数 | 1個 |
| 特殊値 | "なし", "none", "-1" |
| バリデーション | CardLoaderで存在確認 |
| スキル付与 | ability_parsed内のgrant_skill effectを確認（将来実装） ★追加 |

### 土地保有数 (F4)

| 項目 | 仕様 |
|------|------|
| 型 | 整数 |
| 範囲 | 0-10 |
| デフォルト | 0 |
| UI | スライダー |

### バトル発生土地 (F4)

| 項目 | 仕様 |
|------|------|
| 型 | 文字列 |
| 選択肢 | "fire", "water", "earth", "wind", "neutral" |
| デフォルト | "fire" |
| UI | ラジオボタン |

### 隣接条件 (F5)

| 項目 | 仕様 |
|------|------|
| 型 | ブール |
| デフォルト | false |
| UI | チェックボックス |

---

## 出力仕様

### テーブル表示 (F10)

| カラム | 内容 | 型 |
|--------|------|---|
| ID | バトルID | 整数 |
| 攻撃側 | クリーチャー名+アイテム名 | 文字列 |
| 防御側 | クリーチャー名+アイテム名 | 文字列 |
| 勝者 | "攻"または"防" | 文字列 |
| 残HP | 攻撃側/防御側 | 整数/整数 |
| AP | 攻撃側/防御側 | 整数/整数 |
| スキル | 発動したスキル | 文字列 |
| 付与スキル | アイテム・スペルで付与されたスキル | 文字列 ★追加 |

**付与スキル表記例**:
- `強打(I)` - アイテムで付与された強打
- `先制攻撃(S)` - スペルで付与された先制攻撃
- `後手(I),強打(I)` - 複数スキル付与

### CSV出力 (F13)

**ファイル形式**:
```csv
battle_id,attacker_name,attacker_item,attacker_spell,defender_name,defender_item,defender_spell,winner,attacker_final_ap,attacker_final_hp,defender_final_ap,defender_final_hp,attacker_skills,attacker_granted_skills,defender_skills,defender_granted_skills,battle_land
1,アモン,ロングソード,パワーブースト,フェニックス,なし,なし,attacker,50,25,40,0,"先制,強打","強打","","",fire
2,アモン,なし,なし,フェニックス,バックラー,なし,defender,30,0,45,15,"","","","",fire
3,アモン,マグマハンマー,なし,フェニックス,なし,なし,attacker,50,15,40,0,"先制,強打","強打","","",fire
```

**カラム説明**:
- `attacker_granted_skills`: 攻撃側に付与されたスキル（カンマ区切り） ★追加
- `defender_granted_skills`: 防御側に付与されたスキル（カンマ区切り） ★追加

**エンコード**: UTF-8 (BOM付き)  
**改行コード**: CRLF (Windows互換)

---

## スキル付与機能

### 概要

アイテムやスペルを使用することで、クリーチャーに**新たなスキルを付与**できる機能。  
テストツールでは、この付与されたスキルも正しく記録・表示する。

### 付与可能なスキル（現在実装済み）

| スキル名 | 効果 | 付与方法 |
|---------|------|---------|
| 先制攻撃 | 先に攻撃する | アイテム ★ |
| 後手 | 後に攻撃する | アイテム ★ |
| 強打 | APが2倍になる | アイテム ★ |

**今後追加予定のスキル**:
- 貫通、無効化、再生、吸収 など

### アイテムによるスキル付与の例

#### 例1: 無条件で付与

```json
{
	"id": 3010,
	"name": "スピードブーツ",
	"type": "item",
	"ability_parsed": {
		"effects": [
			{
				"effect_type": "grant_skill",
				"skill_name": "先制攻撃"
			}
		]
	}
}
```

**動作**: このアイテムを装備すると、どのクリーチャーでも先制攻撃が付与される。

#### 例2: 条件付きで付与

```json
{
	"id": 3002,
	"name": "マグマハンマー",
	"type": "item",
	"ability_parsed": {
		"effects": [
			{
				"effect_type": "stat_bonus",
				"target_stat": "st",
				"value": 20
			},
			{
				"effect_type": "grant_skill",
				"skill_name": "強打",
				"conditions": {
					"user_element": "fire"
				}
			}
		]
	}
}
```

**動作**: 
- ST+20は無条件
- **強打は火属性のクリーチャーのみ**に付与

### スペルによるスキル付与（将来実装）

```json
{
	"id": 2050,
	"name": "加速の魔法",
	"type": "spell",
	"ability_parsed": {
		"effects": [
			{
				"effect_type": "grant_skill",
				"skill_name": "先制攻撃"
			}
		]
	}
}
```

### テスト結果での表示

#### テーブル表示
```
┌────┬──────────┬──────────┬─────┬──────────┐
│ ID │ 攻撃側    │ 防御側    │ 勝者 │付与スキル │
├────┼──────────┼──────────┼─────┼──────────┤
│ 1  │ アモン    │フェニックス│ 攻  │強打(I)   │
│    │+マグマハン...│+なし   │     │          │
└────┴──────────┴──────────┴─────┴──────────┘
```

#### 詳細表示
```
攻撃側: アモン (火属性)
  アイテム: マグマハンマー
  付与スキル: 
	✓ 強打 (マグマハンマーにより付与)
	  └─ 条件: 火属性クリーチャー → ✓満たす
```

#### 統計サマリー
```
スキル付与統計:
├─ 強打: 450回付与
│   ├─ アイテムから: 400回
│   └─ スペルから: 50回
├─ 先制攻撃: 200回付与
│   ├─ アイテムから: 200回
│   └─ スペルから: 0回
```

### 付与失敗のケース

**条件不一致の場合**:
```
攻撃側: ウォーターエレメンタル (水属性)
  アイテム: マグマハンマー
  付与スキル: 
	✗ 強打 (条件不一致: 火属性必須 → 水属性)
```

このケースでは、ST+20は適用されるが、強打は付与されない。

---

## エラーハンドリング

### E1. 無効なID入力

**状況**: 存在しないIDを入力  
**動作**:
1. 入力欄を赤色表示
2. 名前表示エリアに「（存在しません）」
3. 実行ボタンを無効化

**回復方法**: 有効なIDに修正

### E2. クリーチャー未選択

**状況**: 攻撃側または防御側のクリーチャーが未選択  
**動作**:
1. エラーダイアログ表示
2. 実行を中止

**回復方法**: クリーチャーを選択

### E3. 実行中のエラー

**状況**: バトル実行中に例外発生  
**動作**:
1. 実行を中断
2. エラーログを表示
3. 既に実行済みの結果は保持

**回復方法**: エラー原因を修正して再実行

### E4. メモリ不足

**状況**: 結果データが大きすぎる  
**動作**:
1. 警告ダイアログ表示
2. 実行件数を減らすよう提案

**回復方法**: テスト範囲を縮小

### E5. アイテムデータ不正 ★追加

**状況**: アイテムのability_parsedが不正、またはgrant_skillの定義が不正  
**動作**:
1. 警告ログを出力
2. そのアイテムのスキル付与をスキップ
3. テスト自体は継続

**回復方法**: item.jsonを修正

### E6. スキル付与失敗 ★追加

**状況**: `_grant_skill_to_participant()` で未対応のスキル名が指定された  
**動作**:
1. 警告ログを出力
2. そのスキルの付与をスキップ
3. テスト自体は継続

**回復方法**: BattleSystemに新スキルを追加実装

---

## 制限事項

### 機能制限

1. **1対1バトルのみ**
   - 複数クリーチャーの同時戦闘は非対応

2. **スペルは1つまで**
   - 複数スペルの組み合わせは非対応

3. **アイテムは1つずつテスト**
   - 同時に複数アイテムは装備不可

4. **リアルタイムバトルなし**
   - アニメーションは非表示
   - 高速で結果のみ計算

5. **スキル付与の制限** ★追加
   - BattleSystemで実装済みのスキルのみ付与可能
   - 未実装スキルは付与されない

### パフォーマンス制限

1. **最大バトル数**: 100,000件まで推奨
2. **実行時間**: 件数に応じて変動
3. **メモリ使用量**: 約50MB上限

### UI制限

1. **クリーチャー選択**: 最大10体
2. **ページネーション**: 20件固定
3. **プログレスバー更新**: 100件ごと

### データ制限 ★追加

1. **item.jsonの準備が必要**
   - テスト実行前にアイテムデータを作成
   - ability_parsedが正しく定義されている必要

2. **スキル付与条件**
   - 現在対応: `user_element`（クリーチャー属性）
   - 今後追加予定: `user_level`, `land_count` など

---

## 付録

### プリセット一覧

| プリセット名 | 含まれるID |
|------------|-----------|
| 火属性 | 2, 4, 7, 9, 15, 16, 19 |
| 水属性 | 101, 104, 108, 113, 116, 120 |
| 風属性 | 300, 303, 307, 309, 315, 320 |
| 地属性 | 201, 205, 210, 215, 220 |
| 先制攻撃持ち | 7, 303, 405 |
| 強打持ち | 4, 9, 19 |
| 無効化持ち | 1, 6, 11, 16, 112, 325, 413 |

### 付与可能なスキル一覧 ★追加

| スキル名 | 実装状況 | 付与方法 | 備考 |
|---------|---------|---------|------|
| 先制攻撃 | ✅実装済み | アイテム | has_item_first_strike |
| 後手 | ✅実装済み | アイテム | has_last_strike |
| 強打 | ✅実装済み | アイテム | has_power_strike |
| 貫通 | 🚧未実装 | アイテム/スペル | 今後追加予定 |
| 無効化 | 🚧未実装 | アイテム/スペル | 今後追加予定 |

### キーボードショートカット

| キー | 動作 |
|------|------|
| Ctrl+R | 実行 |
| Ctrl+S | CSV出力 |
| Ctrl+F | フィルター表示 |
| Esc | ダイアログを閉じる |

---

## 用語集 ★追加

| 用語 | 説明 |
|------|------|
| スキル付与 | アイテムやスペルによって、クリーチャーに新しいスキルを与えること |
| grant_skill | ability_parsed内でスキル付与を定義するeffect_type |
| conditions | スキル付与の条件（user_element等） |
| 付与元 | スキルを付与したアイテムまたはスペル |
| (I)マーク | アイテムによる付与を示す表記 |
| (S)マーク | スペルによる付与を示す表記 |

---

## 更新履歴

| 日付 | 内容 | 更新者 |
|------|------|--------|
| 2025/10/18 | 初版作成 | AI |
| 2025/10/18 | アイテム・スペルによるスキル付与機能を追加 | AI |

---

**最終更新**: 2025年10月18日
