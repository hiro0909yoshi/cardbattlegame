# CPU 領地コマンド AI 仕様書

**作成日**: 2026年1月6日  
**ステータス**: 設計中

---

## 📋 目次

1. [概要](#概要)
2. [判断フロー](#判断フロー)
3. [領地コマンドの種類](#領地コマンドの種類)
4. [利益スコア計算](#利益スコア計算)
5. [危機モード](#危機モード)
6. [個別コマンド詳細](#個別コマンド詳細)
7. [共通ルール](#共通ルール)
8. [将来の拡張](#将来の拡張)
9. [実装状況](#実装状況)

---

## 概要

### ゲームの基盤となる3要素

1. **通行料を取られないこと**
2. **領地を増やすこと**
3. **領地のレベルを上げること**

これらを効率的に行うための領地コマンド判断AIを設計する。

### 召喚フェーズの行動

召喚フェーズでは以下のいずれか1つを実行できる:
- クリーチャー召喚
- 領地コマンド（レベルアップ、属性変更、移動侵略、クリーチャー交換）

**どちらか1つのみ**。召喚したら領地コマンドは使えない。

---

## 判断フロー

```
止まったタイルの種類を判定
│
├─ 空き地 ─────────────────────────────────────────┐
│    │                                             │
│    ├─ 属性合うクリーチャーあり → 必ず召喚        │
│    │                                             │
│    └─ 属性合わない or クリーチャーなし           │
│         │                                        │
│         ├─ 手札6枚以上 → 召喚して手札を減らす    │
│         │   （将来: 領地コマンドの方が得な場合は例外）
│         │                                        │
│         └─ 手札6枚未満 → 領地コマンド検討        │
│                                                  │
├─ 自分の領地 → 領地コマンド検討                   │
│                                                  │
└─ 敵の領地 ───────────────────────────────────────┐
	  │                                            │
	  ├─ 倒せる（BattleSimulator判定）             │
	  │    → 侵略スコア vs 領地コマンドスコア比較  │
	  │    → 高い方を実行                          │
	  │                                            │
	  └─ 倒せない                                  │
		   │                                       │
		   ├─ 危機モード（残り魔力 < 100G）        │
		   │    → 最大連鎖の土地を最大限レベルアップ
		   │                                       │
		   └─ 通常 → 領地コマンド検討              │
```

### 領地コマンドをスキップするケース

- 召喚を実行した場合
- 戦闘を実行した場合
- 領地コマンドの条件を満たすものがない場合
- **自分の領地クリーチャーが全てダウン状態**

---

## 領地コマンドの種類

| コマンド | 説明 |
|---------|------|
| レベルアップ | 自領地のレベルを上げる（通行料増加） |
| 属性変更 | 土地の属性を変更する |
| 移動侵略 | 他タイルに移動して敵を攻撃、または空き地に移動 |
| クリーチャー交換 | 配置済みクリーチャーを手札と入れ替え |

---

## 利益スコア計算

### 基本方針

**固定の優先順位ではなく、各行動の「利益スコア」を計算して最大のものを選ぶ。**

```
1. 各コマンドの利益スコアを計算
2. 全コマンドのスコアを比較
3. 最高スコアのコマンドを実行
4. スコアが一定以下（または実行可能なものがない）→ スキップ
```

### 基準スコア

| 行動 | スコア | 備考 |
|------|--------|------|
| 空き地に属性一致召喚 | 290 | 属性一致クリーチャーがあれば無条件で召喚 |
| 空き地に属性不一致召喚 | 100 | 領地コマンドと比較して判断 |

### スコア計算式一覧

#### 侵略（敵領地で戦闘）

敵領地に止まって倒せる場合のスコア。

```
score = (敵土地のレベル × 連鎖ボーナス × 100 + 属性一致ボーナス(50)) × 2
```

**× 2 の理由**: 自分の資産増 + 敵の資産減

| 条件 | 計算 | スコア |
|------|------|--------|
| レベル1、連鎖1.0、属性不一致 | (100) × 2 | 200 |
| レベル2、連鎖1.5、属性一致 | (300 + 50) × 2 | 700 |
| レベル3、連鎖2.5、属性一致 | (750 + 50) × 2 | 1600 |
| レベル5、連鎖5.0、属性一致 | (2500 + 50) × 2 | 5100 |

このスコアと領地コマンドスコアを比較して判断。
低レベル敵地より高連鎖の自領地レベルアップが得な場合がある。

#### 移動侵略（敵地を奪う）

```
score = 敵土地のレベル × 連鎖ボーナス × 100
	  + 属性一致ボーナス（50）
```

| 条件 | スコア |
|------|--------|
| レベル1、連鎖1.0、属性不一致 | 100 |
| レベル5、連鎖5.0、属性一致 | 2550 |

#### 移動侵略（空き地に移動）

```
score = 属性一致ボーナス（150）+ 連鎖数 × 50
```

| 条件 | スコア | 召喚(290)との比較 |
|------|--------|------------------|
| 属性一致 + 連鎖1 | 200 | 召喚優先 |
| 属性一致 + 連鎖2 | 250 | 召喚優先 |
| 属性一致 + 連鎖3 | 300 | 移動優先 |
| 属性一致 + 連鎖4 | 350 | 移動優先 |
| 属性一致 + 連鎖5 | 400 | 移動優先 |
| 属性不一致 | 0 | 召喚優先 |

#### レベルアップ

```
score = 手持ち魔力で上げられる分の合計コスト（動的計算）
```

**前提**: 土地とクリーチャーの属性が一致していること

**計算例（手持ち魔力: 400G、現在レベル1の場合）**:
1. 1→2: 90G（残り310G）→ OK
2. 2→3: 260G（残り50G）→ OK
3. 3→4: 620G → NG（魔力不足）
4. スコア = 90 + 260 = 350

| 手持ち魔力 | 現在レベル | 上げられるレベル | スコア |
|-----------|-----------|----------------|--------|
| 100G | 1 | 2 | 90 |
| 400G | 1 | 3 | 350 |
| 1000G | 1 | 4 | 970 |
| 2500G | 1 | 5 | 2170 |

※コストは`calculate_level_up_cost()`で動的計算。マップごとに異なる。

#### クリーチャー交換

```
rate_diff = 新クリーチャーのコスト - 現クリーチャーのコスト

element_bonus = 属性一致になる場合 ? 150 : 0
element_penalty = 属性不一致になる場合 ? -500 : 0

score = (rate_diff × 2) + element_bonus + element_penalty + (土地レベル × 20)
```

**クリーチャーレート**: 暫定でコスト（10〜100）を使用

| ケース | スコア | 召喚(290)との比較 |
|--------|--------|------------------|
| レート+90、属性一致になる、レベル5 | 430 | 交換優先 |
| レート+50、属性一致になる、レベル3 | 310 | 交換優先 |
| レート+50、属性変わらず、レベル3 | 160 | 召喚優先 |
| レート0、属性一致になる、レベル1 | 170 | 召喚優先 |
| レート-30、属性変わらず、レベル1 | -40 | 召喚優先 |
| レート+90、属性不一致になる、レベル5 | -220 | 絶対しない |

#### 属性変更

```
score = 基本点（100）+ 無属性ボーナス（100）- (コスト × 0.3)
```

**属性変更コスト**:
- 無属性タイル: 100 + ((レベル-1) × 100)
- 通常属性タイル: 300 + ((レベル-1) × 100)
- アーキミミックがいる: 50G固定

| 条件 | スコア | 召喚(290)との比較 |
|------|--------|------------------|
| 無属性レベル1 | 170 | 召喚優先 |
| 無属性レベル2 | 140 | 召喚優先 |
| 無属性レベル5 | 50 | 召喚優先 |
| 通常レベル1 | 10 | 召喚優先 |
| 通常レベル2 | -20 | 召喚優先 |
| 通常レベル5 | -110 | 召喚優先 |

**属性変更は常に召喚より低スコア = 優先度最低**

---

## 危機モード

### 発動条件

```
通行料支払い後の残り魔力 < 100G
```

敵の高レベル領地で高額通行料を払い、手持ち魔力が大幅に減る状況。

### 行動

**最大連鎖数の属性の土地を、持っている魔力で可能な最大レベルまでレベルアップする。**

取られた以上に将来の収入を確保する戦略。

### 処理フロー

```gdscript
func _evaluate_crisis_level_up(context: Dictionary) -> Dictionary:
	# 1. 最大連鎖数の属性を特定
	var best_chain_element = _get_best_chain_element(context)
	
	# 2. その属性の土地で属性一致しているものを取得
	var target_lands = _get_lands_by_element(context, best_chain_element)
	
	# 3. 残り魔力で可能な最大レベルを計算
	var remaining_magic = context.current_magic - context.toll
	
	for land in target_lands:
		if land.level < 5 and land.element_match and not land.is_downed:
			var max_affordable_level = _get_max_affordable_level(
				land.tile_index, 
				land.level, 
				remaining_magic
			)
			
			if max_affordable_level > land.level:
				return {
					"type": "level_up",
					"tile_index": land.tile_index,
					"target_level": max_affordable_level,
					"score": 9999  # 危機モードは最優先
				}
	
	return {}

func _get_max_affordable_level(tile_index: int, current_level: int, magic: int) -> int:
	var max_level = current_level
	
	for target_level in range(current_level + 1, 6):  # 現在+1 〜 5
		# 既存の動的計算を使用（マップごとのコスト差異に対応）
		var cost = board_system.tile_data_manager.calculate_level_up_cost(
			tile_index, target_level
		)
		if cost <= magic:
			max_level = target_level
		else:
			break
	
	return max_level
```

### スコア

危機モード時のレベルアップは **スコア9999（最優先）** とする。

通常の判断フローより優先して実行される。

---

## 個別コマンド詳細

### 移動侵略

#### 評価ポイント

| 要素 | スコア影響 |
|------|-----------|
| 奪える土地のレベル | 高いほど高スコア |
| 奪える土地の連鎖数 | 多いほど高スコア |
| 移動先の連鎖数が多い | 高スコア（同属性土地が隣接） |
| 移動先がクリーチャー属性と合う | 高スコア |

#### 移動パターン

1. **敵クリーチャーを倒して土地を奪う** - 最も利益が高い
2. **空き地に移動して属性を合わせる** - 属性変更より優先

#### アイテム使用

移動侵略でも通常の侵略と同様にアイテムを使用可能。
勝敗判定は`CPUBattleAI.evaluate_battle_with_item()`でアイテム込みで評価する。

- まずアイテムなしで勝てるか判定
- 勝てない場合、手札のアイテムを1つずつ試して評価
- いずれかで勝てれば移動侵略オプションに追加

#### 避けたい行動

- 隣に属性合う土地があるのに属性変更する（移動侵略で解決できる）

---

### レベルアップ

#### 前提条件（必須）

- **土地とクリーチャーの属性が合っていること**
- 属性不一致の土地はレベルアップ対象外

#### 評価ポイント

| 要素 | スコア影響 |
|------|-----------|
| 連鎖数 | 多いほど高スコア（1連鎖 << 5連鎖） |

#### 対象外

- 無属性土地 → 属性変更を先に行う
- 属性不一致土地 → レベルアップしない

---

### クリーチャー交換

#### 評価ポイント

| 要素 | スコア影響 |
|------|-----------|
| 高レートクリーチャーを配置できる | 高スコア |
| 交換で属性が合うようになる | 高スコア |
| 土地レベルが高い | 交換の価値が上がる |

#### クリーチャーレート（暫定）

現時点ではコストで代用:
```
レート = クリーチャーのコスト
```

将来的に専用のレート定義に置き換え予定。

#### 避けたい行動

- 高レートクリーチャーを属性不一致の土地に配置
- 交換で属性合わせられるのに属性変更する

---

### 属性変更

#### 基本方針

**優先度は最低。他の方法で解決できない場合のみ使用。**

#### 使用するケース

| ケース | 理由 |
|--------|------|
| 無属性土地をクリーチャー属性に合わせる | 変更コストが安い、レベルアップの前提 |
| 高レートクリーチャーがいて他の方法がない | 移動侵略・交換で解決できない場合 |

#### 避けたい行動

- 隣に属性合う空き地がある → 移動侵略を使う
- 手札に属性合うクリーチャーがいる → 交換を使う

---

## 共通ルール

### ダウン状態

| ルール | 説明 |
|--------|------|
| ダウン中クリーチャー | 領地コマンドの対象外（選択肢に入らない） |
| 領地コマンド使用後 | そのクリーチャーがダウン状態になる |
| 全クリーチャーダウン | 領地コマンド使用不可 → スキップ |

### 魔力チェック

各コマンドは魔力コストがかかる。支払えない場合は選択肢から除外。

### 魔力温存ルール

**レベルアップと属性変更**では、魔力を全て使い切らないよう制限を設ける。

```
使用可能魔力 = 手持ち魔力 - max(手持ち魔力 × 0.3, 100)
```

| ルール | 説明 |
|--------|------|
| 30%温存 | 手持ち魔力の30%は残す |
| 最低100G | 100G以下にならないようにする |
| 適用対象 | レベルアップ、属性変更 |
| 適用外 | 危機モード（全魔力を使用可能） |

**例:**
| 手持ち魔力 | 温存額 | 使用可能魔力 |
|-----------|--------|-------------|
| 1000G | 300G (30%) | 700G |
| 500G | 150G (30%) | 350G |
| 200G | 100G (最低保証) | 100G |
| 50G | 100G (最低保証) | 0G |

### 移動侵略の制約

移動元の土地には以下の制約がある：

| 制約 | 説明 |
|------|------|
| レベル2以上は移動不可 | 高レベル土地のクリーチャーは移動させない |
| 属性一致は移動不可 | 既に属性が合っている土地からは移動させない |

これにより、既に価値の高い土地を空けてしまうリスクを回避する。

### 召喚判定

| 条件 | 判定 |
|------|------|
| 属性一致クリーチャーあり | 必ず召喚（確率判定なし） |
| 属性不一致のみ | 確率で召喚、スキップ時は領地コマンド検討 |

---

## 将来の拡張

### 難易度による判断の変化

| 難易度 | 判断内容 |
|--------|---------|
| 低 | 基本ルールのみ（属性合えば召喚、など） |
| 中 | 利益スコア計算を使用 |
| 高 | 先読み（レベルアップ後の防衛力など）を考慮 |

### 手札6枚以上でも領地コマンドを選ぶケース

高難易度では以下を考慮:
- 移動侵略で高レベル敵地を奪える
- レベルアップで大きな連鎖ボーナスを得られる

---

## 実装詳細

### 使用する既存API

| 用途 | API |
|------|-----|
| 連鎖数取得 | `board_system.tile_data_manager.get_element_chain_count(tile_index, owner_id)` |
| 連鎖ボーナス取得 | `board_system.tile_data_manager.calculate_chain_bonus(tile_index, owner_id)` |
| 移動先取得 | `MovementHelper.get_move_destinations(board_system, creature_data, from_tile_index)` |
| レベルアップコスト | `board_system.tile_data_manager.calculate_level_up_cost(tile_index, target_level)` |
| 属性変更コスト | `board_system.calculate_terrain_change_cost(tile_index)` |
| 戦闘シミュレーション | `BattleSimulator.simulate_battle()` |
| 隣接タイル取得 | `board_system.tile_neighbor_system.get_spatial_neighbors(tile_index)` |

### 移動侵略の移動範囲

| 移動タイプ | 範囲 | 条件 |
|-----------|------|------|
| adjacent | 隣接タイルのみ | デフォルト |
| vacant_move | 指定属性の空き地 + 隣接 | 「空地移動」スキル持ち |
| enemy_move | 敵領地 + 隣接 | 「敵地移動」スキル持ち |
| remote_move | 全空き地 + 隣接 | 「遠隔移動」呪い |

移動タイプは`MovementHelper`が自動判定する。

### クリーチャー交換の召喚条件

手札クリーチャーに以下がある場合、条件を満たさないと交換不可:

- `cost_lands_required`: 特定属性の土地所有が必要
- `cost_cards_sacrifice`: カード生贄が必要

※スペルでの交換は別扱い（召喚条件不要の場合あり）

### クラス構成（予定）

```gdscript
class_name CPUTerritoryAI
extends RefCounted

var board_system
var card_system
var player_system
var battle_simulator: BattleSimulator

# メイン判断関数
func evaluate_all_options(context: Dictionary) -> Dictionary:
	var options = []
	
	# 危機モード判定
	if is_crisis_mode(context):
		return evaluate_crisis_level_up(context)
	
	# 各コマンドを評価
	options.append_array(_evaluate_invasion(context))       # 敵領地での戦闘
	options.append_array(_evaluate_move_invasion(context))  # 移動侵略
	options.append_array(_evaluate_level_up(context))       # レベルアップ
	options.append_array(_evaluate_creature_swap(context))  # クリーチャー交換
	options.append_array(_evaluate_element_change(context)) # 属性変更
	
	return _get_best_option(options)

# 危機モード判定
func is_crisis_mode(context: Dictionary) -> bool:
	var remaining = context.current_magic - context.toll
	return remaining < 100

# 各評価関数
func _evaluate_invasion(context: Dictionary) -> Array
func _evaluate_move_invasion(context: Dictionary) -> Array
func _evaluate_level_up(context: Dictionary) -> Array
func _evaluate_creature_swap(context: Dictionary) -> Array
func _evaluate_element_change(context: Dictionary) -> Array

# 危機モード用
func evaluate_crisis_level_up(context: Dictionary) -> Dictionary
```

---

## 実装状況

### ファイル構成

```
scripts/cpu_ai/
├── cpu_territory_ai.gd        # 領地コマンド判断メイン（新規作成）
├── cpu_ai_handler.gd          # オーケストレーター（territory_ai統合済み）
└── battle_simulator.gd        # 戦闘シミュレーション（既存）
```

### 実装状況

| 機能 | 状態 |
|------|------|
| 判断フロー | ✅ 実装済み |
| 侵略評価 | ✅ 実装済み |
| 移動侵略評価 | ✅ 実装済み |
| レベルアップ評価 | ✅ 実装済み |
| クリーチャー交換評価 | ✅ 実装済み |
| 属性変更評価 | ✅ 実装済み |
| 利益スコア比較 | ✅ 実装済み |
| 危機モード | ✅ 実装済み |

---

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2026/01/06 | 初版作成: 判断フロー、各コマンド詳細を定義 |
| 2026/01/06 | 利益スコア計算式を追加: 移動侵略、レベルアップ、クリーチャー交換、属性変更 |
| 2026/01/06 | 敵領地での判断を追加: 侵略スコア(×2)、危機モード |
| 2026/01/06 | 実装詳細を追加: 使用API、移動範囲、召喚条件、クラス構成 |
| 2026/01/07 | 実装完了: cpu_territory_ai.gd作成、cpu_ai_handler.gd統合 |
| 2026/01/07 | 魔力温存ルール追加: 30%または100Gは残す（レベルアップ・属性変更） |
| 2026/01/07 | 移動侵略の制約追加: レベル2以上・属性一致の土地からは移動不可 |
| 2026/01/07 | 召喚判定修正: 属性一致は必ず召喚、不一致は確率→領地コマンド検討 |
| 2026/01/07 | 移動侵略のアイテム対応: BattleAI経由でアイテム込みの勝敗判定 |
