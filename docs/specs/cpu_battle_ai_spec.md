# CPU バトル判断仕様書

## 概要

CPUのバトル時の判断ロジック。攻撃側・防御側それぞれで異なる判断基準を持つ。

**主要ファイル**:
- `cpu_battle_ai.gd` - バトル評価、アイテム選択
- `cpu_merge_evaluator.gd` - 合体判断
- `battle_simulator.gd` - バトル結果シミュレーション

---

## BattleSimulator

### シミュレーション結果

```gdscript
enum BattleResult {
	ATTACKER_WIN,      # 攻撃側勝利
	DEFENDER_WIN,      # 防御側勝利
	ATTACKER_SURVIVED, # 両者生存
	BOTH_DEFEATED      # 相打ち
}
```

### 考慮する要素

- HP/AP（基礎値 + base_up補正）
- 土地ボーナス（防御側のみ）
- スキル効果（先制、2回攻撃、強打、無効化、反射など）
- アイテム効果

---

## 攻撃側判断

### 判断フロー

```
1. 敵がアイテム破壊/盗みスキル持ち → アイテム使用不可
2. 合体で勝てる → 合体優先
3. 無効化+即死持ちで敵が無効化アイテム所持 → 無効化+即死を優先
4. 各クリーチャー×アイテムをシミュレーション
5. ATTACKER_WIN のみ攻撃実行
6. 勝てない → 即死スキル持ちで賭ける
7. 即死もない → 攻撃しない
```

### ワーストケース判定

敵の対抗手段（アイテム・援護）を考慮：

```
1. 両方アイテムなしで勝てない → 攻撃しない
2. 敵の全対抗手段をシミュレーション
3. ワーストケースでも勝てる → 攻撃（アイテム温存）
4. ワーストケースで負けるが自アイテムで勝てる → 攻撃（アイテム使用）
5. 自アイテムでも勝てない → 攻撃しない
```

---

## 防御側判断

### 判断フロー

```
1. 無効化スキルで勝てる → パス（アイテム温存）
2. 敵がアイテム破壊/盗み持ち → アイテム使用不可（援護のみ）
3. 合体で勝てる → 合体（最優先）
4. アイテムなしで勝利/両者生存 → パス
5. 勝てるアイテム/援護を探す
6. 防具枚数で優先順位決定
   - 2枚以下: 援護優先
   - 3枚以上: アイテム優先
```

### 温存対象

高レベル土地防衛用に取っておくアイテム/クリーチャー：
- 道連れ（instant_death + on_death）
- 死亡時ダメージ（damage_enemy + on_death）

**Lv2以上の土地でのみ使用**

---

## 合体判断

### 条件

1. 合体スキルを持っている
2. 手札に合体相手（partner_id）がいる
3. 合体相手のコストを支払える
4. 合体後のクリーチャーで勝てる/生き残れる

### 合体パターン例

| バトル側 | 合体相手 | 結果 |
|----------|----------|------|
| アンドロギア | ビーストギア | ギアリオン |
| グランギア | スカイギア | アンドロギア |

---

## 即死スキル判断

### 攻撃側

勝てる組み合わせがない場合、即死スキル持ちで賭ける。

```
1. 即死条件（属性、APチェック等）を満たすか確認
2. 確率が高いクリーチャーを優先
3. 敵が無効化アイテム持ち → 無効化+即死クリーチャーを優先
```

### 防御側

敵が100%即死スキル持ちの場合：

```
1. 通常攻撃100%無効化アイテムを探す
2. あれば使用
3. なければアイテムを使わない（即死されるため無駄）
```
