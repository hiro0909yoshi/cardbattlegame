# CPU バトル判断仕様書

## 概要

CPUプレイヤーのバトル時の判断ロジックについて記載する。
攻撃側・防御側それぞれで異なる判断基準を持ち、BattleSimulatorによるシミュレーションを活用して最適な行動を選択する。

## 関連ファイル

| ファイル | 役割 |
|---------|------|
| `scripts/cpu_ai/battle_simulator.gd` | バトル結果シミュレーター（305行） |
| `scripts/game_flow/item_phase_handler.gd` | 防御側アイテム・援護判断 |
| `scripts/tile_action_processor.gd` | 攻撃判断・バトル開始処理 |

---

## BattleSimulator

### 機能概要

バトル結果を事前にシミュレーションし、勝敗を予測する。
実際のバトル処理（BattlePreparation, BattleSkillProcessor）のロジックを簡易的に再現。

### シミュレーション結果

```gdscript
enum BattleResult {
    ATTACKER_WIN,      # 攻撃側勝利（侵略成功）
    DEFENDER_WIN,      # 防御側勝利（防衛成功）
    ATTACKER_SURVIVED, # 両者生存（攻撃側は土地を奪えない）
    BOTH_DEFEATED      # 相打ち
}
```

### 考慮する要素

#### 基本ステータス
- HP / AP（基礎値 + base_up補正）
- current_hp（ダメージを受けている場合）

#### 土地ボーナス
- 防御側のみ適用
- クリーチャー属性とタイル属性が一致 → HP + (10 × タイルレベル)

#### スキル効果（BattleSkillProcessor経由）
- **先制/後手**: 攻撃順序の変更
- **2回攻撃**: 攻撃回数2回
- **強打**: AP増加（巻物強打含む）
- **感応**: 同属性クリーチャー数に応じたHP/AP増加
- **応援**: 盤面の他クリーチャーからバフ
- **貫通**: 防御側の土地ボーナスHP無効化
- **巻物攻撃**: 土地ボーナス無視
- **無効化**: 条件を満たす相手の攻撃を無効化/軽減
- **反射**: ダメージの一部を反射 + 軽減
- **死亡時効果**: 道連れ・死亡時ダメージ

#### 特殊処理（ItemPhaseHandler経由）
- **援護**: 手札クリーチャーでAP/HP加算
- **合体**: 別クリーチャーに永続変化

#### アイテム効果（BattleItemApplier経由）
- **stat_bonus**: AP/HP増加
- **grant_first_strike**: 先制付与
- **grant_last_strike**: 後手付与
- **grant_double_attack**: 2回攻撃付与
- **reflect_damage**: 反射付与
- **nullify_attacker_special_attacks**: スクイドマントル（敵の特殊攻撃無効化）
- **random_stat_bonus**: ランダムステータス
- **element_mismatch_bonus**: 属性不一致ボーナス
- **fixed_stat**: ステータス固定（スフィアシールドのAP=0等）

#### 考慮していないスキル
- **即死**: 確率で相手を即死（確率計算が複雑なため未実装）

---

## 攻撃側CPU判断

### 判断フロー

```
1. 攻撃可能なクリーチャーを手札から収集
2. 防御側クリーチャー・タイル情報を取得
3. 各クリーチャー × 各アイテムの組み合わせでシミュレーション
4. ATTACKER_WIN となる組み合わせのみ候補
5. 最適な組み合わせを選択して攻撃
6. 勝てる組み合わせがなければ攻撃しない
```

### 勝利条件の厳格化

- `ATTACKER_WIN` のみ攻撃を実行
- `ATTACKER_SURVIVED`（両者生存）は攻撃しない
- `BOTH_DEFEATED`（相打ち）も攻撃しない

### アイテム種別優先度

```
巻物 > 武器 > アクセサリ > 防具
```

- 巻物: 攻撃時に最も効果的（即時効果が多い）
- 武器: AP増加で攻撃力向上
- アクセサリ: 汎用的な効果
- 防具: 攻撃時には温存

### 無効化スキル対応

攻撃側クリーチャーが無効化スキルを持つ場合：
- 防御側が無効化の範囲内なら、アイテムなしでも攻撃可能と判断
- シミュレーション結果で `is_nullified` フラグを確認

### シグナル

```gdscript
signal battle_decided(creature_index: int, item_index: int)
```

- `creature_index`: 攻撃に使用するクリーチャーの手札インデックス
- `item_index`: 使用するアイテムの手札インデックス（-1 = アイテムなし）

---

## 防御側CPU判断

### 判断フロー

```
1. 無効化スキルで勝てるか確認 → 勝てるならパス（アイテム温存）
2. アイテムなしでシミュレーション
   - 勝利/両者生存 → パス（アイテム温存）
3. 負ける場合、手札の防具枚数をカウント
4. 勝てるアイテム・援護を探す
5. 防具枚数に応じて優先順位を決定
   - 2枚以下: 援護優先（防具温存）
   - 3枚以上: アイテム優先
6. 最適なアイテム/援護を選択して使用
```

### 防具温存ロジック

防具はすべてのクリーチャーが使用可能な汎用リソースのため、手札に少ない場合は温存する。

| 防具枚数 | 優先順位 |
|---------|---------|
| 0〜2枚 | 援護 > 防具 > アクセサリ > 武器 |
| 3枚以上 | 防具 > アクセサリ > 武器 > 援護 |

### アイテム種別優先度（防御時）

```
防具 > アクセサリ > 武器
```

- 巻物は防御時使用しない
- 同種の場合はコストが低い方を優先

### 合体判断（最優先）

防御側クリーチャーが「合体」スキルを持ち、手札に合体相手がいる場合に発動可能。

```
1. 合体スキルを持っているか確認
2. 手札に合体相手（partner_id）がいるか確認
3. 合体相手のコストを支払えるか確認
4. 合体後のクリーチャー（result_id）でシミュレーション
5. 勝てる/生き残れる → 合体を選択（最優先）
```

**合体パターン:**

| バトル側 | 合体相手 | 結果 |
|----------|----------|------|
| アンドロギア | ビーストギア | ギアリオン |
| グランギア | スカイギア | アンドロギア |
| スカイギア | グランギア | アンドロギア |

**合体が最優先の理由:**
- 永続変化（戦闘後も元に戻らない）
- 強力なクリーチャーに変身できる
- 土地を守れる確率が高い

**ログ出力例:**
```
[CPU合体] 合体可能: グランギア + スカイギア → アンドロギア (コスト: 40G)
[CPU合体] シミュレーション結果: 防御側勝利
[CPU防御] 合体で勝利可能 → 合体を選択: アンドロギア
```

### 攻撃側合体判断

攻撃側CPUも合体を最優先で使用する。

```
1. 手札のクリーチャーに合体スキルを持つものがあるか確認
2. 手札に合体相手（partner_id）がいるか確認
3. クリーチャーコスト + 合体相手のコストを支払えるか確認
4. 合体後のクリーチャー（result_id）でシミュレーション
5. 勝てる/生き残れる → 合体を選択（最優先）
```

**勝利だけでなく生存も対象:**
- ATTACKER_WIN: 勝利 → 優先度最高
- ATTACKER_SURVIVED: 両者生存 → 勝利より低いが通常バトルより優先

**ログ出力例:**
```
[CPU合体] 合体可能: グランギア + スカイギア → アンドロギア (コスト: 80G)
[CPU合体] シミュレーション結果: 攻撃側勝利
[CPU AI] 合体で勝利/生存可能 → 合体を選択: アンドロギア
[TileActionProcessor] CPU攻撃側合体実行: グランギア → アンドロギア
[CPU合体] 魔力消費: 40G
[CPU合体] スカイギア を捨て札へ
[CPU合体] 完了: アンドロギア (HP:60 AP:60)
```

### 援護判断

防御側クリーチャーが「援護」スキルを持つ場合のみ有効。

```
1. 援護スキルを持っているか確認
2. 手札から援護対象属性のクリーチャーを収集
3. 各候補でシミュレーション（AP/HPを加算した状態）
4. 勝てる/生き残れるなら援護を使用
```

- 援護対象属性は `ability_parsed.keyword_conditions.援護.target_elements` で判定
- コストが低いクリーチャーを優先

### 無効化スキル対応（防御時）

防御側クリーチャーが無効化スキルを持ち、攻撃側が無効化の範囲内の場合：
- アイテム・援護を使用せずパス
- 無効化で勝てるためリソース温存

### 反射対応

スパイクシールド等の反射アイテムもシミュレーションで考慮される。
- 反射ダメージによる攻撃側撃破を正しく計算
- 自身への軽減効果（self_damage_ratio）も反映

### ダメージ軽減（無効化[1/2]）対応

ガスクラウド等の「無効化[1/2]」は完全無効化ではなく、ダメージ50%軽減として処理される。

**判定ロジック:**
- `reduction_rate == 0.0` → 完全無効化（アイテム温存）
- `reduction_rate > 0` → ダメージ軽減（シミュレーションで計算）

**ログ出力例:**
```
[CPU無効化判定] ガスクラウド のダメージ軽減(50%)が スピットコブラ に対して有効 → シミュレーションで判断
防御側ダメージ軽減: 50%
```

**対象クリーチャー:**
| 名前 | 効果 | reduction_rate |
|-----|------|---------------|
| ガスクラウド | 無効化[1/2] | 0.5 |

### 攻撃側クリーチャーの死亡時効果対応

攻撃側クリーチャーが死亡時ダメージを持つ場合（サルファバルーン等）、防御側の残りHPと比較して相打ちになるかをシミュレーションする。

**対象となる効果:**
- `effect_type: "damage_enemy"` + `trigger: "on_death"`
- 例: サルファバルーン（死亡時敵HP-40）

**判定フロー:**
```
1. 通常バトル計算または無効化判定で DEFENDER_WIN
2. 攻撃側クリーチャーに死亡時ダメージ効果があるか確認
3. 防御側の残りHPを推定
4. 死亡時ダメージを適用
5. 残りHP <= 0 なら BOTH_DEFEATED に変更
```

**無効化成功時も考慮:**
無効化で攻撃を防いでも、防御側が攻撃側を倒すため死亡時効果は発動する。
例: マグマシールドでサルファバルーンの攻撃を無効化しても、サルファバルーン撃破時にHP-40が発動。

**ログ出力例:**
```
--- 死亡時効果判定 ---
攻撃側死亡時ダメージ: 40
防御側推定残りHP: 30
  → 死亡時効果で防御側も撃破！相打ちに変更
```

**注意:**
- アイテム（バーニングハート等）の死亡時効果は、攻撃側が使用しているかわからないため考慮しない
- クリーチャー自体の能力のみ考慮（`opponent_creature_data` で見える情報）

### 温存対象アイテム・クリーチャー

高レベル土地防衛用に取っておきたいアイテム・クリーチャーは「温存対象」として扱い、**レベル2以上の土地でのみ使用**する。

#### 自動検出される温存対象

以下の効果を持つアイテム・クリーチャーは自動的に温存対象として検出される：

| 効果タイプ | トリガー | 例 |
|-----------|---------|-----|
| `instant_death` | `on_death` | バーニングハート（道連れ） |
| `damage_enemy` | `on_death` | サルファバルーン（死亡時ダメージ40） |

**除外対象:**

| 効果タイプ | トリガー | 例 | 除外理由 |
|-----------|---------|-----|---------|
| `self_destruct_with_revenge` | `on_hp_threshold` | リビングボム | HP閾値トリガーはシミュレーション複雑 |

#### 判定関数

```gdscript
## アイテムの温存判定
func _is_reserve_item(item: Dictionary) -> bool:
    var effects = item.get("effect_parsed", {}).get("effects", [])
    for effect in effects:
        if effect.get("trigger") == "on_death":
            if effect.get("effect_type") in ["instant_death", "damage_enemy"]:
                return true
    return false

## クリーチャーの温存判定（援護用）
func _is_reserve_creature(creature: Dictionary) -> bool:
    var effects = creature.get("ability_parsed", {}).get("effects", [])
    for effect in effects:
        if effect.get("trigger") == "on_death":
            if effect.get("effect_type") in ["instant_death", "damage_enemy", "self_destruct_with_revenge"]:
                return true
    return false
```

#### 使用判断フロー

```
1. 通常アイテム・援護で勝てるか確認
   - 勝てる → 通常を使用
2. 通常で勝てない場合
   - タイルレベル1 → 温存対象を使わずパス
   - タイルレベル2以上 → 温存対象を使用
```

#### ログ出力例

```
[CPU防御] 勝てるアイテム: 通常0, 温存1 / 援護: 通常0, 温存1
  [アイテムシミュ] バーニングハート[アクセサリ] [温存]: 防御側勝利
  [援護シミュ] サルファバルーン[fire] [温存]: 防御側勝利
[CPU防御] 温存対象あるがLv1土地なので使用せず → パス
```

```
[CPU防御] 温存アイテム使用（Lv3土地防衛）: バーニングハート
```

---

## ログ出力

### 攻撃側ログ例

```
=== シミュレーション開始 ===
攻撃側: ゴブリン (基礎AP:20, 基礎HP:20)
防御側: スライム (基礎AP:10, 基礎HP:30)
--- 基礎ステータス ---
攻撃側: base_up_hp=0, base_up_ap=0
防御側: 土地ボーナス=20 (fire Lv2)
--- スキル処理 ---
【強打適用後】ゴブリン AP:25
=== 最終ステータス ===
攻撃側: AP=25, HP=20, 攻撃回数=1
防御側: AP=10, HP=50, 攻撃回数=1
攻撃順序: attacker_first
★★★ 勝敗判定 ★★★
  → 【勝利】侵略成功！攻撃側の勝ち
```

### 防御側ログ例

```
[CPU防御] アイテム判断開始: スライム vs ゴブリン
[CPU防御] タイル情報: fire Lv2
[CPU防御] アイテムなし結果: 攻撃側勝利
[CPU防御] 手札の防具枚数: 1
  [アイテムシミュ] アイアンシールド[防具]: 攻撃側勝利
  [援護シミュ] スライム[water]: 防御側勝利
[CPU防御] 勝てるアイテム数: 0, 勝てる援護数: 1
[CPU防御] 援護優先選択（防具温存）: スライム
```

---

## 今後の拡張予定

### 未実装項目

1. **クリーチャー装備制限チェック**
   - `restrictions.cannot_use` の考慮
   - 例: アクセサリ使用不可クリーチャー

2. **即死スキル対応**
   - 確率付き即死（60%〜100%）の期待値計算
   - バタリングラム（即死[防御型・100%]）は条件を満たせば確定勝利として実装可能
   - 確率付き即死は複雑なため後回し

3. **巻物の防御時使用**
   - 現在は巻物は防御時使用しない
   - 特定条件での使用判断

4. **on_attack_success系効果の戦略的判断**

   **攻撃側（未実装）:**
   - 現在は「ATTACKER_WIN」のみ攻撃判断としている
   - 以下の効果は「両者生存」でも戦略的価値がある

   | 効果 | 戦略的価値 | 判断基準 |
   |-----|-----------|---------|
   | APドレイン | 相手APを0に弱体化 | 先制取れる + 攻撃成功 → 次ターンで他クリーチャーが勝てる |
   | 強制変化 | 相手を自分と同じに | 高レベル土地の強敵を弱体化 |
   
   **使用例（APドレイン）:**
   ```
   1. 勝てるクリーチャーがいない
   2. APドレイン持ち（サキュバスリング等）で侵略
   3. 先制で攻撃成功 → 相手AP=0
   4. 両者生存だが相手は弱体化
   5. 次ターンで別クリーチャーが勝てる
   ```

   **防御側対応方針（未実装）:**
   
   | 相手の効果 | 条件 | 対応 |
   |-----------|------|------|
   | APドレイン | 先制を取られる | 武器を使わない（APが0にされるから無意味） |
   | 強制変化 | 先制を取られる | 無効化できる防具を使用、それ以外は通常判断 |

---

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2025-12-30 | 初版作成 |
| 2025-12-30 | 防御側アイテム・援護判断実装 |
| 2025-12-30 | 防具温存ロジック追加 |
| 2025-12-30 | 無効化・反射対応 |
| 2025-12-30 | 温存対象アイテム・クリーチャー実装（道連れ、死亡時ダメージ等） |
| 2025-12-30 | 攻撃側クリーチャーの死亡時効果対応（サルファバルーン等） |
| 2025-12-30 | 防御側合体判断実装（最優先で合体を選択） |
| 2025-12-30 | 攻撃側合体判断実装（勝利/生存時に最優先） |
| 2025-12-30 | ダメージ軽減（無効化[1/2]）対応 |
| 2025-12-30 | 考慮するスキル一覧を正確に更新（応援・貫通・巻物攻撃含む） |
