# CPU バトル判断仕様書

## 概要

CPUプレイヤーのバトル時の判断ロジックについて記載する。
攻撃側・防御側それぞれで異なる判断基準を持ち、BattleSimulatorによるシミュレーションを活用して最適な行動を選択する。

## ファイル構成

### CPU AIコアファイル（scripts/cpu_ai/）

| ファイル | 役割 | 行数 |
|---------|------|------|
| `cpu_battle_ai.gd` | バトル評価、アイテム選択、ワーストケース判定 | 838 |
| `cpu_merge_evaluator.gd` | 合体判断、合体シミュレーション | 181 |
| `battle_simulator.gd` | バトル結果シミュレーター | 556 |
| `cpu_hand_utils.gd` | 手札アクセスユーティリティ | 308 |
| `cpu_ai_handler.gd` | CPU判断のエントリーポイント | 277 |
| `cpu_turn_processor.gd` | CPUターン処理フロー制御 | 492 |

### 関連ファイル

| ファイル | 役割 |
|---------|------|
| `scripts/game_flow/item_phase_handler.gd` | 防御側アイテム・援護判断 |
| `scripts/tile_action_processor.gd` | 攻撃判断・バトル開始処理 |

### ファイル責務

**cpu_battle_ai.gd**
- `evaluate_all_combinations_for_battle()` - クリーチャー×アイテムの全組み合わせ評価
- `simulate_worst_case()` - 敵の対抗手段を考慮したワーストケース判定
- `find_item_to_beat_worst_case()` - ワーストケースに勝つアイテム探索
- 即死ギャンブル判断
- 無効化+即死優先判断

**cpu_merge_evaluator.gd**
- `check_merge_option_for_attack()` - 攻撃側合体判断
- `check_merge_option_for_defense()` - 防御側合体判断
- `simulate_attack_with_merge()` - 合体後シミュレーション

**battle_simulator.gd**
- `simulate_battle()` - バトル結果シミュレーション
- スキル効果・アイテム効果・土地ボーナス計算
- 先制/後手/2回攻撃/反射等の処理

**cpu_hand_utils.gd**
- 手札からクリーチャー/アイテム抽出
- コスト計算
- 敵手札参照（密命カード除外）
- アイテム破壊/盗みスキル検出

---

## BattleSimulator

### 機能概要

バトル結果を事前にシミュレーションし、勝敗を予測する。
実際のバトル処理（BattlePreparation, BattleSkillProcessor）のロジックを簡易的に再現。

### シミュレーション結果

```gdscript
enum BattleResult {
	ATTACKER_WIN,      # 攻撃側勝利（侵略成功）
	DEFENDER_WIN,      # 防御側勝利（防衛成功）
	ATTACKER_SURVIVED, # 両者生存（攻撃側は土地を奪えない）
	BOTH_DEFEATED      # 相打ち
}
```

### 考慮する要素

#### 基本ステータス
- HP / AP（基礎値 + base_up補正）
- current_hp（ダメージを受けている場合）

#### 土地ボーナス
- 防御側のみ適用
- クリーチャー属性とタイル属性が一致 → HP + (10 × タイルレベル)

#### スキル効果（BattleSkillProcessor経由）
- **先制/後手**: 攻撃順序の変更
- **2回攻撃**: 攻撃回数2回
- **強打**: AP増加（巻物強打含む）
- **感応**: 同属性クリーチャー数に応じたHP/AP増加
- **応援**: 盤面の他クリーチャーからバフ
- **貫通**: 防御側の土地ボーナスHP無効化
- **巻物攻撃**: 土地ボーナス無視
- **無効化**: 条件を満たす相手の攻撃を無効化/軽減
- **反射**: ダメージの一部を反射 + 軽減
- **死亡時効果**: 道連れ・死亡時ダメージ

#### 特殊処理（ItemPhaseHandler経由）
- **援護**: 手札クリーチャーでAP/HP加算
- **合体**: 別クリーチャーに永続変化

#### アイテム効果（BattleItemApplier経由）
- **stat_bonus**: AP/HP増加
- **grant_first_strike**: 先制付与
- **grant_last_strike**: 後手付与
- **grant_double_attack**: 2回攻撃付与
- **reflect_damage**: 反射付与
- **nullify_attacker_special_attacks**: スクイドマントル（敵の特殊攻撃無効化）
- **random_stat_bonus**: ランダムステータス
- **element_mismatch_bonus**: 属性不一致ボーナス
- **fixed_stat**: ステータス固定（スフィアシールドのAP=0等）

#### 考慮していないスキル
- **即死**: 確率で相手を即死（確率計算が複雑なため未実装）

#### アイテム破壊・盗み対策 ✅ 実装済み

敵がアイテム破壊・盗みスキルを持つ場合、CPUはアイテム使用を控える。

**攻撃側の場合:**
- 防御側クリーチャーがアイテム破壊/盗みスキルを持つ場合
- アイテムを使わずにクリーチャーのみで勝てる組み合わせを探す
- アイテムなしで勝てない場合は攻撃を見送り

**防御側の場合:**
- 攻撃側クリーチャーがアイテム破壊/盗みスキルを持つ場合
- アイテム使用を控え、援護のみで対応を試みる

**対象スキル:**
| スキル | effect_type | 説明 |
|--------|-------------|------|
| アイテム破壊 | `destroy_item` | 敵のアイテムを破壊（target_typesで対象種別指定） |
| アイテム盗み | `steal_item` | 敵のアイテムを奪う |

**ログ出力例:**
```
[CPU AI] 警告: 敵がアイテム破壊スキルを所持 (対象: ["道具"])
[CPU AI] → アイテム使用を控えます
```

---

## 攻撃側CPU判断

### 判断フロー

```
1. 攻撃可能なクリーチャーを手札から収集
2. 防御側クリーチャー・タイル情報を取得
3. 敵がアイテム破壊・盗みを持つかチェック → 持つ場合はアイテム使用不可
4. 各クリーチャー × 各アイテムの組み合わせでシミュレーション
5. ATTACKER_WIN となる組み合わせのみ候補
6. 最適な組み合わせを選択して攻撃
7. 勝てる組み合わせがなければ攻撃しない
```

### 勝利条件の厳格化

- `ATTACKER_WIN` のみ攻撃を実行
- `ATTACKER_SURVIVED`（両者生存）は攻撃しない
- `BOTH_DEFEATED`（相打ち）も攻撃しない

### アイテム種別優先度

```
巻物 > 武器 > アクセサリ > 防具
```

- 巻物: 攻撃時に最も効果的（即時効果が多い）
- 武器: AP増加で攻撃力向上
- アクセサリ: 汎用的な効果
- 防具: 攻撃時には温存

### 無効化スキル対応

攻撃側クリーチャーが無効化スキルを持つ場合：
- 防御側が無効化の範囲内なら、アイテムなしでも攻撃可能と判断
- シミュレーション結果で `is_nullified` フラグを確認

### シグナル

```gdscript
signal battle_decided(creature_index: int, item_index: int)
```

- `creature_index`: 攻撃に使用するクリーチャーの手札インデックス
- `item_index`: 使用するアイテムの手札インデックス（-1 = アイテムなし）

---

## 防御側CPU判断

### 判断フロー

```
1. 無効化スキルで勝てるか確認 → 勝てるならパス（アイテム温存）
2. 敵がアイテム破壊・盗みを持つかチェック → 持つ場合はアイテム使用不可（援護のみ）
3. アイテムなしでシミュレーション
   - 勝利/両者生存 → パス（アイテム温存）
4. 負ける場合、手札の防具枚数をカウント
5. 勝てるアイテム・援護を探す（敵がアイテム破壊/盗みを持つ場合は援護のみ）
6. 防具枚数に応じて優先順位を決定
   - 2枚以下: 援護優先（防具温存）
   - 3枚以上: アイテム優先
7. 最適なアイテム/援護を選択して使用
```

### 防具温存ロジック

防具はすべてのクリーチャーが使用可能な汎用リソースのため、手札に少ない場合は温存する。

| 防具枚数 | 優先順位 |
|---------|---------|
| 0〜2枚 | 援護 > 防具 > アクセサリ > 武器 |
| 3枚以上 | 防具 > アクセサリ > 武器 > 援護 |

### アイテム種別優先度（防御時）

```
防具 > アクセサリ > 武器
```

- 巻物は防御時使用しない
- 同種の場合はコストが低い方を優先

### 合体判断（最優先）

防御側クリーチャーが「合体」スキルを持ち、手札に合体相手がいる場合に発動可能。

```
1. 合体スキルを持っているか確認
2. 手札に合体相手（partner_id）がいるか確認
3. 合体相手のコストを支払えるか確認
4. 合体後のクリーチャー（result_id）でシミュレーション
5. 勝てる/生き残れる → 合体を選択（最優先）
```

**合体パターン:**

| バトル側 | 合体相手 | 結果 |
|----------|----------|------|
| アンドロギア | ビーストギア | ギアリオン |
| グランギア | スカイギア | アンドロギア |
| スカイギア | グランギア | アンドロギア |

**合体が最優先の理由:**
- 永続変化（戦闘後も元に戻らない）
- 強力なクリーチャーに変身できる
- 土地を守れる確率が高い

**ログ出力例:**
```
[CPU合体] 合体可能: グランギア + スカイギア → アンドロギア (コスト: 40G)
[CPU合体] シミュレーション結果: 防御側勝利
[CPU防御] 合体で勝利可能 → 合体を選択: アンドロギア
```

### 攻撃側合体判断

攻撃側CPUも合体を最優先で使用する。

```
1. 手札のクリーチャーに合体スキルを持つものがあるか確認
2. 手札に合体相手（partner_id）がいるか確認
3. クリーチャーコスト + 合体相手のコストを支払えるか確認
4. 合体後のクリーチャー（result_id）でシミュレーション
5. 勝てる/生き残れる → 合体を選択（最優先）
```

**勝利だけでなく生存も対象:**
- ATTACKER_WIN: 勝利 → 優先度最高
- ATTACKER_SURVIVED: 両者生存 → 勝利より低いが通常バトルより優先

**ログ出力例:**
```
[CPU合体] 合体可能: グランギア + スカイギア → アンドロギア (コスト: 80G)
[CPU合体] シミュレーション結果: 攻撃側勝利
[CPU AI] 合体で勝利/生存可能 → 合体を選択: アンドロギア
[TileActionProcessor] CPU攻撃側合体実行: グランギア → アンドロギア
[CPU合体] 魔力消費: 40G
[CPU合体] スカイギア を捨て札へ
[CPU合体] 完了: アンドロギア (HP:60 AP:60)
```

### 援護判断

防御側クリーチャーが「援護」スキルを持つ場合のみ有効。

```
1. 援護スキルを持っているか確認
2. 手札から援護対象属性のクリーチャーを収集
3. 各候補でシミュレーション（AP/HPを加算した状態）
4. 勝てる/生き残れるなら援護を使用
```

- 援護対象属性は `ability_parsed.keyword_conditions.援護.target_elements` で判定
- コストが低いクリーチャーを優先

### 無効化スキル対応（防御時）

防御側クリーチャーが無効化スキルを持ち、攻撃側が無効化の範囲内の場合：
- アイテム・援護を使用せずパス
- 無効化で勝てるためリソース温存

### 反射対応

スパイクシールド等の反射アイテムもシミュレーションで考慮される。
- 反射ダメージによる攻撃側撃破を正しく計算
- 自身への軽減効果（self_damage_ratio）も反映

### ダメージ軽減（無効化[1/2]）対応

ガスクラウド等の「無効化[1/2]」は完全無効化ではなく、ダメージ50%軽減として処理される。

**判定ロジック:**
- `reduction_rate == 0.0` → 完全無効化（アイテム温存）
- `reduction_rate > 0` → ダメージ軽減（シミュレーションで計算）

**ログ出力例:**
```
[CPU無効化判定] ガスクラウド のダメージ軽減(50%)が スピットコブラ に対して有効 → シミュレーションで判断
防御側ダメージ軽減: 50%
```

**対象クリーチャー:**
| 名前 | 効果 | reduction_rate |
|-----|------|---------------|
| ガスクラウド | 無効化[1/2] | 0.5 |

### 攻撃側クリーチャーの死亡時効果対応

攻撃側クリーチャーが死亡時ダメージを持つ場合（サルファバルーン等）、防御側の残りHPと比較して相打ちになるかをシミュレーションする。

**対象となる効果:**
- `effect_type: "damage_enemy"` + `trigger: "on_death"`
- 例: サルファバルーン（死亡時敵HP-40）

**判定フロー:**
```
1. 通常バトル計算または無効化判定で DEFENDER_WIN
2. 攻撃側クリーチャーに死亡時ダメージ効果があるか確認
3. 防御側の残りHPを推定
4. 死亡時ダメージを適用
5. 残りHP <= 0 なら BOTH_DEFEATED に変更
```

**無効化成功時も考慮:**
無効化で攻撃を防いでも、防御側が攻撃側を倒すため死亡時効果は発動する。
例: マグマシールドでサルファバルーンの攻撃を無効化しても、サルファバルーン撃破時にHP-40が発動。

**ログ出力例:**
```
--- 死亡時効果判定 ---
攻撃側死亡時ダメージ: 40
防御側推定残りHP: 30
  → 死亡時効果で防御側も撃破！相打ちに変更
```

**注意:**
- アイテム（バーニングハート等）の死亡時効果は、攻撃側が使用しているかわからないため考慮しない
- クリーチャー自体の能力のみ考慮（`opponent_creature_data` で見える情報）

### 温存対象アイテム・クリーチャー

高レベル土地防衛用に取っておきたいアイテム・クリーチャーは「温存対象」として扱い、**レベル2以上の土地でのみ使用**する。

#### 自動検出される温存対象

以下の効果を持つアイテム・クリーチャーは自動的に温存対象として検出される：

| 効果タイプ | トリガー | 例 |
|-----------|---------|-----|
| `instant_death` | `on_death` | バーニングハート（道連れ） |
| `damage_enemy` | `on_death` | サルファバルーン（死亡時ダメージ40） |

**除外対象:**

| 効果タイプ | トリガー | 例 | 除外理由 |
|-----------|---------|-----|---------|
| `self_destruct_with_revenge` | `on_hp_threshold` | リビングボム | HP閾値トリガーはシミュレーション複雑 |

#### 判定関数

```gdscript
## アイテムの温存判定
func _is_reserve_item(item: Dictionary) -> bool:
	var effects = item.get("effect_parsed", {}).get("effects", [])
	for effect in effects:
		if effect.get("trigger") == "on_death":
			if effect.get("effect_type") in ["instant_death", "damage_enemy"]:
				return true
	return false

## クリーチャーの温存判定（援護用）
func _is_reserve_creature(creature: Dictionary) -> bool:
	var effects = creature.get("ability_parsed", {}).get("effects", [])
	for effect in effects:
		if effect.get("trigger") == "on_death":
			if effect.get("effect_type") in ["instant_death", "damage_enemy", "self_destruct_with_revenge"]:
				return true
	return false
```

#### 使用判断フロー

```
1. 通常アイテム・援護で勝てるか確認
   - 勝てる → 通常を使用
2. 通常で勝てない場合
   - タイルレベル1 → 温存対象を使わずパス
   - タイルレベル2以上 → 温存対象を使用
```

#### ログ出力例

```
[CPU防御] 勝てるアイテム: 通常0, 温存1 / 援護: 通常0, 温存1
  [アイテムシミュ] バーニングハート[アクセサリ] [温存]: 防御側勝利
  [援護シミュ] サルファバルーン[fire] [温存]: 防御側勝利
[CPU防御] 温存対象あるがLv1土地なので使用せず → パス
```

```
[CPU防御] 温存アイテム使用（Lv3土地防衛）: バーニングハート
```

---

## ログ出力

### 攻撃側ログ例

```
=== シミュレーション開始 ===
攻撃側: ゴブリン (基礎AP:20, 基礎HP:20)
防御側: スライム (基礎AP:10, 基礎HP:30)
--- 基礎ステータス ---
攻撃側: base_up_hp=0, base_up_ap=0
防御側: 土地ボーナス=20 (fire Lv2)
--- スキル処理 ---
【強打適用後】ゴブリン AP:25
=== 最終ステータス ===
攻撃側: AP=25, HP=20, 攻撃回数=1
防御側: AP=10, HP=50, 攻撃回数=1
攻撃順序: attacker_first
★★★ 勝敗判定 ★★★
  → 【勝利】侵略成功！攻撃側の勝ち
```

### 防御側ログ例

```
[CPU防御] アイテム判断開始: スライム vs ゴブリン
[CPU防御] タイル情報: fire Lv2
[CPU防御] アイテムなし結果: 攻撃側勝利
[CPU防御] 手札の防具枚数: 1
  [アイテムシミュ] アイアンシールド[防具]: 攻撃側勝利
  [援護シミュ] スライム[water]: 防御側勝利
[CPU防御] 勝てるアイテム数: 0, 勝てる援護数: 1
[CPU防御] 援護優先選択（防具温存）: スライム
```

---

## 敵の対抗手段を考慮したシミュレーション（ワーストケース想定）

### 概要

CPUが攻撃を仕掛ける際、敵（防御側）が使用可能な対抗手段（アイテム・援護）を考慮して判断する。
「両方がアイテム/援護を使わない状態で勝てる」ことが攻撃の最低条件。

### 敵の対抗手段

#### 1. 敵のアイテム
- 敵の手札にあるアイテムをすべてチェック
- 各アイテムを防御側が使用した場合のシミュレーションを実行
- 最悪ケース（最も勝ちにくいアイテム）を特定

#### 2. 敵の援護
- 防御側クリーチャーが「援護」スキルを持っているかチェック
- 敵の手札に援護対象属性のクリーチャーがいるかチェック
- 援護を使用した場合のシミュレーションを実行
- 援護クリーチャーのAP/HPが防御側に加算される

### 攻撃判断フロー（ワーストケース対応版）

```
1. 両方アイテムなしでシミュレーション
   → 勝てない場合 → 即死ギャンブル or 攻撃しない

2. 両方アイテムなしで勝てる場合
   → 敵の対抗手段（アイテム・援護）をすべて列挙
   
3. ワーストケースシミュレーション
   → 敵の各アイテム使用時のシミュレーション
   → 敵の援護使用時のシミュレーション
   → 最も勝ちにくいケースを特定

4. ワーストケースでの判断
   A) ワーストケースでも勝てる → 攻撃（アイテムなし）
   B) ワーストケースで負けるが、自分もアイテムを使えば勝てる → 攻撃（アイテム使用）
   C) ワーストケースで負け、自分がアイテムを使っても勝てない → 性格に応じて判断
```

### CPU性格パラメータ（将来実装）

ワーストケースで負ける場合の判断を性格で調整可能にする。

| パラメータ | 説明 | デフォルト値 |
|-----------|------|-------------|
| `risk_tolerance` | リスク許容度（0.0〜1.0） | 0.0（リスク回避） |
| `defense_item_rate` | 防御時アイテム使用確率 | 1.0（必ず使用） |

**risk_tolerance の影響:**
- 0.0: ワーストケースで負ける場合は攻撃しない
- 0.5: 50%の確率で攻撃する
- 1.0: ワーストケースでも常に攻撃する

**設定例（将来のJSON）:**
```json
{
  "character_id": "aggressive_cpu",
  "battle_profile": {
	"risk_tolerance": 0.7,
	"defense_item_rate": 0.9
  }
}
```

### 防御時の敵アイテム想定

防御側CPUも、攻撃側がアイテムを使う想定でシミュレーションする。

```
1. アイテムなしでシミュレーション
   → 勝てる場合 → パス（アイテム温存）

2. アイテムなしで負ける場合
   → 攻撃側の手札アイテムをチェック
   → 攻撃側が最強アイテムを使った場合のシミュレーション
   
3. 攻撃側ワーストケースでの判断
   → アイテム/援護を使っても負ける場合 → パス（無駄遣い防止）
   → アイテム/援護を使えば勝てる場合 → 使用
```

### 適用箇所

1. **CPU侵略判断**（cpu_battle_ai.gd）
   - `evaluate_all_combinations_for_battle()` でワーストケース判定

2. **スペル移動判断**（cpu_spell_condition_checker.gd, cpu_spell_ai.gd）
   - `move_invasion_win` 条件でワーストケース判定
   - アウトレイジ、チャリオット等の移動侵略スペル

3. **防御時アイテム選択**（item_phase_handler.gd）
   - `_decide_cpu_item_usage()` で攻撃側アイテム想定

### ログ出力例

```
[CPU攻撃] ワーストケース分析開始
[CPU攻撃] 敵の対抗手段:
  - アイテム: アイアンシールド (HP+30), スパイクシールド (反射)
  - 援護: ゴブリン (AP+20, HP+20)
[CPU攻撃] ワーストケース: スパイクシールド使用時 → 防御側勝利
[CPU攻撃] 自アイテム使用で逆転可能: ファイアソード使用時 → 攻撃側勝利
[CPU攻撃] 判断: 攻撃実行（ファイアソード使用）
```

```
[CPU防御] 攻撃側ワーストケース分析
[CPU防御] 攻撃側アイテム: ファイアソード (AP+30)
[CPU防御] ワーストケース: ファイアソード使用時 → 攻撃側勝利
[CPU防御] 対抗: スパイクシールド使用時 → 防御側勝利
[CPU防御] 判断: スパイクシールド使用
```

---

## 今後の拡張予定

### 未実装項目

0. **敵の対抗手段を考慮したシミュレーション** 🔜 次に実装
   - 攻撃側：敵のアイテム・援護を考慮したワーストケース判定
   - 防御側：攻撃側のアイテムを考慮したシミュレーション
   - CPU性格パラメータ（将来拡張用の設計）

1. **クリーチャー装備制限チェック**
   - `restrictions.cannot_use` の考慮
   - 例: アクセサリ使用不可クリーチャー

2. **即死スキル対応** ✅ 完全実装
   - 勝てる組み合わせがない場合、即死スキル持ちで賭ける判断を実装
   - 即死条件（属性、APチェック等）を満たすクリーチャーを検出
   - 最も確率が高いクリーチャーを優先選択
   - 期待値計算ではなく「最後の手段」として扱う
   - 敵の手札参照機能実装（密命カード除外）
   - 無効化+即死クリーチャーの優先判断実装
   
   **攻撃側判断フロー:**
   ```
   1. 合体判断（最優先）
   2. 敵が無効化アイテムを持っている場合
	  → 無効化+即死クリーチャー（イエティ、シグルド、ダンピール、セイント）を優先使用
	  → アイテムなしで、敵に無効化アイテムを消費させつつ即死チャンス
   3. 通常の勝利判定
   4. 勝てない場合 → 即死スキル持ちで賭ける
   ```
   
   **防御側判断フロー:**
   ```
   1. 無効化スキルで勝てる → アイテム温存
   2. 合体で勝てる → 合体
   3. 敵が即死スキル持ち → 無効化アイテム優先使用
   4. 通常のシミュレーション判断（防具/援護）
   ```

3. **巻物の防御時使用**
   - 現在は巻物は防御時使用しない
   - 特定条件での使用判断

4. **on_attack_success系効果の戦略的判断**

   **攻撃側（未実装）:**
   - 現在は「ATTACKER_WIN」のみ攻撃判断としている
   - 以下の効果は「両者生存」でも戦略的価値がある

   | 効果 | 戦略的価値 | 判断基準 |
   |-----|-----------|---------|
   | APドレイン | 相手APを0に弱体化 | 先制取れる + 攻撃成功 → 次ターンで他クリーチャーが勝てる |
   | 強制変化 | 相手を自分と同じに | 高レベル土地の強敵を弱体化 |
   
   **使用例（APドレイン）:**
   ```
   1. 勝てるクリーチャーがいない
   2. APドレイン持ち（サキュバスリング等）で侵略
   3. 先制で攻撃成功 → 相手AP=0
   4. 両者生存だが相手は弱体化
   5. 次ターンで別クリーチャーが勝てる
   ```

   **防御側対応方針（未実装）:**
   
   | 相手の効果 | 条件 | 対応 |
   |-----------|------|------|
   | APドレイン | 先制を取られる | 武器を使わない（APが0にされるから無意味） |
   | 強制変化 | 先制を取られる | 無効化できる防具を使用、それ以外は通常判断 |

---

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2025-12-30 | 初版作成 |
| 2025-12-30 | 防御側アイテム・援護判断実装 |
| 2025-12-30 | 防具温存ロジック追加 |
| 2025-12-30 | 無効化・反射対応 |
| 2025-12-31 | 即死スキル基本判断実装 |
| 2025-12-31 | 敵手札参照・無効化+即死優先判断実装 |
| 2025-12-31 | 防御側: 敵即死クリーチャーに対する無効化アイテム優先使用 |
| 2025-12-30 | 温存対象アイテム・クリーチャー実装（道連れ、死亡時ダメージ等） |
| 2025-12-30 | 攻撃側クリーチャーの死亡時効果対応（サルファバルーン等） |
| 2025-12-30 | 防御側合体判断実装（最優先で合体を選択） |
| 2025-12-30 | 攻撃側合体判断実装（勝利/生存時に最優先） |
| 2025-12-30 | ダメージ軽減（無効化[1/2]）対応 |
| 2025-12-30 | 考慮するスキル一覧を正確に更新（応援・貫通・巻物攻撃含む） |
| 2026-01-05 | 敵の対抗手段（アイテム・援護）を考慮したワーストケースシミュレーション設計追加 |
| 2026-01-05 | CPU性格パラメータ（将来拡張用）の設計追加 |
| 2026-01-06 | アイテム破壊・盗みスキル対策を実装（敵がスキルを持つ場合はアイテム使用を控える） |
| 2026-01-06 | ファイル構成を分割計画に合わせて更新 |
| 2026-01-06 | cpu_merge_evaluator.gd分離完了、実際の行数に更新 |
