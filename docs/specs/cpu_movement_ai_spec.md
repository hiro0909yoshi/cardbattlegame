# CPU移動判断システム仕様書

## 概要

CPUプレイヤーの移動方向決定とダイス固定スペル（ホーリーワード等）の使用判断を行うシステム。
**経路全体をシミュレート**し、停止位置と通過経路の両方を評価して最適な選択を行う。

## ファイル構成

| ファイル | 役割 |
|---------|------|
| `scripts/cpu_ai/cpu_movement_evaluator.gd` | 移動経路評価・方向決定・ホーリーワード判断 |

---

## 方向選択が発生するタイミング

| タイミング | 処理箇所 | 説明 |
|-----------|---------|------|
| ゲームスタート時 | `game_flow_manager.gd` L253 | 全プレイヤーに `direction_choice_pending = true` |
| スペルワープ時 | `spell_player_move.gd` L390 | ワープ後に `direction_choice_pending = true` |
| 分岐タイル | `movement_controller.gd` `_get_next_tile_with_branch()` | 選択肢が複数ある場合のみUI表示 |

**注意:** 分岐タイルでは「開いている方向」のみ選択可能。閉じている方向には進めない。

---

## 経路シミュレーション

### 概要

指定位置から指定歩数の経路をシミュレートし、実際の停止位置を特定する。

### 考慮要素

1. **分岐タイルの開閉状態** - `BranchTile.get_next_tile_for_direction()`
2. **足止め判定** - `SpellMovement.check_forced_stop_with_tiles()`
   - 呪い「強制停止」(forced_stop) - クイックサンド等、誰でも止まる、1回で消滅
   - スキル「足どめ」(trap_stop) - クリーチャースキル、所有者以外を止める、永続
3. **ワープタイル** - 通過型ワープの処理
4. **歩行逆転呪い** - 進行方向の反転

### 足止め判定の注意点

- **自分の領地は足止めされない** - 足止めスキルは「所有者以外を止める」
- **足止めがあっても勝てる場合** - 侵略チャンスとしてプラス評価
- **複数の足止めがある場合** - 最初の足止めで評価を打ち切る

### 経路途中の分岐処理

10マス先までの経路評価中に分岐タイルに遭遇した場合：

```
1. 各分岐先について、残り歩数で止まるタイルを特定
2. 各停止位置のスコアを計算（再帰的にevaluate_path()を呼び出し）
3. 最高スコアの選択肢を「CPUが選ぶ」と仮定して経路を進める
```

これにより、複数の分岐がある複雑なマップでも最良経路を探索できる。

### 関数シグネチャ

```gdscript
## 経路をシミュレート
## start_tile: 開始タイル
## steps: 歩数
## player_id: プレイヤーID
## came_from: 来た方向のタイル（-1なら現在のcame_fromを使用）
## 返り値: { 
##   path: Array[tile_index],      # 通過するタイルの配列
##   stop_tile: int,               # 最終停止位置
##   forced_stop: bool,            # 足止めで強制停止したか
##   forced_stop_at: int           # 足止め発生位置（-1なら発生なし）
## }
func simulate_path(start_tile: int, steps: int, player_id: int, came_from: int = -1) -> Dictionary
```

---

## スコア定数

```gdscript
# === 停止位置スコア ===
const SCORE_STOP_ENEMY_CANT_WIN_MULTIPLIER = -1    # 敵領地（倒せない）: -通行料 × 1
const SCORE_STOP_ENEMY_CAN_WIN_MULTIPLIER = 2      # 敵領地（倒せる）: +通行料 × 2
const SCORE_STOP_EMPTY_ELEMENT_MATCH = 300         # 空き地（属性一致・召喚可能）
const SCORE_STOP_EMPTY_ELEMENT_MISMATCH = 100      # 空き地（属性不一致・召喚可能）
const SCORE_STOP_EMPTY_NO_SUMMON = 0               # 空き地（召喚不可）
const SCORE_STOP_OWN_LAND = 0                      # 自分の領地
const SCORE_STOP_SPECIAL_TILE = 50                 # 特殊タイル（城、魔法石等）

# === 経路スコア ===
const SCORE_PATH_DIVISOR = 10                      # 経路スコアの除数（1/10にする）

# === 方向ボーナス ===
const SCORE_DIRECTION_UNVISITED_GATE = 1200        # 未訪問ゲート方向ボーナス

# === 足止めペナルティ ===
const SCORE_FORCED_STOP_PENALTY = -500             # 足止めペナルティ基礎値（倒せない場合のみ）
```

---

## スコア計算式

### 総合スコア

```
総合スコア = 停止位置スコア + (経路スコア / 10) + 方向ボーナス
```

### 停止位置スコア

| 状況 | 計算式 |
|------|--------|
| 敵領地（倒せない） | `-通行料` |
| 敵領地（倒せる） | `+通行料 × 2` |
| 空き地（属性一致・召喚可能） | `+300` |
| 空き地（属性不一致・召喚可能） | `+100` |
| 空き地（召喚不可） | `0` |
| 自分の領地 | `0`（評価対象外） |
| 特殊タイル（城、魔法石等） | `+50` |

### 経路スコア（10マス先まで）

| 状況 | 計算式 |
|------|--------|
| 敵領地を通過 | `-(通行料の合計)` |
| 空き地（属性一致）を通過 | `+(300 × 数)` |
| 空き地（属性不一致）を通過 | `+(100 × 数)` |

**注意:** 自分の領地は経路スコアに含めない

経路スコアは最終的に `÷ 10` して総合スコアに加算する。

### 足止めがある場合

| 状況 | 計算式 |
|------|--------|
| 足止め（倒せない） | `-500 - 通行料` |
| 足止め（倒せる） | `+通行料 × 2`（侵略ボーナス、ペナルティなし） |

足止めで停止する場合、その先の経路は評価しない。

### 方向ボーナス

| 状況 | スコア |
|------|--------|
| 未訪問ゲート方向 | `+1200` |

---

## 計算例

### 例1: 敵の高額領地に止まる（倒せない）

```
停止位置: 敵領地（通行料500G、倒せない）
経路: 空き地2つ（属性一致1、不一致1）

停止位置スコア = -500
経路スコア = (300 + 100) / 10 = 40
総合スコア = -500 + 40 = -460
```

### 例2: 敵領地に止まる（倒せる）

```
停止位置: 敵領地（通行料300G、倒せる）
経路: 敵領地1つ（通行料200G）

停止位置スコア = 300 × 2 = +600
経路スコア = -200 / 10 = -20
総合スコア = 600 - 20 = +580
```

### 例3: 空き地に止まる（属性一致）+ 未訪問ゲート方向

```
停止位置: 空き地（属性一致、召喚可能）
経路: 空き地3つ（全て属性一致）
方向: 未訪問ゲート方向

停止位置スコア = +300
経路スコア = (300 × 3) / 10 = 90
方向ボーナス = +1200
総合スコア = 300 + 90 + 1200 = +1590
```

### 例4: 足止めで強制停止（倒せない）

```
3マス目で足止め（通行料400G、倒せない）
本来の停止位置: 5マス目

停止位置スコア = -500 - 400 = -900
経路スコア = 0（足止め地点より先は評価しない）
総合スコア = -900
```

### 例5: 足止めで強制停止（倒せる）

```
3マス目で足止め（通行料400G、倒せる）
本来の停止位置: 5マス目

停止位置スコア = 400 × 2 = +800（侵略ボーナス）
経路スコア = 0
総合スコア = +800
```

---

## 機能1: 進行方向決定

### 概要

ゲームスタート時やワープ後に、両方向の経路を評価して最適な方向を選択する。

### 実装フロー

```
1. CPUの方向選択権をチェック
2. 両方向（+1/-1）それぞれについて:
   a. 10マス先までの経路を評価
   b. 未訪問ゲート方向ならボーナス加算
3. スコアが高い方向を選択
```

---

## 機能2: 分岐タイルでの選択

### 概要

移動中に分岐タイルに到達した場合、残り歩数を考慮して最適な選択肢を選ぶ。

### 実装フロー

```
1. 残り歩数を取得（サイコロの目 - 既に移動した歩数）
2. 各選択肢について:
   a. その選択肢から残り歩数分の経路をシミュレート
   b. 停止位置スコア + 経路スコアを計算
3. 最高スコアの選択肢を返す
```

### 関数シグネチャ

```gdscript
## 分岐タイルでの選択
## player_id: CPUプレイヤーID
## available_tiles: 選択可能なタイルインデックス配列
## remaining_steps: 残り歩数
## 返り値: 選択したタイルインデックス
func decide_branch_choice(player_id: int, available_tiles: Array, remaining_steps: int) -> int
```

---

## 機能3: ホーリーワード（固定ダイス）スペル判断

### スペル情報

| スペル名 | ID | ダイス目 | コスト |
|---------|-----|---------|--------|
| ホーリーワード1 | 2098 | 1 | 30G |
| ホーリーワード3 | 2099 | 3 | 10G |
| ホーリーワード6 | 2100 | 6 | 50G |
| ホーリーワード8 | 2101 | 8 | 80G |

### 攻撃的使用（敵を自分の高額土地に止まらせる）

**判断フロー:**

```
1. 各敵プレイヤーについて:
   a. 敵の現在位置＋進行方向から各ダイス目先の停止位置を計算
   b. 停止位置が自分の高額土地（Lv3以上）かチェック
   c. 通行料を計算
   d. 侵略リスクをチェック（敵が勝てるクリーチャーを持っているか）
2. 最も高い通行料を取れる＆侵略されない組み合わせを選択
3. 期待利益がコストを上回れば使用
```

### 防御的使用（自分が敵の高額土地を避ける）

**判断フロー:**

```
1. 自分の現在位置から各ダイス目（1〜8）の停止位置を計算
2. 敵の高額土地に止まるダイス目を特定
3. それを避けるダイス目のホーリーワードがあれば使用候補
4. 回避できる通行料がコストを上回れば使用
```

---

## システム参照

### CPUMovementEvaluatorが必要とする参照

| 参照 | 用途 |
|-----|------|
| `board_system` | タイル情報取得、通行料計算 |
| `player_system` | プレイヤー位置、進行方向 |
| `lap_system` | 未訪問ゲート判定 |
| `movement_controller` | タイルノード、came_from情報 |
| `card_system` | 手札のクリーチャー取得 |
| `battle_simulator` | 侵略可否判定（アイテム考慮） |
| `spell_movement` | 足止め判定 |

---

## 実装順序

1. **経路シミュレーション**
   - `simulate_path()` - 足止め考慮した経路計算
   - 足止め判定は `SpellMovement.check_forced_stop_with_tiles()` を使用

2. **停止位置評価**
   - `evaluate_stop_tile()` - 停止位置のスコア計算
   - `can_invade_and_win()` - 侵略可否判定（BattleSimulator経由）

3. **経路評価**
   - `evaluate_path_score()` - 10マス先までの経路スコア

4. **統合評価**
   - `evaluate_path()` - 停止位置 + 経路 + 方向ボーナスの総合評価

5. **方向決定**
   - `decide_direction()` - 両方向を評価して選択

6. **分岐選択**
   - `decide_branch_choice()` - 残り歩数考慮の分岐選択

7. **ホーリーワード判断**
   - `evaluate_holy_word()` - 攻撃的/防御的使用の判断

---

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2026-01-09 | 初版作成 |
| 2026-01-09 | 方向選択タイミング、評価基準、実装フローを詳細化 |
| 2026-01-09 | 経路全体シミュレーション方式に変更、停止位置評価を最重要化 |
| 2026-01-09 | スコア計算の詳細設計、計算例を追加 |
