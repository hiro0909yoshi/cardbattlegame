# 通行料システム仕様書

**バージョン**: 2.0（新定義）  
**最終更新**: 2025年11月20日  
**ステータス**: 仕様確定

---

## 概要

通行料システムは、プレイヤーが他プレイヤーの領地に留まる際に支払う金銭制度です。通行料は土地の価値を表し、プレイヤーの総魔力計算に組み込まれます。

---

## 基本定義

### 通行料 = 土地の価値

```
土地の価値 = 土地の通行料
```

### 総魔力の計算

```
総魔力 = 手持ち魔力 + 保有土地の総価値
	 = 手持ち魔力 + Σ(各土地の通行料)
```

**勝利条件**:
```
総魔力 >= 8000G で勝利
```

---

## 通行料の計算式

### 現在の実装

```
通行料 = BASE_TOLL × 土地レベル × 連鎖ボーナス
	  = 100 × レベル(1～5) × 連鎖ボーナス(1.0～4.0)
```

**例**:
- Lv1、連鎖ボーナスなし: 100 × 1 × 1.0 = 100G
- Lv3、2連鎖ボーナス: 100 × 3 × 1.5 = 450G
- Lv5、4連鎖以上: 100 × 5 × 4.0 = 2000G

### 連鎖ボーナス

| 同属性タイル数 | ボーナス倍率 |
|-------------|----------|
| 1個 | 1.0 |
| 2個 | 1.5 |
| 3個 | 2.5 |
| 4個以上 | 4.0 |

---

## 通行料の支払い

### 支払いの統一ルール

**シンプルな原則**:
```
プレイヤーが敵地に「留まる」状態 → 通行料支払い義務
```

### 支払いが発生するシーン

**統一条件**: `end_turn()` 実行時に敵地にいるかチェック

#### シーン1: パスアクション選択後
```
プレイヤーA が敵プレイヤーBの領地でパスを選択
  ↓
on_action_pass() 実行（支払いなし）
  ↓
tile_action_completed シグナル → end_turn() 呼び出し
  ↓
end_turn() 内で敵地判定
  ├─ 敵地にいる？ → Yes
  ↓
通行料を計算・支払い
  ↓
プレイヤーA: 総魔力が減少
プレイヤーB: 総魔力が増加
```

#### シーン2: 戦闘敗北後（DEFENDER_WIN）
```
プレイヤーA が敵プレイヤーBの領地でバトル
  ↓
BattleSystem: 防御側勝利判定
  ↓
battle_system.invasion_completed シグナル発火
  ↓
tile_action_processor._on_battle_completed()
  ↓
tile_action_completed シグナル → end_turn() 呼び出し
  ↓
end_turn() 内で敵地判定
  ├─ 敵地にいる？ → Yes
  ↓
通行料を計算・支払い
  ↓
プレイヤーA: 総魔力が減少
プレイヤーB: 総魔力が増加
```

#### シーン3: 敵地に生き残り（ATTACKER_SURVIVED - 通常侵略）
```
プレイヤーA が敵プレイヤーBの領地でバトル
  ↓
BattleSystem: 攻撃側敗北（生き残り）
  ↓
クリーチャーは手札に戻る
  ↓
tile_action_completed シグナル → end_turn() 呼び出し
  ↓
end_turn() 内で敵地判定
  ├─ 敵地にいる？ → Yes
  ↓
通行料を計算・支払い
  ↓
プレイヤーA: 総魔力が減少
プレイヤーB: 総魔力が増加
```

**実装位置**:
- `scripts/game_flow_manager.gd` - `end_turn()` (Line 460～)
  - 新規関数 `check_and_pay_toll_on_enemy_land()` を追加
  - **手札調整の後に実行**（手札が確定した状態で支払い）

**実装順序**:
```gdscript
func end_turn():
	# 1. 初期チェック
	if is_ending_turn or current_phase == GamePhase.END_TURN:
		return
	is_ending_turn = true
	
	# 2. UI/ランド処理
	# ... 既存処理 ...
	
	# 3. 手札調整
	await check_and_discard_excess_cards()
	
	# 4. ★敵地判定・支払い（ここで実行）
	await check_and_pay_toll_on_enemy_land()
	
	# 5. ターン終了処理・次ターン
	# ... 既存処理 ...
```

### 支払いが発生しないシーン

#### 1. 戦闘勝利時 (ATTACKER_WIN)
```
プレイヤーA が敵プレイヤーBの領地でバトル
  ↓
BattleSystem: 攻撃側勝利判定
  ↓
敵地を奪取してクリーチャー配置
  ↓
「敵地」ではなく「自領地」になる
  ↓
支払いなし ← 自分の土地だから
```

#### 2. 移動敗北で元タイルに戻る場合
```
移動侵略で敗北した場合:
BattleResult.ATTACKER_SURVIVED
  ↓
移動元タイルにクリーチャーが戻る
  ↓
敵地に留まっていない → 自領地に配置
  ↓
支払いなし
```

#### 3. 相打ちになった場合 (BOTH_DEFEATED)
```
プレイヤーA と プレイヤーB のクリーチャー両方破壊
  ↓
土地が無所有に
  ↓
敵地でなくなる
  ↓
支払いなし
```

### 支払い処理

**手持ち魔力が足りる場合**:
```
支払い側: 手持ち魔力 -= 通行料
受け取り側: 手持ち魔力 += 通行料
```

**手持ち魔力が足りない場合**:
```
土地を売却してまかなう（将来実装）
```

---

## 土地の売却

### 売却額

```
売却額 = その土地の通行料（土地の価値）
```

**売却のメリット**:
- 手持ち魔力が増える
- 土地を失うため、総魔力は増えない

**売却のデメリット**:
- その土地の価値分、総魔力が減る
- 領地を手放す

---

## 呪いによる修正（将来実装）

以下の呪いで通行料を修正予定:

| 呪いタイプ | 効果 | 対象 |
|----------|------|------|
| `toll_disable` | 通行料無効（0G） | プレイヤー（支払い側） |
| `toll_multiplier` | 通行料倍率（×1.5など） | クリーチャー（領地） |
| `toll_fixed` | 通行料固定値 | クリーチャー（領地） |
| `toll_share` | 通行料共有（50%等） | プレイヤー（受け取り側） |
| `peace` | 侵略不可+通行料0 | クリーチャー（領地） |

---

## 総資産計算

### 現在のコード実装

```gdscript
# TileDataManager.calculate_total_land_value()
var total_value = 0
for each tile owned by player:
	total_value += tile.通行料
```

この値が総魔力に反映されている。

### 総魔力の最新計算式

```
総魔力 = player.magic_power + tile_data_manager.calculate_total_land_value(player_id)
```

---

## 実装ファイル一覧

| ファイル | 役割 | 状態 |
|---------|------|------|
| `scripts/game_flow_manager.gd` | **支払い判定・実行（end_turn()内）** | 🚧 実装中 |
| `scripts/tile_data_manager.gd` | 通行料計算・土地価値計算 | ✅ 実装済み |
| `scripts/tile_action_processor.gd` | パス処理（支払いなし） | ✅ 実装済み |
| `scripts/battle_system.gd` | pay_toll_3d()削除予定 | 🚧 削除予定 |
| `scripts/player_system.gd` | 金銭移動・pay_toll() | ✅ 実装済み |
| `scripts/game_constants.gd` | BASE_TOLL等の定数 | ✅ 実装済み |
| 魔力不足時の処理 | スキップまたは売却 | 🚧 実装検討中 |
| 呪いシステム | 通行料修正 | ❌ 将来実装 |

---

## パラメータ

### GameConstants

```gdscript
const BASE_TOLL = 100            # 基礎通行料
const CHAIN_BONUS_2 = 1.5        # 2個連鎖倍率
const CHAIN_BONUS_3 = 2.5        # 3個連鎖倍率
const CHAIN_BONUS_4 = 4.0        # 4個以上連鎖倍率（上限）
```

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025/11/23 | 2.2 | 支払い処理一本化：実装位置明記、敗北時シーン詳細化、魔力不足対応追加 |
| 2025/11/23 | 2.1 | 支払い処理の一本化：敵地「留まる」を統一条件に、敗北時の支払い追加 |
| 2025/11/20 | 2.0 | 新定義：土地価値＝通行料、総魔力に反映 |
| 2025/11/20 | 1.0 | 初版作成 |

---

**最終更新**: 2025年11月23日
