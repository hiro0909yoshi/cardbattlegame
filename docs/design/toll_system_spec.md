# 通行料システム仕様書

**バージョン**: 2.0（新定義）  
**最終更新**: 2025年11月20日  
**ステータス**: 仕様確定

---

## 概要

通行料システムは、プレイヤーが他プレイヤーの領地に留まる際に支払う金銭制度です。通行料は土地の価値を表し、プレイヤーの総魔力計算に組み込まれます。

---

## 基本定義

### 通行料 = 土地の価値

```
土地の価値 = 土地の通行料
```

### 総魔力の計算

```
総魔力 = 手持ち魔力 + 保有土地の総価値
	 = 手持ち魔力 + Σ(各土地の通行料)
```

**勝利条件**:
```
総魔力 >= 8000G で勝利
```

---

## 通行料の計算式

### 現在の実装

```
通行料 = BASE_TOLL × 土地レベル × 連鎖ボーナス
	  = 100 × レベル(1～5) × 連鎖ボーナス(1.0～4.0)
```

**例**:
- Lv1、連鎖ボーナスなし: 100 × 1 × 1.0 = 100G
- Lv3、2連鎖ボーナス: 100 × 3 × 1.5 = 450G
- Lv5、4連鎖以上: 100 × 5 × 4.0 = 2000G

### 連鎖ボーナス

| 同属性タイル数 | ボーナス倍率 |
|-------------|----------|
| 1個 | 1.0 |
| 2個 | 1.5 |
| 3個 | 2.5 |
| 4個以上 | 4.0 |

---

## 通行料の支払い

### 支払いシーン

**敵領地でパスアクション選択時**

```
プレイヤーA が敵プレイヤーBの領地でパスを選択
  ↓
通行料を計算
  ↓
手持ち魔力から通行料を支払う
  ↓
プレイヤーA: 総魔力が減少
プレイヤーB: 総魔力が増加
```

### 支払い処理

**手持ち魔力が足りる場合**:
```
支払い側: 手持ち魔力 -= 通行料
受け取り側: 手持ち魔力 += 通行料
```

**手持ち魔力が足りない場合**:
```
土地を売却してまかなう（将来実装）
```

---

## 土地の売却

### 売却額

```
売却額 = その土地の通行料（土地の価値）
```

**売却のメリット**:
- 手持ち魔力が増える
- 土地を失うため、総魔力は増えない

**売却のデメリット**:
- その土地の価値分、総魔力が減る
- 領地を手放す

---

## 呪いによる修正（将来実装）

以下の呪いで通行料を修正予定:

| 呪いタイプ | 効果 | 対象 |
|----------|------|------|
| `toll_disable` | 通行料無効（0G） | プレイヤー（支払い側） |
| `toll_multiplier` | 通行料倍率（×1.5など） | クリーチャー（領地） |
| `toll_fixed` | 通行料固定値 | クリーチャー（領地） |
| `toll_share` | 通行料共有（50%等） | プレイヤー（受け取り側） |
| `peace` | 侵略不可+通行料0 | クリーチャー（領地） |

---

## 総資産計算

### 現在のコード実装

```gdscript
# TileDataManager.calculate_total_land_value()
var total_value = 0
for each tile owned by player:
	total_value += tile.通行料
```

この値が総魔力に反映されている。

### 総魔力の最新計算式

```
総魔力 = player.magic_power + tile_data_manager.calculate_total_land_value(player_id)
```

---

## 実装ファイル一覧

| ファイル | 役割 | 状態 |
|---------|------|------|
| `scripts/tile_data_manager.gd` | 通行料計算・土地価値計算 | ✅ 実装済み |
| `scripts/tile_action_processor.gd` | 支払い処理 | ✅ 実装済み |
| `scripts/player_system.gd` | 金銭移動・pay_toll() | ✅ 実装済み |
| `scripts/game_constants.gd` | BASE_TOLL等の定数 | ✅ 実装済み |
| 土地売却機能 | 魔力不足時の売却処理 | ❌ 未実装 |
| 呪いシステム | 通行料修正 | ❌ 未実装 |

---

## パラメータ

### GameConstants

```gdscript
const BASE_TOLL = 100            # 基礎通行料
const CHAIN_BONUS_2 = 1.5        # 2個連鎖倍率
const CHAIN_BONUS_3 = 2.5        # 3個連鎖倍率
const CHAIN_BONUS_4 = 4.0        # 4個以上連鎖倍率（上限）
```

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025/11/20 | 2.0 | 新定義：土地価値＝通行料、総魔力に反映 |
| 2025/11/20 | 1.0 | 初版作成 |

---

**最終更新**: 2025年11月20日
