# マップシステム仕様

**バージョン**: 1.0  
**最終更新**: 2025年12月1日

---

## 📐 マップ構造

### 基本仕様
- **形状**: ダイヤモンド型
- **タイル数**: 20マス
- **移動方向**: 時計回り（0 → 1 → 2 ... → 19 → 0）
- **座標系**: 3D空間（XZ平面）

### タイル配置
```
タイル番号は時計回りに0〜19
	  
	  15  14  13  12  11  10
	16                      9
  17                          8
	18                      7
	  19  0   1   2   3   4   5   6
```

---

## 🎯 特殊タイルの種類

### 1. CheckpointTile（チェックポイントタイル）

**配置場所**:
- **タイル0** - タイプN（スタート地点）
- **タイル10** - タイプS（対角線上）

**役割**: 周回検出
- プレイヤーが通過するとシグナル発行（N または S）
- N + S のセット = 1周完了

**視覚的特徴**: 黒色のオーバーレイメッシュ

**詳細**: [周回システム](#-周回システム) を参照

---

### 2. WarpTile（ワープタイル）

**配置場所**:
- **タイル5** ↔ **タイル15** （ワープペア）

**動作**: 通過型ワープ
- タイル5を通過 → 自動的にタイル6へ瞬間移動
- タイル15を通過 → 自動的にタイル16へ瞬間移動

**視覚的特徴**: 紫色のオーバーレイメッシュ

**実装**:
- `MovementController.check_and_handle_warp()`
- `SpecialTileSystem`でペア管理
- フェードアウト/フェードインアニメーション

---

### 3. 通常タイル（属性タイル）

**種類**:
- FireTile（火）
- WaterTile（水）
- EarthTile（土）
- WindTile（風）
- NeutralTile（無）

**機能**:
- クリーチャー配置可能
- 属性一致でHP土地ボーナス: `HP + (レベル × 10)`
- レベル1〜5まで成長可能

---

## 🔄 周回システム

### 仕組み

**周回完了の条件**:
1. プレイヤーがタイル0（N）を通過 → **Nシグナル**
2. プレイヤーがタイル10（S）を通過 → **Sシグナル**
3. **N + S 両方揃う** → **周回完了**

**特殊ルール**:
- ゲーム開始時のタイル0通過はカウントしない
- 2回目以降の通過からNシグナル発行
- 順序は問わない（N→S でも S→N でもOK）

---

### 周回完了時の効果

#### 永続バフ対象クリーチャー

| ID | 名前 | 効果 |
|----|------|------|
| 7 | キメラ | 周回ごとにAP+10（累積、上限なし） |
| 240 | モスタイタン | 周回ごとにMHP+10（MHP≧80で30にリセット） |

**データ保存**:
```gdscript
creature_data["map_lap_count"] = 0      # 周回数カウンター
creature_data["base_up_ap"] += 10       # キメラ用
creature_data["base_up_hp"] += 10       # モスタイタン用
```

**リセット条件**: 手札に戻った時

---

## 🎁 スタート通過ボーナス

### タイル0通過時の効果

プレイヤーがタイル0を通過するたび、以下の3つの効果が発動：

#### 1. 💰 魔力ボーナス
- `GameConstants.PASS_BONUS`分の魔力を獲得
- 現在値: 500G

#### 2. 🔓 ダウン状態クリア
- プレイヤーの**全領地**のダウン状態を解除
- 次のターンで領地コマンド（レベルアップ/移動/交換）が再び可能に

#### 3. 💚 クリーチャーHP回復
- プレイヤーの**全クリーチャー**のHPを**+10回復**
- MHP（最大HP）を超えない
- 計算式: `new_HP = min(current_HP + 10, MHP)`

**例**:
```
MHP 50, 現在HP 30 → 40に回復
MHP 50, 現在HP 45 → 50に回復（上限）
```

---

## 🚶 移動方向システム

### 基本概念

プレイヤーの移動は以下の方向が存在する：

| 方向 | 値 | 説明 |
|------|-----|------|
| 順方向（時計回り） | +1 | タイル番号が増加する方向（0→1→2...） |
| 逆方向（反時計回り） | -1 | タイル番号が減少する方向（...2→1→0→19） |

**通常ターン**: 一定方向のみ（方向選択なし）

---

### 方向選択のタイプ

方向選択には2つのタイプがある：

#### タイプA: 自由選択（direction_choice_pending フラグ）

**発生タイミング**:
- ゲームスタート時（全員）
- ワープ後（停止型ワープ、または通過型ワープ先が分岐）
- スペルワープ後の次ターン

**特徴**:
- 全方向から選択可能（2方向 or 4方向）
- 移動開始前に決定
- フラグで管理

**実装**:
```gdscript
player.direction_choice_pending = true   # 方向選択が必要
player.direction_choice_type = "free"    # 自由選択タイプ
```

---

#### タイプB: 分岐選択（移動中リアルタイム処理）

**発生タイミング**:
- 移動中に分岐点に差し掛かった時

**特徴**:
- 来た方向（戻る方向）は選択不可
- 残りの方向から選択
- 移動処理中にタイルの接続情報を見て判定

**実装**:
```gdscript
# 移動中に記録
var previous_direction = 1  # どこから来たか（+1 or -1）

# 分岐点に到達した時
func get_branch_choices(tile_index: int, came_from_direction: int) -> Array:
    var tile = tile_nodes[tile_index]
    var all_directions = tile.connections.branches  # 例: [1, -1, 2]
    
    # 来た方向の逆（戻る方向）を除外
    var back_direction = -came_from_direction
    var choices = all_directions.filter(func(d): return d != back_direction)
    
    return choices  # 例: [1, 2] （-1は除外）
```

**例**:
```
プレイヤーが順方向（+1）で分岐点に到着
分岐点の接続: [+1, -1, +2]（3方向）
来た方向の逆 = -1（戻る方向）
選択肢 = [+1, +2]（2方向のみ表示）
```

---

### 方向に影響する呪い/バフ

#### 歩行逆転呪い（カオスパニック）

**付与方法**: カオスパニック（ID: 2019）

**効果**:
- 付与されたプレイヤーは移動方向が反転する
- 順方向を選択 → 実際は逆方向に移動
- 逆方向を選択 → 実際は順方向に移動

**持続**: 1ターン（ターン終了時に解除）

**実装**:
```gdscript
player.curse = {
    "curse_type": "movement_reverse",
    "duration": 1,
    "name": "歩行逆転"
}
```

---

### タイル接続システム

#### 基本方針

- **通常タイル**: `connections`設定不要 → 従来通り `+1/-1` で計算
- **分岐点/行き止まり**: `connections`設定必要 → 接続情報から判定

これにより、既存の全タイルに設定を追加する必要はなく、特殊なタイルのみ設定すればよい。

---

#### タイル種別と処理

| タイルの種類 | connections | 処理 |
|-------------|-------------|------|
| 通常タイル（1〜19等） | 設定なし | `(tile + direction) % total` で計算 |
| 分岐点（複数接続） | `[0, 1, 20]`等 | 選択肢を表示（来た方向除外） |
| 行き止まり（1接続） | `[0]`等 | 自動的に来た方向に戻る |

---

#### connections設定例

```gdscript
# タイル0: 3方向に分岐（1, 19, 20に接続）
tile_0.connections = [1, 19, 20]

# タイル20: 行き止まり（0のみに接続）
tile_20.connections = [0]

# タイル1〜19: 通常タイル（設定不要）
# connections が空または未設定 → 従来計算
```

---

#### 次タイル取得ロジック

```gdscript
func get_next_tile(current_tile: int, direction: int, came_from: int) -> int:
    var tile = tile_nodes[current_tile]
    
    # connectionsが設定されていれば接続情報ベース
    if tile.has("connections") and not tile.connections.is_empty():
        return _get_next_from_connections(tile.connections, came_from)
    
    # 設定されていなければ従来の計算
    var total = tile_nodes.size()
    return (current_tile + direction + total) % total

func _get_next_from_connections(connections: Array, came_from: int) -> int:
    # 来た方向を除外
    var choices = connections.filter(func(n): return n != came_from)
    
    # 選択肢がなければ来た方向に戻る（行き止まり）
    if choices.is_empty():
        return came_from
    
    # 選択肢が1つなら自動選択
    if choices.size() == 1:
        return choices[0]
    
    # 複数なら選択UI表示（タイプB分岐選択）
    return await show_branch_selection(choices)
```

---

#### 行き止まりの自動戻り

行き止まりタイル（接続先が1つのみ）では、「来た方向に戻れない」ルールは適用されない。

**例: タイル20（行き止まり）**:
```
1. タイル0で「タイル20方向」を選択
2. タイル20に到着
3. 次に進む → 接続先がタイル0しかない
4. 選択UIなし、自動的にタイル0に戻る
```

**ルールまとめ**:
- 選択肢が2つ以上 → 来た方向を除外して選択UI表示
- 選択肢が1つ → 自動選択（UIなし）
- 選択肢が0（行き止まり） → 来た方向に戻る

---

### 移動フェーズの流れ（詳細）

```
1. ターン開始
   ↓
2. 方向選択チェック（タイプA: 自由選択）
   ├─ direction_choice_pending == true？
   │   └─ YES → 方向選択UI表示 → プレイヤー選択
   └─ NO → 一定方向（順方向）
   ↓
3. ダイスロール
   ↓
4. 歩行逆転チェック
   └─ 呪いあり？ → 方向を反転
   ↓
5. 1マスずつ移動（move_along_path）
   各マスで:
   │
   ├─ 次タイル判定
   │   ├─ connections設定あり？
   │   │   └─ YES → 接続情報から選択肢取得
   │   │            ├─ 選択肢2つ以上 → 分岐選択UI（タイプB）
   │   │            ├─ 選択肢1つ → 自動選択
   │   │            └─ 選択肢0 → 来た方向に戻る（行き止まり）
   │   └─ NO → 従来計算（tile + direction）
   │
   ├─ ワープタイル？ → ワープ処理 → フラグ設定
   ├─ チェックポイント？ → 周回チェック
   └─ スタート通過？ → ボーナス処理
   ↓
6. 最終位置に到着
   ↓
7. タイルアクション
```

---

## 📊 実装状況

### ✅ 実装済み
- [x] 20マスのダイヤモンド型マップ
- [x] CheckpointTile（N/S）と周回検出
- [x] 周回完了時の永続バフ（キメラ、モスタイタン）
- [x] スタート通過ボーナス（魔力、ダウンクリア、HP回復）
- [x] WarpTile（5↔15）
- [x] 通過型ワープシステム
- [x] 属性タイル（火/水/土/風/無）
- [x] 土地ボーナスシステム
- [x] 歩行逆転呪い（カオスパニック）- 呪い付与

### 🔄 実装中（タイル接続システム）

#### ハードコード「20」の修正（6箇所）
| ファイル | 行 | 内容 | 状態 |
|----------|-----|------|------|
| `game_constants.gd` | 12 | `TOTAL_TILES = 20` | [ ] |
| `movement_controller.gd` | 174 | `% 20` 移動計算 | [ ] |
| `movement_controller.gd` | 227 | `% 20` ワープ後計算 | [ ] |
| `spell_curse.gd` | 375 | `range(20)` ループ | [ ] |
| `debug_controller.gd` | 426 | `>= 20` チェック | [ ] |
| `spell_land_new.gd` | 369 | `>= 20` チェック | [ ] |

#### タイル接続システム
- [ ] BaseTileに`connections`プロパティ追加
- [ ] `get_next_tile()`を接続情報ベースに修正
- [ ] 行き止まり自動戻り処理
- [ ] タイル20（テスト分岐）をマップに追加

#### 移動方向システム
- [ ] タイプA: 自由選択（direction_choice_pending フラグ）
  - [ ] ゲームスタート時の方向選択
  - [ ] ワープ後の方向選択フラグ設定
  - [ ] スペルワープ後の次ターンフラグ設定
- [ ] タイプB: 分岐選択（移動中処理）
  - [ ] 分岐点到達時の選択UI
  - [ ] 来た方向除外ロジック
- [ ] 方向選択UI
- [ ] 逆方向移動の基本動作

### 🚧 未実装
- [ ] 追加のワープゲート
- [ ] 停止型ワープタイル
- [ ] 停止型特殊マス（宿屋、店など）
- [ ] マップ選択システム
- [ ] ランダムマップ生成

---

## 🔧 技術詳細

### 周回状態管理

**GameFlowManager.player_lap_state**:
```gdscript
{
  player_id: {
	"game_started": bool,  # ゲーム開始フラグ
	"N": bool,             # Nシグナル受信フラグ
	"S": bool              # Sシグナル受信フラグ
  }
}
```

### シグナルフロー

```
CheckpointTile
  └─ checkpoint_passed(player_id, "N"|"S")
	   ↓
  GameFlowManager._on_checkpoint_passed()
	   ↓
  両方のフラグが立つ？
	   ├─ YES → _complete_lap()
	   │          ├─ フラグリセット
	   │          ├─ 永続バフ適用
	   │          └─ lap_completed シグナル
	   │
	   └─ NO → 待機
```

---

## 📝 関連ドキュメント

- [周回システム実装ノート](../implementation_notes/lap_system_implementation.md)
- [条件付きステータスバフシステム](conditional_stat_buff_system.md)
- [スキルシステム設計](skills_design.md)

---

## 🎮 プレイヤー向けヒント

### 周回を効率よく回るコツ
1. **ワープゲートを活用**: タイル5→6でショートカット
2. **チェックポイントの位置を把握**: タイル0とタイル10
3. **周回ボーナスを狙う**: キメラ、モスタイタンを配置すれば強力

### スタート通過を意識した戦略
- ダウン状態の土地が多い時は早めにスタートを目指す
- 瀕死のクリーチャーはスタート通過で+10回復
- 魔力が不足している時は周回で補充

---

**最終更新**: 2025年12月1日  
**作成者**: Development Team
