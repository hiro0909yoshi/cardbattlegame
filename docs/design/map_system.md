# マップシステム仕様

**バージョン**: 1.0  
**最終更新**: 2025年10月27日

---

## 📐 マップ構造

### 基本仕様
- **形状**: ダイヤモンド型
- **タイル数**: 20マス
- **移動方向**: 時計回り（0 → 1 → 2 ... → 19 → 0）
- **座標系**: 3D空間（XZ平面）

### タイル配置
```
タイル番号は時計回りに0〜19
      
      15  14  13  12  11  10
    16                      9
  17                          8
    18                      7
      19  0   1   2   3   4   5   6
```

---

## 🎯 特殊タイルの種類

### 1. CheckpointTile（チェックポイントタイル）

**配置場所**:
- **タイル0** - タイプN（スタート地点）
- **タイル10** - タイプS（対角線上）

**役割**: 周回検出
- プレイヤーが通過するとシグナル発行（N または S）
- N + S のセット = 1周完了

**視覚的特徴**: 黒色のオーバーレイメッシュ

**詳細**: [周回システム](#-周回システム) を参照

---

### 2. WarpTile（ワープタイル）

**配置場所**:
- **タイル5** ↔ **タイル15** （ワープペア）

**動作**: 通過型ワープ
- タイル5を通過 → 自動的にタイル15へ瞬間移動
- タイル15を通過 → 自動的にタイル5へ瞬間移動

**視覚的特徴**: 紫色のオーバーレイメッシュ

**実装**:
- `MovementController.check_and_handle_warp()`
- `SpecialTileSystem`でペア管理
- フェードアウト/フェードインアニメーション

---

### 3. 通常タイル（属性タイル）

**種類**:
- FireTile（火）
- WaterTile（水）
- EarthTile（土）
- WindTile（風）
- NeutralTile（無）

**機能**:
- クリーチャー配置可能
- 属性一致でHP土地ボーナス: `HP + (レベル × 10)`
- レベル1〜5まで成長可能

---

## 🔄 周回システム

### 仕組み

**周回完了の条件**:
1. プレイヤーがタイル0（N）を通過 → **Nシグナル**
2. プレイヤーがタイル10（S）を通過 → **Sシグナル**
3. **N + S 両方揃う** → **周回完了**

**特殊ルール**:
- ゲーム開始時のタイル0通過はカウントしない
- 2回目以降の通過からNシグナル発行
- 順序は問わない（N→S でも S→N でもOK）

---

### 周回完了時の効果

#### 永続バフ対象クリーチャー

| ID | 名前 | 効果 |
|----|------|------|
| 7 | キメラ | 周回ごとにST+10（累積、上限なし） |
| 240 | モスタイタン | 周回ごとにMHP+10（MHP≧80で30にリセット） |

**データ保存**:
```gdscript
creature_data["map_lap_count"] = 0      # 周回数カウンター
creature_data["base_up_ap"] += 10       # キメラ用
creature_data["base_up_hp"] += 10       # モスタイタン用
```

**リセット条件**: 手札に戻った時

---

## 🎁 スタート通過ボーナス

### タイル0通過時の効果

プレイヤーがタイル0を通過するたび、以下の3つの効果が発動：

#### 1. 💰 魔力ボーナス
- `GameConstants.PASS_BONUS`分の魔力を獲得
- 現在値: 500G

#### 2. 🔓 ダウン状態クリア
- プレイヤーの**全領地**のダウン状態を解除
- 次のターンで領地コマンド（レベルアップ/移動/交換）が再び可能に

#### 3. 💚 クリーチャーHP回復
- プレイヤーの**全クリーチャー**のHPを**+10回復**
- MHP（最大HP）を超えない
- 計算式: `new_HP = min(current_HP + 10, MHP)`

**例**:
```
MHP 50, 現在HP 30 → 40に回復
MHP 50, 現在HP 45 → 50に回復（上限）
```

---

## 🌀 ワープシステム

### ワープゲートの仕組み

**ワープペア**:
- タイル5 ↔ タイル15
- 双方向ワープ

**動作フロー**:
1. プレイヤーがワープタイルに到達
2. `SpecialTileSystem.is_warp_gate()` でチェック
3. `get_warp_pair()` でワープ先を取得
4. フェードアウト → 瞬間移動 → フェードイン
5. `warp_executed` シグナル発行

**実装ファイル**:
- `scripts/movement_controller.gd` - 移動制御
- `scripts/special_tile_system.gd` - ワープロジック
- `scenes/Tiles/WarpTile.tscn` - ビジュアル

---

## 📊 実装状況

### ✅ 実装済み
- [x] 20マスのダイヤモンド型マップ
- [x] CheckpointTile（N/S）と周回検出
- [x] 周回完了時の永続バフ（キメラ、モスタイタン）
- [x] スタート通過ボーナス（魔力、ダウンクリア、HP回復）
- [x] WarpTile（5↔15）
- [x] 通過型ワープシステム
- [x] 属性タイル（火/水/土/風/無）
- [x] 土地ボーナスシステム

### 🚧 未実装
- [ ] 追加のワープゲート
- [ ] 停止型特殊マス（宿屋、店など）
- [ ] マップ選択システム
- [ ] ランダムマップ生成

---

## 🔧 技術詳細

### 移動処理の流れ

```
1. ダイスロール
   ↓
2. MovementController.move_player()
   ↓
3. move_along_path() で1マスずつ移動
   ↓
   各マスで以下をチェック:
   ├─ スタート通過（tile_index == 0 && previous > current）
   │   └─ handle_start_pass() → 3つのボーナス適用
   │
   ├─ チェックポイント通過
   │   └─ check_and_handle_checkpoint() → N/Sシグナル
   │
   └─ ワープ通過
       └─ check_and_handle_warp() → ワープ実行
   ↓
4. 最終位置に到達
   ↓
5. movement_completed シグナル
```

### 周回状態管理

**GameFlowManager.player_lap_state**:
```gdscript
{
  player_id: {
    "game_started": bool,  # ゲーム開始フラグ
    "N": bool,             # Nシグナル受信フラグ
    "S": bool              # Sシグナル受信フラグ
  }
}
```

### シグナルフロー

```
CheckpointTile
  └─ checkpoint_passed(player_id, "N"|"S")
       ↓
  GameFlowManager._on_checkpoint_passed()
       ↓
  両方のフラグが立つ？
       ├─ YES → _complete_lap()
       │          ├─ フラグリセット
       │          ├─ 永続バフ適用
       │          └─ lap_completed シグナル
       │
       └─ NO → 待機
```

---

## 📝 関連ドキュメント

- [周回システム実装ノート](../implementation_notes/lap_system_implementation.md)
- [条件付きステータスバフシステム](conditional_stat_buff_system.md)
- [スキルシステム設計](skills_design.md)

---

## 🎮 プレイヤー向けヒント

### 周回を効率よく回るコツ
1. **ワープゲートを活用**: タイル5→15でショートカット
2. **チェックポイントの位置を把握**: タイル0とタイル10
3. **周回ボーナスを狙う**: キメラ、モスタイタンを配置すれば強力

### スタート通過を意識した戦略
- ダウン状態の土地が多い時は早めにスタートを目指す
- 瀕死のクリーチャーはスタート通過で+10回復
- 魔力が不足している時は周回で補充

---

**最終更新**: 2025年10月27日  
**作成者**: Development Team
