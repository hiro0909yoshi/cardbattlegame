# 合成システム 完成図書

## 概要

カード使用時に別のカードを犠牲にすることで、効果を強化するシステム。

| 種類 | 発動タイミング | 効果 |
|------|---------------|------|
| スペル合成 | スペル使用時 | 効果の強化・対象範囲拡大 |
| クリーチャー合成 | クリーチャー配置時 | ステータス上昇または変身 |

---

## カード犠牲コスト

### 概要

`cost.cards_sacrifice: 1` を持つカードは、使用時にカード1枚を犠牲にする必要がある。

### 発動箇所

| 状況 | 処理ファイル |
|------|-------------|
| 召喚（空き地/自領地） | tile_action_processor.gd |
| 侵略（敵領地） | tile_action_processor.gd |
| スペル使用 | spell_phase_handler.gd |
| クリーチャー交換スペル | spell_creature_swap.gd |

### 処理フロー

```
1. カード選択
2. EPコスト確認
3. カード犠牲必要？ → 犠牲カード選択UI表示
4. カード破棄
5. 合成条件判定 → 条件成立時は効果強化
6. カード効果実行
```

---

## スペル合成

### 対象スペル（7種）

| ID | 名前 | 合成条件 | 効果変化 |
|----|------|----------|----------|
| 2003 | アステロイド | 同名カード | レベル-1 → レベル1に設定 |
| 2017 | エロージョン | 任意スペル | 対象1人 → 全プレイヤー |
| 2030 | サブサイド | 同名カード | 対象1人 → 全プレイヤー |
| 2033 | シャイニングガイザー | 単体対象スペル | HP-30 → HP-40 |
| 2055 | ディスエレメント | クリーチャー | 1領地 → ダウン全クリーチャー |
| 2058 | デビリティ | 任意スペル | AP=0 → AP=0 & MHP-20 |
| 2107 | マスグロース | アイテム | 全クリーチャー → 自クリーチャーのみ |

### 合成条件タイプ

| タイプ | 説明 |
|--------|------|
| same_card | 同名カード |
| any_spell | 任意のスペル |
| single_target_spell | 単体対象スペル |
| creature | クリーチャーカード |
| item | アイテムカード |

### JSON定義

```json
"synthesis": {
  "type": "single_target_spell",
  "value_override": 40
}
```

| パターン | 用途 |
|----------|------|
| value_override | 数値変更 |
| target_override | 対象範囲変更 |
| effects_add | 効果追加 |
| effect_override | 効果置換 |

---

## クリーチャー合成

### ステータス上昇型（4体）

| ID | 名前 | 属性 | 合成条件 | 効果 |
|----|------|------|----------|------|
| 22 | デッドウォーロード | 火 | 地属性カード | AP+20、MHP+20 |
| 248 | ワーベア | 地 | 地属性カード | AP+30、MHP+10 |
| 317 | サムハイン | 風 | 呪いスペル | AP+20 |
| 341 | マーシャルモンク | 風 | アイテム | AP+40、MHP-10 |

### 変身型（3体）

| ID | 名前 | 属性 | 合成条件 | 変身先 |
|----|------|------|----------|--------|
| 25 | ナイトエラント | 火 | 地属性カード | アームドパラディン |
| 112 | イド | 水 | クリーチャー | 犠牲クリーチャー |
| 320 | スカラベンドラ | 風 | 水属性カード | ディープシードラゴン |

### 犠牲コストのみ（17体）

合成効果なし。召喚コストとしてカード1枚を犠牲にするだけ。

### 合成条件タイプ

| タイプ | 説明 |
|--------|------|
| element | 特定属性のカード |
| curse_spell | 呪いスペル（単体/複数特殊能力付与） |
| item | アイテムカード |
| creature | クリーチャーカード |

### 手札に戻る時の挙動

| 合成タイプ | 戻るカード |
|------------|------------|
| ステータスアップ型 | 元のカード（ステータスリセット） |
| 変身型 | 変身後のカード |

### JSON定義

**ステータス上昇型**
```json
"synthesis": {
  "type": "element",
  "condition": "earth",
  "effect_type": "stat_boost",
  "effect": { "ap": 30, "mhp": 10 }
}
```

**変身型（特定クリーチャー）**
```json
"synthesis": {
  "type": "element",
  "condition": "earth",
  "effect_type": "transform",
  "transform_to": "アームドパラディン"
}
```

**変身型（犠牲クリーチャー）**
```json
"synthesis": {
  "type": "creature",
  "effect_type": "transform",
  "transform_to": "sacrifice"
}
```

---

## 実装ファイル一覧

| ファイル | 役割 |
|----------|------|
| scripts/helpers/card_sacrifice_helper.gd | カード犠牲UI・破棄処理（共通） |
| scripts/spells/spell_synthesis.gd | スペル合成判定・効果適用 |
| scripts/skills/creature_synthesis.gd | クリーチャー合成判定・効果適用 |
| scripts/game_flow/spell_phase_handler.gd | スペル使用時の犠牲処理統合 |
| scripts/tile_action_processor.gd | 召喚・侵略時の犠牲処理統合 |
| scripts/spells/spell_creature_swap.gd | 交換スペル使用時の犠牲処理統合 |
| scripts/card_system.gd | 手札戻し時の合成分岐処理 |
| scripts/spells/spell_creature_return.gd | スペルでの手札戻し時の合成分岐 |

---

## デバッグ

```gdscript
# カード犠牲を無効化（テスト用）
spell_phase_handler.debug_disable_card_sacrifice = true
tile_action_processor.debug_disable_card_sacrifice = true
```

---

## 実装状況

✅ 全て実装完了
