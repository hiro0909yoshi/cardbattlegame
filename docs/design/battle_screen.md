# バトル画面設計書

## 概要

バトル開始時に専用のバトル画面（オーバーレイ）を表示し、クリーチャー同士の戦闘を視覚的に演出する。

## 画面構成

```
┌─────────────────────────────────────────────────────────────────┐
│                          バトル背景                              │
│                                                                  │
│  ┌─────────────────┐                  ┌─────────────────┐       │
│  │  ┌───────────┐  │                  │  ┌───────────┐  │       │
│  │  │           │  │                  │  │           │  │       │
│  │  │ 侵略側    │  │       VS        │  │ 防衛側    │  │       │
│  │  │ カード    │  │                  │  │ カード    │  │       │
│  │  │ (3.9倍)   │  │                  │  │ (3.9倍)   │  │       │
│  │  │           │  │                  │  │           │  │       │
│  │  └───────────┘  │                  │  └───────────┘  │       │
│  └─────────────────┘                  └─────────────────┘       │
│        ←───── 片側300px ─────→  ←───── 片側300px ─────→        │
│                        合計600px                                 │
│  ┌────────────────────┐              ┌────────────────────┐     │
│  │ HP ████████░░ 50/60│              │ HP ████████░░ 50/60│     │
│  │ AP ██████████ 30   │              │ AP ██████████ 25   │     │
│  └────────────────────┘              └────────────────────┘     │
│   中央から左に300px                      中央から右に300px       │
└─────────────────────────────────────────────────────────────────┘

カードサイズ: 220×293 × 3.9倍 = 858×1143
カード間隔: 片側300px（合計600px）
HP/APバー間隔: 中央から左右に300pxずつ（合計600px）
```

## レイヤー構造

```
※既存レイヤー: NotificationLayer = 100

CanvasLayer (layer = 110) - TransitionLayer（最前面）
└── ColorRect (黒、フェード用)
└── BattleStartLabel ("BATTLE!" テキスト)

CanvasLayer (layer = 90) - BattleScreen  
└── Background (背景)
├── AttackerDisplay (左・侵略側カード)
│   └── CardContainer (Card.tscnインスタンス、3.9倍スケール)
│   └── SkillLabel (スキル名表示、36pt)
├── DefenderDisplay (右・防衛側カード)
│   └── CardContainer (Card.tscnインスタンス、3.9倍スケール)
│   └── SkillLabel (スキル名表示、36pt)
├── AttackerHPBar (固定位置、中央から左に300px)
├── DefenderHPBar (固定位置、中央から右に300px)
├── VSLabel (中央)
├── EffectLayer (エフェクト用)
└── ClickArea (クリック待ち用、最前面)
```

## 画面遷移

### バトル開始時
```
1. フェードアウト（0.25秒）→ 画面が暗くなる
2. 暗転中（0.25秒）
   - "BATTLE!" テキスト表示（オプション）
   - バトル画面を準備（非表示状態で）
3. フェードイン（0.25秒）→ バトル画面が表示される
4. イントロ演出
   - 侵略側カードが左からスライドイン
   - 防衛側カードが右からスライドイン
   - VSが表示される
5. クリック待ち（ユーザーがクリックするまで停止）
6. スキル発動フェーズ → バトル開始
```

### バトル終了時
```
1. 結果演出（勝敗表示など）
2. フェードアウト（0.25秒）
3. バトル画面を非表示に
4. フェードイン（0.25秒）→ 元のゲーム画面
```

## バトル演出フロー

### 1. バトル準備フェーズ
```
- 侵略側/防衛側のクリーチャーデータ読み込み
- アイテム使用がある場合はアイテムデータも読み込み
- HPバー初期表示:
  - 緑セグメント: current_hp + item_bonus_hp
  - 土地ボーナス: 黄色
  - この時点ではバフ（水色）は無し
- APバー初期表示: 基本AP値
```

### 2. クリック待ち
```
- ユーザーがクリックするまで待機
- クリック後、スキル発動フェーズへ
```

### 3. スキル発動フェーズ（1つずつアニメーション）
```
発動順序に従って以下を繰り返す（各スキル1.5秒）:
1. スキル名をカード上部に表示
2. HP/APバーを変動させる（1.5秒かけて滑らかに）
   - 緑セグメント: current_hp + item_bonus_hp
   - バフ（水色）: 感応 + 一時 + スペル
   - 土地（黄）: 土地ボーナス
3. 次のスキルへ

適用されるスキル例:
- アイテムクリーチャー効果
- ターン数ボーナス
- 感応スキル
- 土地数効果
- 強打
- 貫通（土地ボーナス無効化）
- 巻物攻撃
```

### 4. 攻撃フェーズ
```
攻撃順序に従って:
1. 攻撃側カードが前に移動（0.2秒）
2. 攻撃エフェクト再生
3. 被攻撃側カードが揺れる
4. ダメージ数値ポップアップ
5. HPバー減少（1.5秒かけて右側から消費）
   - 土地(黄) → バフ(水色) → 緑セグメント の順で減少
6. 攻撃側カードが元の位置に戻る（0.2秒）
7. 次の攻撃へ
```

### 5. 結果表示
```
- 勝敗に応じた演出
- 敗北側カードが消える/倒れるアニメーション
```

## HP/APバー仕様

### HPバー（複合セグメント構造）

HPバーは複数の色セグメントで構成され、HPの内訳を視覚的に表現する。
**右側から消費される**ため、表示順序は消費順序の逆になる。

```
HPバー構造（左から右）:
┌─────────────────────────────────────────────────┐
│ 緑セグメント    │ バフ(水色) │ 土地ボーナス(黄) │ 空(灰)
└─────────────────────────────────────────────────┘
  current_hp        感応+一時     最初に消費
  +item_bonus_hp    +スペル
  （最後に消費）

数値表示: 「65 / 90」(現在の合計HP / 合計最大HP)
※数値は実際の値を表示（100を超えることもある）
```

**バーの最大幅:**
- 常に100固定
- HP/APが100を超えてもバーは100%で止まる
- 数値ラベルは実際の値を正確に表示

**消費順序（battle_participant.gd準拠）:**
1. 土地ボーナス（land_bonus_hp）← 最初に消費
2. 感応ボーナス（resonance_bonus_hp）
3. 一時的ボーナス（temporary_bonus_hp）
4. スペルボーナス（spell_bonus_hp）
5. アイテムボーナス（item_bonus_hp）
6. current_hp ← 最後に消費

**色分け:**
- 緑 `#4CAF50`: current_hp + item_bonus_hp
- バフ（水色）`#03A9F4`: 感応 + 一時的 + スペルボーナスの合計
- 土地ボーナス（黄）`#FFC107`: 最初に消費
- 空（灰）`#424242`: 残りHP枠（最大100）
- ダメージ中（赤）`#F44336`: 減少演出用オーバーレイ

**アニメーション:**
- 変動時間: 1.5秒
- 消費順序を反映（右から順に減少: 黄→水色→緑）
- 回復時は全セグメント同時に増加

**サイズ（5.2倍スケール）:**
- 幅: 1040px
- 高さ: 125px
- 数値フォント: 72pt、太字、白色、アウトライン10px
- 枠線: 10px

**配置:**
- 固定位置（画面下部、y = 画面高さ - 280px）
- カードと連動せず独立配置
- 攻撃側: 中央から左に300px（バー右端）
- 防御側: 中央から右に300px（バー左端）

### APバー
- 色: 青系 `#2196F3`（単色）
- 最大幅: 100固定（APが100以上でもバーは100%で止まる）
- 幅: 1040px
- 高さ: 83px
- 数値フォント: 62pt
- スペーシング: 21px（HPバーとの間隔）
- 数値表示: 実際のAP値
- アニメーション: 1.5秒かけて滑らかに変動

## スキル名表示仕様

- 位置: カード上部（カードの中央揃え）
- 背景: 半透明の茶色プレート（300×60px）
- フォント: 36pt、太字、白色
- アウトライン: 4px、黒色
- 表示時間: 1.5秒
- アニメーション: フェードイン（0.15秒）→ 維持 → フェードアウト（0.15秒）

## ダメージポップアップ仕様

- ダメージ: 赤色、「-30」形式
- 回復: 緑色、「+20」形式
- バフ: 青色、「AP+10」等
- アニメーション: 上に浮き上がりながらフェードアウト
- フォントサイズ: 大きめ（視認性重視）

## カード表示

バトル画面では実際のCard.tscnシーンをインスタンス化して表示する。

**仕様:**
- Card.tscn（res://scenes/Card.tscn）をインスタンス化
- スケール: 3.9倍（元サイズ 220×293 → 858×1143）
- `load_dynamic_creature_data()`でクリーチャーデータを設定
- マウスイベントは無効化（バトル画面では選択不要）

**配置:**
- 画面中央を基準に左右均等配置
- カード間スペース: 片側300px（合計600px）
- 攻撃側: 中央 - 300 - カード幅
- 防御側: 中央 + 300
- Y位置: 画面中央から550px上

## 実装ファイル構成

```
res://scripts/battle_screen/
├── battle_screen.gd            # メイン制御（CanvasLayer）
├── battle_creature_display.gd  # クリーチャー表示制御（Card.tscnインスタンス化）
├── hp_ap_bar.gd                # バー制御（固定位置、最大値100固定）
├── damage_popup.gd             # ポップアップ制御
├── skill_label.gd              # スキル名表示制御（36pt）
├── transition_layer.gd         # 画面遷移制御
└── battle_screen_manager.gd    # 既存システムとの連携

res://scripts/battle/
└── battle_skill_processor.gd   # スキル適用（1つずつアニメーション対応）
```

## 既存システムとの連携

### BattleScreenManager
```gdscript
class_name BattleScreenManager

signal intro_completed
signal skill_animation_completed
signal attack_animation_completed
signal battle_screen_closed

func start_battle(attacker_data, defender_data, item_data = null):
	# トランジション → バトル画面表示 → イントロ演出
	pass

func show_skill_activation(side: String, skill_name: String, effects: Dictionary):
	# スキル発動演出（1.5秒）
	# side: "attacker" or "defender"
	# effects: {hp_data, ap}
	pass

func show_attack(attacker_side: String, damage: int):
	# 攻撃演出
	pass

func show_damage(side: String, amount: int):
	# ダメージ表示
	pass

func update_hp(side: String, hp_data: Dictionary):
	# HPバー更新（1.5秒アニメーション）
	pass

func update_ap(side: String, value: int):
	# APバー更新（1.5秒アニメーション）
	pass

func end_battle(result: int):
	# 結果表示 → トランジション → 閉じる
	pass
```

## 開発フェーズ

### Phase 1: 基本画面 ✅
- [x] TransitionLayer作成
- [x] BattleScreen基本レイアウト
- [x] カード表示（Card.tscnインスタンス化）
- [x] HP/APバー（固定位置配置）

### Phase 2: アニメーション ✅
- [x] 画面遷移（フェードイン/アウト）
- [x] カードスライドイン
- [x] HP/APバーのTweenアニメーション（1.5秒）
- [x] ダメージポップアップ
- [x] クリック待ち機能
- [x] 右から順にHP消費するアニメーション

### Phase 3: スキル演出 ✅
- [x] スキル名表示（36pt、1.5秒）
- [x] スキル1つずつアニメーション表示
- [x] 攻撃アニメーション
- [ ] 基本エフェクト

### Phase 4: 既存システム連携 ✅
- [x] BattleScreenManager実装
- [x] battle_system.gdとの統合
- [x] battle_skill_processor.gdのスキル別アニメーション対応
- [x] awaitによる演出待機

### Phase 5: サウンド・仕上げ
- [ ] 効果音追加
- [ ] BGM切り替え
- [ ] エフェクト追加・調整

## 実装メモ

### 2024年12月実装
- BattleCreatureDisplayでCard.tscnをインスタンス化
- HPバーを固定位置に配置（カードと連動しない）
- バトル開始後のクリック待ち機能
- カード間隔: 片側300px（合計600px）
- HPバー間隔: 中央から左右に300pxずつ
- HP/APバー最大値100固定（100以上でもバーは100%で止まる）
- スキル1つずつアニメーション表示（1.5秒）
- スキル名表示を大きく（36pt、背景300×60px）
- HP消費アニメーション: 右から順（黄→水色→緑）
