# CPU移動判断システム仕様書

## 概要

CPUの移動方向決定、分岐選択、ホーリーワード使用判断を行う。

**ファイル**: `scripts/cpu_ai/cpu_movement_evaluator.gd`

---

## チェックポイント距離事前計算システム

### 概要

マップロード時に、各チェックポイントから全タイルへの最短距離をBFSで事前計算する。
これにより、分岐選択時に「どの方向がチェックポイントに近いか」を高速に判定できる。

**ファイル**: `scripts/cpu_ai/checkpoint_distance_calculator.gd`

### 初期化タイミング

- `CPUMovementEvaluator._ensure_checkpoint_distances_calculated()` で遅延初期化
- 最初のCPU分岐選択時に計算される（ワープペア登録後）

### ワープの扱い

- **通過型ワープ（warp）**: ワープタイルに入ると即座にワープ先に飛び、そのまま進む
  - ワープタイル自体には停止できない
  - BFSでは、ワープペアを「同じ場所」として扱い、両方の隣接を統合
- **停止型ワープ（warp_stop）**: 止まったときにワープ発動 → コスト+1

### 主要メソッド

```gdscript
# 距離取得
func get_distance(tile_index: int, checkpoint_id: String) -> int

# 最も近い未訪問チェックポイント取得
func get_nearest_unvisited_checkpoint(tile_index: int, visited_checkpoints: Array) -> Dictionary
# 返り値: { "checkpoint_id": String, "distance": int }
```

### 制限事項

- 進行方向を考慮していない（全方向の最短距離で計算）
- Uターンを含む経路も最短として計算される
- そのため、方向ボーナスより**CP通過ボーナス**の影響が大きい

---

## 経路シミュレーション

### simulate_path()

指定位置から指定歩数の経路をシミュレートし、停止位置を特定。

**考慮要素**:
- 分岐タイルの開閉状態
- 足止め（呪い・スキル）
- ワープタイル
- 歩行逆転呪い

```gdscript
func simulate_path(start_tile: int, steps: int, player_id: int, came_from: int = -1) -> Dictionary
# 返り値: { path: Array, stop_tile: int, forced_stop: bool, forced_stop_at: int }
```

---

## スコア計算（現行方式: v2 - 最短CP方向優先 + 魔力ボーナス）

### 基本方針

**分岐での選択ルール**:
1. **最短未所持CP方向に進む**（絶対原則）
2. ただし、その方向のスコアがマイナスなら選ばない
3. 両方マイナスの場合:
   - マイナス差が1000以内 → 最短CP方向を選ぶ
   - マイナス差が1000超 → マイナスが小さい方を選ぶ

### 総合スコア（経路評価）

```
基礎スコア = 停止位置スコア（のみ）
```

※経路スコア、CP通過ボーナスは除外

### 分岐選択時の最終スコア

```
最終スコア = 基礎スコア + (最短CP方向なら手持ち魔力)
```

最短CP方向には手持ち魔力をボーナスとして加算。
これにより、マイナススコア時に破産するかどうかの判断が可能。

### スコア定数

```gdscript
# 停止位置
SCORE_STOP_ENEMY_CANT_WIN = -通行料        # 敵領地（倒せない）
SCORE_STOP_ENEMY_CAN_WIN = +通行料×2       # 敵領地（倒せる）
SCORE_STOP_EMPTY_MATCH = 50                # 空き地（属性一致）
SCORE_STOP_EMPTY_MISMATCH = 20             # 空き地（属性不一致）
SCORE_STOP_SPECIAL = 50                    # 特殊タイル

# 足止め
SCORE_FORCED_STOP_PENALTY = -500           # 足止めペナルティ（倒せない場合）

# 以下は現行方式では未使用
# SCORE_PATH_CHECKPOINT_PASS = 0           # 経路上CP通過ボーナス（削除）
# SCORE_DIRECTION_UNVISITED_GATE = 1200    # 方向ボーナス（削除）
```

### 動作例（タイル2での分岐、魔力2950）

```
タイル3方向: CP[W]まで4歩（最短）
  基礎スコア: 50
  最終スコア: 50 + 2950 = 3000

タイル24方向: CP[N]まで6歩
  基礎スコア: 50
  最終スコア: 50（魔力ボーナスなし）

→ タイル3選択 ✓
```

---

## 旧方式参考（v1 - 方向ボーナス + CP通過ボーナス）

<details>
<summary>クリックして展開</summary>

### 総合スコア

```
総合スコア = 停止位置スコア + (経路スコア / 10) + CP通過ボーナス + 方向ボーナス
```

### スコア定数

```gdscript
# 停止位置
SCORE_STOP_EMPTY_MATCH = 300               # 空き地（属性一致）
SCORE_STOP_EMPTY_MISMATCH = 100            # 空き地（属性不一致）

# チェックポイント通過ボーナス（経路スコアとは別枠、除算されない）
SCORE_PATH_CHECKPOINT_PASS = 1500          # 経路上でチェックポイント通過（シグナル取得）

# 方向ボーナス
SCORE_DIRECTION_UNVISITED_GATE = 1200      # 未訪問ゲート方向（距離で減少）
```

### 方向ボーナス判定

事前計算テーブルを使用して、最も近い未訪問チェックポイントへの距離を取得：
- 最大1200点（距離0の場合）
- 距離が1増えるごとに60点減少
- 距離20以上で0点

```gdscript
var distance_bonus = max(0, 1200 - (distance * 60))
```

</details>

---

## 方向選択（decide_direction）

ゲームスタート時やワープ後に呼ばれる。

```
1. 両方向（+1/-1）の経路を評価
2. スコアが高い方向を選択
```

---

## 分岐選択（decide_branch_choice）

移動中に分岐タイルに到達した場合。

```
1. 残り歩数で各選択肢の停止位置を計算
2. 最高スコアの選択肢を返す
```

---

## ホーリーワード判断

`cpu_spell_ai.gd` の `_evaluate_holy_word_spell()` で処理。

### 攻撃的使用

敵を自分のLv3以上領地に止まらせる。

```
1. 各敵の停止位置を計算（ダイス固定値）
2. 自分のLv3+領地に止まるか判定
3. 敵が侵略して勝てないか確認
4. 最高通行料の組み合わせを選択
```

### 防御的使用

自分が敵の高額領地を回避する。

```
1. 経路上の危険な位置（敵Lv3+領地）をリストアップ
2. ホーリーワードの停止位置が：
   - いずれの危険にも止まらない
   - かつ、少なくとも1つの危険を超えている
   → 使用
```

| スペル | ダイス目 | コスト |
|--------|---------|--------|
| ホーリーワード1 | 1 | 30G |
| ホーリーワード3 | 3 | 10G |
| ホーリーワード6 | 6 | 50G |
| ホーリーワード8 | 8 | 80G |
