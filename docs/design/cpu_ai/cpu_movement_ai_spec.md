# CPU移動判断システム仕様書

## 概要

CPUの移動方向決定、分岐選択、ホーリーワード使用判断を行う。

**ファイル**: `scripts/cpu_ai/cpu_movement_evaluator.gd`

---

## 経路シミュレーション

### simulate_path()

指定位置から指定歩数の経路をシミュレートし、停止位置を特定。

**考慮要素**:
- 分岐タイルの開閉状態
- 足止め（呪い・スキル）
- ワープタイル
- 歩行逆転呪い

```gdscript
func simulate_path(start_tile: int, steps: int, player_id: int, came_from: int = -1) -> Dictionary
# 返り値: { path: Array, stop_tile: int, forced_stop: bool, forced_stop_at: int }
```

---

## スコア計算

### 総合スコア

```
総合スコア = 停止位置スコア + (経路スコア / 10) + 方向ボーナス
```

### スコア定数

```gdscript
# 停止位置
SCORE_STOP_ENEMY_CANT_WIN = -通行料        # 敵領地（倒せない）
SCORE_STOP_ENEMY_CAN_WIN = +通行料×2       # 敵領地（倒せる）
SCORE_STOP_EMPTY_MATCH = 300               # 空き地（属性一致）
SCORE_STOP_EMPTY_MISMATCH = 100            # 空き地（属性不一致）
SCORE_STOP_SPECIAL = 50                    # 特殊タイル

# 方向ボーナス
SCORE_DIRECTION_UNVISITED_GATE = 1200      # 未訪問ゲート方向

# 足止め
SCORE_FORCED_STOP_PENALTY = -500           # 足止めペナルティ（倒せない場合）
```

### 方向ボーナス判定

両方向の未訪問ゲートまでの距離を比較：
- 片方だけゲートがある → そちらにボーナス
- 両方にゲートがある → 近い方にボーナス（同距離なら両方）

---

## 方向選択（decide_direction）

ゲームスタート時やワープ後に呼ばれる。

```
1. 両方向（+1/-1）の経路を評価
2. スコアが高い方向を選択
```

---

## 分岐選択（decide_branch_choice）

移動中に分岐タイルに到達した場合。

```
1. 残り歩数で各選択肢の停止位置を計算
2. 最高スコアの選択肢を返す
```

---

## ホーリーワード判断

`cpu_spell_ai.gd` の `_evaluate_holy_word_spell()` で処理。

### 攻撃的使用

敵を自分のLv3以上領地に止まらせる。

```
1. 各敵の停止位置を計算（ダイス固定値）
2. 自分のLv3+領地に止まるか判定
3. 敵が侵略して勝てないか確認
4. 最高通行料の組み合わせを選択
```

### 防御的使用

自分が敵の高額領地を回避する。

```
1. 経路上の危険な位置（敵Lv3+領地）をリストアップ
2. ホーリーワードの停止位置が：
   - いずれの危険にも止まらない
   - かつ、少なくとも1つの危険を超えている
   → 使用
```

| スペル | ダイス目 | コスト |
|--------|---------|--------|
| ホーリーワード1 | 1 | 30G |
| ホーリーワード3 | 3 | 10G |
| ホーリーワード6 | 6 | 50G |
| ホーリーワード8 | 8 | 80G |
