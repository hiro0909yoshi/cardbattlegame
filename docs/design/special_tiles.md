# 特殊タイル仕様

**バージョン**: 1.0  
**最終更新**: 2025年12月16日

---

## 概要

特殊タイルはクリーチャー配置不可の特別なマス。各タイルに固有の効果がある。

---

## 1. カード購入タイル (card_buy)

### 基本情報
| 項目 | 値 |
|------|-----|
| tile_type | `card_buy` |
| 停止可 | ✅ |
| 発動タイミング | 停止時 |
| 色 | 緑 |

### 効果
1. 停止すると**スペル・アイテム**からランダムで3枚表示
2. プレイヤーは1枚を選択して購入可能（購入しない選択肢あり）
3. 購入価格 = **カードコストの50%（切り上げ）**
4. 購入したカードは**手札**に追加

### 処理フロー
```
停止
  ↓
スペル・アイテムから3枚ランダム選出（CardLoaderから）
  ↓
UI: 3枚表示 + 「買わない」ボタン
  ↓
プレイヤー選択
  ├─ カード選択 → コスト50%（切り上げ）支払い → 手札に追加
  └─ 買わない → 何もしない
  ↓
完了
```

### 計算例
- カードコスト100 → 購入価格50
- カードコスト70 → 購入価格35
- カードコスト15 → 購入価格8（切り上げ）

---

## 2. カード譲渡タイル (card_give)

### 基本情報
| 項目 | 値 |
|------|-----|
| tile_type | `card_give` |
| 停止可 | ✅ |
| 発動タイミング | 停止時 |
| 色 | 黄 |

### 効果
1. 停止すると**クリーチャー/アイテム/スペル**の3種類から選択
2. 選択した種類のカードを**自分の山札**からランダムで1枚取得
3. 取得したカードは**手札**に追加
4. **無料**

### 処理フロー
```
停止
  ↓
UI: 「クリーチャー」「アイテム」「スペル」ボタン表示
  ↓
プレイヤー選択
  ↓
山札から該当種類のカードを検索
  ├─ 見つかった → ランダム1枚を手札に移動
  └─ 見つからない → メッセージ表示（該当カードなし）
  ↓
完了
```

### 注意
- 山札（deck）から取得するため、山札にない種類は取得不可
- 取得したカードは山札から消える

---

## 3. 魔法石タイル (magic_stone)

### 基本情報
| 項目 | 値 |
|------|-----|
| tile_type | `magic_stone` |
| 停止可 | ✅ |
| 発動タイミング | **通過時・停止時** |
| 色 | シアン |

### 概念
魔法石は4属性（火・水・土・風）の株式のようなアイテム。価値は盤面の状況により動的に変化する。

### 石の種類
| 石 | 初期価値 |
|----|---------|
| 火の石 | 50G |
| 水の石 | 50G |
| 土の石 | 50G |
| 風の石 | 50G |

### 価値計算

全プレイヤーの全タイルを参照して動的に計算。

#### 計算式
```
石の価値 = 初期値(50) + 同属性ボーナス - 相克属性ペナルティ

同属性ボーナス = (同属性クリーチャー数 × 10) + (同属性総レベル × 5)
相克属性ペナルティ = (相克属性クリーチャー数 × 5) + (相克属性総レベル × 2.5)
                   ※ペナルティ係数はボーナス係数の半分
```

#### 相克関係
| 石 | 同属性（+） | 相克属性（-） |
|----|-----------|--------------|
| 火の石 | 火 | 水 |
| 水の石 | 水 | 火 |
| 土の石 | 土 | 風 |
| 風の石 | 風 | 土 |

#### 計算例
盤面状況:
- 火クリーチャー: 3体、総レベル7
- 水クリーチャー: 2体、総レベル4

**火の石の価値:**
```
= 50 + (3 × 10) + (7 × 5) - (2 × 5) - (4 × 2.5)
= 50 + 30 + 35 - 10 - 10
= 95G
```

**水の石の価値:**
```
= 50 + (2 × 10) + (4 × 5) - (3 × 5) - (7 × 2.5)
= 50 + 20 + 20 - 15 - 17.5
= 57.5G → 57G（切り捨て）
```

### 売買
| 操作 | 価格 |
|------|------|
| 購入 | 現在価値 |
| 売却 | 現在価値 |

### 所持上限
なし（無制限に購入可能）

### 総魔力への影響
所持している石の**現在価値**が総魔力に加算される

```
総魔力 = 所持魔力 + 土地価値 + 石の現在価値合計
```

### 処理フロー
```
通過 or 停止
  ↓
UI: ショップ画面表示
  ├─ 各石の現在価値表示
  ├─ 所持数表示
  ├─ 「購入」「売却」「買わない」ボタン
  ↓
プレイヤー操作
  ├─ 購入 → 魔力支払い → 石を取得
  ├─ 売却 → 石を手放す → 魔力獲得
  └─ 買わない → 何もしない
  ↓
完了
```

---

## 4. 魔法タイル (magic)

### 基本情報
| 項目 | 値 |
|------|-----|
| tile_type | `magic` |
| 停止可 | ✅ |
| 発動タイミング | 停止時 |
| 色 | ピンク |

### 効果
1. 停止すると**全スペル**からランダムで3枚表示
2. プレイヤーは1枚を選択して使用可能（使用しない選択肢あり）
3. 使用時は**カードコストを支払う**
4. 使用後のカードは消滅（手札には入らない）

### 処理フロー
```
停止
  ↓
全スペルから3枚ランダム選出（CardLoaderから）
  ↓
UI: 3枚表示 + 「使わない」ボタン
  ↓
プレイヤー選択
  ├─ スペル選択 → コスト支払い → 通常のスペル使用処理
  │    （ターゲット選択等、通常のスペルUIを使用）
  └─ 使わない → 何もしない
  ↓
完了
```

### 注意
- スペル使用処理は既存のSpellPhaseHandler等を流用
- ターゲット指定が必要なスペルは通常通りUI表示

---

## 5. ベースタイル (base)

### 基本情報
| 項目 | 値 |
|------|-----|
| tile_type | `base` |
| 停止可 | ✅ |
| 発動タイミング | 停止時 |
| 色 | グレー |

### 効果
1. 停止すると**任意の空き地**にクリーチャーを配置可能
2. **手札**からクリーチャーを選択
3. 通常の**カードコスト**を支払う
4. 通常の**配置制限**（lands_required）も適用
5. 配置しない選択肢あり

### 処理フロー
```
停止
  ↓
UI: 手札からクリーチャー選択
  ├─ lands_required を満たさないカードはグレーアウト
  ├─ コストが足りないカードもグレーアウト
  ↓
プレイヤー選択
  ├─ クリーチャー選択 → 空き地選択UI表示
  │    ↓
  │    空き地タイル選択
  │    ↓
  │    コスト支払い → 配置実行
  └─ 配置しない → 何もしない
  ↓
完了
```

### 制限チェック
1. **lands_required**: 必要属性土地数を満たしているか
2. **カードコスト**: 魔力が足りているか
3. **空き地**: 配置可能なタイルがあるか

---

## 実装優先度

| 優先度 | タイル | 理由 |
|--------|--------|------|
| 1 | card_give | シンプル（無料、山札から取得のみ） |
| 2 | card_buy | シンプル（コスト計算のみ追加） |
| 3 | magic | 既存スペル処理を流用可能 |
| 4 | base | 既存配置処理を流用可能 |
| 5 | magic_stone | 新規システム（石の管理、価値計算） |

---

## 関連ファイル

- `scripts/special_tile_system.gd` - 特殊タイル処理
- `scripts/tile_helper.gd` - タイルタイプ定数
- `scripts/quest/stage_loader.gd` - タイルシーンマッピング
- `data/master/maps/map_diamond_20_v2.json` - 特殊タイル配置マップ

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025/12/16 | 初版作成 |
| 2025/12/16 | 魔法石の価値計算式追加（相克属性ペナルティ含む） |
