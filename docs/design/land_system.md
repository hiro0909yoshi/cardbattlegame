# 土地システム統合仕様

## 📋 目次
1. [隣接判定システム（TileNeighborSystem）](#隣接判定システムtileneighborsystem)
2. [土地ボーナスシステム](#土地ボーナスシステム)
3. [ダウン状態システム](#ダウン状態システム)
4. [領地コマンド詳細](#領地コマンド詳細)
5. [地形変化システム](#地形変化システム)(#領地コマンド詳細)

---

## 隣接判定システム（TileNeighborSystem）

### 概要
タイルの物理的な隣接関係を座標ベースで判定するシステム。

### 判定方法
```gdscript
# XZ平面での距離計算
const TILE_SIZE = 4.0
const NEIGHBOR_THRESHOLD = 4.5  # タイルサイズより10%大きい

var dx = abs(my_pos.x - other_pos.x)
var dz = abs(my_pos.z - other_pos.z)
var distance_xz = sqrt(dx * dx + dz * dz)

if distance_xz < NEIGHBOR_THRESHOLD:
	# 隣接と判定
```

### 使用例
```gdscript
# スキル条件: 「隣接した自領地なら強打」
var neighbors = board_system.tile_neighbor_system.get_spatial_neighbors(tile_index)
# → [5, 7]  # タイル6の隣接タイル

var has_ally = board_system.tile_neighbor_system.has_adjacent_ally_land(
	tile_index, player_id, board_system
)
# → true/false
```

### キャッシュ機構
- 初回起動時に全タイルの隣接関係を計算
- 結果をキャッシュして高速化（O(1)で取得）
- マップ変更時は再計算可能

### 拡張性
- 十字路・T字路: 4方向以上の隣接にも対応
- 立体交差: Y軸も考慮可能（将来）

### 主要メソッド
```gdscript
# 初期化
func setup(tiles: Dictionary)

# 隣接取得
func get_spatial_neighbors(tile_index: int) -> Array
func get_sequential_neighbors(tile_index: int) -> Array

# 条件判定
func has_adjacent_ally_land(tile_index: int, player_id: int, board_system) -> bool
```

### アルゴリズム
1. 全タイルペアの距離を計算（XZ平面）
2. 閾値4.5以内を隣接と判定
3. 結果を`spatial_neighbors_cache`にキャッシュ

### パフォーマンス
- 初回構築: O(N²) - 20タイルで400回計算、<10ms
- 実行時取得: O(1) - キャッシュから即座に取得

---

## 土地ボーナスシステム

### 概要
クリーチャーと土地の属性が一致すると、土地レベルに応じたHPボーナスが得られる。

### 計算式
```
土地ボーナスHP = 土地レベル × 10

例:
- レベル1の火属性土地 + 火属性クリーチャー → +10HP
- レベル3の水属性土地 + 水属性クリーチャー → +30HP
- レベル5の風属性土地 + 風属性クリーチャー → +50HP (最大)
```

### 実装場所
- 召喚時: `BaseTile.place_creature()` → `_apply_land_bonus()`
- バトル時: `BattleSystem._apply_attacker_land_bonus()`

### データ構造
```gdscript
creature_data = {
	"name": "フェニックス",
	"element": "火",
	"hp": 30,              # 基本HP
	"land_bonus_hp": 20,   # 土地ボーナス（別管理）
	# 表示HP = 30 + 20 = 50
}
```

### 特徴
- `hp`とは別フィールドで管理
- 「貫通」「巻物」スキルで無視される（将来実装）
- 常時適用（召喚時・バトル時）

---

## ダウン状態システム

### 概要
土地でアクション（召喚、レベルアップ、移動、交換）を実行すると、その土地は「ダウン状態」になり、次のターンまで再度選択できなくなる。

### ダウン状態の設定タイミング
- 召喚実行後
- レベルアップ実行後
- クリーチャー移動実行後（移動先の土地）
- クリーチャー交換実行後

### 例外: 不屈スキル
- 不屈スキルを持つクリーチャーがいる土地は、アクション後もダウン状態にならない
- 何度でも領地コマンドを実行可能

### ダウン状態の解除タイミング
- プレイヤーがスタートマスを通過したとき
- 全プレイヤーの全土地のダウン状態が一括解除される

### 制約
- **ダウン状態の土地は領地コマンドで選択できない**
  - `get_player_owned_lands()`でダウン状態の土地を除外
  - UI上で選択肢として表示されない
- ダウン状態でもクリーチャーは通常通り機能する
  - バトルの防御側として機能
  - 通行料は発生する

### 実装
```gdscript
# ダウン状態の設定
tile.set_down(true)

# ダウン状態の確認
if tile.is_down():
	# 選択不可

# ダウン状態の解除（スタート通過時）
movement_controller.clear_all_down_states_for_player(player_id)
```

### 不屈スキルの実装
```gdscript
# SkillSystem.gd
static func has_unyielding(creature_data: Dictionary) -> bool:
	if creature_data.is_empty():
		return false
	var ability_detail = creature_data.get("ability_detail", "")
	return "不屈" in ability_detail

# ダウン状態設定時の不屈チェック（各アクション処理）
if tile.has_method("set_down_state"):
	var creature = tile.creature_data if tile.has("creature_data") else {}
	if not SkillSystem.has_unyielding(creature):
		tile.set_down_state(true)
	else:
		print("不屈によりダウンしません")
```

### 不屈持ちクリーチャー一覧（16体）
- 火: シールドメイデン(14), ショッカー(18), バードメイデン(28)
- 水: エキノダーム(113), カワヒメ(117), マカラ(141)
- 地: キャプテンコック(207), ヒーラー(234), ピクシー(235), ワーベア(249)
- 風: グレートニンバス(312), トレジャーレイダー(331), マーシャルモンク(341), マッドハーレクイン(342)
- 無: アーキビショップ(403), シャドウガイスト(418)

### ビジュアル表示（枠の色）
土地の状態は枠の色で視覚的に確認できる：

| 状態 | 枠の表示 |
|------|----------|
| 未所有 | 元の黒い枠（変化なし） |
| 所有中（ダウン状態） | プレイヤー色で常時点灯 |
| 所有中（アクティブ） | グレー⇔プレイヤー色で滑らかに点滅（周期2.5秒） |

**実装詳細**:
- 点滅はsin波で滑らかにフェード（急な切り替えではない）
- 発光の強さは控えめに設定（emission_energy_multiplier: 0.3〜1.0）
- マテリアルの切り替えではなく、色の補間で実現

### デバッグコマンド
- **Uキー**: 現在プレイヤーの全土地のダウン状態を即座に解除
- テスト用の機能（本番では無効化予定）

---

## 領地コマンド詳細

### タイル到着時の動作

移動完了後、到着したタイルの状態に応じて以下の動作となる：

| 到着タイル | 動作 | 備考 |
|-----------|------|------|
| 空き地 | 召喚UI表示 | クリーチャーを召喚して土地獲得可能 |
| 自分の土地 | 召喚不可（パスして領地コマンドへ） | 領地コマンドでレベルアップ・交換等を実行 |
| 敵の土地 | バトルUI表示 | クリーチャーで侵略可能 |
| 特殊タイル（空き地） | 召喚不可（パスして領地コマンドへ） | チェックポイント・ワープ等は召喚不可 |
| 特殊タイル（敵地） | バトルUI表示 | 通常の敵地と同様 |

**実装**:
- 召喚不可の場合は `show_summon_ui_disabled()` でカード選択UIをグレーアウト表示
- プレイヤーは「召喚しない」（パス）を選択して領地コマンドフェーズへ進む
- 領地コマンドで交換等を行う際は `card_selection_filter` をクリアして正常に動作させる

### フェーズ管理（状態遷移）

領地コマンドは以下の状態（フェーズ）で管理される。各フェーズは「戻る」操作で1つ前のフェーズに戻れる。

**状態定義（LandCommandHandler.State）**:
```gdscript
enum State {
	CLOSED,              # 領地コマンド非表示
	SELECTING_LAND,      # 土地選択中
	SELECTING_ACTION,    # アクション選択中
	SELECTING_LEVEL,     # レベル選択中
	SELECTING_SWAP,      # 交換クリーチャー選択中
	SELECTING_MOVE_DEST, # 移動先選択中
	SELECTING_TERRAIN    # 地形選択中
}
```

**フェーズ遷移図**:
```
┌─────────────────────────────────────────────────────────────────┐
│                        召喚フェーズ                              │
│                     (card_selection_ui)                          │
└─────────────────────┬───────────────────────────────────────────┘
					  │ 領地コマンドボタン押下
					  ▼
┌─────────────────────────────────────────────────────────────────┐
│                     SELECTING_LAND                               │
│                     （土地選択中）                                │
│   操作: ↑↓で土地切替、Enterで確定、数字キーで即確定             │
│   戻る: 領地コマンド終了 → 召喚フェーズへ                        │
└─────────────────────┬───────────────────────────────────────────┘
					  │ Enter / 数字キー
					  ▼
┌─────────────────────────────────────────────────────────────────┐
│                    SELECTING_ACTION                              │
│                   （アクション選択中）                            │
│   操作: L=レベルアップ, M=移動, S=交換, T=地形変化               │
│   戻る: SELECTING_LAND へ                                        │
└───────┬─────────┬─────────┬─────────┬───────────────────────────┘
		│ L       │ M       │ S       │ T
		▼         ▼         ▼         ▼
┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐
│SELECTING_ │ │SELECTING_ │ │SELECTING_ │ │SELECTING_ │
│  LEVEL    │ │ MOVE_DEST │ │   SWAP    │ │ TERRAIN   │
│(レベル選択)│ │(移動先選択)│ │(交換選択) │ │(地形選択) │
│           │ │           │ │           │ │           │
│ 戻る:     │ │ 戻る:     │ │ 戻る:     │ │ 戻る:     │
│ ACTION へ │ │ ACTION へ │ │ ACTION へ │ │ ACTION へ │
└─────┬─────┘ └─────┬─────┘ └─────┬─────┘ └─────┬─────┘
	  │ 選択確定    │ 選択確定    │ 選択確定    │ 選択確定
	  ▼             ▼             ▼             ▼
┌─────────────────────────────────────────────────────────────────┐
│              アクション実行 → complete_action()                  │
│                         ↓                                        │
│                    ターン終了                                     │
└─────────────────────────────────────────────────────────────────┘
```

**重要な設計原則**:
- 各フェーズは`cancel()`メソッドで1つ前に戻る
- `cancel()`は`land_command_handler.gd`で統一管理
- 各選択UI（レベル選択、カード選択等）の戻るボタンは`cancel()`を呼ぶ
- アクション実行後は`complete_action()`→`end_turn()`で統一的にターン終了

### グローバルアクションボタン

領地コマンドを含む全UIで、画面右下の**グローバルアクションボタン**（決定/戻る）を使用する。

**ボタン仕様**:
- 配置: 画面右下に縦並び（上: 決定、下: 戻る）
- サイズ: 直径200px、フォント28px
- キーボード連動: Enter（決定）、Escape（戻る）

**状況別のボタンテキスト**:
| 状況 | 決定ボタン | 戻るボタン |
|------|-----------|-----------|
| 召喚フェーズ | - | 召喚しない |
| 領地選択 | - | 閉じる |
| アクションメニュー | - | 戻る |
| レベル選択 | - | 戻る |
| クリーチャー交換選択 | - | 交換しない |
| クリーチャー情報パネル（召喚） | 召喚 | 戻る |
| クリーチャー情報パネル（交換） | 交換 | 戻る |

**交換キャンセル時の動作**:
- 「交換しない」ボタン → 召喚フェーズに戻る（ターン終了しない）
- 領地コマンドの状態をリセットし、カード選択UIを再初期化

**アクションメニュー表示時**:
- 選択した土地のクリーチャー情報パネルを自動表示（閲覧モード）
- アクションメニューは右側、クリーチャー情報パネルは中央左に配置

### UIフラグ管理とターン終了フロー

**重要なフラグ**: `card_selection_ui.is_active`
- `true`: カード選択可能（召喚フェーズ）
- `false`: カード選択不可（領地コマンド中・その他のフェーズ）

**実装**:
```gdscript
// 領地コマンドを開く時
ui_manager.card_selection_ui.is_active = false  // カード選択を無効化
ui_manager.clear_back_action()  // グローバルボタンの「召喚しない」をクリア

// 領地コマンドを閉じる時（end_turn()で統一的に処理）
// 1. is_ending_turnフラグを立てる（最優先）
is_ending_turn = true

// 2. 領地コマンドを閉じる
land_command_handler.close_land_command()

// 3. UIを非表示にする
ui_manager.hide_land_command_button()
ui_manager.hide_card_selection_ui()

// 4. _on_land_command_closed()がis_ending_turnをチェックして再初期化をスキップ
```

**重要な設計原則**:
- すべてのアクション（レベルアップ、移動、交換、地形変化）は`complete_action()`を呼ぶだけ
- `complete_action()` → `tile_action_completed`シグナル → `end_turn()`
- `end_turn()`で領地コマンドとUIを統一的に閉じる
- 各アクション内で個別に`close_land_command()`を呼ばない
- **各UI画面はアクティブ時にグローバルボタンにコールバック登録、非アクティブ時にクリア**

### 基本制約
1. **1ターンに1回のみ実行可能**
   - レベルアップ、移動、交換、地形変化のいずれか1つのみ
   - 実行後は自動的にターン終了
   
2. **召喚と領地コマンドは排他的**
   - 召喚を実行した場合、領地コマンドは実行できない
   - 領地コマンドを実行した場合、召喚は実行できない
   - どちらか一方のみ選択可能

3. **ダウン状態の土地は選択不可**
   - アクション実行済みの土地はダウン解除まで使用不可
   - 選択肢として表示されない
   - **例外**: 不屈スキル持ちのクリーチャーがいる土地はダウンしないため、何度でも使用可能

### 土地選択の操作方法
- **矢印キー（↑↓←→）**: 土地を切り替え（プレビュー）
- **Enterキー**: 選択を確定してアクションメニューへ
- **数字キー（1-0）**: 該当する土地を即座に確定
- **Escapeキー / 戻るボタン**: 閉じる（召喚フェーズに戻る）

### アクション選択
- **Lキー**: レベルアップ
- **Mキー**: クリーチャー移動
- **Sキー**: クリーチャー交換
- **Tキー**: 地形変化
- **Escapeキー / 戻るボタン**: 土地選択に戻る

---

## 1. レベルアップ

### フロー
```
移動完了
  ↓
領地コマンドボタン表示（人間プレイヤーのみ）
  ↓
土地選択（数字キー1-0）
  ├─ ダウン状態の土地は選択不可
  └─ 所有している土地のみ選択可能
  ↓
アクションメニュー表示（右側中央パネル）
  ├─ [L] レベルアップ
  ├─ [M] 移動
  ├─ [S] 交換
  └─ [C] 戻る（土地選択に戻る）
  ↓
レベルアップ選択（Lキー）
  ↓
レベル選択画面表示
  ├─ 現在レベル表示
  ├─ Lv2-5選択ボタン
  │   ├─ 累計コスト表示
  │   │   Lv1→2: 80G
  │   │   Lv1→3: 240G
  │   │   Lv1→4: 620G
  │   │   Lv1→5: 1200G
  │   └─ EP不足のボタンは無効化
  └─ [C] 戻る（アクションメニューに戻る）
  ↓
レベル選択（Lv2-5いずれか）
  ↓
レベルアップ実行
  ├─ EP消費（累計コスト）
  ├─ 土地レベル更新
  ├─ ダウン状態設定
  └─ UI更新
  ↓
ターン終了
```

### レベルコスト（累計方式）
```gdscript
const LEVEL_COSTS = {
	0: 0,
	1: 0,
	2: 80,      // Lv1→2: 80G
	3: 240,     // Lv1→3: 240G (80 + 160)
	4: 620,     // Lv1→4: 620G (80 + 160 + 380)
	5: 1200     // Lv1→5: 1200G (80 + 160 + 380 + 580)
}

// コスト計算
var cost = LEVEL_COSTS[target_level] - LEVEL_COSTS[current_level]
```

### 実装クラス
- `LandCommandHandler`: 領地コマンドのロジック
- `UIManager`: アクションメニュー・レベル選択パネルのUI
- `GameFlowManager`: ターン終了処理

---

## 2. クリーチャー移動

### フロー
```
領地コマンド → 移動を選択
  ↓
移動元の土地を選択（ダウン状態除外）
  ↓
隣接する移動先を表示
  ├─ 空き地
  ├─ 自分の土地（移動不可）
  └─ 敵の土地
  ↓
移動先を選択（↑↓キーで切り替え）
  ↓
【空き地への移動】
  - 移動元が空き地になる
  - 移動先に土地獲得
  - クリーチャー配置
  - ダウン状態設定
  - ターン終了
  
【敵地への移動】
  - 移動元が空き地になる
  - バトル実行
  - 勝利: 土地獲得 + ダウン設定
  - 敗北: クリーチャー消滅
  - ターン終了
```

### 実装クラス
- `LandCommandHandler.execute_move_creature()`
- `LandCommandHandler.confirm_move()`

---

## 3. クリーチャー交換

### フロー
```
領地コマンド → 交換を選択
  ↓
交換対象の土地を選択（ダウン状態除外）
  ↓
手札にクリーチャーカードがあるか確認
  ├─ なし → エラーメッセージ
  └─ あり → 次へ
  ↓
新しいクリーチャーカードを選択
  ↓
元のクリーチャーを手札に戻す
  ↓
新しいクリーチャーを召喚
  - コスト支払い（mp × 10G）
  - 土地ボーナス適用
  - 土地レベル継承
  - ダウン状態設定
  ↓
ターン終了
```

### 実装クラス
- `LandCommandHandler.execute_swap_creature()`
- `TileActionProcessor.execute_swap()`

---

## 4. 地形変化

### 概要
土地の属性（火/水/土/風）を変更するシステム。領地コマンドから実行、またはスペル/スキルからも発動可能。

### 操作方法
1. 土地を選択 → [T]キーで地形変化
2. 変更先の属性を選択（火/水/土/風の4属性）
   - ↑↓キーまたは数字キー（1-4）で選択
   - [Enter]で決定、[C]でキャンセル
3. EP消費してターン終了

### コスト
```
地形変化コスト = 300 + (土地レベル × 100)G

例: Lv1=400G、Lv3=600G、Lv5=800G
```

### 制約
- 変更可能: 火/水/土/風/無属性タイル
- 変更不可: チェックポイント（0, 10）、ワープ（5, 15）
- 無属性への変更: 不可（4属性のみ選択可能）
- 実行後: ダウン状態＋ターン終了（不屈で回避可）
- **ソリッドワールド発動中**: 属性変更不可（世界呪いによるブロック）

### 引き継ぎデータ
| データ | 継承 |
|--------|------|
| レベル | ✅ |
| 所有者 | ✅ |
| クリーチャー | ✅ |
| ダウン状態 | ✅ |

### 土地ボーナスの再計算
地形変化により属性一致が変わると、土地ボーナスも自動で再計算される。

**例**:
```
火属性Lv3 + 火クリーチャー → +30HP
↓ 水属性に変更
水属性Lv3 + 火クリーチャー → 0HP（不一致）
```

### 永続バフ対応クリーチャー
| ID | 名前 | 効果 |
|----|------|------|
| 200 | アースズピリット | 配置領地で地形変化時、MHP+10 |
| 328 | デュータイタン | 配置領地で地形変化時、MHP-10 |

### 実装クラス
- `BoardSystem3D.change_tile_terrain()` - タイル交換処理
- `LandActionHelper.execute_terrain_change()` - 属性選択UI表示
- `LandActionHelper.execute_terrain_change_with_element()` - 実行処理
- `LandInputHelper.handle_terrain_selection_input()` - キー入力処理
- `LandCommandHandler` - 状態管理（`SELECTING_TERRAIN`）

### ソリッドワールド（世界呪い）対応 ⚠️

**ソリッドワールド（ID: 2047）**発動中は、全領地の土地変性（属性変更・レベルダウン）が無効になる。

**ブロックされる操作**:
| 操作 | チェック箇所 | 結果 |
|------|-------------|------|
| 領地コマンドの地形変化 | `BoardSystem3D.change_tile_terrain()` | 失敗（false返却） |
| スペルによる属性変更 | `SpellLand.change_element()` | 失敗（false返却） |
| スペルによるレベルダウン | `SpellLand.change_level(delta < 0)` | 失敗（false返却） |

**ブロックされない操作**:
- レベルアップ（`SpellLand.change_level(delta > 0)`）
- クリーチャー召喚・交換
- 土地放棄

**新規実装時の注意**:
バトル中スキルやトリガー効果で土地を変更する場合は、必ず以下のメソッドを経由すること：
- 属性変更 → `SpellLand.change_element()`
- レベル変更 → `SpellLand.change_level()`
- ランドコマンド経由 → `BoardSystem3D.change_tile_terrain()`

直接`tile.tile_type`や`tile.level`を変更するとソリッドワールドがバイパスされるため禁止。

**関連ドキュメント**: [世界呪い.md](spells/世界呪い.md) - ソリッドワールド詳細

### スペル/スキル連携
スペルコストのみで地形変化可能（領地コマンドの追加コスト不要）：
```gdscript
{
  "effect_type": "terrain_change",
  "target": "tile",
  "new_element": "fire"  // または "random"
}
```

---

## 将来計画

### 分岐路システム設計案

#### マップ設計の進化
```
現在（菱形1周）        将来（自由分岐）
	 ◇                      ◇
	◇ ◇                    ╱ ╲
   ◇   ◇                  ◇   ◇
  ◇     ◇      →         │   │
   ◇   ◇                  ◇═══◇
	◇ ◇                    ╲ ╱
	 ◇                      ◇
```

#### タイルの接続情報
```gdscript
# タイルの接続情報
{
  "index": 5,
  "connections": [4, 6, 12],  # 3方向に分岐
  "junction_type": "T-junction"  # 十字路・T字路
}
```

#### TileNeighborSystemの対応
- 十字路・T字路: 4方向以上の隣接にも対応済み
- 立体交差: Y軸も考慮可能（将来）
- 非ループ構造: 分岐のあるマップに対応可能

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025/10/25 | 1.0 | 初版作成: design.mdから土地関連システムを統合 |
| 2025/10/25 | 1.1 | 将来計画（分岐路システム）を追加 |
| 2025/12/12 | 1.3 | グローバルアクションボタン対応、交換キャンセル時の動作追加 |
| 2025/12/12 | 1.4 | アクションメニューでクリーチャー情報パネル表示、UIサイズ拡大 |
| 2025/12/13 | 1.5 | フェーズ管理（状態遷移）追加: SELECTING_LEVEL, SELECTING_SWAP状態、cancel()統一処理 |
| 2025/12/16 | 1.6 | タイル到着時の動作を追加: 自分の土地・特殊タイルでの召喚不可動作を明記 |
| 2026/01/26 | 1.7 | ダウン状態のビジュアル表示を追加: 枠の色による状態表示（点滅/常時点灯） |

---

**最終更新**: 2026年1月26日（v1.7 - ダウン状態ビジュアル表示追加）  
**関連ドキュメント**: [design.md](design.md) - プロジェクト設計書, [card_info_panels.md](card_info_panels.md) - カード情報パネル
