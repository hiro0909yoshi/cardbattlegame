# チュートリアルシステム設計

## 概要

通常のゲームシステムをベースに、チュートリアルモード時のみ操作を固定・ガイドするインタラクティブ型チュートリアル。

## 基本方針

- 通常のゲームフロー（GameFlowManager等）をそのまま使用
- チュートリアルモード時は特定の操作のみ許可
- 各ステップで説明テキストを表示（GlobalCommentUI活用）
- プレイヤーが正しい操作をしたら次のステップへ
- CPUの行動も固定（スクリプト化）

## チュートリアル1: 基本操作編

### 初期設定

**プレイヤー**
- 初期位置: タイル0（城）
- 初期手札: グリーンオーガ×2、ロングソード×1
- 初期EP: 200

**CPU**
- 初期位置: タイル0（城）
- 初期手札: グリーンオーガ×2（ドローなし）
- 初期EP: 200

**ルール**
- 目標TEP: 300（低めに設定して1周で達成可能）
- ドロー: なし（チュートリアル中はカードを引かない）

### ターン進行シナリオ

#### ターン1: ドミニオを作る

**プレイヤーターン**
1. 勝利条件の説明
   - 「目標TEPに到達して城に戻ると勝利です」
2. 方向選択
   - 「進む方向を選んでください」
   - プレイヤーが選んだ方向に進む
3. ダイス目: 3（固定）
   - 「✓ボタンでダイスを振ります」
   - グローバルボタンの説明
4. 移動後、空き地に到着
5. 召喚の説明
   - 「クリーチャーを召喚してドミニオにしましょう」
   - コストの説明（MP消費）
   - グリーンオーガを召喚
6. ドミニオボーナスの説明
   - 「属性が一致するとHPにボーナスがつきます」

**CPUターン**
1. 方向選択: プレイヤーと反対方向
2. ダイス目: 3（固定）
3. 移動後、グリーンオーガを召喚

#### ターン2: バトル

**プレイヤーターン**
1. ダイス目: 6（固定）
2. 移動してCPUのドミニオに到着
3. アイテムフェーズの説明
   - 「バトル前にアイテムを使用できます」
   - アイテム制限の説明（1つまで等）
   - ロングソードを使用
4. バトル発生
   - 「敵のドミニオに侵入するとバトルになります」
   - バトルに勝利してドミニオを奪う

**CPUターン**
1. ダイス目: 6（固定）
2. 移動してプレイヤーのドミニオに到着
3. バトル発生（CPUはアイテムなし）
   - CPUが負けるがHP20残る
   - 通行料の支払い説明
   - 「バトルに負けると通行料を支払います」

#### ターン3: 周回完了

**プレイヤーターン**
1. ダイス目: 5（固定）
2. 砦（タイル6）を通過
   - チェックポイント（シグナル）の説明
   - 「砦を通過するとシグナルを獲得します」
3. 城（タイル0）に到着
4. 周回ボーナスの説明
   - 「城に戻ると周回ボーナスがもらえます」
   - 「クリーチャーのHPも回復します」
   - 実際にHPが回復しているのを確認
5. 目標TEP達成 → 勝利！
   - 「おめでとうございます！勝利です」
   - ゴールド獲得
   - チュートリアル終了

### 教える内容まとめ

1. 勝利条件（目標TEP+城に戻る）
2. グローバルボタンの使い方（✓で決定）
3. ダイスを振って移動
4. クリーチャー召喚とコスト
5. ドミニオボーナス（属性一致でHP増加）
6. アイテムフェーズとアイテム使用
7. バトル（侵略とドミニオ強奪）
8. 通行料（バトル敗北時）
9. チェックポイント（砦通過でシグナル）
10. 周回ボーナス（EP獲得+HP回復）

### マップ配置図

```
タイル0: 城 ← スタート/ゴール
   ↓
タイル1: 火  ← プレイヤードミニオ（ターン1）
   ↓
タイル2: 水
   ↓
タイル3: 地
   ↓
タイル4: 風
   ↓
タイル5: 無
   ↓
タイル6: 砦 ← チェックポイント
   ↓
タイル7: 火
   ↓
タイル8: 水
   ↓
タイル9: 地
   ↓
タイル10: 風
   ↓
タイル11: 無 ← CPUドミニオ（ターン1）
   ↓
タイル0に戻る
```

## チュートリアル専用マップ

### マップ要件
- 小さいサイズ（8〜12タイル程度）
- 単純な周回構造
- 各属性タイルを含む（火・水・地・風 各1〜2）
- 城タイル1つ

### マップ案（仮）
```
	[城]
   /    \
 [火]   [水]
  |      |
 [地]---[風]
   \    /
	[無]
```

## システム構成

### TutorialManager
チュートリアル全体を管理するクラス

```
TutorialManager
├── current_step: int          # 現在のステップ
├── tutorial_data: Dictionary  # ステップ定義データ
├── is_tutorial_mode: bool     # チュートリアルモードフラグ
│
├── start_tutorial()           # チュートリアル開始
├── advance_step()             # 次のステップへ
├── check_action_valid()       # 操作が許可されているか
├── show_guide_message()       # ガイドメッセージ表示
└── end_tutorial()             # チュートリアル終了
```

### 各ステップのデータ構造

```gdscript
var step_data = {
	"step_id": 1,
	"message": "ダイスを振って移動しましょう！\n✓ボタンを押してください",
	"allowed_actions": ["roll_dice"],      # 許可するアクション
	"expected_result": {},                  # 期待する結果（オプション）
	"highlight_elements": ["dice_button"], # ハイライトするUI要素
	"cpu_actions": [],                      # このステップでのCPU行動
	"on_complete": "advance"                # 完了時の動作
}
```

### 操作制限の実装方針

1. **GameFlowManager側でチェック**
   - 各入力処理の前に`TutorialManager.check_action_valid()`を呼ぶ
   - 許可されていない操作は無視またはガイドメッセージ表示

2. **UI側での視覚的ガイド**
   - 許可されたボタン/カードのみハイライト
   - 他はグレーアウトまたは非表示

### CPU行動の固定

```gdscript
var cpu_script = [
	{"turn": 1, "action": "pass_spell", "dice": 3, "summon": "goblin", "tile": 2},
	{"turn": 2, "action": "pass_spell", "dice": 2, "summon": null, "tile": null},
	# ...
]
```

- ダイス目も固定（チュートリアル用の固定ダイス）
- 召喚するクリーチャーも固定
- バトル時のアイテム使用も固定

## UI表示

### ガイドメッセージ
- `GlobalCommentUI`を活用
- 画面中央に大きく表示
- クリックまたは正しい操作で次へ

### ハイライト表示
- 操作すべきUI要素を強調（枠線、点滅等）
- 他の要素は暗くする

### 進行状況表示
- 「ステップ 1/8」のような表示
- スキップボタン（オプション）

## ファイル構成

```
scripts/
└── tutorial/
	├── tutorial_manager.gd      # メイン管理クラス
	├── tutorial_step.gd         # ステップデータクラス
	└── tutorial_ui.gd           # チュートリアル専用UI

data/
└── tutorial/
	├── tutorial_steps.json      # ステップ定義
	└── tutorial_cpu_script.json # CPU行動スクリプト

scenes/
└── maps/
	└── tutorial_map.json        # チュートリアル専用マップ
```

## 実装順序

### Step 1: 基盤
- [ ] TutorialManager基本実装
- [ ] チュートリアルモードフラグ追加
- [ ] チュートリアル専用マップ作成

### Step 2: 操作制限
- [ ] GameFlowManagerに操作チェック追加
- [ ] 許可アクションのフィルタリング

### Step 3: ガイドUI
- [ ] ガイドメッセージ表示
- [ ] ハイライト表示
- [ ] 進行状況表示

### Step 4: CPU固定行動
- [ ] 固定ダイス実装
- [ ] CPUスクリプト実行

### Step 5: ステップ定義
- [ ] 各ステップのデータ作成
- [ ] テスト・調整

## 将来の拡張

- 複数のチュートリアルコース（初級/中級/上級）
- 特定システムだけ学ぶミニチュートリアル
- チュートリアル完了フラグの保存
- リプレイ機能
