ğŸ® ãƒãƒˆãƒ«ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ã‚«ãƒ«ãƒ‰ã‚»ãƒ—ãƒˆé¢¨ã‚«ãƒ¼ãƒ‰ãƒãƒˆãƒ«ã‚²ãƒ¼ãƒ 
ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.3
æœ€çµ‚æ›´æ–°: 2025å¹´12æœˆ16æ—¥ï¼ˆv1.3 - ç§»å‹•ä¾µç•¥ãƒ»ç‰¹æ®Šå‡¦ç†è¿½è¨˜ã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ä¿®æ­£ï¼‰

ğŸ“‹ ç›®æ¬¡

ãƒãƒˆãƒ«ãƒ•ãƒ­ãƒ¼å…¨ä½“
BattleParticipantã¨HPç®¡ç†
ã‚¹ã‚­ãƒ«é©ç”¨é †åº
åœŸåœ°ãƒœãƒ¼ãƒŠã‚¹ã‚·ã‚¹ãƒ†ãƒ 
å…ˆåˆ¶ãƒ»å¾Œæ‰‹åˆ¤å®š
ãƒãƒˆãƒ«çµæœåˆ¤å®š
ãƒãƒˆãƒ«æº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºã®åˆ†å‰²æ§‹é€ 
é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«


ãƒãƒˆãƒ«ãƒ•ãƒ­ãƒ¼å…¨ä½“
æº–å‚™ãƒ•ã‚§ãƒ¼ã‚º (prepare_participants())
1. BattleParticipantä½œæˆ
   â”œâ”€ æ”»æ’ƒå´ãƒ»é˜²å¾¡å´ã®åŸºæœ¬ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®š
   â””â”€ å…ˆåˆ¶ãƒ»å¾Œæ‰‹ãƒ•ãƒ©ã‚°ã‚’ã‚¹ã‚­ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿
   
2. åŠ¹æœé…åˆ—é©ç”¨ (apply_effect_arrays)
   â”œâ”€ permanent_effects ã‚’ HP/AP ã«åæ˜ 
   â””â”€ temporary_effects ã‚’ HP/AP ã«åæ˜ ï¼ˆåˆ»å°ãªã©ï¼‰
   
3. åˆ»å°å¤‰æ› (_apply_creature_curses)
   â”œâ”€ åˆ»å°ï¼ˆstat_boost/stat_reduceï¼‰ã‚’ temporary_effects ã«è¿½åŠ 
   â””â”€ temporary_bonus_hp/ap ã‚’åŠ ç®—
   
4. ã‚¢ã‚¤ãƒ†ãƒ åŠ¹æœé©ç”¨ (apply_item_effects)
   â”œâ”€ è¤‡æ•°ã®åŠ¹æœã‚¿ã‚¤ãƒ—ã«å¯¾å¿œï¼ˆSTåŠ ç®—ã€ã‚¹ã‚­ãƒ«ä»˜ä¸ç­‰ï¼‰
   â””â”€ åŠ å‹¢ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼å‡¦ç†ã‚’å«ã‚€
   
5. ç‰¹æ®Šã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼å‡¦ç†
   â”œâ”€ ãƒªãƒ“ãƒ³ã‚°ã‚¢ãƒ¼ãƒãƒ¼ (ID: 438) â†’ AP+50
   â”œâ”€ ãƒ–ãƒ«ã‚¬ã‚µãƒª (ID: 339) â†’ ã‚¢ã‚¤ãƒ†ãƒ ä½¿ç”¨æ™‚ AP+20
   â””â”€ ã‚ªãƒ¼ã‚¬ãƒ­ãƒ¼ãƒ‰ (ID: 407) â†’ éš£æ¥è‡ªãƒ‰ãƒŸãƒ‹ã‚ªãƒœãƒ¼ãƒŠã‚¹
   
6. å¤‰èº«ã‚¹ã‚­ãƒ«å‡¦ç† (on_battle_start)
   â””â”€ æˆ¦é—˜é–‹å§‹æ™‚å¤‰èº«ã‚’å®Ÿè¡Œ
å®Ÿè¡Œãƒ•ã‚§ãƒ¼ã‚º (_execute_battle_core())
1. pre_battle_skills é©ç”¨ (battle_skill_processor)
   â”œâ”€ é¼“èˆã‚¹ã‚­ãƒ«ï¼ˆç›¤é¢ã®æ”¯æ´ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼ï¼‰
   â”œâ”€ å…±é³´ã‚¹ã‚­ãƒ«ï¼ˆå±æ€§ãƒœãƒ¼ãƒŠã‚¹ï¼‰
   â””â”€ ãã®ä»–ã®ãƒãƒˆãƒ«å‰ã‚¹ã‚­ãƒ«
   
2. æ”»æ’ƒé †æ±ºå®š
   â”œâ”€ ã‚¢ã‚¤ãƒ†ãƒ å…ˆåˆ¶ > å…ˆåˆ¶ã‚¹ã‚­ãƒ« > é˜²å¾¡å´å¾Œæ‰‹ > ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
   â””â”€ é †åºã¯ [å…ˆæ”»è€…, å¾Œæ”»è€…] ã§è¿”å´
   
3. æ”»æ’ƒã‚·ãƒ¼ã‚±ãƒ³ã‚¹å®Ÿè¡Œ
   â”œâ”€ å…ˆæ”»è€…ãŒæ”»æ’ƒ â†’ ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç† â†’ å³æ­»åˆ¤å®š
   â””â”€ å¾Œæ”»è€…ãŒæ”»æ’ƒï¼ˆç”Ÿå­˜æ™‚ï¼‰â†’ ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç† â†’ å³æ­»åˆ¤å®š
   
4. çµæœåˆ¤å®š (resolve_battle_result)
   â””â”€ HPçŠ¶æ…‹ã‹ã‚‰ ATTACKER_WIN / DEFENDER_WIN / BOTH_DEFEATED / ATTACKER_SURVIVED ã‚’æ±ºå®š
   
5. ãƒãƒˆãƒ«å¾Œå‡¦ç† (_apply_post_battle_effects)
   â”œâ”€ å†ç”Ÿã‚¹ã‚­ãƒ«ï¼ˆç”Ÿå­˜è€…ã®ã¿ï¼‰
   â”œâ”€ æ°¸ç¶šãƒãƒ•é©ç”¨
   â””â”€ åœŸåœ°å‡¦ç†ï¼ˆç²å¾—ãƒ»æ¶ˆæ»…ãƒ»ç„¡æ‰€æœ‰åŒ–ï¼‰

BattleParticipantã¨HPç®¡ç†
BattleParticipantã‚¯ãƒ©ã‚¹
å½¹å‰²: ãƒãƒˆãƒ«å‚åŠ è€…ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨HPç®¡ç†ã‚’æ‹…å½“
å®Ÿè£…å ´æ‰€: scripts/battle/battle_participant.gd
HPãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸€è¦§
ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰èª¬æ˜base_hpã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼ã®åŸºæœ¬HPbase_up_hpæ°¸ç¶šçš„ãªåŸºç¤HPä¸Šæ˜‡ï¼ˆåˆæˆãƒ»ãƒã‚¹ã‚°ãƒ­ãƒ¼ã‚¹ç­‰ï¼‰temporary_bonus_hpä¸€æ™‚åŠ¹æœã«ã‚ˆã‚‹åŠ ç®—HPï¼ˆåŠ¹æœé…åˆ—ã‹ã‚‰è¨ˆç®—ï¼‰resonance_bonus_hpå…±é³´ã‚¹ã‚­ãƒ«ã®ãƒœãƒ¼ãƒŠã‚¹HPland_bonus_hpåœŸåœ°ãƒœãƒ¼ãƒŠã‚¹HPï¼ˆå±æ€§ä¸€è‡´æ™‚ï¼‰item_bonus_hpã‚¢ã‚¤ãƒ†ãƒ åŠ¹æœã®ãƒœãƒ¼ãƒŠã‚¹HPspell_bonus_hpã‚¹ãƒšãƒ«åŠ¹æœã®ãƒœãƒ¼ãƒŠã‚¹HPcurrent_hpåˆè¨ˆHPï¼ˆä¸Šè¨˜ã™ã¹ã¦ã®åˆè¨ˆï¼‰
ãƒ€ãƒ¡ãƒ¼ã‚¸æ¶ˆè²»é †åº

1. åœŸåœ°ãƒœãƒ¼ãƒŠã‚¹ (land_bonus_hp - æœ€å„ªå…ˆã§æ¶ˆè²»ã€æˆ¦é—˜ã”ã¨ã«å¾©æ´»)
2. å…±é³´ãƒœãƒ¼ãƒŠã‚¹ (resonance_bonus_hp - ãƒãƒˆãƒ«é™å®š)
3. ä¸€æ™‚åŠ¹æœ (temporary_bonus_hp - åˆ»å°ç­‰)
4. ã‚¹ãƒšãƒ«ãƒœãƒ¼ãƒŠã‚¹ (spell_bonus_hp)
5. ã‚¢ã‚¤ãƒ†ãƒ ãƒœãƒ¼ãƒŠã‚¹ (item_bonus_hp)
6. ç¾åœ¨HP (current_hp - æœ€å¾Œã«æ¶ˆè²»)

â€» æ°¸ç¶šåŸºç¤HP (base_up_hp) ã¯ãƒ€ãƒ¡ãƒ¼ã‚¸ã§æ¶ˆè²»ã•ã‚Œã¾ã›ã‚“ã€‚ã“ã‚Œã¯MHPè¨ˆç®—ã«ä½¿ç”¨ã•ã‚Œã‚‹å€¤ã§ã™ã€‚
â€» MHP = base_hp + base_up_hpï¼ˆã‚¢ã‚¤ãƒ†ãƒ ãƒœãƒ¼ãƒŠã‚¹ã¯MHPã«å«ã¾ãªã„ï¼‰

è¨­è¨ˆæ€æƒ³

ä¸€æ™‚çš„ãªãƒœãƒ¼ãƒŠã‚¹ã‚’å…ˆã«æ¶ˆè²»ã—ã€ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼ã®æœ¬æ¥ã®HPã‚’å®ˆã‚‹
åœŸåœ°ãƒœãƒ¼ãƒŠã‚¹: æˆ¦é—˜ã”ã¨ã«å¾©æ´»ã™ã‚‹ãŸã‚ã€æœ€å„ªå…ˆæ¶ˆè²»
å…±é³´ãƒœãƒ¼ãƒŠã‚¹: ãƒãƒˆãƒ«é™å®šã®ãŸã‚ã€æ¬¡ã«æ¶ˆè²»
ã‚¢ã‚¤ãƒ†ãƒ ãƒœãƒ¼ãƒŠã‚¹: æˆ¦é—˜ä¸­ã®ã¿æœ‰åŠ¹ã€current_hpã®ç›´å‰ã«æ¶ˆè²»
æ°¸ç¶šåŸºç¤HP (base_up_hp): ãƒ€ãƒ¡ãƒ¼ã‚¸ã§ã¯å‰Šã‚‰ã‚Œãšã€MHPè¨ˆç®—ã«ä½¿ç”¨ã•ã‚Œã‚‹

ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç†
take_damage() ã¯æ¶ˆè²»é †åºã«å¾“ã„ã€æ®‹ã£ãŸãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’æ¬¡ã®HPãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«é©ç”¨ã—ã¾ã™ã€‚
æˆ»ã‚Šå€¤: damage_breakdown è¾æ›¸

å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã„ãã‚‰æ¶ˆè²»ã•ã‚ŒãŸã‹ã‚’è¨˜éŒ²
ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ç”¨ã«ä½¿ç”¨

å‰¯ä½œç”¨:

was_attacked_by_enemy ãƒ•ãƒ©ã‚°ã‚’è¨­å®šï¼ˆãƒã‚¤ãƒ­ãƒãƒ³ã‚µãƒ¼ç”¨ï¼‰
_trigger_magic_from_damage() ã‚’å‘¼ã¶ï¼ˆã‚¼ãƒ©ãƒãƒ³ã‚¢ãƒ¼ãƒãƒ¼ç”¨ï¼‰

ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰

| ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ |
|----------|------|
| `update_current_ap()` | å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰ current_ap ã‚’å†è¨ˆç®— |
| `add_base_up_hp(value)` | base_up_hp ã‚’å¢—åŠ ã—ã€current_hp ã¨ creature_data ã‚‚åŒæ™‚ã«æ›´æ–° |
| `get_max_hp()` | çœŸã®MHPï¼ˆbase_hp + base_up_hpï¼‰ |
| `is_alive()` | current_hp > 0 ã‹ãƒã‚§ãƒƒã‚¯ |
| `take_damage(damage)` | ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç†ï¼ˆæ¶ˆè²»é †åºã«å¾“ã†ï¼‰ |
| `take_mhp_damage(damage)` | MHPã«ç›´æ¥ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼ˆå ±å¾©åŠ¹æœç”¨ï¼‰ |
| `is_damaged()` | current_hp < get_max_hp() ã‹ãƒã‚§ãƒƒã‚¯ |
| `apply_item_first_strike()` | ã‚¢ã‚¤ãƒ†ãƒ ã§å…ˆåˆ¶ä»˜ä¸ï¼ˆå¾Œæ‰‹ã‚’ç„¡åŠ¹åŒ–ï¼‰ |

ã‚¹ã‚­ãƒ«é©ç”¨é †åº
ç›¸ä¹—åŠ¹æœã®è¨­è¨ˆæ€æƒ³
ã“ã®é †åºã«ã‚ˆã‚Šã€è¤‡æ•°ã‚¹ã‚­ãƒ«ã‚’æŒã¤ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼ã¯ç›¸ä¹—åŠ¹æœã‚’å¾—ã‚‰ã‚Œã‚‹ã€‚
ä¾‹: å…±é³´+å¼·åŒ–ã®çµ„ã¿åˆã‚ã›
ãƒ¢ãƒ«ãƒ¢ï¼ˆå…±é³´[ç«]+30ã€å¼·åŒ–Ã—1.5ã‚’ä»®å®šï¼‰

åŸºæœ¬AP: 20
  â†“ å…±é³´ç™ºå‹•ï¼ˆç«åœŸåœ°1å€‹æ‰€æœ‰ï¼‰
AP: 50 (+30)
  â†“ å¼·åŒ–ç™ºå‹•ï¼ˆéš£æ¥è‡ªãƒ‰ãƒŸãƒ‹ã‚ªã‚ã‚Šï¼‰
AP: 75 (Ã—1.5)

â†’ æœ€çµ‚çš„ã«AP: 75ã§æ”»æ’ƒï¼
ã“ã®è¨­è¨ˆã«ã‚ˆã‚Šã€å…±é³´ã§ä¸Šæ˜‡ã—ãŸAPãŒå¼·åŒ–ã®åŸºæº–å€¤ã¨ãªã‚Šã€å¤§ããªæˆ¦åŠ›å¢—å¼·ãŒå¯èƒ½ã€‚
è©³ç´°ãªå€‹åˆ¥ã‚¹ã‚­ãƒ«ä»•æ§˜ã¯ skills_design.md ã‚’å‚ç…§ã€‚

åœŸåœ°ãƒœãƒ¼ãƒŠã‚¹ã‚·ã‚¹ãƒ†ãƒ 
è¨ˆç®—å¼
åœŸåœ°ãƒœãƒ¼ãƒŠã‚¹HP = land_level Ã— 10
é©ç”¨æ¡ä»¶

ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼ã®å±æ€§ = ã‚¿ã‚¤ãƒ«ã®å±æ€§ ã®ã¨ãã®ã¿é©ç”¨
ä¾‹: ç«å±æ€§ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼ãŒç«å±æ€§ã‚¿ã‚¤ãƒ«ã«ã„ã‚‹

ä¿å­˜å ´æ‰€

land_bonus_hp ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ç‹¬ç«‹ã—ã¦ä¿å­˜
åŸºæœ¬HPã¨ã¯åˆ†é›¢ç®¡ç†

ç‰¹æ®Šãƒ«ãƒ¼ãƒ«

åˆºçªã‚¹ã‚­ãƒ«: ç›¸æ‰‹ã®åœŸåœ°ãƒœãƒ¼ãƒŠã‚¹ã‚’ç„¡åŠ¹åŒ–å¯èƒ½
æˆ¦é—˜ã”ã¨ã«å¾©æ´»: æ¬¡ã®ãƒãƒˆãƒ«ã§ã¯å†åº¦é©ç”¨ã•ã‚Œã‚‹

è©³ç´°ã¯ land_system.md ã‚’å‚ç…§ã€‚

å…ˆåˆ¶ãƒ»å¾Œæ‰‹åˆ¤å®š
åˆ¤å®šé †åº

å…ˆåˆ¶ã‚¹ã‚­ãƒ«ä¿æŒè€…ãŒå…ˆæ”»
å¾Œæ‰‹ã‚¹ã‚­ãƒ«ä¿æŒè€…ãŒå¾Œæ”»
ä¸¡æ–¹ãªã— â†’ æ”»æ’ƒå´ãŒå…ˆæ”»ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
ä¸¡æ–¹ã‚ã‚Š â†’ æ‰“ã¡æ¶ˆã—åˆã„ â†’ æ”»æ’ƒå´ãŒå…ˆæ”»

å®Ÿè£…
gdscriptfunc _determine_attack_order(attacker: BattleParticipant, defender: BattleParticipant) -> String:
	var attacker_has_first = attacker.has_first_strike
	var attacker_has_last = attacker.has_last_strike
	var defender_has_first = defender.has_first_strike
	var defender_has_last = defender.has_last_strike
	
	# æ”»æ’ƒå´ãŒå…ˆåˆ¶ && é˜²å¾¡å´ãŒå¾Œæ‰‹ã§ãªã„
	if attacker_has_first and not defender_has_first:
		return "attacker_first"
	
	# é˜²å¾¡å´ãŒå…ˆåˆ¶ && æ”»æ’ƒå´ãŒå¾Œæ‰‹ã§ãªã„
	if defender_has_first and not attacker_has_last:
		return "defender_first"
	
	# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: æ”»æ’ƒå´å…ˆæ”»
	return "attacker_first"

ãƒãƒˆãƒ«çµæœåˆ¤å®š
çµæœã®ç¨®é¡
ãƒãƒˆãƒ«çµæœã¯ä»¥ä¸‹ã®4ç¨®é¡ã«åˆ†é¡ã•ã‚Œã‚‹ï¼š
çµæœenumå€¤èª¬æ˜ä¾µç•¥æˆåŠŸATTACKER_WINé˜²å¾¡å´ã®ã¿æ­»äº¡ â†’ æ”»æ’ƒå´ãŒåœŸåœ°ã‚’ç²å¾—é˜²å¾¡æˆåŠŸDEFENDER_WINæ”»æ’ƒå´ã®ã¿æ­»äº¡ â†’ æ”»æ’ƒå´ã‚«ãƒ¼ãƒ‰ã¯ç ´å£Šä¾µç•¥å¤±æ•—ATTACKER_SURVIVEDä¸¡æ–¹ç”Ÿå­˜ â†’ æ”»æ’ƒå´ã‚«ãƒ¼ãƒ‰ã¯æ‰‹æœ­ã«æˆ»ã‚‹ç›¸æ‰“ã¡BOTH_DEFEATEDä¸¡æ–¹æ­»äº¡ â†’ åœŸåœ°ã¯ç„¡æ‰€æœ‰ã«ãªã‚‹
åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
gdscriptfunc resolve_battle_result(attacker: BattleParticipant, defender: BattleParticipant) -> int:
	# 1. ä¸¡æ–¹æ­»äº¡ â†’ ç›¸æ‰“ã¡ï¼ˆåœŸåœ°ã¯ç„¡æ‰€æœ‰ï¼‰
	if not attacker.is_alive() and not defender.is_alive():
		return BOTH_DEFEATED
	
	# 2. é˜²å¾¡å´ã®ã¿æ­»äº¡ â†’ æ”»æ’ƒå´å‹åˆ©
	elif not defender.is_alive():
		return ATTACKER_WIN
	
	# 3. æ”»æ’ƒå´ã®ã¿æ­»äº¡ â†’ é˜²å¾¡å´å‹åˆ©
	elif not attacker.is_alive():
		return DEFENDER_WIN
	
	# 4. ä¸¡æ–¹ç”Ÿå­˜ â†’ æ”»æ’ƒå´ç”Ÿé‚„
	else:
		return ATTACKER_SURVIVED
æ­»äº¡æ™‚åŠ¹æœï¼ˆç›¸è¨ãƒ»å ±å¾©ï¼‰
é‡è¦: ãƒãƒˆãƒ«çµæœåˆ¤å®šã®å‰ã«ã€æ­»äº¡æ™‚åŠ¹æœãŒç™ºå‹•ã™ã‚‹ã€‚
ç™ºå‹•ã‚¿ã‚¤ãƒŸãƒ³ã‚°
æ”»æ’ƒå®Ÿè¡Œ
  â†“
ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç†
  â†“
å³æ­»åˆ¤å®š
  â†“
ã€æ’ƒç ´åˆ¤å®šã€‘â† ã“ã“ã§æ­»äº¡æ™‚åŠ¹æœã‚’ãƒã‚§ãƒƒã‚¯
  â”œâ”€ ç›¸è¨ï¼ˆinstant_deathï¼‰
  â””â”€ å ±å¾©ï¼ˆrevenge_mhp_damageï¼‰
  â†“
è˜‡ç”Ÿãƒã‚§ãƒƒã‚¯
  â†“
ãƒãƒˆãƒ«çµæœåˆ¤å®š â† ã“ã“ã§æœ€çµ‚çš„ãªç”Ÿå­˜çŠ¶æ³ã‚’åˆ¤å®š
æ­»äº¡æ™‚åŠ¹æœã®ç¨®é¡
åŠ¹æœeffect_typeèª¬æ˜ç›¸è¨instant_deathä½¿ç”¨è€…ãŒæ­»äº¡æ™‚ã€ç›¸æ‰‹ã‚’å³æ­»ã•ã›ã‚‹ï¼ˆç¢ºç‡åˆ¤å®šã‚ã‚Šï¼‰å ±å¾©revenge_mhp_damageä½¿ç”¨è€…ãŒæ­»äº¡æ™‚ã€ç›¸æ‰‹ã®MHPã«ç›´æ¥ãƒ€ãƒ¡ãƒ¼ã‚¸
è©³ç´°ã¯ skills/on_death_effects.md ã‚’å‚ç…§ã€‚
ç›¸æ‰“ã¡ã®ç™ºç”Ÿãƒ‘ã‚¿ãƒ¼ãƒ³

ç›¸è¨ã«ã‚ˆã‚‹ç›¸æ‰“ã¡

Aæ”»æ’ƒ â†’ Bæ­»äº¡ â†’ ç›¸è¨ç™ºå‹• â†’ Aæ­»äº¡ â†’ ç›¸æ‰“ã¡


å ±å¾©ã«ã‚ˆã‚‹ç›¸æ‰“ã¡

Aæ”»æ’ƒ â†’ Bæ­»äº¡ â†’ å ±å¾©ç™ºå‹• â†’ Aã®MHP-40 â†’ Aå³æ­» â†’ ç›¸æ‰“ã¡


åå°„ã«ã‚ˆã‚‹ç›¸æ‰“ã¡

Aæ”»æ’ƒ â†’ Bæ­»äº¡ â†’ åå°„ãƒ€ãƒ¡ãƒ¼ã‚¸ â†’ Aæ­»äº¡ â†’ ç›¸æ‰“ã¡



ç§»å‹•ä¾µç•¥
ãƒ‰ãƒŸãƒ‹ã‚ªã‚ªãƒ¼ãƒ€ãƒ¼ã®ã€Œç§»å‹•ã€ã§æ•µåœ°ã«ç§»å‹•ã—ãŸå ´åˆã€ç§»å‹•ä¾µç•¥ã¨ãªã‚‹ã€‚
é€šå¸¸ã®ä¾µç•¥ã¨ã®é•ã„
é …ç›®é€šå¸¸ä¾µç•¥ç§»å‹•ä¾µç•¥æ”»æ’ƒå´ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼æ‰‹æœ­ã‹ã‚‰å‡ºã™é…ç½®æ¸ˆã¿ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼åœŸåœ°ãƒœãƒ¼ãƒŠã‚¹æ”»æ’ƒå´ã«ãªã—æ”»æ’ƒå´ã«ãªã—ï¼ˆç§»å‹•å…ƒã‹ã‚‰é›¢ã‚Œã‚‹ãŸã‚ï¼‰æ•—åŒ—æ™‚ã‚«ãƒ¼ãƒ‰ç ´å£Šç§»å‹•å…ƒã«æˆ»ã‚‹ï¼ˆHPãƒ€ãƒ¡ãƒ¼ã‚¸ç¶­æŒï¼‰å‹åˆ©æ™‚åœŸåœ°ç²å¾—ï¼‹é…ç½®åœŸåœ°ç²å¾—ï¼‹é…ç½®ã€ç§»å‹•å…ƒã¯ç©ºãåœ°ã«ç›¸æ‰“ã¡æ™‚ã‚«ãƒ¼ãƒ‰ç ´å£Šä¸¡æ–¹ç ´å£Šã€ç§»å‹•å…ƒã‚‚ç©ºãåœ°ã«
å®Ÿè£…
```gdscript
# from_tile_index >= 0 ã®å ´åˆã¯ç§»å‹•ä¾µç•¥
func _execute_battle_core(..., from_tile_index: int = -1):
	# ãƒãƒˆãƒ«å®Ÿè¡Œ...
	
	# çµæœå‡¦ç†ã§ from_tile_index ã‚’å‚ç…§
	match result:
		BattleResult.ATTACKER_WIN:
			# ç§»å‹•å…ƒã®ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼ã‚’å‰Šé™¤
			if from_tile_index >= 0:
				board_system_ref.remove_creature(from_tile_index)
		
		BattleResult.ATTACKER_SURVIVED:
			# ç§»å‹•ä¾µç•¥ï¼šç§»å‹•å…ƒã‚¿ã‚¤ãƒ«ã«æˆ»ã™
			if from_tile_index >= 0:
				# ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼ã‚’ç§»å‹•å…ƒã«æˆ»ã™ï¼ˆHPãƒ€ãƒ¡ãƒ¼ã‚¸ç¶­æŒï¼‰
				from_tile.place_creature(return_data)
			else:
				# é€šå¸¸ä¾µç•¥ï¼šæ‰‹æœ­ã«æˆ»ã™ï¼ˆHPå…¨å›å¾©ï¼‰
				card_system_ref.return_card_to_hand(...)
```

ãƒãƒˆãƒ«å¾Œå‡¦ç†
å„çµæœã«å¿œã˜ãŸå‡¦ç†ï¼š
ATTACKER_WINï¼ˆä¾µç•¥æˆåŠŸï¼‰

ç ´å£Šã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°
æ”»æ’ƒå´ã®æ°¸ç¶šãƒãƒ•é©ç”¨
åœŸåœ°æ‰€æœ‰æ¨©ã‚’æ”»æ’ƒå´ã«å¤‰æ›´
æ”»æ’ƒå´ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼ã‚’é…ç½®ï¼ˆæ®‹ã‚ŠHPåæ˜ ï¼‰
åœŸåœ°ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—åŠ¹æœï¼ˆã‚·ãƒ«ãƒãƒ¼ãƒ—ãƒ­ã‚¦ï¼‰

DEFENDER_WINï¼ˆé˜²å¾¡æˆåŠŸï¼‰

ç ´å£Šã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°
é˜²å¾¡å´ã®æ°¸ç¶šãƒãƒ•é©ç”¨
é˜²å¾¡å´ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼ã®HPæ›´æ–°
åœŸåœ°ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—åŠ¹æœï¼ˆã‚·ãƒ«ãƒãƒ¼ãƒ—ãƒ­ã‚¦ï¼‰
æ”»æ’ƒå´ã‚«ãƒ¼ãƒ‰ã¯ç ´å£Šï¼ˆæ‰‹æœ­ã«æˆ»ã‚‰ãªã„ï¼‰

ATTACKER_SURVIVEDï¼ˆä¾µç•¥å¤±æ•—ï¼‰

æ”»æ’ƒå´ã‚«ãƒ¼ãƒ‰ã‚’æ‰‹æœ­ã«æˆ»ã™ï¼ˆHPå…¨å›å¾©ï¼‰
é˜²å¾¡å´ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼ã®HPæ›´æ–°

BOTH_DEFEATEDï¼ˆç›¸æ‰“ã¡ï¼‰

ç ´å£Šã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°Ã—2
ä¸¡æ–¹ã®æ°¸ç¶šãƒãƒ•é©ç”¨
åœŸåœ°ã‚’ç„¡æ‰€æœ‰ã«ã™ã‚‹ï¼ˆowner = -1ï¼‰
ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼ã‚’å‰Šé™¤
ä¸¡æ–¹ã®ã‚«ãƒ¼ãƒ‰ã¯ç ´å£Šï¼ˆæ‰‹æœ­ã«æˆ»ã‚‰ãªã„ï¼‰


ç‰¹æ®Šå‡¦ç†
ãƒãƒ¼ãƒŸãƒƒãƒˆã‚ºãƒ‘ãƒ©ãƒ‰ãƒƒã‚¯ã‚¹ï¼ˆåŒåã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼ç›¸æ®ºï¼‰
**ãƒãƒ¼ãƒŸãƒƒãƒˆã‚ºãƒ‘ãƒ©ãƒ‰ãƒƒã‚¯ã‚¹ï¼ˆID: 2050ï¼‰**ç™ºå‹•ä¸­ã€åŒåã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼åŒå£«ã®æˆ¦é—˜ã¯ä¸¡è€…å³åº§ã«ç ´å£Šã•ã‚Œã‚‹ã€‚
```gdscript
# ãƒãƒˆãƒ«é–‹å§‹å‰ã«ãƒã‚§ãƒƒã‚¯
func _check_mirror_world_destroy(card_data, tile_info, attacker_index, tile_index, from_tile_index):
	if not _is_mirror_world_active():
		return false
	
	var attacker_name = card_data.get("name", "")
	var defender_name = tile_info.get("creature", {}).get("name", "")
	
	if attacker_name == defender_name:
		# ä¸¡è€…ç ´å£Šå‡¦ç†
		return true
	return false
```
ãƒã‚¦ãƒ³ãƒ†ã‚£ãƒãƒ³ãƒˆï¼ˆè³é‡‘ï¼‰å ±é…¬
æ•—åŒ—ã—ãŸã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼ã«ã€Œè³é‡‘ã€åˆ»å°ãŒã‚ã‚‹å ´åˆã€å‹è€…ã¯å ±é…¬EPã‚’ç²å¾—ã€‚
```
ç™ºå‹•ã‚¿ã‚¤ãƒŸãƒ³ã‚°: å„ãƒãƒˆãƒ«çµæœå‡¦ç†ã®å†’é ­
å ±é…¬: åˆ»å°ã«è¨­å®šã•ã‚ŒãŸ magic_amount
å¯¾è±¡: ATTACKER_WINæ™‚ã¯é˜²å¾¡å´ã€DEFENDER_WINæ™‚ã¯æ”»æ’ƒå´
ç›¸æ‰“ã¡: å ±é…¬ãªã—ï¼ˆå‹è€…ãŒã„ãªã„ï¼‰
```
å¤‰èº«å‡¦ç†ï¼ˆãƒãƒ«ãƒ€ãƒ³ãƒ€ãƒ¼ã‚¹ç­‰ï¼‰
```
1. æˆ¦é—˜é–‹å§‹æ™‚å¤‰èº« (on_battle_start)
   - BattlePreparationå†…ã§ TransformSkill.process_transform() ã‚’å‘¼ã¶
   - ä¸€æ™‚å¤‰èº«ã®å ´åˆã€å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ battle_result["attacker_original"] ç­‰ã«ä¿å­˜

2. æˆ¦é—˜çµ‚äº†æ™‚å¾©å¸°
   - _apply_post_battle_effects() å†…ã§å…ƒã«æˆ»ã™
   - TransformSkill.revert_transform() ã‚’å‘¼ã¶

3. æ°¸ç¶šå¤‰èº«ï¼ˆã‚³ã‚«ãƒˆãƒªã‚¹ç­‰ï¼‰
   - defender_original ãŒç©ºã®å ´åˆã¯æˆ»ã•ãªã„
   - ã‚¿ã‚¤ãƒ«ã®creature_dataã‚’æ›´æ–°
```
è˜‡ç”Ÿ
```
ç™ºå‹•ã‚¿ã‚¤ãƒŸãƒ³ã‚°: æ”»æ’ƒã‚·ãƒ¼ã‚±ãƒ³ã‚¹å†…ã®æ’ƒç ´åˆ¤å®šå¾Œ
å¯¾è±¡ã‚¹ã‚­ãƒ«: è˜‡ç”Ÿï¼ˆID: 420 ãƒã‚¯ãƒ­ãƒãƒ³ã‚µãƒ¼ç­‰ï¼‰

å‡¦ç†ãƒ•ãƒ­ãƒ¼:
1. ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼ãŒæ’ƒç ´ã•ã‚Œã‚‹
2. è˜‡ç”Ÿã‚¹ã‚­ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
3. å¾©æ´»æˆåŠŸ: HP1ã§å¾©æ´»ã€battle_result["xxx_revived"] = true
4. æˆ¦é—˜ç¶™ç¶šï¼ˆå¾©æ´»å¾Œã‚‚æ”»æ’ƒå¯èƒ½ï¼‰
5. ãƒãƒˆãƒ«å¾Œå‡¦ç†ã§ã‚¿ã‚¤ãƒ«ã®creature_dataã‚’æ›´æ–°
```

ãƒãƒˆãƒ«æº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºã®åˆ†å‰²æ§‹é€ 
æ¦‚è¦
BattlePreparationã¯ãƒãƒˆãƒ«æº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºå…¨ä½“ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã€è¤‡æ•°ã®ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ã«è²¬å‹™ã‚’åˆ†å‰²ã—ã¦ã„ã¾ã™ã€‚
æ§‹æˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
1. BattlePreparationï¼ˆãƒ¡ã‚¤ãƒ³ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼‰
å½¹å‰²: æº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºå…¨ä½“ã®çµ±åˆãƒ»èª¿æ•´

BattleParticipant ã®ä½œæˆ
å„ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ã®å‡¦ç†é †åºç®¡ç†
åœŸåœ°ãƒœãƒ¼ãƒŠã‚¹è¨ˆç®—
åˆºçªã‚¹ã‚­ãƒ«åˆ¤å®š

2. BattleCurseApplier
å½¹å‰²: åˆ»å°åŠ¹æœã®é©ç”¨

åˆ»å°ï¼ˆstat_boost/stat_reduceï¼‰ã‚’temporary_effectsã«å¤‰æ›
æ°¸ç¶šãƒ»ä¸€æ™‚ãƒœãƒ¼ãƒŠã‚¹HP/APã®è¨ˆç®—
ã‚¿ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã®åˆ»å°åˆ¤å®š

3. BattleItemApplier
å½¹å‰²: ã‚¢ã‚¤ãƒ†ãƒ åŠ¹æœã®é©ç”¨

è¤‡æ•°ã®åŠ¹æœã‚¿ã‚¤ãƒ—å¯¾å¿œï¼ˆSTåŠ ç®—ã€ã‚¹ã‚­ãƒ«ä»˜ä¸ã€HPåŠ ç®—ç­‰ï¼‰
åŠ å‹¢ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼ã«ã‚ˆã‚‹ãƒœãƒ¼ãƒŠã‚¹å‡¦ç†
åå°„ã‚¹ã‚­ãƒ«ã®ãƒã‚§ãƒƒã‚¯

4. BattleSkillGranter
å½¹å‰²: ã‚¹ã‚­ãƒ«ä»˜ä¸ã®å‡¦ç†

ã‚¢ã‚¤ãƒ†ãƒ ã‚„ã‚¹ãƒšãƒ«ã‹ã‚‰å¾—ã‚‹ã‚¹ã‚­ãƒ«ã®ä»˜ä¸
å…ˆåˆ¶ãƒ»å¾Œæ‰‹ãƒ•ãƒ©ã‚°ã®è¨­å®š
æ¡ä»¶ä»˜ãã‚¹ã‚­ãƒ«ä»˜ä¸

å‡¦ç†ãƒ•ãƒ­ãƒ¼
BattlePreparation.prepare_participants()
  â”‚
  â”œâ”€> BattleParticipantä½œæˆ
  â”‚   â”œâ”€ æ”»æ’ƒå´ãƒ»é˜²å¾¡å´ã®åˆæœŸåŒ–
  â”‚   â””â”€ base_hp, current_hp ã®å¾©å…ƒ
  â”‚
  â”œâ”€> apply_effect_arrays()
  â”‚   â”œâ”€ permanent_effects ã‚’åæ˜ 
  â”‚   â””â”€ temporary_effects ã‚’åæ˜ 
  â”‚
  â”œâ”€> BattleCurseApplier.apply_creature_curses()
  â”‚   â””â”€ åˆ»å°åŠ¹æœã‚’ temporary_effects ã«å¤‰æ›
  â”‚
  â”œâ”€> BattleItemApplier.apply_item_effects()
  â”‚   â””â”€ ã‚¢ã‚¤ãƒ†ãƒ åŠ¹æœã‚’é©ç”¨
  â”‚
  â”œâ”€> ç‰¹æ®Šã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼å‡¦ç†
  â”‚   â”œâ”€ ãƒªãƒ“ãƒ³ã‚°ã‚¢ãƒ¼ãƒãƒ¼ (ID: 438)
  â”‚   â”œâ”€ ãƒ–ãƒ«ã‚¬ã‚µãƒª (ID: 339)
  â”‚   â””â”€ ã‚ªãƒ¼ã‚¬ãƒ­ãƒ¼ãƒ‰ (ID: 407)
  â”‚
  â””â”€> TransformSkillå‡¦ç†
	  â””â”€ æˆ¦é—˜é–‹å§‹æ™‚å¤‰èº«ã‚’å®Ÿè¡Œ

é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«
å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«
ãƒ•ã‚¡ã‚¤ãƒ«å½¹å‰²scripts/battle_system.gdãƒãƒˆãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯scripts/battle/battle_participant.gdBattleParticipantã‚¯ãƒ©ã‚¹scripts/skills/condition_checker.gdã‚¹ã‚­ãƒ«æ¡ä»¶åˆ¤å®šscripts/skills/effect_combat.gdã‚¹ã‚­ãƒ«åŠ¹æœé©ç”¨scripts/battle/battle_preparation.gdãƒãƒˆãƒ«å‰æº–å‚™ï¼ˆã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼‰scripts/battle/battle_curse_applier.gdåˆ»å°åŠ¹æœé©ç”¨scripts/battle/battle_item_applier.gdã‚¢ã‚¤ãƒ†ãƒ åŠ¹æœé©ç”¨scripts/battle/battle_skill_granter.gdã‚¹ã‚­ãƒ«ä»˜ä¸å‡¦ç†
è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…å®¹skills_design.mdã‚¹ã‚­ãƒ«ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“è¨­è¨ˆland_system.mdåœŸåœ°ã‚·ã‚¹ãƒ†ãƒ ãƒ»åœŸåœ°ãƒœãƒ¼ãƒŠã‚¹item_system.mdã‚¢ã‚¤ãƒ†ãƒ ã‚·ã‚¹ãƒ†ãƒ ãƒ»ã‚¢ã‚¤ãƒ†ãƒ ãƒ•ã‚§ãƒ¼ã‚º
