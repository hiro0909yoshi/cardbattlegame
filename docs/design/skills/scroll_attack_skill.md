# 術攻撃スキル

**バージョン**: 1.1  
**最終更新**: 2025年10月25日

---

## 📋 目次

1. [概要](#概要)
2. [実装状況](#実装状況)
3. [主な効果](#主な効果)
4. [詳細仕様](#詳細仕様)

---

## 概要

巻物アイテムを使用した場合に発動する特殊攻撃スキル。

---

## 実装状況

✅ **完全実装**（2025年11月13日 - アイテム巻物実装完了）

---

## 主な効果

### 術攻撃
- **土地ボーナスHP無視**: 防御側の土地ボーナスHPを無視してダメージを与える
- 刺突スキルと同様の効果だが、巻物使用時のみ発動

### 強化術
- 術攻撃の効果
- 1.5倍ダメージ
- 共鳴ボーナス適用

---

## 詳細仕様

### 発動条件

#### クリーチャースキル「術攻撃」「強化術」
- クリーチャー自身が「術攻撃」または「強化術」スキルを持つ
- **バフ制約**: `base_up_ap`（永続AP上昇）以外のバフが入っていない場合のみ発動
  - ✅ OK: `base_up_ap`のみ（合成・マスグロース等による永続AP上昇）
  - ❌ NG: 加勢、共鳴、アイテムボーナス、スペルボーナス等の一時バフ
- バフが入っている場合は通常攻撃に変更される
- `is_using_scroll`フラグが立つ

#### アイテム「巻物」使用
- アイテムフェーズで巻物アイテムを使用（`_apply_scroll_attack()` で keyword_conditions に設定）
- バフの有無に関係なく発動（強制的に AP を設定）
- `is_using_scroll` フラグが立つ
- **実装完了**：クリーチャースキルと分けて実装済み

**AP適用の流れ**:
1. アイテムフェーズ：`_apply_scroll_attack()` で keyword_conditions に巻物設定を保存
2. スキル適用フェーズ：
   - 共鳴、強化などすべてのスキル実行
   - HP関連スキルも含めて全て適用
3. スキル適用終了後：`apply_skills()` の最後で AP を最終固定
   - `scroll_type` に応じて AP を再計算・固定
   - `"fixed_ap"`: 指定値に固定
   - `"base_ap"`: 基本 AP に固定
   - `"land_count"`: 土地数 × 係数で固定

### 無効化との関係
術攻撃は以下のスキルで無効化できる：
- 無効化[巻物]: 術攻撃のみ無効化
- 無効化[通常攻撃]: 術攻撃は無効化できない

詳細は [`docs/design/skills/nullify_skill.md`](nullify_skill.md) を参照。

---

## 実装のポイント

### アイテム巻物とクリーチャースキルの違い

| 項目 | クリーチャースキル | アイテム巻物 |
|------|-----------------|----------|
| 発動条件 | バフなしの場合のみ | 無条件 |
| AP 適用 | スキル内で設定 | スキル処理終了後に最終固定 |
| 他スキル | 実行されない（バフあるため） | 全スキル実行される |
| HP ボーナス | 適用される | 適用される |

### AP 最終固定の仕組み

- `apply_skills()` の最後で実行
- 他のスキル（共鳴、強化等）で変更された AP をリセット
- `scroll_type` に応じた値に固定
- 刻印や HP ボーナスには影響しない

---

## バグ修正履歴

### 2025/10/25 - バフ検出による術攻撃制約の追加

**問題**: 加勢などのバフが入っているクリーチャーでも術攻撃が発動し、APがリセットされていた

**例**: モルモ（加勢・共鳴・強化術持ち）
- 加勢でAP: 20 → 50
- 術攻撃判定でAP: 50 → 20にリセット ❌
- 共鳴でAP: 20 → 50
- 強化術でAP: 50 → 75

**修正内容**:
```gdscript
# バフチェック: base_up_ap以外のバフが入っていたら発動しない
var base_ap = participant.creature_data.get("ap", 0)
var expected_ap = base_ap + participant.base_up_ap

if participant.current_ap != expected_ap:
	# バフが入っている → 術攻撃不可
	return
```

**影響**: 
- クリーチャースキル「術攻撃」「強化術」はバフがあると発動しなくなった
- `base_up_ap`（永続AP上昇）のみ例外として許可
- アイテム「巻物」は無条件で発動（未実装）

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025/10/24 | 1.0 | 簡易版として作成（詳細仕様は今後追加予定） |
| 2025/10/25 | 1.1 | バフ検出による術攻撃制約を追加 |
| 2025/11/13 | 1.2 | アイテム巻物の完全実装、AP最終固定機能追加 |
