# 巻物攻撃スキル

**バージョン**: 1.1  
**最終更新**: 2025年10月25日

---

## 📋 目次

1. [概要](#概要)
2. [実装状況](#実装状況)
3. [主な効果](#主な効果)
4. [詳細仕様](#詳細仕様)

---

## 概要

巻物アイテムを使用した場合に発動する特殊攻撃スキル。

---

## 実装状況

✅ **完全実装**（2025年10月）

---

## 主な効果

### 巻物攻撃
- **土地ボーナスHP無視**: 防御側の土地ボーナスHPを無視してダメージを与える
- 貫通スキルと同様の効果だが、巻物使用時のみ発動

### 巻物強打
- 巻物攻撃の効果
- 1.5倍ダメージ
- 感応ボーナス適用

---

## 詳細仕様

### 発動条件

#### クリーチャースキル「巻物攻撃」「巻物強打」
- クリーチャー自身が「巻物攻撃」または「巻物強打」スキルを持つ
- **バフ制約**: `base_up_ap`（永続AP上昇）以外のバフが入っていない場合のみ発動
  - ✅ OK: `base_up_ap`のみ（合成・マスグロース等による永続AP上昇）
  - ❌ NG: 援護、感応、アイテムボーナス、スペルボーナス等の一時バフ
- バフが入っている場合は通常攻撃に変更される
- `is_using_scroll`フラグが立つ

#### アイテム「巻物」使用
- アイテムフェーズで巻物アイテムを使用
- バフの有無に関係なく発動（強制的にAPを設定）
- `is_using_scroll`フラグが立つ
- ※アイテム巻物は未実装.スキルの方とは分けて実装する必要がある

### 無効化との関係
巻物攻撃は以下のスキルで無効化できる：
- 無効化[巻物]: 巻物攻撃のみ無効化
- 無効化[通常攻撃]: 巻物攻撃は無効化できない

詳細は [`docs/design/skills/nullify_skill.md`](nullify_skill.md) を参照。

---

## 注意事項

⚠️ **このドキュメントは簡易版です**

巻物攻撃スキルの完全な仕様書は現在作成中です。以下の情報が不足しています：
- 巻物アイテムの一覧
- 巻物強打の詳細な計算式
- 実装コード例
- 使用例

---

## バグ修正履歴

### 2025/10/25 - バフ検出による巻物攻撃制約の追加

**問題**: 援護などのバフが入っているクリーチャーでも巻物攻撃が発動し、APがリセットされていた

**例**: モルモ（援護・感応・巻物強打持ち）
- 援護でAP: 20 → 50
- 巻物攻撃判定でAP: 50 → 20にリセット ❌
- 感応でAP: 20 → 50
- 巻物強打でAP: 50 → 75

**修正内容**:
```gdscript
# バフチェック: base_up_ap以外のバフが入っていたら発動しない
var base_ap = participant.creature_data.get("ap", 0)
var expected_ap = base_ap + participant.base_up_ap

if participant.current_ap != expected_ap:
	# バフが入っている → 巻物攻撃不可
	return
```

**影響**: 
- クリーチャースキル「巻物攻撃」「巻物強打」はバフがあると発動しなくなった
- `base_up_ap`（永続AP上昇）のみ例外として許可
- アイテム「巻物」は無条件で発動（未実装）

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025/10/24 | 1.0 | 簡易版として作成（詳細仕様は今後追加予定） |
| 2025/10/25 | 1.1 | バフ検出による巻物攻撃制約を追加 |
