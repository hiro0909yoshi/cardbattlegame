# 再生スキル

**プロジェクト**: カルドセプト風カードバトルゲーム  
**バージョン**: 1.5  
**最終更新**: 2025年10月24日

---

## 📋 目次

1. [概要](#概要)
2. [発動条件](#発動条件)
3. [効果](#効果)
4. [回復範囲](#回復範囲)
5. [適用タイミング](#適用タイミング)
6. [実装クリーチャー](#実装クリーチャー)
7. [データ構造](#データ構造)
8. [実装コード](#実装コード)
9. [使用例](#使用例)
10. [設計思想](#設計思想)

---

## 概要

バトル終了後に基本HPを全回復するパッシブスキル。

---

## 発動条件

- **生き残った場合のみ**発動（`current_hp > 0`）
- HP0以下（倒された）の場合は発動しない
- **無条件発動**（生存していれば必ず発動）

---

## 効果

- バトル終了後、`base_hp`を元の最大値まで回復
- 土地ボーナスや感応ボーナスは含まない（戦闘ごとにリセット）

---

## 回復範囲

再生スキルは**基本HPのみ**を回復します。

| 対象 | 回復 |
|------|------|
| ✅ 基本HP (`base_hp`) | する |
| ❌ 土地ボーナス (`land_bonus_hp`) | しない |
| ❌ 感応ボーナス (`resonance_bonus_hp`) | しない |
| ❌ アイテムボーナス (`item_bonus_hp`) | しない |
| ❌ スペルボーナス (`spell_bonus_hp`) | しない |

### 重要なポイント

土地ボーナスや感応ボーナスは戦闘ごとにリセットされる一時的なボーナスです。再生スキルはクリーチャー本来のHPのみを回復します。

---

## 適用タイミング

- **関数**: `BattleSystem._apply_regeneration()`
- **タイミング**: `_apply_post_battle_effects()`内（バトル結果判定後）
- **対象**: 侵略側・防御側の両方

### 処理フロー

```
1. バトル実行
   ↓
2. バトル結果判定
   ↓
3. ポストバトル処理
   ↓
4. 再生スキルチェック
   - HP > 0 ? → Yes
   - 再生キーワード保持 ? → Yes
   ↓
5. base_hp を最大値まで回復
   ↓
6. current_hp 再計算
```

---

## 実装クリーチャー

再生スキルを持つクリーチャーは全部で **11体** います。

| ID | 名前 | 属性 | 備考 |
|----|------|------|------|
| 113 | エキノダーム | 水 | 再生・不屈 |
| 125 | スラッジタイタン | 水 | 戦闘開始時HP減少・再生 |
| 129 | テンタクルズ | 水 | 再生 |
| 133 | バハムート | 水 | 先制・土地変性・再生 |
| 140 | マイコロン | 水 | 敵攻撃成功の戦闘後・再生 |
| 205 | カクタスウォール | 地 | 防御型・再生 |
| 219 | シルバンダッチェス | 地 | 援護・アイテム破壊・再生 |
| 233 | ヒーラー | 地 | 再生・秘術・不屈 |
| 242 | ヨルムンガンド | 地 | 先制・土地変性・再生 |
| 247 | ロックトロル | 地 | 再生 |
| 418 | スケルトン | 無 | 再生 |

### 注目すべきクリーチャー

#### バハムート & ヨルムンガンド
- **先制 + 再生**: 先に攻撃して、ダメージを受けても回復
- **土地変性**: 戦略的な土地操作も可能

#### エキノダーム & ヒーラー
- **不屈 + 再生**: 何度でも行動でき、ダメージを受けても回復
- 最強の防衛クリーチャー

---

## データ構造

```json
{
  "ability_parsed": {
	"keywords": ["再生"]
  }
}
```

---

## 実装コード

```gdscript
func _apply_regeneration(participant: BattleParticipant) -> void:
	# 1. 生存チェック（HP > 0）
	if not participant.is_alive():
		return
	
	# 2. 再生キーワードチェック
	var ability_parsed = participant.creature_data.get("ability_parsed", {})
	var keywords = ability_parsed.get("keywords", [])
	
	if "再生" in keywords:
		# 3. base_hpを元の最大HPまで回復
		var max_base_hp = participant.creature_data.get("hp", 0)
		
		if participant.base_hp < max_base_hp:
			var healed = max_base_hp - participant.base_hp
			participant.base_hp = max_base_hp
			participant.update_current_hp()
			print("【再生発動】", participant.creature_data.get("name", "?"), 
				  " HP回復: +", healed, " → ", participant.current_hp)
```

---

## 使用例

### シナリオ1: 基本的な再生

```
1. バトル開始
   侵略側: ロックトロル HP:50/50
   防御側: フェニックス HP:30/30

2. 戦闘実行
   フェニックスの攻撃 → ロックトロルに30ダメージ
   ロックトロル HP:50 → 20
   ロックトロルの反撃 → フェニックス撃破

3. バトル終了後
   【再生発動】ロックトロル HP回復: +30 → 50
   → 次のバトルでは満タンの状態！
```

### シナリオ2: 土地ボーナスは回復しない

```
1. バトル開始
   防御側: テンタクルズ（基本HP:30、土地ボーナス+20）
   総HP: 50

2. 戦闘実行
   テンタクルズ被ダメージ: 40
   残HP: 10（土地ボーナス消費、基本HPも一部消費）

3. バトル終了後
   【再生発動】
   - 基本HP: 30まで回復
   - 土地ボーナス: 0のまま（回復しない）
   
4. 次のバトル
   総HP: 30（基本のみ） + 新しい土地ボーナス
```

### シナリオ3: 再生 + 不屈の組み合わせ

```
1. ターン開始
   自陣: エキノダーム（再生・不屈、HP:40）配置

2. 敵の攻撃
   被ダメージ: 25
   残HP: 15

3. バトル終了後
   【再生発動】HP: 15 → 40

4. 同じターン内
   - 不屈により領地コマンド実行可能
   - レベルアップで防御力強化
   - HPは40で維持

5. 次の敵の攻撃にも備えられる
```

---

## 戦略的価値

### メリット

1. **永続的な回復**: 配置クリーチャーとして残る限り、何度でも再生
2. **土地防衛に最適**: 防御側として配置すれば長期間生き残れる
3. **リソース節約**: HP回復アイテムや魔法が不要
4. **不屈との相乗効果**: 何度も戦闘→回復を繰り返せる

### デメリット

1. **倒されたら無意味**: HP0になると再生しない
2. **土地ボーナスは消える**: 戦闘ごとにボーナスはリセット
3. **一撃必殺に弱い**: 即死や大ダメージには無力

### 相性の良いスキル

- **不屈**: 連続戦闘 + 毎回回復で無敵に近い
- **先制**: 先に攻撃してダメージを減らし、受けたダメージは回復
- **反射**: ダメージを返しつつ、自分は回復

---

## 設計思想

- **永続的な回復**: 配置クリーチャーとして残る限り、何度でも再生
- **土地防衛に有利**: 防御側として配置されたクリーチャーが長期間生き残る
- **基本HPのみ回復**: 土地ボーナス等は戦闘ごとにリセットされる仕様と整合

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.5 | 2025/10/24 | 個別ドキュメントとして分離 |
