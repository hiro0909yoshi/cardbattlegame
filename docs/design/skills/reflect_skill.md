# 反射スキル

**バージョン**: 1.0  
**最終更新**: 2025年10月24日

---

## 📋 目次

1. [概要](#概要)
2. [実装状況](#実装状況)
3. [スキルパターン](#スキルパターン)
4. [発動タイミング](#発動タイミング)
5. [反射の種類](#反射の種類)
6. [反射無効スキル](#反射無効スキル)
7. [先制攻撃との関係](#先制攻撃との関係)
8. [勝敗判定](#勝敗判定)
9. [実装クリーチャー・アイテム](#実装クリーチャーアイテム)
10. [ability_parsed定義](#ability_parsed定義)
11. [処理フロー](#処理フロー)
12. [戦略的価値](#戦略的価値)
13. [注意事項](#注意事項)

---

## 概要

攻撃を受けた時、ダメージを攻撃者に返すリアクティブスキル。反射率によって自分が受けるダメージと返すダメージの割合が変わる。

---

## 実装状況

✅ **実装完了**（2025年10月23日）

---

## スキルパターン

| パターン | 自分ダメージ | 返すダメージ | 対象攻撃 |
|---------|------------|------------|---------|
| **反射100%** | 0% | 100% | 通常攻撃 or 術攻撃 |
| **反射50%** | 50% | 50% | 通常攻撃 |

---

## 発動タイミング

```
1. 攻撃側の攻撃（先制含む）
2. ダメージ計算
3. 反射判定 ← ここで発動
4. ダメージ適用
   - 防御側：元ダメージ × (1 - 反射率)
   - 攻撃側：元ダメージ × 反射率
5. 勝敗判定
```

---

## 反射の種類

### 1. 反射[通常攻撃] / 反射（100%）

- **効果**: 通常攻撃を100%反射（自分はダメージ0）
- **対象**: デコイ(426)

**ability_parsed**:
```json
{
  "keywords": ["反射"],
  "effects": [{
	"effect_type": "reflect_damage",
	"reflect_ratio": 1.0,
	"attack_types": ["normal"]
  }]
}
```

**例**:
```
攻撃者AP: 100
防御側: デコイ（反射100%）

結果:
- デコイが受けるダメージ: 0
- 攻撃者が受けるダメージ: 100
```

---

### 2. 反射[1/2]（50%）

- **効果**: 通常攻撃を50%反射（自分は50%ダメージ）
- **対象**: ナイトエラント(25), スパイクシールド(1025)

**ability_parsed**:
```json
{
  "keywords": ["反射[1/2]"],
  "effects": [{
	"effect_type": "reflect_damage",
	"reflect_ratio": 0.5,
	"attack_types": ["normal"]
  }]
}
```

**例**:
```
攻撃者AP: 100
防御側: ナイトエラント（反射50%）

結果:
- ナイトエラントが受けるダメージ: 50
- 攻撃者が受けるダメージ: 50
```

---

### 3. 反射[巻物]（100%）

- **効果**: 術攻撃を100%反射（自分はダメージ0）
- **対象**: メイガスミラー(1069)

**ability_parsed**:
```json
{
  "keywords": ["反射[巻物]"],
  "effects": [{
	"effect_type": "reflect_damage",
	"reflect_ratio": 1.0,
	"attack_types": ["scroll"]
  }]
}
```

---

### 4. 反射[全]（100%）

- **効果**: 通常攻撃・術攻撃を100%反射（自分はダメージ0）
- **対象**: ミラーホブロン(1066)
- **条件**: 敵アイテム未使用時のみ

**ability_parsed**:
```json
{
  "keywords": ["反射[全]"],
  "effects": [{
	"effect_type": "reflect_damage",
	"reflect_ratio": 1.0,
	"attack_types": ["normal", "scroll"],
	"conditions": [{
	  "condition_type": "enemy_no_item"
	}]
  }]
}
```

---

## 反射無効スキル

### 概要

攻撃側が持つと、相手の反射を無効化するパッシブスキル。

### 対象

- ムラサメ(1068)

**ability_parsed**:
```json
{
  "keywords": ["反射無効"],
  "effects": [{
	"effect_type": "nullify_reflect"
  }]
}
```

**効果**:
```
攻撃側: ムラサメ装備（反射無効）
防御側: デコイ（反射100%）

結果:
- デコイの反射は発動しない
- デコイが100%ダメージを受ける
```

---

## 先制攻撃との関係

反射は先制攻撃でも発動する。

**例**:
```
攻撃側: AP 60（先制あり）
防御側: HP 50、AP 70（反射100%あり）

1. 先制攻撃: AP 60
2. 反射発動: 60ダメージ返す
3. 結果:
   - 防御側: ダメージ0（生存）
   - 攻撃側: 60ダメージ受ける
```

---

## 勝敗判定

反射ダメージによる勝敗判定は通常と同じ。

### 例1: 防御側勝利

```
攻撃側: AP 100、HP 40
防御側: HP 80、AP 50（反射50%）

1. 攻撃: 100ダメージ
2. 反射: 50ダメージ返す
3. 結果:
   - 防御側: HP 80 - 50 = 30（生存）
   - 攻撃側: HP 40 - 50 = -10（死亡）
   → 防御側の勝利
```

### 例2: 攻撃側勝利

```
攻撃側: AP 200、HP 100
防御側: HP 80、AP 50（反射50%）

1. 攻撃: 200ダメージ
2. 反射: 100ダメージ返す
3. 結果:
   - 防御側: HP 80 - 100 = -20（死亡）
   - 攻撃側: HP 100 - 100 = 0（死亡）
   → 攻撃側の勝利（先に攻撃したため）
```

---

## 実装クリーチャー・アイテム

### クリーチャー（2体）

| ID | 名前 | 属性 | AP | HP | スキル | 効果 |
|----|------|------|----|----|--------|------|
| 426 | デコイ | 無 | 0 | 10 | 反射[通常攻撃] | 通常攻撃100%反射 |
| 25 | ナイトエラント | 火 | 40 | 30 | 合成・反射[1/2] | 通常攻撃50%反射 |

**注意**: ナイトエラントは合成後に変身するため、変身後は反射スキルを失う。

### アイテム（4個）

| ID | 名前 | タイプ | 効果 | 詳細 |
|----|------|--------|------|------|
| 1025 | スパイクシールド | 防具 | 反射[1/2] | 通常攻撃50%反射 |
| 1066 | ミラーホブロン | 防具 | 敵アイテム未使用時、反射[全] | 条件付き：通常・巻物100%反射 |
| 1068 | ムラサメ | 武器 | AP+20；反射無効 | 相手の反射を無効化 |
| 1069 | メイガスミラー | アクセサリ | HP+20；反射[巻物] | 術攻撃100%反射 |

---

## ability_parsed定義

### 反射100%（通常攻撃）- デコイ

```json
{
  "ability": "反射",
  "ability_detail": "反射[通常攻撃]",
  "ability_parsed": {
	"keywords": ["反射"],
	"effects": [
	  {
		"effect_type": "reflect_damage",
		"reflect_ratio": 1.0,
		"self_damage_ratio": 0.0,
		"attack_types": ["normal"],
		"triggers": ["on_damaged"]
	  }
	]
  }
}
```

### 反射50%（通常攻撃）- ナイトエラント、スパイクシールド

```json
{
  "ability": "反射",
  "ability_detail": "反射[1/2]",
  "ability_parsed": {
	"keywords": ["反射"],
	"effects": [
	  {
		"effect_type": "reflect_damage",
		"reflect_ratio": 0.5,
		"self_damage_ratio": 0.5,
		"attack_types": ["normal"],
		"triggers": ["on_damaged"]
	  }
	]
  }
}
```

### 反射100%（術攻撃）- メイガスミラー

```json
{
  "ability": "反射[巻物]",
  "ability_detail": "反射[巻物]",
  "ability_parsed": {
	"keywords": ["反射[巻物]"],
	"effects": [
	  {
		"effect_type": "reflect_damage",
		"reflect_ratio": 1.0,
		"self_damage_ratio": 0.0,
		"attack_types": ["scroll"],
		"triggers": ["on_damaged"]
	  }
	]
  }
}
```

### 反射100%（全攻撃）- ミラーホブロン

```json
{
  "ability": "反射[全]",
  "ability_detail": "敵アイテム未使用時、反射[全]",
  "ability_parsed": {
	"keywords": ["反射[全]"],
	"effects": [
	  {
		"effect_type": "reflect_damage",
		"reflect_ratio": 1.0,
		"self_damage_ratio": 0.0,
		"attack_types": ["normal", "scroll"],
		"triggers": ["on_damaged"],
		"conditions": [
		  {
			"condition_type": "enemy_no_item"
		  }
		]
	  }
	]
  }
}
```

### 反射無効 - ムラサメ

```json
{
  "ability": "反射無効",
  "ability_detail": "AP+20；反射無効",
  "ability_parsed": {
	"keywords": ["反射無効"],
	"effects": [
	  {
		"effect_type": "nullify_reflect",
		"triggers": ["before_attack"]
	  }
	]
  }
}
```

---

## 処理フロー

```
1. 攻撃判定
2. 攻撃側の「反射無効」チェック
   - あり → 反射スキップ、通常ダメージ
   - なし → 3へ
3. 防御側の反射スキルチェック
   - なし → 通常ダメージ
   - あり → 4へ
4. 攻撃タイプと反射タイプの一致確認
   - 不一致 → 通常ダメージ
   - 一致 → 5へ
5. 反射条件チェック（条件付き反射の場合）
   - 条件不成立 → 通常ダメージ
   - 条件成立 → 6へ
6. 反射ダメージ計算
   - 防御側が受けるダメージ = 元ダメージ × self_damage_ratio
   - 攻撃側が受けるダメージ = 元ダメージ × reflect_ratio
7. 勝敗判定
```

---

## 戦略的価値

- **低HP防御**: デコイ（HP10）でも大型クリーチャーを倒せる
- **先制対策**: 先制攻撃を反射で返せる
- **巻物対策**: メイガスミラーで術攻撃を防げる
- **反射メタ**: ムラサメで反射戦略を封じられる

---

## 注意事項

### 1. 合成スキルとの関係

ナイトエラントが合成で変身した後、反射スキルは消える

### 2. HPを超えるダメージ

防御側のHPを超えるダメージでも、元のダメージを基準に反射

```
攻撃AP: 300
防御HP: 50（反射50%）

結果:
- 防御側: 150ダメージ受けて死亡
- 攻撃側: 150ダメージ返す
```

### 3. 反射の連鎖なし

反射ダメージはさらに反射されない

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025/10/24 | 1.0 | 個別ドキュメントとして分離 |
