# 通行料操作システム設計

**最終更新**: 2025年11月24日 | **実装状況**: ✅ 実装完了

---

## 概要

通行料操作は、クリーチャーが持つ固有スキルです。クリーチャーが配置されている間、永続的に通行料を変更します。

---

## 優先順位

```
1. スペル呪い（peace, toll_multiplier, toll_fixed） ← 最優先
2. クリーチャースキル（toll_change）
3. 通常計算（MP値 × 土地レベル係数）
```

スペル呪いがある場合、クリーチャースキルは完全に無視されます。

---

## 対象クリーチャー

| ID | 名前 | 要素 | スキル | 効果 |
|----|----|------|--------|------|
| 230 | ドワーフマイナー | 地 | 通行料変化[1.5倍] | 倍率：1.5 |
| 343 | ヨーウィ | 風 | 通行料変化[1/2～2.5倍] | 可変倍率：0.5～2.5 |
| 411 | グレートフォシル | 無 | 通行料変化[0EP] | 固定値：0 |
| 422 | スチームギア | 無 | 通行料変化[1/2] | 倍率：0.5 |

**ヨーウィの可変倍率について：** 移動時にランダムに0.5～2.5の倍率が決定されます。毎回異なる値が適用されます。

---

## 実装

### クラス: SkillTollChange
**ファイル**: `scripts/skills/skill_toll_change.gd`

メインメソッド：
- `get_toll_change_effect()` - ability_parsed から toll_change effect を取得
- `calculate_final_toll()` - 倍率型・固定値型・可変倍率型に対応して計算

### 統合: SpellCurseToll
**ファイル**: `scripts/spells/spell_curse_toll.gd`

`calculate_final_toll()` で以下の順序で処理：
1. スペル呪いをチェック（peace, toll_multiplier, toll_fixed）
2. クリーチャースキルをチェック（toll_change）
3. 通常計算を実行

---

## 使用例

**グレートフォシル（0EP）:**
- 基本: 70G → クリーチャースキル（value=0） → **最終: 0G**

**ドワーフマイナー（1.5倍）:**
- 基本: 70G × 土地Lv2（1.2） = 84G → クリーチャースキル（×1.5） → **最終: 126G**

**スチームギア（1/2倍）:**
- 基本: 70G → クリーチャースキル（×0.5） → **最終: 35G**

**ヨーウィ（可変1/2～2.5倍）:**
- 基本: 70G → クリーチャースキル（ランダム） → **最終: 35G～175G**（毎回異なる）

**スペル呪い優先の例:**
- ドワーフマイナー（1.5倍）の領地に toll_fixed（200G）呪い付与
- → クリーチャースキルは無視 → **最終: 200G**（呪いが優先）

---

## 実装ファイル

| ファイル | 役割 |
|---------|------|
| `scripts/skills/skill_toll_change.gd` | 通行料計算処理（倍率・固定値・可変） |
| `scripts/spells/spell_curse_toll.gd` | 優先順位管理・統合処理 |
| `data/earth_2.json` | ID 230（ドワーフマイナー） |
| `data/wind_2.json` | ID 343（ヨーウィ） |
| `data/neutral_1.json` | ID 411（グレートフォシル）、ID 422（スチームギア） |
