# 合体スキル

**バージョン**: 1.0  
**最終更新**: 2025年12月10日

---

## 📋 目次

1. [概要](#概要)
2. [発動条件](#発動条件)
3. [発動タイミング](#発動タイミング)
4. [効果](#効果)
5. [コスト計算](#コスト計算)
6. [実装済みクリーチャー](#実装済みクリーチャー)
7. [使用例](#使用例)
8. [JSONデータ形式](#jsonデータ形式)
9. [実装メモ](#実装メモ)

---

## 概要

特定のクリーチャー同士を掛け合わせると、**別のクリーチャーに永続的に変化**するスキル。バトル中に自動発動し、変化後のクリーチャーでバトルを行う。

---

## 発動条件

- バトル参加クリーチャーが「合体」スキルを持っている
- 手札に合体相手（partner_id）のクリーチャーがいる
- 合体相手のコスト分の魔力を支払える

---

## 発動タイミング

```
召喚フェーズ → アイテム選択フェーズ（合体相手を選択）→ バトル開始処理
```

- **アイテム選択フェーズ**で合体相手を選択して発動
- 援護スキルと同様の選択式（アイテムの代わりに合体相手を選ぶ）
- 合体相手を選択しなければ合体しない（アイテムを使うか、パスする選択肢もある）

---

## 効果

| 項目 | 内容 |
|------|------|
| クリーチャー変化 | result_idで指定されたクリーチャーに変身 |
| ステータス | 変身先の基本ステータスになる |
| スキル | 変身先のスキルになる |
| 永続性 | **永続変化**（戦闘後も元に戻らない） |
| 合体相手カード | 捨て札へ |

---

## コスト計算

通常のコスト計算と同様：

```
合計コスト = 召喚コスト + アイテムコスト + 合体相手コスト
```

- 合体相手クリーチャーのmp値をそのまま魔力消費

---

## 実装済みクリーチャー

**合計3体**が合体スキルを持っています。

### 合体パターン一覧

| バトル側 | ID | 合体相手 | partner_id | 結果 | result_id |
|----------|-----|----------|------------|------|-----------|
| アンドロギア | 406 | ビーストギア | 434 | ギアリオン | 408 |
| グランギア | 409 | スカイギア | 419 | アンドロギア | 406 |
| スカイギア | 419 | グランギア | 409 | アンドロギア | 406 |

※ グランギア + スカイギア と スカイギア + グランギア は同じ結果（アンドロギア）

---

## 使用例

### シナリオ: グランギアの合体

```
1. グランギア（ID:409、合体スキル持ち）でバトル開始
2. 手札にスカイギア（ID:419）がある
3. アイテム選択フェーズ完了後、合体フェーズに入る
4. 自動的に合体発動
   - スカイギアのコスト分の魔力を消費
   - スカイギアは捨て札へ
5. グランギアがアンドロギア（ID:406）に永続変化
6. アンドロギアのステータス・スキルでバトル開始
7. 戦闘後もアンドロギアのまま（タイルのクリーチャーデータも更新済み）
```

---

## JSONデータ形式

### ability_parsed内の定義

```json
{
  "ability_parsed": {
	"keywords": ["合体"],
	"keyword_conditions": {
	  "合体": {
		"partner_id": 419,
		"result_id": 406
	  }
	}
  }
}
```

### パラメータ

| キー | 型 | 説明 |
|------|-----|------|
| partner_id | int | 合体相手のクリーチャーID |
| result_id | int | 合体結果のクリーチャーID |

---

## 実装メモ

### 実装ファイル

**コアロジック**:
- `scripts/battle/skills/skill_merge.gd` - 合体スキル判定
  - `has_merge_skill()` - 合体スキル所持チェック
  - `get_merge_partner_id()` - 合体相手IDを取得
  - `get_merge_result_id()` - 合体結果IDを取得
  - `find_merge_partner_in_hand()` - 手札に合体相手がいるかチェック

**統合部分**:
- `scripts/game_flow/item_phase_handler.gd` - 合体処理の実行
  - `_execute_merge()` - 合体効果を適用
  - `was_merged()` - 合体が発生したか
  - `get_merged_creature()` - 合体後のクリーチャーデータ取得
- `scripts/tile_action_processor.gd` - 合体後データをバトルに渡す

### 援護スキルとの違い

| 項目 | 援護 | 合体 |
|------|------|------|
| 発動タイミング | アイテムフェーズ | アイテムフェーズ後 |
| 発動方式 | 手動選択 | 自動発動 |
| 効果 | AP/HP加算 | クリーチャー変身 |
| 永続性 | 戦闘中のみ | 永続変化 |
| スキル継承 | なし | 変身先のスキル |
| タイルデータ | 変更なし | 更新必要 |

### 処理フロー

```
1. アイテムフェーズ開始時、合体スキルをチェック
2. 手札に合体相手がいれば選択可能として表示
3. プレイヤーが合体相手を選択した場合:
   a. 魔力消費
   b. 合体相手を捨て札へ
   c. result_idのクリーチャーデータを取得
   d. merged_creature_dataに保存
4. アイテムフェーズ完了時、tile_action_processorで合体データを取得
5. pending_battle_card_dataを合体後のデータに更新
6. バトル開始処理へ（合体後のクリーチャーでバトル）
```

※ 永続化は侵略成功時にタイルに配置されるため、バトルシステム側で行われる

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025/12/10 | 1.0 | 初版作成 |
