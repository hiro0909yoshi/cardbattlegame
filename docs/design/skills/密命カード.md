# 密命カードシステム

**バージョン**: 2.0  
**最終更新**: 2025年11月11日

---

## 概要

密命カードは、自分には内容が見えるが相手プレイヤーには真っ黒に表示される特殊なカードシステム。

**対象カードタイプ**: スペル専用（現時点）

**ゲームデザイン的意図**:
- 戦略的な駆け引きを生む
- 相手に「何を使われるか分からない」緊張感を与える
- 密命の条件達成・失敗も相手には明かされない

---

## データ構造

### spells.json での定義

```json
{
  "id": 2029,
  "name": "サドンインパクト",
  "rarity": "N",
  "type": "spell",
  "spell_type": "単体対象",
  "is_secret": true,
  "cost": {
	"mp": 100
  },
  "effect": "密命；対象レベル4領地のレベルを1下げる",
  "effect_parsed": {
	"target_type": "land",
	"target_info": {
	  "owner_filter": "any",
	  "required_level": 4
	},
	"effects": [
	  {
		"effect_type": "change_level",
		"value": -1
	  }
	]
  }
}
```

**フラグの意味**:
- `is_secret: true` → 密命カード（相手には真っ黒に表示）
- `is_secret: false` または省略 → 通常カード（デフォルト）

---

## 表示ルール

### 基本仕様

このゲームは**常にプレイヤー0（人間）視点**でプレイします：
- プレイヤー0（自分）: 手札が見える、密命カードも見える
- プレイヤー1（CPU）: 手札は見えるが、**密命カードだけは真っ黒**

### 手札での表示

| プレイヤー | 通常カード | 密命カード |
|-----------|-----------|-----------|
| プレイヤー0（自分） | 見える | 見える |
| プレイヤー1（CPU） | 見える | **真っ黒で見えない** |

**重要**: このゲームは相手の手札が見えるゲームですが、密命カードだけは例外です。

---

## 実装アーキテクチャ

### 1. Card.gd の拡張

```gdscript
# 密命カード用の変数
var owner_player_id: int = -1      # このカードの所有者
var viewing_player_id: int = -1    # 現在表示を見ているプレイヤー（常に0）
var is_showing_secret_back: bool = false  # 裏面（真っ黒）表示中か

# カードデータを設定（所有者情報も含む）
func set_card_data_with_owner(data: Dictionary, owner: int):
	card_data = data
	owner_player_id = owner
	_update_secret_display()

# 表示を見ているプレイヤーを設定（常に0）
func set_viewing_player(viewer_id: int):
	viewing_player_id = viewer_id
	_update_secret_display()

# 表示を更新（密命判定）
func _update_secret_display():
	var is_secret = card_data.get("is_secret", false)
	
	# 密命カードで、所有者以外が見ている場合
	if is_secret and viewing_player_id != owner_player_id and viewing_player_id != -1:
		_show_secret_back()
	else:
		_show_card_front()

# 裏面表示に切り替え（カード全体を真っ黒に）
func _show_secret_back():
	if is_showing_secret_back:
		return
	
	is_showing_secret_back = true
	
	# カード全体を覆う黒いColorRectを作成
	var black_overlay = ColorRect.new()
	black_overlay.name = "SecretBlackOverlay"
	black_overlay.color = Color(0, 0, 0, 1)
	black_overlay.size = size
	black_overlay.position = Vector2.ZERO
	black_overlay.mouse_filter = Control.MOUSE_FILTER_IGNORE
	
	# 最前面に配置
	add_child(black_overlay)
	move_child(black_overlay, get_child_count() - 1)

# 通常表示に切り替え
func _show_card_front():
	if not is_showing_secret_back:
		return
	
	is_showing_secret_back = false
	
	# 黒いオーバーレイを削除
	var overlay = get_node_or_null("SecretBlackOverlay")
	if overlay:
		overlay.queue_free()
```

### 2. HandDisplay.gd の修正

```gdscript
func create_card_node(card_data: Dictionary, _index: int, player_id: int) -> Node:
	# ...（カード生成処理）...
	
	# まず従来の方法でカードを表示
	if card.has_method("load_card_data"):
		card.load_card_data(card_data.get("id", 0))
	
	# 密命カード対応: card_dataを上書きして密命情報を含める
	card.card_data = card_data
	card.owner_player_id = player_id
	# 重要: 常にプレイヤー0（人間）が見ている
	card.viewing_player_id = 0
	
	# 密命カードの表示判定
	if card.has_method("_update_secret_display"):
		card._update_secret_display()
	
	return card
```

**ポイント**: `viewing_player_id` を常に `0` に設定することで、プレイヤー0視点で表示されます。

### 3. CardSelectionUI.gd の修正

```gdscript
func enable_card_selection(hand_data: Array, available_magic: int, player_id: int = 0):
	# ...
	for i in range(hand_nodes.size()):
		var card_node = hand_nodes[i]
		if card_node and is_instance_valid(card_node):
			var card_data = hand_data[i]
			
			# 密命カード対応: カードの所有者と閲覧者を設定
			if card_node.has_method("set_card_data_with_owner"):
				card_node.set_card_data_with_owner(card_data, player_id)
			if card_node.has_method("set_viewing_player"):
				# 常にプレイヤー0（人間）が見ている
				card_node.set_viewing_player(0)
	# ...
```

### 4. SpellPhaseHandler.gd での処理

```gdscript
func execute_spell_effect(spell_card: Dictionary, target_data: Dictionary):
	current_state = State.EXECUTING_EFFECT
	
	# 密命カード使用時のログ出力
	var is_secret = spell_card.get("is_secret", false)
	if is_secret:
		print("[密命発動] プレイヤー%d が密命カード「%s」を使用" % [current_player_id, spell_card.get("name", "???")])
	
	# 効果実行
	# ...
```

---

## 密命スペル一覧

### 実装済みの密命カード

| ID | 名前 | コスト | 効果 | 実装状況 |
|----|------|--------|------|---------|
| 2029 | サドンインパクト | 100G | 対象レベル4領地のレベルを1下げる | ✅ 完全実装 |

### 実装予定の密命カード

| ID | 名前 | コスト | 条件 | 成功効果 | 失敗効果 |
|----|------|--------|------|---------|---------|
| 2004 | アセンブルカード | 50G | 手札に火水風地がある | 500EP獲得 | カードを2枚引く |
| 2085 | フラットランド | 40G | レベル2領地を5つ持つ | それらをレベル+1 | 復帰[ブック] |
| 2096 | ホームグラウンド | 50G | 属性違いの領地を4つ持つ | 合う属性に変化 | 復帰[ブック] |

**復帰[ブック]**: 既存のアイテム復帰スキル（`skill_item_return.gd`）を活用し、使用者のデッキのランダムな位置に戻る

---

## テスト方法

### 基本テスト

1. Godotを実行
2. **Lキー**で現在のタイルをレベル4に設定
3. プレイヤー1のターンで **Hキー** → `2029` を入力
4. プレイヤー1の手札にサドンインパクトが**真っ黒**で表示されることを確認 ✅
5. スペルフェーズでカードを選択してレベル4の土地を対象に使用
6. レベルが3に下がることを確認 ✅

### 期待される動作

- プレイヤー0の手札: 密命カードも通常表示
- プレイヤー1の手札: 密命カードは真っ黒に表示
- スペル使用時: `[密命発動]` ログが出力される

---

## 技術的な注意事項

### 1. viewing_player_id の設定

**重要**: このゲームは常にプレイヤー0視点なので、`viewing_player_id` は常に `0` に設定する。

```gdscript
card.viewing_player_id = 0  // 常に0（人間プレイヤー）
```

### 2. 密命カードの表示判定

```gdscript
if is_secret and viewing_player_id != owner_player_id and viewing_player_id != -1:
	_show_secret_back()  // 真っ黒表示
```

- プレイヤー0の密命カード: `viewing(0) == owner(0)` → 通常表示
- プレイヤー1の密命カード: `viewing(0) != owner(1)` → 真っ黒表示

### 3. ColorRectによる真っ黒表示

グレーアウトと異なり、カード全体を覆う黒いColorRectを使用：

```gdscript
var black_overlay = ColorRect.new()
black_overlay.color = Color(0, 0, 0, 1)  // 完全な黒
black_overlay.size = size  // カード全体のサイズ
```

---

## 将来の拡張案

### クリーチャー・アイテムへの拡張

```json
{
  "id": 3001,
  "name": "スパイクリーチャー",
  "type": "creature",
  "is_secret": true,
  "ap": 50,
  "hp": 50
}
```

### 密命カード裏面のデザイン

現在は真っ黒だが、将来的には：
- 「？」マークの表示
- 専用の裏面デザイン（カードゲーム風）
- アニメーション効果

---

## 関連ドキュメント

- [スペルシステム設計](../spells_design.md) - 密命システムの全体設計
- [カードシステム](../card_system_multi_deck.md) - カードデータの管理
- [領地変更スペル](../spells/領地変更.md) - サドンインパクトの詳細

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025/11/10 | 1.0 | 初版作成 - 密命カードシステムの設計ドキュメント |
| 2025/11/11 | 2.0 | ✅ 実装完了 - ColorRectによる真っ黒表示実装、viewing_player_id常に0に修正 |

---

**最終更新**: 2025年11月11日（v2.0 - 実装完了）
