# アイテム復帰スキル

**プロジェクト**: カルドセプト風カードバトルゲーム  
**バージョン**: 1.0  
**最終更新**: 2025年11月10日

---

## 📋 目次

1. [概要](#概要)
2. [発動タイミング](#発動タイミング)
3. [復帰タイプ](#復帰タイプ)
4. [実装アイテム](#実装アイテム)
5. [実装クリーチャー](#実装クリーチャー)
6. [データ構造](#データ構造)
7. [実装コード](#実装コード)
8. [他スキルとの相互作用](#他スキルとの相互作用)
9. [設計思想](#設計思想)

---

## 概要

戦闘で使用したアイテムを再利用できる経済的なスキル。

**特徴**: 
- 使用したアイテムが破棄されずに戻る
- 戻り先は「ブック」または「手札」
- 手札満杯でも強制的に手札に追加可能
- **マルチデッキ対応**: 使用者自身のデッキに戻る（敵のデッキには影響しない）

---

## 発動タイミング

### アイテム使用後（after_item_use）

- **タイミング**: 戦闘でアイテムを使用した直後
- **発動条件**: スキル保有者がアイテムを使用した場合
- **効果**: 使用したアイテムを指定先に戻す

**処理順序**:
```
1. アイテム効果適用
2. アイテム使用処理（通常は捨て札へ）
3. 復帰スキルチェック
4. 条件を満たせば復帰処理実行
```

---

## 復帰タイプ

### 1. ブックへ復帰 (`return_to_deck`)
- 使用したアイテムがデッキ（ブック）に戻る
- **デッキのランダムな位置に挿入される**（即座に引けない）
- 数ターン後にランダムなタイミングで再度引ける可能性
- **重要**: 使用者のデッキに戻る（マルチデッキ対応）

### 2. 手札へ復帰 (`return_to_hand`)
- 使用したアイテムが即座に手札に戻る
- 手札上限（6枚）を超えても強制的に追加
- その後の手札調整フェーズで通常のカード捨て処理

**手札満杯時の処理**:
```
戦闘前: 手札6枚（上限）
↓
アイテム使用: ブーメラン使用
↓
復帰発動: 手札に戻る → 手札7枚（一時的に上限超過）
↓
ターン終了時: 通常の手札調整処理
  → プレイヤーが1枚選んで捨てる
  → 手札6枚に戻る
```

---

## 実装アイテム

### 実装予定（3個）

| ID | 名前 | レアリティ | アイテム種別 | 効果 | 復帰先 |
|---|------|---------|----------|-----|-------|
| 1005 | エターナルメイル | N | 防具 | HP+40 | ブック |
| 1030 | ソウルレイ | S | 巻物 | 巻物攻撃[ST30] | 手札 |
| 1054 | ブーメラン | S | 武器 | ST+20；HP+10 | 手札 |

---

## 実装クリーチャー

### 実装済み（2体）

| ID | 名前 | レアリティ | 属性 | 効果 | 復帰先 |
|---|------|---------|-----|-----|-------|
| 314 | ケンタウロス | N | wind | 先制；アイテム復帰[ブック] | ブック（全アイテム） |
| 41 | フレイムデューク | R | fire | 先制；武器使用時、強打；アイテム復帰[ブック] | ブック（全アイテム） |

**特殊仕様**:
- 両者とも使用したアイテム**全て**をブックに戻す
- アイテム復帰の汎用版
- フレイムデュークは強打も持つため、武器との相性が良い

---

## データ構造

### アイテムの復帰効果

アイテムカードの`effect_parsed.effects`配列に記述：

```json
{
  "effect_type": "item_return",
  "trigger": "after_item_use",
  "return_type": "return_to_deck" または "return_to_hand"
}
```

**例 - エターナルメイル（ID: 1005）**:
```json
{
  "id": 1005,
  "name": "エターナルメイル",
  "effect": "HP+40；復帰[ブック]",
  "effect_parsed": {
	"stat_bonus": {
	  "hp": 40
	},
	"effects": [
	  {
		"effect_type": "item_return",
		"trigger": "after_item_use",
		"return_type": "return_to_deck"
	  }
	]
  }
}
```

### クリーチャーの復帰効果

クリーチャーの`ability_parsed.effects`配列に記述：

```json
{
  "effect_type": "item_return",
  "trigger": "after_item_use",
  "return_type": "return_to_deck",
  "target": "all_items"
}
```

**例 - ケンタウロス（ID: 314）**:
```json
{
  "id": 314,
  "name": "ケンタウロス",
  "ability": "先制・アイテム復帰",
  "ability_detail": "先制；アイテム復帰[ブック]",
  "ability_parsed": {
	"keywords": ["先制"],
	"effects": [
	  {
		"effect_type": "item_return",
		"trigger": "after_item_use",
		"return_type": "return_to_deck",
		"target": "all_items"
	  }
	]
  }
}
```

---

## 実装コード

**実装箇所**: `scripts/skills/skill_item_return.gd`

### 主要メソッド

#### `check_and_apply_item_return(participant, used_items, player_id)`
- アイテム復帰の条件チェックと実行
- **引数**:
  - `participant`: BattleParticipant（スキル保有者）
  - `used_items`: Array[Dictionary]（使用したアイテムのリスト）
  - `player_id`: int（プレイヤーID）
- **戻り値**: Dictionary（復帰したアイテム情報）

#### `_get_return_effects(participant)`
- クリーチャーとアイテムから復帰効果を収集
- 複数の復帰効果を統合して返す

#### `_return_to_deck(player_id, item_data)`
- アイテムを**使用者のデッキのランダムな位置**に戻す
- 使用者の捨て札から削除してデッキに挿入
- デッキが空の場合は単純に追加、それ以外はランダムな位置に`insert()`
- **引数**:
  - `player_id`: int（使用者のプレイヤーID）
  - `item_data`: Dictionary（戻すアイテムのデータ）

#### `_return_to_hand(player_id, item_data)`
- アイテムを手札に戻す
- 手札上限を超えても強制追加
- CardSystemの`return_card_to_hand()`を使用

### 処理フロー

```
アイテム使用
  ↓
check_and_apply_item_return()呼び出し
  ↓
_get_return_effects() - 復帰効果取得
  ├─ クリーチャーのability_parsed.effects
  └─ 使用アイテムのeffect_parsed.effects
  ↓
各アイテムに対してループ
  ↓
return_typeに応じて処理
  ├─ return_to_deck → _return_to_deck(player_id, item_data)
  │   └─ 使用者のデッキのランダムな位置に挿入
  └─ return_to_hand → _return_to_hand(player_id, item_data)
      └─ 使用者の手札に即座に追加
  ↓
復帰完了（ログ出力）
```

---

## 他スキルとの相互作用

### アイテム破壊・盗みスキル
- **優先順位**: 破壊・盗みが先
- アイテムが破壊または盗まれた場合、復帰は発動しない

### アイテム無効化スキル
- アイテム効果が無効化されても復帰効果は発動
- 復帰効果はアイテム使用そのものに付随

### 変身スキル
- 変身後もアイテムは引き継がれる
- 変身前に使用したアイテムも復帰対象

---

## 設計思想

### 経済システムとしての役割
- 強力なアイテムの再利用を可能に
- リスク/リターンのバランス調整に寄与
- デッキ構築の戦略性を高める

### ブック vs 手札の使い分け
- **ブック復帰**: 安定的な再利用（防具向き）
- **手札復帰**: 即時再利用可能（巻物・武器向き）

### ケンタウロスの汎用性
- どんなアイテムでも復帰可能
- アイテム依存戦略の中核クリーチャー
- 「全アイテム復帰」という固有性

---

## 実装チェックリスト

- [x] `scripts/skills/skill_item_return.gd`作成
- [x] データ更新
  - [x] ID 1005: エターナルメイル
  - [x] ID 1030: ソウルレイ
  - [x] ID 1054: ブーメラン
  - [x] ID 314: ケンタウロス
  - [x] ID 41: フレイムデューク
- [x] BattlePreparationとの統合
- [x] マルチデッキ対応（2025/11/10）
  - [x] player_idパラメータ追加
  - [x] ランダム位置挿入実装
  - [x] 使用者のデッキに正しく戻る
- [x] テスト
  - [x] ブック復帰が正常動作（ランダム位置）
  - [x] 手札復帰が正常動作
  - [x] 手札満杯時の処理
  - [x] ケンタウロスの全アイテム復帰
  - [x] プレイヤー別デッキの独立性

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2025/11/02 | 初版作成：アイテム復帰スキル設計完了 |
| 1.1 | 2025/11/03 | フレイムデューク（ID: 41）の実装を追加 |
| 1.2 | 2025/11/10 | マルチデッキ対応：ランダム位置復帰に変更 |

---
