# 形見スキル

**バージョン**: 1.0  
**最終更新**: 2025年11月3日

---

## 概要

死亡時に特殊効果を発動するスキル。蓄魔やカードドローなど、敗北してもプレイヤーに利益をもたらす。

**実装ファイル**: `scripts/battle/skills/skill_legacy.gd`

**発動タイミング**: クリーチャー撃破時

---

## スキル種類

### 1. 形見[カード]

死亡時にカードをドローする。

**該当クリーチャー**:
- **フェイト** (ID: 136): 形見[カード1枚]

**JSON定義**:
```json
{
  "ability_parsed": {
	"keywords": ["形見"],
	"effects": [
	  {
		"effect_type": "legacy_card",
		"trigger": "on_death",
		"card_count": 1
	  }
	]
  }
}
```

**動作**:
```
フェイト撃破
  → 【形見発動】フェイト → プレイヤー1がカード1枚ドロー
  → spell_draw.draw_cards(player_id, 1)
```

---

### 2. 形見[EP]

死亡時にEPを獲得する。

**該当クリーチャー**:
- **コーンフォーク** (ID: 315): 道産[200EP]
- **クリーピングコイン** (ID: 410): 道産[100EP]

**JSON定義**:
```json
{
  "ability_parsed": {
	"keywords": ["道産"],
	"effects": [
	  {
		"effect_type": "legacy_magic",
		"trigger": "on_death",
		"amount": 200
	  }
	]
  }
}
```

**動作**:
```
コーンフォーク撃破
  → 【道産発動】コーンフォーク → プレイヤー1が200G獲得
  → spell_magic.add_magic(player_id, 200)
```

---

## 実装詳細

### 発動場所

`BattleSpecialEffects.check_on_death_effects()`

```gdscript
func check_on_death_effects(defeated: BattleParticipant, opponent: BattleParticipant):
	# ... アイテムの形見処理 ...
	
	# クリーチャースキル: 形見・道産
	SkillLegacy.apply_on_death(defeated, spell_draw_ref, spell_magic_ref)
```

### スキルメソッド

```gdscript
# 形見[カード]
static func apply_card_legacy(defeated, spell_draw):
	if has_card_legacy(defeated.creature_data):
		var card_count = _extract_card_count(ability_detail, 1)
		spell_draw.draw_cards(defeated.player_id, card_count)

# 形見[EP]
static func apply_magic_legacy(defeated, spell_magic):
	if has_magic_legacy(defeated.creature_data):
		var amount = _extract_magic_amount(ability_detail, 100)
		spell_magic.add_magic(defeated.player_id, amount)

# まとめて適用
static func apply_on_death(defeated, spell_draw, spell_magic):
	apply_card_legacy(defeated, spell_draw)
	apply_magic_legacy(defeated, spell_magic)
```

---

## 正規表現パターン

### カード枚数抽出
```gdscript
regex.compile("形見\\[カード(\\d+)枚\\]")
# "形見[カード1枚]" → 1
```

### EP量抽出
```gdscript
regex.compile("道産\\[G(\\d+)\\]")
# "道産[200EP]" → 200
```

---

## 関連システム

- **SpellDraw** (`scripts/spells/spell_draw.gd`) - カードドロー基盤
- **SpellMagic** (`scripts/spells/spell_magic.gd`) - EP操作基盤
- **BattleSpecialEffects** - 死亡時効果処理

---

## 注意事項

### アイテムとの共存

- ゴールドグース（アイテム）の形見効果と同じタイミングで発動
- アイテムの形見処理 → クリーチャーの形見処理の順

### 復活との関係

- 蘇生スキルで復活した場合、形見効果は発動しない
- 復活失敗後に撃破確定となった時点で形見効果が発動

---

**最終更新**: 2025年11月3日（v1.0）
