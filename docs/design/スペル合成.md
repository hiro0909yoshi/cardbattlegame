# スペル合成

## 概要

スペル使用時にカードを犠牲にすることで、特定の条件を満たした場合に効果が強化されるシステム。

クリーチャー合成とは異なり、ステータス上昇ではなく「元の効果の強化」を行う。

---

## 対象スペル

| ID | 名前 | コスト | 合成条件 | 通常効果 | 合成効果 |
|----|------|--------|----------|----------|----------|
| 2003 | アステロイド | 100G+1枚 | 同名カード | 対象領地のレベルを1下げる | レベルを1にする |
| 2017 | エロージョン | 40G+1枚 | 任意スペル | 対象手札の重複カードを破壊 | 全手札が対象 |
| 2030 | サブサイド | 100G+1枚 | 同名カード | 対象敵の最高レベル領地を1下げる | 全セプターが対象 |
| 2033 | シャイニングガイザー | 100G+1枚 | 単体対象スペル | 対象敵クリーチャーのHP-30 | HP-40に強化 |
| 2055 | ディスエレメント | 20G+1枚 | クリーチャー | 対象領地に呪い"地形効果無効" | ダウンした全クリーチャー対象 |
| 2058 | デビリティ | 40G+1枚 | 任意スペル | 対象クリーチャーのAP=0 | MHP-20を追加 |
| 2107 | マスグロース | 30G+1枚 | アイテム | 全クリーチャーのMHP+5 | 全自クリーチャーのみ対象 |

---

## 合成タイプ分類

| タイプ | 条件 | 対象スペル |
|--------|------|-----------|
| 同名カード（same_card） | 犠牲カードが使用スペルと同名 | アステロイド、サブサイド |
| 任意スペル（any_spell） | 犠牲カードがスペルカード | エロージョン、デビリティ |
| 単体対象スペル（single_target_spell） | 犠牲カードが単体対象のスペル | シャイニングガイザー |
| クリーチャー（creature） | 犠牲カードがクリーチャー | ディスエレメント |
| アイテム（item） | 犠牲カードがアイテム | マスグロース |

---

## 処理フロー

```
スペル選択
  ↓
魔力コスト確認
  ↓
cards_sacrifice が設定されている？
  ↓ Yes
CardSacrificeHelper.show_hand_selection() → 手札選択UI表示
  ↓
カード選択
  ↓
CardSacrificeHelper.consume_card() → 犠牲カードを破棄
  ↓
SpellSynthesis.check_condition() → 合成条件判定
  ↓
SpellSynthesis.apply_overrides() → JSON override適用
  ↓
対象選択（必要なら）
  ↓
効果実行（override適用済みのeffect_parsed使用）
```

---

## クラス設計

### CardSacrificeHelperクラス（共通）

**ファイル**: `scripts/helpers/card_sacrifice_helper.gd`

スペル合成・クリーチャー合成スキルの両方で使用する共通システム。

| メソッド | 説明 |
|----------|------|
| `show_hand_selection(hand, filter)` | 手札選択UIを表示 |
| `get_selected_card()` | 選択されたカードを取得 |
| `consume_card(hand, card)` | カードを手札から破棄 |

### SpellSynthesisクラス（スペル専用）

**ファイル**: `scripts/spells/spell_synthesis.gd`

| メソッド | 説明 |
|----------|------|
| `requires_sacrifice(spell_data)` | このスペルがカード犠牲を必要とするか判定 |
| `check_condition(spell_data, sacrifice_card)` | 合成条件を満たすか判定 |
| `apply_overrides(spell_data, is_synthesized)` | 合成時のJSON override適用 |

---

## 合成効果のoverride定義

### パターン一覧

| パターン | 用途 | 使用スペル |
|----------|------|-----------|
| value_override | 数値変更 | シャイニングガイザー |
| target_override | 対象範囲変更 | エロージョン、サブサイド、ディスエレメント、マスグロース |
| effects_add | 効果追加 | デビリティ |
| effect_override | 効果置換 | アステロイド |

---

## JSON定義

### シャイニングガイザー（数値変更）

```json
{
  "id": 2033,
  "name": "シャイニングガイザー",
  "cost": { "mp": 100, "cards_sacrifice": 1 },
  "synthesis": {
    "type": "single_target_spell",
    "value_override": 40
  },
  "effect_parsed": {
    "target_type": "creature",
    "target_info": { "owner_filter": "enemy" },
    "effects": [{ "effect_type": "damage", "value": 30 }]
  }
}
```

### アステロイド（効果置換）

```json
{
  "id": 2003,
  "name": "アステロイド",
  "cost": { "mp": 100, "cards_sacrifice": 1 },
  "synthesis": {
    "type": "same_card",
    "effect_override": {
      "effect_type": "set_level",
      "value": 1
    }
  },
  "effect_parsed": {
    "target_type": "land",
    "target_info": { "owner_filter": "any" },
    "effects": [{ "effect_type": "change_level", "value": -1 }]
  }
}
```

### サブサイド（対象範囲変更）

```json
{
  "id": 2030,
  "name": "サブサイド",
  "cost": { "mp": 100, "cards_sacrifice": 1 },
  "synthesis": {
    "type": "same_card",
    "target_override": {
      "target_type": "all_players",
      "target_info": { "owner_filter": "enemy" }
    }
  },
  "effect_parsed": {
    "target_type": "player",
    "target_info": { "owner_filter": "enemy" },
    "effects": [{ "effect_type": "find_and_change_highest_level", "value": -1 }]
  }
}
```

### エロージョン（対象範囲変更）

```json
{
  "id": 2017,
  "name": "エロージョン",
  "cost": { "mp": 40, "cards_sacrifice": 1 },
  "synthesis": {
    "type": "any_spell",
    "target_override": {
      "target_type": "all_players"
    }
  },
  "effect_parsed": {
    "target_type": "player",
    "target_filter": "any",
    "effects": [{ "effect_type": "destroy_duplicate_cards" }]
  }
}
```

### ディスエレメント（対象範囲変更）

```json
{
  "id": 2055,
  "name": "ディスエレメント",
  "cost": { "mp": 20, "cards_sacrifice": 1 },
  "synthesis": {
    "type": "creature",
    "target_override": {
      "target_type": "all_creatures",
      "target_info": { "state_filter": "downed" }
    }
  },
  "effect_parsed": {
    "target_type": "land",
    "target_filter": "creature",
    "target_info": { "owner_filter": "any" },
    "effects": [{ "effect_type": "land_effect_disable", "name": "地形効果無効", "duration": -1 }]
  }
}
```

### デビリティ（効果追加）

```json
{
  "id": 2058,
  "name": "デビリティ",
  "cost": { "mp": 40, "cards_sacrifice": 1 },
  "synthesis": {
    "type": "any_spell",
    "effects_add": [
      { "effect_type": "mhp_change", "value": -20 }
    ]
  },
  "effect_parsed": {
    "target_type": "land",
    "target_filter": "creature",
    "effects": [
      { "effect_type": "ap_nullify", "name": "AP=0", "duration": -1 },
      { "effect_type": "draw", "count": 1 }
    ]
  }
}
```

### マスグロース（対象フィルタ変更）

```json
{
  "id": 2107,
  "name": "マスグロース",
  "cost": { "mp": 30, "cards_sacrifice": 1 },
  "synthesis": {
    "type": "item",
    "target_override": {
      "target_info": { "owner_filter": "own" }
    }
  },
  "effect_parsed": {
    "target_type": "all_creatures",
    "target_info": { "owner_filter": "any" },
    "effects": [{ "effect_type": "permanent_hp_change", "value": 5 }]
  }
}
```

---

## 合成条件判定ロジック

```gdscript
func check_condition(spell_data: Dictionary, sacrifice_card: Dictionary) -> bool:
    var synthesis = spell_data.get("synthesis", {})
    var synthesis_type = synthesis.get("type", "")
    
    match synthesis_type:
        "same_card":
            return sacrifice_card.get("id") == spell_data.get("id")
        
        "any_spell":
            return sacrifice_card.get("type") == "spell"
        
        "single_target_spell":
            return sacrifice_card.get("type") == "spell" \
                and sacrifice_card.get("spell_type") == "単体対象"
        
        "creature":
            return sacrifice_card.get("type") == "creature"
        
        "item":
            return sacrifice_card.get("type") == "item"
    
    return false
```

---

## override適用ロジック

```gdscript
func apply_overrides(spell_data: Dictionary, is_synthesized: bool) -> Dictionary:
    if not is_synthesized:
        return spell_data.get("effect_parsed", {})
    
    var synthesis = spell_data.get("synthesis", {})
    var effect_parsed = spell_data.get("effect_parsed", {}).duplicate(true)
    
    # 数値変更
    if synthesis.has("value_override"):
        if effect_parsed.has("effects") and effect_parsed["effects"].size() > 0:
            effect_parsed["effects"][0]["value"] = synthesis["value_override"]
    
    # 対象範囲変更
    if synthesis.has("target_override"):
        effect_parsed.merge(synthesis["target_override"], true)
    
    # 効果追加
    if synthesis.has("effects_add"):
        if not effect_parsed.has("effects"):
            effect_parsed["effects"] = []
        effect_parsed["effects"].append_array(synthesis["effects_add"])
    
    # 効果置換
    if synthesis.has("effect_override"):
        if effect_parsed.has("effects") and effect_parsed["effects"].size() > 0:
            effect_parsed["effects"][0].merge(synthesis["effect_override"], true)
    
    return effect_parsed
```

---

## 関連ドキュメント

- [spells/クリーチャー交換.md](spells/クリーチャー交換.md) - 手札選択UIの参考
- [effect_system.md](effect_system.md) - クリーチャー合成（ステータス上昇）

---

## 実装状況

| 項目 | ステータス |
|------|----------|
| CardSacrificeHelper | 🚧 未実装 |
| SpellSynthesisクラス | 🚧 未実装 |
| 手札選択UI | 🚧 未実装 |
| JSON定義更新 | 🚧 未実装 |

---

## 備考

- 合成可能なスペルは必ず `cards_sacrifice: 1` を持つ
- 合成条件を満たさなくてもスペルは使用可能（通常効果で発動）
- 犠牲カードの選択は任意ではなく必須（コストの一部）
- CardSacrificeHelperはクリーチャー合成スキルでも使用する共通クラス
- override適用はSpellSynthesisクラスが担当（共通クラスには入れない）
