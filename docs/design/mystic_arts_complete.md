# 秘術システム完成図書

**ステータス**: ✅ 実装完了（Phase 1-3）  
**最終更新**: 2025年11月25日

---

## 概要

秘術（Mystic Arts）は、クリーチャーが持つ特殊な魔法効果。スペルフェーズで発動でき、コストとして魔力を消費する。

### 基本仕様

| 項目 | 内容 |
|------|------|
| 発動者 | 自分のクリーチャーのみ |
| コスト | 魔力（プレイヤーの共通資源） |
| タイミング | スペルフェーズ内（ターン1回） |
| 排他性 | スペルカード使用時は秘術は使えない（逆も同様） |
| 発動後 | クリーチャーはダウン状態（不屈で回避可） |

---

## 実装方式：spell_id参照

既存スペルの効果を秘術として使用する方式を採用。

### データ構造

```json
{
  "id": 2,
  "name": "アモン",
  "ability_parsed": {
    "keywords": ["感応", "防魔", "秘術"],
    "mystic_arts": [
      {
        "id": "amon_mystic_001",
        "name": "バイタリティ",
        "description": "対象領地に呪い\"能力値+20\"；カードを1枚引く",
        "spell_id": 2066,
        "cost": 50
      }
    ]
  }
}
```

### フィールド説明

| フィールド | 説明 |
|-----------|------|
| `id` | 秘術の一意ID |
| `name` | 秘術名（UI表示用） |
| `description` | 説明テキスト |
| `spell_id` | 参照するスペルのID（`data/spell_*.json`に定義） |
| `cost` | 魔力コスト（スペル本来のコストとは独立） |

### 効果適用フロー

```
1. mystic_art["spell_id"] からスペルID取得
2. CardLoader.get_card_by_id(spell_id) でスペルデータ取得
3. spell_card["effect_parsed"] からターゲット情報と効果を取得
4. spell_phase_handler._apply_single_effect() で各効果を適用
```

---

## 実行フロー

```
スペルフェーズ開始
  │
  ├─ [秘術を使う] 選択
  │   ├─ 発動可能クリーチャーを列挙
  │   ├─ クリーチャー選択UI表示
  │   ├─ 秘術選択UI表示
  │   ├─ ターゲット選択（セルフターゲット時は自動）
  │   ├─ 秘術発動・効果適用
  │   ├─ 魔力消費
  │   ├─ クリーチャーをダウン状態に設定
  │   └─ スペルUIを非表示（排他制御）
  │
  ├─ [スペルカード使用] → 秘術UIを非表示
  └─ [スペルをしない] → スペルフェーズ終了
```

---

## 関連ファイル

```
scripts/spells/spell_mystic_arts.gd      # 秘術実行エンジン
scripts/game_flow/spell_phase_handler.gd # 秘術発動フロー
scripts/ui_components/spell_and_mystic_ui.gd  # 秘術選択UI
data/fire_1.json                         # アモン（秘術持ちクリーチャー例）
data/spell_2.json                        # バイタリティ（参照されるスペル）
```

---

## SpellMysticArts 主要メソッド

| メソッド | 説明 |
|---------|------|
| `get_available_creatures(player_id)` | 秘術発動可能なクリーチャー一覧を取得 |
| `get_mystic_arts_for_creature(creature_data)` | クリーチャーの秘術一覧を取得 |
| `can_cast_mystic_art(mystic_art, context)` | 発動可否判定（魔力・ダウン状態・ターゲット有無） |
| `apply_spell_effect(mystic_art, target_data, context)` | spell_id参照で効果適用 |
| `_set_down_state(tile_index)` | 発動後のダウン状態設定 |

---

## ダウン状態と不屈

秘術発動後、クリーチャーはダウン状態になる（領地コマンドと同様）。

- ダウン状態のクリーチャーは次ターンまで秘術使用不可
- ダウン状態はスタート通過時に全土地で一括解除
- **不屈スキル**を持つクリーチャーはダウン状態にならない

---

## UI仕様

### ボタン配置

```
画面レイアウト

  [秘術を使う]                    [スペルをしない]
  ← 手札左側                      手札右側 →

          ┌─ 手札コンテナ ─┐
          │ [🃏][🃏][🃏]... │
          └────────────────┘
```

- CardUIHelper.calculate_card_layout() で位置計算
- 全画面解像度対応（1280×720〜2560×1440）

### スタイル

| ボタン | 色（Normal） | 用途 |
|--------|-------------|------|
| 秘術を使う | 紫 (#663399) | 秘術選択 |
| スペルをしない | グレー (#808080) | スキップ |

---

## 動作確認済み効果

| effect_type | 説明 | 確認状況 |
|-------------|------|---------|
| `stat_boost` | 能力値増加 | ✅ バイタリティで確認 |
| `draw` | カードドロー | ✅ バイタリティで確認 |
| `damage` | ダメージ適用 | ✅ 実装済み |

---

## 検討中：パラメータカスタマイズ

秘術ごとに数値やターゲットをカスタマイズしたい場合の対応方式。

### A案：overrides方式

```json
"mystic_arts": [{
  "spell_id": 2066,
  "cost": 50,
  "overrides": {
    "effects": [{ "effect_type": "stat_boost", "value": 30 }]
  }
}]
```

### B案：秘術専用スペル方式

```json
// spell_mystic.json（ID: 9000番台）
{ "id": 9001, "name": "強化バイタリティ", "effect_parsed": { ... value: 30 ... } }

// クリーチャーデータ
"mystic_arts": [{ "spell_id": 9001, "cost": 50 }]
```

**決定予定**: 秘術発動時のUI表示実装時

---

## 秘術を追加する手順

1. **スペル定義確認**: 使用したいスペルが`data/spell_*.json`に存在するか確認
2. **クリーチャーJSONに追加**:
   ```json
   "ability_parsed": {
     "keywords": ["秘術"],
     "mystic_arts": [{
       "id": "unique_id",
       "name": "秘術名",
       "description": "説明",
       "spell_id": スペルID,
       "cost": コスト
     }]
   }
   ```
3. **動作確認**: ゲーム内で秘術が発動できることを確認

---

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2025/11/24 | 初版作成、基盤実装 |
| 2025/11/25 | spell_id参照方式実装完了、バイタリティ動作確認 |
