# ステータス増減スペル設計

**最終更新**: 2025年11月12日 | **実装状況**: ❌ 未実装

---

## 概要

クリーチャーの戦闘能力（ST/HP）を一時的に増減させるスペル効果。  
呪い（Curse）システムを利用してクリーチャーに付与し、バトル開始時に適用。

**特徴**:
- クリーチャー呪いとして実装
- バトル開始時に `BattleParticipant` の能力値を増減
- 移動・交換・撃破で呪いが消滅
- duration管理で持続ターン数を制御

---

## 実装スペル一覧

| ID | 名前 | コスト | 効果 | 追加効果 | レアリティ |
|----|------|--------|------|---------|-----------|
| 2066 | バイタリティ | 30MP | ST&HP+20 | カードドロー | R |
| 2054 | ディジーズ | 30MP | ST&HP-20 | カードドロー | R |


**共通仕様**:
- `target_type: "land"` - 土地を対象（クリーチャーがいる土地）
- `target_filter: "creature"` - クリーチャーがいる土地のみ選択可能
- 呪いは移動で消滅

---

## 呪いタイプ詳細

### stat_boost（能力値上昇）

**効果**: 戦闘中にST&HPを増加

**パラメータ**:
- `value`: 増加量（例: 20）

**JSON例**:
```json
{
  "effect_type": "stat_boost",
  "value": 20,
  "duration": -1
}
```

**バトル適用**:
```gdscript
participant.temporary_bonus_hp += 20
participant.temporary_bonus_ap += 20
```

### stat_reduce（能力値減少）

**効果**: 戦闘中にST&HPを減少

**パラメータ**:
- `value`: 減少量（例: -20）

**JSON例**:
```json
{
  "effect_type": "stat_reduce",
  "value": -20,
  "duration": -1
}
```

**バトル適用**:
```gdscript
participant.temporary_bonus_hp += -20  # 減少
participant.temporary_bonus_ap += -20  # 減少
```



## アーキテクチャ

### データフロー

```
スペル使用 → SpellPhaseHandler
  ↓
土地選択（クリーチャーがいる土地）
  ↓
SpellCurse.curse_creature() - 呪い付与
  ↓
移動なし → 呪い持続
  ↓
バトル発生 → battle_preparation.gd
  ↓
_apply_creature_curse() - BattleParticipantに適用
  ↓
戦闘実行（能力値が変化した状態）
  ↓
【消滅条件】
- 移動 → 呪い削除
- 交換 → 呪い削除
- 撃破 → クリーチャー消滅
- duration=0 → 呪い削除
```

### クラス構成

**SpellCurse** (`scripts/spells/spell_curse.gd`)
- 呪い付与: `curse_creature(tile_index, curse_type, duration, params)`
- 呪い取得: `get_creature_curse(tile_index)`
- 呪い削除: `remove_curse_from_creature(tile_index)`

**BattlePreparation** (`scripts/battle/battle_preparation.gd`)
- 呪い適用: `_apply_creature_curse(participant, tile_index)`

**BoardSystem3D** (`scripts/board_system_3d.gd`)
- 移動時削除: `move_creature()` 内で `remove_curse_from_creature()`

---

## 実装詳細

### 1. SpellCurse - 呪い付与

```gdscript
# バイタリティ（能力値+20）
spell_curse.curse_creature(tile_index, "stat_boost", -1, {
	"name": "能力値+20",
	"value": 20
})

# ディジーズ（能力値-20）
spell_curse.curse_creature(tile_index, "stat_reduce", -1, {
	"name": "能力値-20",
	"value": -20
})


```

**保存場所**:
```gdscript
creature_data["curse"] = {
	"curse_type": "stat_boost",
	"name": "能力値+20",
	"duration": -1,
	"params": {
		"value": 20
	}
}
```

### 2. BattlePreparation - 呪い適用

```gdscript
func prepare_participants(...):
	# ... 既存処理（HP/ST設定） ...
	
	# クリーチャー呪いを適用
	if spell_curse:
		_apply_creature_curse(attacker, attacker_tile_index)
		_apply_creature_curse(defender, defender_tile_index)
	
	return [attacker, defender]

func _apply_creature_curse(participant: BattleParticipant, tile_index: int):
	var curse = spell_curse.get_creature_curse(tile_index)
	if curse.is_empty():
		return
	
	var curse_type = curse.get("curse_type", "")
	var params = curse.get("params", {})
	
	match curse_type:
		"stat_boost":
			# 能力値上昇
			var value = params.get("value", 20)
			participant.temporary_bonus_hp += value
			participant.temporary_bonus_ap += value
			print("[呪い適用] ", curse.get("name", ""), " ST+", value, " HP+", value)
		
		"stat_reduce":
			# 能力値減少
			var value = params.get("value", -20)
			participant.temporary_bonus_hp += value
			participant.temporary_bonus_ap += value
			print("[呪い適用] ", curse.get("name", ""), " ST", value, " HP", value)
		

```

**重要**: `temporary_bonus_hp/ap` に加算することで、バトル計算に反映される

### 3. BoardSystem3D - 移動時削除

```gdscript
func move_creature(from_tile: int, to_tile: int):
	# ... クリーチャー移動処理 ...
	
	# 移動元の呪いを削除
	if spell_curse:
		spell_curse.remove_curse_from_creature(from_tile)
		print("[呪い消滅] 移動により削除 tile=", from_tile)
```

### 4. SpellPhaseHandler - スペル効果適用

```gdscript
func _apply_single_effect(effect: Dictionary, target_data: Dictionary):
	match effect.get("effect_type", ""):
		"stat_boost":
			# 能力値上昇呪いを付与
			if target_data.get("type") == "land":
				var tile_index = target_data.get("tile_index", -1)
				var value = effect.get("value", 20)
				var duration = effect.get("duration", -1)
				var name = effect.get("name", "能力値上昇")
				
				if game_flow_manager and game_flow_manager.spell_curse:
					game_flow_manager.spell_curse.curse_creature(tile_index, "stat_boost", duration, {
						"name": name,
						"value": value
					})
		
		"stat_reduce":
			# 能力値減少呪いを付与
			if target_data.get("type") == "land":
				var tile_index = target_data.get("tile_index", -1)
				var value = effect.get("value", -20)
				var duration = effect.get("duration", -1)
				var name = effect.get("name", "能力値減少")
				
				if game_flow_manager and game_flow_manager.spell_curse:
					game_flow_manager.spell_curse.curse_creature(tile_index, "stat_reduce", duration, {
						"name": name,
						"value": value
					})
```

---

## スペルJSON設計

### バイタリティ（ID: 2066）

```json
{
  "id": 2066,
  "name": "バイタリティ",
  "rarity": "R",
  "type": "spell",
  "spell_type": "単体特殊能力付与",
  "cost": {"mp": 30},
  "effect": "対象領地に呪い\"能力値+20\"(戦闘中、ST&HP+20)；カードを1枚引く",
  "effect_parsed": {
	"target_type": "land",
	"target_filter": "creature",
	"effects": [
	  {
		"effect_type": "stat_boost",
		"name": "能力値+20",
		"value": 20,
		"duration": -1
	  },
	  {
		"effect_type": "draw",
		"count": 1
	  }
	]
  }
}
```

### ディジーズ（ID: 2054）

```json
{
  "id": 2054,
  "name": "ディジーズ",
  "rarity": "R",
  "type": "spell",
  "spell_type": "単体特殊能力付与",
  "cost": {"mp": 30},
  "effect": "対象領地に呪い\"能力値-20\"(戦闘中、ST&HP-20)；カードを1枚引く",
  "effect_parsed": {
	"target_type": "land",
	"target_filter": "creature",
	"effects": [
	  {
		"effect_type": "stat_reduce",
		"name": "能力値-20",
		"value": -20,
		"duration": -1
	  },
	  {
		"effect_type": "draw",
		"count": 1
	  }
	]
  }
}
```

---

## 使用例

### バイタリティの使用フロー

```
1. プレイヤーがバイタリティ使用（コスト30MP）
   ↓
2. 土地選択UI表示（クリーチャーがいる土地のみ）
   ↓
3. tile_index=5を選択
   ↓
4. SpellCurse.curse_creature(5, "stat_boost", -1, {value: 20})
   ↓
5. [呪い付与] 能力値+20 → tile=5
   ↓
6. カードを1枚ドロー
   ↓
7. プレイヤーがtile=5に止まる → バトル発生
   ↓
8. battle_preparation._apply_creature_curse()
   ↓
9. participant.temporary_bonus_hp += 20
   participant.temporary_bonus_ap += 20
   ↓
10. [呪い適用] 能力値+20 ST+20 HP+20
   ↓
11. 戦闘実行（強化された状態）
   ↓
12. 【呪いはまだ残る】duration=-1（無期限）
   ↓
13. クリーチャーが移動 → 呪い消滅
```

### duration管理の例

もし `duration: 3` で付与した場合:

```
付与時: duration=3
  ↓
ターン終了1: duration=3→2
  ↓
ターン終了2: duration=2→1
  ↓
ターン終了3: duration=1→0 → 呪い消滅
```

---

## 実装チェックリスト

### Phase 1: 基盤構築
- [ ] SpellCurse確認（既に存在するか）
- [ ] `curse_creature()` メソッド実装
- [ ] `get_creature_curse()` メソッド実装
- [ ] `remove_curse_from_creature()` メソッド実装

### Phase 2: バトルシステム統合
- [ ] battle_preparation.gdに `_apply_creature_curse()` 追加
- [ ] `prepare_participants()` に統合

### Phase 3: 移動システム統合
- [ ] BoardSystem3D.move_creature() に削除処理追加
- [ ] 交換処理にも削除処理追加

### Phase 4: スペル実装
- [ ] SpellPhaseHandlerに3つのeffect_type追加
  - [ ] `stat_boost`
  - [ ] `stat_reduce`


### Phase 5: JSON設定
- [ ] 2066: バイタリティ - effect_parsed追加
- [ ] 2054: ディジーズ - effect_parsed追加


### Phase 6: テスト
- [ ] バイタリティでST/HP+20確認
- [ ] ディジーズでST/HP-20確認
- [ ] 移動で呪いが消えることを確認


---

## トラブルシューティング

### 呪いがバトルに反映されない

**原因**: `_apply_creature_curse()` が呼ばれていない

**確認箇所**:
1. battle_preparation.gdに統合されているか
2. spell_curseが初期化されているか
3. ログ `[呪い適用]` が出力されているか

### 移動しても呪いが消えない

**原因**: BoardSystem3Dに削除処理がない

**確認箇所**:
1. `move_creature()` に `remove_curse_from_creature()` があるか
2. spell_curseが初期化されているか

### 能力値が変わらない

**原因**: `temporary_bonus_hp/ap` ではなく `base_hp/ap` を変更している

**修正**: 必ず `temporary_bonus_hp/ap` を使用

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025/11/12 | 初版作成 - バイタリティ、ディジーズ、バインドミスト設計 |
