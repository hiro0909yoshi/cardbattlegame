# ステータス増減スペル設計

**最終更新**: 2025年11月28日 | **実装状況**: ✅ 完了

---

## 概要

クリーチャーのステータス（HP/AP）を変更するスペル群。

### 実装方式

| 方式 | 対象 | 持続 | 用途例 |
|------|------|------|--------|
| 恒久変更 | `base_up_hp`, `base_up_ap` | 永続 | グロースボディ、ファットボディ、マスグロース |
| 刻印 | `creature_data["curse"]` | 移動で消滅 | バイタリティ、ディジーズ、デビリティ |

---

## 実装済みスペル一覧

### 恒久変更方式

| ID | 名前 | コスト | 効果 |
|----|------|--------|------|
| 2026 | グロースボディ | 50MP | MHP+10 |
| 2075 | ファットボディ | 20MP | MHP+20, AP-20 |
| 2107 | マスグロース | 80MP | 全自クリーチャー MHP+5 |

### 刻印方式（ステータス増減）

| ID | 名前 | コスト | 効果 |
|----|------|--------|------|
| 2066 | バイタリティ | 30MP | 刻印"暁光"（AP&HP+20）+ ドロー1枚 |
| 2054 | ディジーズ | 30MP | 刻印"衰月"（AP&HP-20）+ ドロー1枚 |
| 2058 | デビリティ | 30MP | 刻印"AP=0"（基礎AP無効化）+ ドロー1枚 |

### 刻印方式（特殊効果）

| ID | 名前 | コスト | 効果 |
|----|------|--------|------|
| 2120 | リキッドフォーム | 30MP | 刻印"狂星"（AP&HP=10～70ランダム）+ ドロー1枚 |
| 2060 | ドミナントグロース | 50MP | 刻印"昇華"（レベルアップ/地形変化でMHP+20） |

### 密命スペル

| ID | 名前 | コスト | 効果 |
|----|------|--------|------|
| 2050 | タイニーアーミー | 40MP | 密命: MHP30以下が5体以上なら全員MHP+10 & 500蓄魔 |

### クリーチャーアルカナアーツ

| ID | 名前 | アルカナアーツ効果 |
|----|------|---------|
| 244 | リチェノイド | 30EP・対象クリーチャーのMHP+10 (spell_id: 9010) |
| 303 | エアロダッチェス | 50EP・対象敵クリーチャーに刻印"HP-10" (spell_id: 9011) |

### アルカナアーツ付与スペル

| ID | 名前 | コスト | 効果 |
|----|------|--------|------|
| 2035 | ウィザー | 30MP | 刻印"零落"付与（アルカナアーツ: 50EPで敵MHP-10） |

---

## 効果タイプ

### permanent_hp_change / permanent_ap_change

`base_up_hp`/`base_up_ap`を直接変更。永続。

```json
{"effect_type": "permanent_hp_change", "value": 10}
```

### stat_boost / stat_reduce

刻印としてAP&HPを増減。バトル時に`temporary_effects`に変換され、移動で消滅。

```json
{"effect_type": "stat_boost", "name": "暁光", "value": 20}
```

### ap_nullify

基礎APを0に固定する刻印。バフ・アイテムは加算可能。

```json
{"effect_type": "ap_nullify", "name": "AP=0"}
```

### random_stat_curse

バトル時にAP/HPを指定範囲のランダム値に設定。

```json
{"effect_type": "random_stat_curse", "name": "狂星", "min": 10, "max": 70}
```

### command_growth_curse

レベルアップ/地形変化コマンド実行時にMHP増加。移動するまで何度でも発動。

```json
{"effect_type": "command_growth_curse", "name": "昇華", "hp_bonus": 20}
```

### secret_tiny_army

密命：条件判定後、成功なら効果発動、失敗ならカードをデッキに戻す。

```json
{"effect_type": "secret_tiny_army", "mhp_threshold": 30, "required_count": 5, "hp_bonus": 10, "gold_bonus": 500}
```

### grant_mystic_arts

刻印としてアルカナアーツを付与。アルカナアーツを持たないクリーチャーのみ対象。

```json
{
  "effect_type": "grant_mystic_arts",
  "curse_name": "零落",
  "mystic_arts": [{
	"name": "零落",
	"spell_id": 9012,
	"cost": 50
  }]
}
```

**アルカナアーツ付与の仕組み**:
1. スペル使用時、対象クリーチャーに刻印としてアルカナアーツ情報を付与
2. 刻印内の`mystic_arts`配列がアルカナアーツ選択UIに表示される
3. アルカナアーツ発動時、`spell_id`で`spell_mystic.json`から効果を取得して実行
4. 移動で刻印が消滅すると付与されたアルカナアーツも消える

**spell_mystic.json側の定義**:
```json
{
  "id": 9012,
  "name": "零落",
  "effect_parsed": {
	"target_type": "creature",
	"target_info": { "owner_filter": "enemy" },
	"effects": [{ "effect_type": "permanent_hp_change", "value": -10 }]
  }
}
```

---

## アーキテクチャ

### クラス構成

| クラス | 役割 |
|--------|------|
| SpellCurse | 刻印の基盤管理（付与/取得/削除/トリガー） |
| SpellCurseStat | ステータス増減スペルの統合処理（恒久変更/刻印/密命） |
| BattleCurseApplier | バトル時の刻印→temporary_effects変換 |
| LandActionHelper | ドミニオオーダー時のcommand_growth刻印トリガー |

### 統合エントリポイント

SpellCurseStatは`apply_effect()`メソッドで効果タイプを振り分け：

```gdscript
# SpellPhaseHandlerからの呼び出し（1行）
await game_flow_manager.spell_container.spell_curse_stat.apply_effect(self, effect, target_data, current_player_id, selected_spell_card)
```

対応する効果タイプ：
- `permanent_hp_change` - 恒久MHP変更
- `permanent_ap_change` - 恒久AP変更
- `secret_tiny_army` - 密命処理（失敗時のカード復帰含む）

### データフロー（刻印方式）

```
【スペル使用時】
SpellPhaseHandler._apply_single_effect()
  → SpellCurse.apply_effect()
  → creature_data["curse"] = {...}

【バトル発生時】
BattlePreparation.prepare_participants()
  → BattleCurseApplier.apply_curses()
  → 刻印をtemporary_effectsに変換
  → participant.current_hp/ap に反映

【移動時】
MovementController → 刻印消滅
```

### データフロー（昇華）

```
【ドミニオオーダー実行時】
LandActionHelper.execute_level_up_with_level() / execute_terrain_change_with_element()
  → _trigger_command_growth()
  → SpellCurse.trigger_command_growth()
  → EffectManager.apply_max_hp_effect()
  → 通知UI表示
```

---

## JSON設計例

### バイタリティ（2066）
```json
{
  "id": 2066,
  "name": "バイタリティ",
  "cost": {"mp": 30},
  "effect_parsed": {
	"target_type": "land",
	"target_filter": "creature",
	"effects": [
	  {"effect_type": "stat_boost", "name": "暁光", "value": 20},
	  {"effect_type": "draw", "count": 1}
	]
  }
}
```

### グロースボディ（2026）
```json
{
  "id": 2026,
  "name": "グロースボディ",
  "cost": {"mp": 50},
  "effect_parsed": {
	"target_type": "land",
	"target_filter": "creature",
	"effects": [
	  {"effect_type": "permanent_hp_change", "value": 10}
	]
  }
}
```

### ドミナントグロース（2060）
```json
{
  "id": 2060,
  "name": "ドミナントグロース",
  "cost": {"mp": 50},
  "effect_parsed": {
	"target_type": "land",
	"target_filter": "creature",
	"target_info": {"owner_filter": "any"},
	"effects": [
	  {"effect_type": "command_growth_curse", "name": "昇華", "hp_bonus": 20}
	]
  }
}
```

---

## 関連ファイル

| ファイル | 内容 |
|----------|------|
| `scripts/spells/spell_curse.gd` | 刻印基盤（command_growth含む） |
| `scripts/spells/spell_curse_stat.gd` | ステータス増減刻印 |
| `scripts/battle/battle_curse_applier.gd` | バトル時刻印変換 |
| `scripts/game_flow/land_action_helper.gd` | 昇華トリガー |
| `scripts/game_flow/spell_phase_handler.gd` | スペル効果実行 |
| `data/spell_1.json`, `data/spell_2.json` | スペルデータ |
| `data/spell_mystic.json` | アルカナアーツ用内部スペル（9010, 9011） |

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025/11/12 | 初版 - バイタリティ/ディジーズ実装 |
| 2025/11/28 | 恒久変更方式（グロースボディ等）実装 |
| 2025/11/28 | デビリティ（AP=0刻印）実装 |
| 2025/11/28 | タイニーアーミー（密命）実装 |
| 2025/11/28 | クリーチャーアルカナアーツ（リチェノイド、エアロダッチェス）実装 |
| 2025/11/28 | ウィザー（アルカナアーツ付与刻印）実装 |
| 2025/11/28 | リキッドフォーム（ランダムステータス刻印）実装 |
| 2025/11/28 | ドミナントグロース（昇華刻印）実装 |
| 2025/11/28 | SpellCurseStat.apply_effect()統合メソッド追加 |
