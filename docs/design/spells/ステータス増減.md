# ステータス増減スペル設計

**最終更新**: 2025年11月13日 | **実装状況**: ✅ 実装完了

---

## 概要

クリーチャーのAP/HP|AP&HPを一時的に増減させるスペル。  
呪いシステムと効果システムを統合して実装。

**特徴**:
- クリーチャー呪いとして付与（`creature_data["curse"]`）
- バトル時に`temporary_effects`配列に変換
- `lost_on_move: true`フラグで移動時自動削除
- ドキュメント設計に完全準拠

---

## 実装スペル一覧

| ID | 名前 | コスト | 効果 | 追加効果 | レアリティ |
|----|------|--------|------|---------|-----------|
| 2066 | バイタリティ | 30MP | AP/HP|AP&HP+20 | カードドロー | R |
| 2054 | ディジーズ | 30MP | AP/HP|AP&HP-20 | カードドロー | R |

**共通仕様**:
- `target_type: "land"` - 土地を対象
- `target_filter: "creature"` - クリーチャーがいる土地のみ
- 呪いは移動で消滅（temporary_effectsの`lost_on_move: true`で自動処理）

---

## 呪いタイプ詳細

### stat_boost（能力値上昇）

**効果**: AP/HP|AP&HPを増加

**パラメータ**:
- `value`: 増加量（例: 20）
- `duration`: 持続ターン（-1=無期限）

**JSON例**:
```json
{
  "effect_type": "stat_boost",
  "value": 20,
  "duration": -1
}
```

### stat_reduce（能力値減少）

**効果**: AP/HP|AP&HPを減少

**パラメータ**:
- `value`: 減少量（例: -20）
- `duration`: 持続ターン（-1=無期限）

**JSON例**:
```json
{
  "effect_type": "stat_reduce",
  "value": -20,
  "duration": -1
}
```

---

## アーキテクチャ

### クラス構成

**SpellCurse** (`spell_curse.gd`):
- 呪いの基盤管理（汎用）
- `curse_creature()`, `get_creature_curse()`, `remove_curse_from_creature()`
- duration管理とターン終了時の自動削除

**SpellCurseStat** (`spell_curse_stat.gd`):
- ステータス増減スペルの実装
- SpellCurseを使用して呪いを付与
- バトル時には使用されない（battle_preparation.gdで直接処理）

**BattlePreparation** (`scripts/battle/battle_preparation.gd`):
- `_apply_creature_curses()` で呪いを temporary_effects に変換
- temporary_effects 配列に効果オブジェクトを追加
- `lost_on_move: true` フラグで移動時の自動削除を指定

**MovementController**:
- 移動時に `battle_system.clear_temporary_effects_on_move()` で自動削除

### データフロー

```
【スペル使用時】
SpellPhaseHandler._apply_single_effect()
  ↓ (stat_boost/stat_reduce効果)
SpellCurseStat.apply_stat_boost/reduce(tile_index, effect)
  ↓
SpellCurse.curse_creature(tile_index, "stat_boost", duration, params)
  ↓
creature_data["curse"] = {
  "curse_type": "stat_boost",
  "name": "バイタリティ",
  "duration": -1,
  "params": {"value": 20}
}

【バトル発生時】
BattlePreparation.prepare_participants()
  ↓
apply_effect_arrays(attacker)     # 既存のpermanent/temporary_effectsを処理
apply_effect_arrays(defender)
  ↓
_apply_creature_curses(defender, battle_tile_index)
  ↓ (呪いをtemporary_effectsに変換)
participant.temporary_effects.append({
  "type": "stat_bonus",
  "stat": "hp",
  "value": 20,
  "source": "curse",
  "source_name": "バイタリティ",
  "removable": true,
  "lost_on_move": true
})
participant.temporary_effects.append({
  "type": "stat_bonus",
  "stat": "ap",
  "value": 20,
  "source": "curse",
  "source_name": "バイタリティ",
  "removable": true,
  "lost_on_move": true
})
  ↓ (効果を計算に反映)
participant.temporary_bonus_hp += 20
participant.temporary_bonus_ap += 20
participant.current_ap += 20
participant.update_current_hp()
  ↓
戦闘実行（強化状態）

【移動時】
MovementController.move_along_path()
  ↓
battle_system.clear_temporary_effects_on_move(tile_index)
  ↓ (lost_on_move: true の効果を削除)
creature_data["temporary_effects"] をクリア
  ↓
呪いが消滅
```

---

## 実装詳細

### 1. SpellCurseStat クラス

**ファイル**: `scripts/spells/spell_curse_stat.gd`

```gdscript
extends Node
class_name SpellCurseStat

var spell_curse: SpellCurse
var creature_manager: CreatureManager

func setup(curse: SpellCurse, creature_mgr: CreatureManager):
	spell_curse = curse
	creature_manager = creature_mgr
	print("[SpellCurseStat] 初期化完了")

# ========================================
# スペル使用時（SpellPhaseHandlerから）
# ========================================

func apply_stat_boost(tile_index: int, effect: Dictionary):
	"""能力値上昇呪いを付与"""
	var value = effect.get("value", 20)
	var duration = effect.get("duration", -1)
	var name = effect.get("name", "能力値+20")
	
	spell_curse.curse_creature(tile_index, "stat_boost", duration, {
		"name": name,
		"value": value
	})

func apply_stat_reduce(tile_index: int, effect: Dictionary):
	"""能力値減少呪いを付与"""
	var value = effect.get("value", -20)
	var duration = effect.get("duration", -1)
	var name = effect.get("name", "能力値-20")
	
	spell_curse.curse_creature(tile_index, "stat_reduce", duration, {
		"name": name,
		"value": value
	})
```

**注**: バトル時には `SpellCurseStat` は使用されません。呪いの効果変換は `BattlePreparation._apply_creature_curses()` で直接処理されます。

---

### 2. BattlePreparation 統合

**ファイル**: `scripts/battle/battle_preparation.gd`

**メソッド**: `_apply_creature_curses(participant, tile_index)`

```gdscript
## 呪いをtemporary_effectsに変換して適用
func _apply_creature_curses(participant: BattleParticipant, tile_index: int) -> void:
	# クリーチャーデータから呪いを取得
	var creature_data = participant.creature_data
	
	if not creature_data or creature_data.is_empty() or not creature_data.has("curse"):
		return
	
	var curse = creature_data["curse"]
	var curse_type = curse.get("curse_type", "")
	var params = curse.get("params", {})
	var curse_name = curse.get("name", "")
	
	# 呪いタイプに応じてtemporary_effectsに追加
	match curse_type:
		"stat_boost":
			var value = params.get("value", 20)
			participant.temporary_effects.append({
				"type": "stat_bonus",
				"stat": "hp",
				"value": value,
				"source": "curse",
				"source_name": curse_name,
				"removable": true,
				"lost_on_move": true
			})
			participant.temporary_effects.append({
				"type": "stat_bonus",
				"stat": "ap",
				"value": value,
				"source": "curse",
				"source_name": curse_name,
				"removable": true,
				"lost_on_move": true
			})
			print("[呪い変換] stat_boost: HP+", value, ", AP+", value)
			
			# 効果を計算に反映
			participant.temporary_bonus_hp += value
			participant.temporary_bonus_ap += value
		
		"stat_reduce":
			var value = params.get("value", -20)
			participant.temporary_effects.append({
				"type": "stat_bonus",
				"stat": "hp",
				"value": value,
				"source": "curse",
				"source_name": curse_name,
				"removable": true,
				"lost_on_move": true
			})
			participant.temporary_effects.append({
				"type": "stat_bonus",
				"stat": "ap",
				"value": value,
				"source": "curse",
				"source_name": curse_name,
				"removable": true,
				"lost_on_move": true
			})
			print("[呪い変換] stat_reduce: HP", value, ", AP", value)
			
			# 効果を計算に反映
			participant.temporary_bonus_hp += value
			participant.temporary_bonus_ap += value
	
	# current_hpとcurrent_apを更新
	participant.current_ap += participant.temporary_bonus_ap
	participant.update_current_hp()
```

**実装フロー** (`prepare_participants()` 内):
```gdscript
func prepare_participants(...):
	# ... クリーチャーデータ準備 ...
	
	# 効果配列を適用（apply_effect_arrays()でpermanent/temporary_effectsを処理）
	apply_effect_arrays(attacker, card_data)
	apply_effect_arrays(defender, defender_creature)
	
	# 呪いをtemporary_effectsに変換して適用
	_apply_creature_curses(defender, battle_tile_index)
	
	# ... アイテム効果等 ...
	
	return {...}
```

---

### 3. SpellPhaseHandler 統合

**ファイル**: `scripts/game_flow/spell_phase_handler.gd`

**メソッド**: `_apply_single_effect(effect, target_data)`

```gdscript
func _apply_single_effect(effect: Dictionary, target_data: Dictionary):
	match effect.get("effect_type", ""):
		"stat_boost":
			# 能力値上昇呪いを付与
			if target_data.get("type") == "land":
				var tile_index = target_data.get("tile_index", -1)
				if game_flow_manager and game_flow_manager.spell_curse_stat:
					game_flow_manager.spell_curse_stat.apply_stat_boost(tile_index, effect)
		
		"stat_reduce":
			# 能力値減少呪いを付与
			if target_data.get("type") == "land":
				var tile_index = target_data.get("tile_index", -1)
				if game_flow_manager and game_flow_manager.spell_curse_stat:
					game_flow_manager.spell_curse_stat.apply_stat_reduce(tile_index, effect)
```

---

### 4. GameFlowManager 初期化

**ファイル**: `scripts/game_flow_manager.gd`

**メソッド**: `_setup_spell_systems()`

```gdscript
func _setup_spell_systems():
	# ... 既存のSpellDraw, SpellMagic等 ...
	
	# SpellCurseStat初期化
	spell_curse_stat = SpellCurseStat.new()
	spell_curse_stat.setup(spell_curse, creature_manager)
	add_child(spell_curse_stat)
```

---

## スペルJSON設計

### バイタリティ（ID: 2066）

```json
{
  "id": 2066,
  "name": "バイタリティ",
  "cost": {"mp": 30},
  "effect_parsed": {
	"target_type": "land",
	"target_filter": "creature",
	"effects": [
	  {
		"effect_type": "stat_boost",
		"name": "能力値+20",
		"value": 20,
		"duration": -1
	  },
	  {
		"effect_type": "draw",
		"count": 1
	  }
	]
  }
}
```

### ディジーズ（ID: 2054）

```json
{
  "id": 2054,
  "name": "ディジーズ",
  "cost": {"mp": 30},
  "effect_parsed": {
	"target_type": "land",
	"target_filter": "creature",
	"effects": [
	  {
		"effect_type": "stat_reduce",
		"name": "能力値-20",
		"value": -20,
		"duration": -1
	  },
	  {
		"effect_type": "draw",
		"count": 1
	  }
	]
  }
}
```

---

## 使用例

### バイタリティの使用フロー

```
1. プレイヤーがバイタリティ使用（30MP消費）
2. 土地選択UI（クリーチャーがいる土地のみ）
3. tile_index=5を選択
4. SpellCurseStat.apply_stat_boost(5, effect)
5. SpellCurse.curse_creature(5, "stat_boost", -1, {...})
6. creature_data["curse"] = {呪いデータ} が設定
7. カードドロー実行
8. バトル発生（tile=5）
9. BattlePreparation.prepare_participants()
10. _apply_creature_curses() で temporary_effects に変換
11. participant.temporary_bonus_hp/ap に反映
12. 戦闘実行（強化状態）
13. バトル終了後、呪いは残る（duration=-1）
14. クリーチャー移動 → 呪い消滅（lost_on_moveで自動削除）
```

---

## 実装チェックリスト

### ✅ Phase 1: SpellCurseStat作成 - 完了
- [x] `scripts/spells/spell_curse_stat.gd` 作成
- [x] `setup()` 実装
- [x] `apply_stat_boost()` 実装
- [x] `apply_stat_reduce()` 実装

### ✅ Phase 2: 統合 - 完了
- [x] GameFlowManager - 初期化
- [x] SpellPhaseHandler - effect_type追加
- [x] BattlePreparation - _apply_creature_curses()実装
- [x] MovementController - 呪い削除コード削除（効果システムに統合）

### ✅ Phase 3: JSON設定 - 完了
- [x] 2066: バイタリティ - effect_parsed
- [x] 2054: ディジーズ - effect_parsed

### ✅ Phase 4: テスト - 完了
- [x] バイタリティでAP/HP|AP&HP+20確認
- [x] ディジーズでAP/HP|AP&HP-20確認
- [x] temporary_effects変換確認
- [x] 移動で呪い消滅確認

---

## トラブルシューティング

### 呪いがバトルに反映されない

**原因**: `_apply_creature_curses()` が呼ばれていない

**確認**:
1. BattlePreparationの `prepare_participants()` 内で呼ばれているか
2. ログ `[呪い変換]` が出力されているか
3. temporary_effects に効果オブジェクトが追加されているか

### temporary_effectsが空

**原因**: creature_dataに "curse" フィールドがない

**解決**: SpellCurse.curse_creature() で呪いが正しく設定されているか確認

### 移動しても呪いが消えない

**原因**: temporary_effects の `lost_on_move: true` フラグが設定されていない

**確認**: _apply_creature_curses() で全ての効果オブジェクトに `lost_on_move: true` が設定されているか

---

## UI表示への統合

### HPバー表示
- 基礎HP（青色）: `participant.base_hp + participant.base_up_hp`
- テンポラリーHP（赤色）: `participant.temporary_bonus_hp`
- 総HP: `participant.current_hp`

### 効果追跡
- 呪いの効果源: `temporary_effects` の `source_name` フィールドから取得
- 複数呪い対応: `temporary_effects` 配列をループして全ての効果を表示可能

---

## 関連ドキュメント

- `docs/design/hp_structure.md` - HP管理構造
- `docs/design/effect_system.md` - 効果システム全体設計
- `docs/design/spells/呪い効果.md` - 呪いシステム設計

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025/11/12 | 1.0 | 初版 - SpellCurseStat設計、temporary_effects統合提案 |
| 2025/11/13 | 2.0 | **実装完了** - movement_controller削除、_apply_creature_cursesの正式実装を反映 |

---

**作成日**: 2025年11月12日  
**最終更新**: 2025年11月13日
