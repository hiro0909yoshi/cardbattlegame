# ステータス増減スペル設計

**最終更新**: 2025年11月28日 | **実装状況**: ✅ 完了

---

## 概要

クリーチャーのステータス（HP/AP）を変更するスペル群。

### 実装方式

| 方式 | 対象 | 持続 | 用途例 |
|------|------|------|--------|
| 恒久変更 | `base_up_hp`, `base_up_ap` | 永続 | グロースボディ、ファットボディ、マスグロース |
| 呪い | `creature_data["curse"]` | 移動で消滅 | バイタリティ、ディジーズ、デビリティ |

---

## 実装済みスペル一覧

### 恒久変更方式

| ID | 名前 | コスト | 効果 |
|----|------|--------|------|
| 2026 | グロースボディ | 50MP | MHP+10 |
| 2075 | ファットボディ | 20MP | MHP+20, AP-20 |
| 2107 | マスグロース | 80MP | 全自クリーチャー MHP+5 |

### 呪い方式（ステータス増減）

| ID | 名前 | コスト | 効果 |
|----|------|--------|------|
| 2066 | バイタリティ | 30MP | 呪い"能力値+20"（AP&HP+20）+ ドロー1枚 |
| 2054 | ディジーズ | 30MP | 呪い"能力値-20"（AP&HP-20）+ ドロー1枚 |
| 2058 | デビリティ | 30MP | 呪い"AP=0"（基礎AP無効化）+ ドロー1枚 |

### 呪い方式（特殊効果）

| ID | 名前 | コスト | 効果 |
|----|------|--------|------|
| 2120 | リキッドフォーム | 30MP | 呪い"能力値不定"（AP&HP=10～70ランダム）+ ドロー1枚 |
| 2060 | ドミナントグロース | 50MP | 呪い"コマンド成長"（レベルアップ/地形変化でMHP+20） |

### 密命スペル

| ID | 名前 | コスト | 効果 |
|----|------|--------|------|
| 2050 | タイニーアーミー | 40MP | 密命: MHP30以下が5体以上なら全員MHP+10 & G500獲得 |

### クリーチャー秘術

| ID | 名前 | 秘術効果 |
|----|------|---------|
| 244 | リチェノイド | G30・対象クリーチャーのMHP+10 (spell_id: 9010) |
| 303 | エアロダッチェス | G50・対象敵クリーチャーに呪い"HP-10" (spell_id: 9011) |

### 秘術付与スペル

| ID | 名前 | コスト | 効果 |
|----|------|--------|------|
| 2035 | シュリンクシジル | 30MP | 呪い"縮小術"付与（秘術: G50で敵MHP-10） |

---

## 効果タイプ

### permanent_hp_change / permanent_ap_change

`base_up_hp`/`base_up_ap`を直接変更。永続。

```json
{"effect_type": "permanent_hp_change", "value": 10}
```

### stat_boost / stat_reduce

呪いとしてAP&HPを増減。バトル時に`temporary_effects`に変換され、移動で消滅。

```json
{"effect_type": "stat_boost", "name": "能力値+20", "value": 20}
```

### ap_nullify

基礎APを0に固定する呪い。バフ・アイテムは加算可能。

```json
{"effect_type": "ap_nullify", "name": "AP=0"}
```

### random_stat_curse

バトル時にAP/HPを指定範囲のランダム値に設定。

```json
{"effect_type": "random_stat_curse", "name": "能力値不定", "min": 10, "max": 70}
```

### command_growth_curse

レベルアップ/地形変化コマンド実行時にMHP増加。移動するまで何度でも発動。

```json
{"effect_type": "command_growth_curse", "name": "コマンド成長", "hp_bonus": 20}
```

### secret_tiny_army

密命：条件判定後、成功なら効果発動、失敗ならカードをデッキに戻す。

```json
{"effect_type": "secret_tiny_army", "mhp_threshold": 30, "required_count": 5, "hp_bonus": 10, "gold_bonus": 500}
```

### grant_mystic_arts

呪いとして秘術を付与。秘術を持たないクリーチャーのみ対象。

```json
{"effect_type": "grant_mystic_arts", "curse_name": "縮小術", "mystic_arts": [...]}
```

---

## アーキテクチャ

### クラス構成

| クラス | 役割 |
|--------|------|
| SpellCurse | 呪いの基盤管理（付与/取得/削除/トリガー） |
| SpellCurseStat | ステータス増減呪いの付与処理 |
| BattleCurseApplier | バトル時の呪い→temporary_effects変換 |
| LandActionHelper | 領地コマンド時のcommand_growth呪いトリガー |

### データフロー（呪い方式）

```
【スペル使用時】
SpellPhaseHandler._apply_single_effect()
  → SpellCurse.apply_effect()
  → creature_data["curse"] = {...}

【バトル発生時】
BattlePreparation.prepare_participants()
  → BattleCurseApplier.apply_curses()
  → 呪いをtemporary_effectsに変換
  → participant.current_hp/ap に反映

【移動時】
MovementController → 呪い消滅
```

### データフロー（コマンド成長）

```
【領地コマンド実行時】
LandActionHelper.execute_level_up_with_level() / execute_terrain_change_with_element()
  → _trigger_command_growth()
  → SpellCurse.trigger_command_growth()
  → EffectManager.apply_max_hp_effect()
  → 通知UI表示
```

---

## JSON設計例

### バイタリティ（2066）
```json
{
  "id": 2066,
  "name": "バイタリティ",
  "cost": {"mp": 30},
  "effect_parsed": {
	"target_type": "land",
	"target_filter": "creature",
	"effects": [
	  {"effect_type": "stat_boost", "name": "能力値+20", "value": 20},
	  {"effect_type": "draw", "count": 1}
	]
  }
}
```

### グロースボディ（2026）
```json
{
  "id": 2026,
  "name": "グロースボディ",
  "cost": {"mp": 50},
  "effect_parsed": {
	"target_type": "land",
	"target_filter": "creature",
	"effects": [
	  {"effect_type": "permanent_hp_change", "value": 10}
	]
  }
}
```

### ドミナントグロース（2060）
```json
{
  "id": 2060,
  "name": "ドミナントグロース",
  "cost": {"mp": 50},
  "effect_parsed": {
	"target_type": "land",
	"target_filter": "creature",
	"target_info": {"owner_filter": "any"},
	"effects": [
	  {"effect_type": "command_growth_curse", "name": "コマンド成長", "hp_bonus": 20}
	]
  }
}
```

---

## 関連ファイル

| ファイル | 内容 |
|----------|------|
| `scripts/spells/spell_curse.gd` | 呪い基盤（command_growth含む） |
| `scripts/spells/spell_curse_stat.gd` | ステータス増減呪い |
| `scripts/battle/battle_curse_applier.gd` | バトル時呪い変換 |
| `scripts/game_flow/land_action_helper.gd` | コマンド成長トリガー |
| `scripts/game_flow/spell_phase_handler.gd` | スペル効果実行 |
| `data/spell_1.json`, `data/spell_2.json` | スペルデータ |
| `data/spell_mystic.json` | 秘術用内部スペル（9010, 9011） |

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025/11/12 | 初版 - バイタリティ/ディジーズ実装 |
| 2025/11/28 | 恒久変更方式（グロースボディ等）実装 |
| 2025/11/28 | デビリティ（AP=0呪い）実装 |
| 2025/11/28 | タイニーアーミー（密命）実装 |
| 2025/11/28 | クリーチャー秘術（リチェノイド、エアロダッチェス）実装 |
| 2025/11/28 | シュリンクシジル（秘術付与呪い）実装 |
| 2025/11/28 | リキッドフォーム（ランダムステータス呪い）実装 |
| 2025/11/28 | ドミナントグロース（コマンド成長呪い）実装 |
