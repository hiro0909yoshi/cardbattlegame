# ダイス操作スペル設計

**最終更新**: 2025年11月12日 | **実装状況**: ✅ 完全実装済み

---

## 概要

プレイヤーのダイス結果を固定値・範囲指定・複数回ロールに変更するスペル効果。  
呪い（Curse）システムを利用して実装。

---

## 実装スペル一覧

| タイプ | ID | 名前 | コスト | 効果 | レアリティ |
|--------|-----|------|--------|------|-----------|
| 固定 | 2098 | ホーリーワード1 | 30MP | 1固定 | R |
| 固定 | 2099 | ホーリーワード3 | 10MP | 3固定 | R |
| 固定 | 2100 | ホーリーワード6 | 50MP | 6固定 | R |
| 固定 | 2101 | ホーリーワード8 | 80MP | 8固定 | S |
| 範囲 | 2091 | ヘイスト | 70MP | 6-8範囲/2R | S |
| 範囲+魔力 | 2051 | チャージステップ | 20MP | 2-4範囲+50G/2R | R |
| 複数 | 2080 | フライ | 50MP | 3回振る | R |

**共通**: `target_type: "player"`, `target_filter: "any"` - 自分・敵の両方選択可能

---

## 呪いタイプ

### dice_fixed（ダイス固定）
- **効果**: 次のダイスロールを指定値に固定
- **パラメータ**: `value`（1-8）、`duration`（通常1）
- **JSON例**:
```json
{
  "effect_type": "dice_fixed",
  "value": 6,
  "duration": 1
}
```

### dice_range（ダイス範囲指定）
- **効果**: 指定範囲内のランダム値
- **パラメータ**: `min`, `max`, `duration`
- **JSON例**:
```json
{
  "effect_type": "dice_range",
  "min": 6,
  "max": 8,
  "duration": 2
}
```

### dice_multi（複数ダイスロール）
- **効果**: ダイスを複数回振って合計移動
- **パラメータ**: `count`（回数）、`duration`
- **特徴**: 各ダイス0.8秒間隔で表示、`target_type: "none"`で自動付与
- **JSON例**:
```json
{
  "effect_type": "dice_multi",
  "count": 3,
  "duration": 1
}
```

### dice_range_magic（範囲指定+魔力獲得）
- **効果**: 範囲指定ダイス + ロール後に魔力獲得
- **パラメータ**: `min`, `max`, `magic`, `duration`
- **JSON例**:
```json
{
  "effect_type": "dice_range_magic",
  "min": 2,
  "max": 4,
  "magic": 50,
  "duration": 2
}
```

---

## アーキテクチャ

### データフロー
```
スペル使用 → SpellDice.apply_*_effect()
  ↓
SpellCurse.curse_player() - 呪い付与
  ↓
ダイスロール → SpellDice.get_modified_dice_value()
  ↓
魔力付与判定 → SpellDice.process_magic_grant()
  ↓
ターン終了 → SpellCurse.update_player_curse() - duration減少
```

### クラス構成

**SpellDice** (`scripts/spells/spell_dice.gd`)
- スペル効果適用: `apply_dice_fixed_effect()`, `apply_dice_range_effect()`, `apply_dice_multi_effect()`, `apply_dice_range_magic_effect()`
- 呪い適用: `get_modified_dice_value()`
- 複数ダイス判定: `needs_multi_roll()`, `get_multi_roll_count()`
- 魔力付与: `should_grant_magic()`, `process_magic_grant()`

**SpellCurse** (`scripts/spells/spell_curse.gd`)
- 呪い管理・duration更新

**GameFlowManager** (`scripts/game_flow_manager.gd`)
- `roll_dice()` で複数ダイス・呪い適用・魔力付与を統合

**SpellPhaseHandler** (`scripts/game_flow/spell_phase_handler.gd`)
- `_apply_single_effect()` でSpellDiceメソッドを呼び出し

---

## 主要メソッド

### SpellDice.get_modified_dice_value()
**役割**: ダイスロール時に呪いを適用

```gdscript
func get_modified_dice_value(player_id: int, original_value: int) -> int:
	var curse = spell_curse.get_player_curse(player_id)
	
	match curse.get("curse_type", ""):
		"dice_fixed":
			return params.get("value", 6)
		"dice_range", "dice_range_magic":
			var min_val = int(params.get("min", 1))
			var max_val = int(params.get("max", 6))
			return randi() % (max_val - min_val + 1) + min_val
		_:
			return original_value
```

**呼び出し元**: `GameFlowManager.roll_dice()`

### SpellDice.process_magic_grant()
**役割**: ダイスロール後に魔力を付与

```gdscript
func process_magic_grant(player_id: int, ui_manager) -> void:
	if should_grant_magic(player_id):
		var magic_amount = get_magic_grant_amount(player_id)
		player_system.add_magic(player_id, magic_amount)
```

**呼び出し元**: `GameFlowManager` のダイスロール後

---

## duration管理

### 仕組み
- **付与時**: `duration=1` で呪いを設定
- **ダイスロール時**: 呪いが適用（まだ消えない）
- **ターン終了時**: `duration` が `1 → 0` に減少
- **duration=0**: 呪いが削除

### 重要ポイント
**ターン終了したプレイヤーのみ**呪いを更新（全プレイヤーではない）

```gdscript
# GameFlowManager.end_turn()
if spell_curse:
	spell_curse.update_player_curse(player_system.current_player_index)
```

---

## ターゲット選択

| キー | 動作 |
|------|------|
| ↑/← | 前のプレイヤー |
| ↓/→ | 次のプレイヤー |
| Enter | 選択確定 |
| C/ESC | キャンセル |

**フィルター**:
- `"own"` - 自分のみ
- `"enemy"` - 敵のみ
- `"any"` - 自分・敵の両方

---

## 使用例

### ホーリーワード6（敵に使用）
```
1. プレイヤー0がホーリーワード6使用（コスト50MP）
2. プレイヤー1（敵）を選択
3. 呪い付与: dice_fixed, value=6, duration=1
4. プレイヤー0のターン終了（duration変化なし）
5. プレイヤー1のターン開始 → ダイスロール
6. SpellDice適用 → 6固定
7. プレイヤー1が6マス移動
8. プレイヤー1のターン終了 → duration減少 → 呪い消滅
```

### チャージステップ（蓄魔歩行）
```
1. チャージステップ使用 → 呪い付与（duration=2）
2. 【1回目】ダイスロール → 2-4範囲 → 魔力+50G → 移動
3. ターン終了 → duration=2→1
4. 【2回目】ダイスロール → 2-4範囲 → 魔力+50G → 移動
5. ターン終了 → duration=1→0 → 呪い消滅
合計: 魔力100G獲得
```

---

## トラブルシューティング

### 呪いが即座に消える
**原因**: 全プレイヤーの呪いを更新していた  
**修正**: `update_player_curse(player_id)` で現在プレイヤーのみ更新

### ダイス値が変わらない
**確認箇所**:
1. `GameFlowManager.roll_dice()` に統合されているか
2. `spell_dice` が初期化されているか
3. ログ `[ダイス呪い]` が出力されているか

### 型エラー（int/float）
**原因**: JSONから読み込んだ数値が`float`型  
**修正**: `int(params.get("min", 1))` でキャスト

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025/11/12 | 初版 - ホーリーワード1/3/6/8実装 |
| 2025/11/12 | ヘイスト実装 - dice_range型エラー修正 |
| 2025/11/12 | フライ実装 - dice_multi、複数ダイスロール対応 |
| 2025/11/12 | チャージステップ実装 - dice_range_magic追加 |
| 2025/11/12 | コード整理 - SpellDiceへの処理移動完了 |
