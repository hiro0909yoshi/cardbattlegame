# 防魔システム設計

**バージョン**: 1.0  
**最終更新**: 2025年12月2日

---

## 概要

防魔（ぼうま）は、スペルの対象に選べなくなる効果。クリーチャーのパッシブスキル、プレイヤー呪い、クリーチャー呪いの3種類がある。

**重要**: 防魔は**スペルの対象選択をブロック**する効果であり、スペル効果の無効化ではない。

---

## 防魔の種類

| 種類 | 対象 | 効果 | 例 |
|------|------|------|-----|
| **パッシブスキル** | クリーチャー | 常時スペル対象不可 | アモン、ケットシー |
| **プレイヤー呪い** | セプター | 一定ターンスペル対象不可 | バリアー(5R)、ミスティワールド(6R) |
| **クリーチャー呪い** | クリーチャー | 一定ターンスペル対象不可 | マジックシェルター、ドモビー秘術 |

---

## タスク管理

### Phase 1: 基盤実装 ✅
- [x] ターゲット選択時の防魔判定メソッド作成（SpellProtection.gd）
- [x] TargetSelectionHelperにフィルター統合

### Phase 2: パッシブスキル（クリーチャー）
- [x] 防魔スキル持ちクリーチャーがスペル対象から除外される
- [x] テスト: アモン配置 → ダメージスペル使用 → 対象に選べないことを確認

### Phase 3: プレイヤー呪い
- [ ] 2071 バリアー実装
- [ ] 2110 ミスティワールド実装

### Phase 4: クリーチャー呪い
- [ ] 2105 マジックシェルター実装
- [ ] 2048 アンチエレメント実装（世界呪い→クリーチャー呪い変換）

### Phase 5: 秘術による防魔付与
- [ ] ID 24 ドモビー秘術実装
- [ ] ID 336 パトロナス秘術実装

---

## 対象スペル一覧

| ID | 名前 | 効果 | 呪いタイプ | 対象 | コスト |
|----|------|------|-----------|------|--------|
| 2048 | アンチエレメント | 世界呪い「呪い防魔化」(6R間、呪いのついた全クリーチャーは防魔) | 世界呪→クリーチャー呪い | 呪い付きクリーチャー | 70 |
| 2071 | バリアー | 対象セプターに呪い「防魔」(5R間、スペルの対象に選べない) | プレイヤー呪い | セプター | 30 |
| 2105 | マジックシェルター | 対象領地に呪い「防魔壁」(防魔と防御型を持つ) | クリーチャー呪い | 領地 | 70 |
| 2110 | ミスティワールド | 世界呪い「防魔」(6R間、全セプターはスペルの対象に選べない) | 世界呪（プレイヤー全員） | なし | 50 |

---

## 対象クリーチャー一覧（防魔スキル持ち）

| ID | 名前 | 属性 | 能力 | ファイル |
|----|------|------|------|----------|
| 2 | アモン | 火 | 感応[地]・AP&HP+20；防魔；秘術[G50・対象敵に30ダメージ] | fire_1.json |
| 11 | ケットシー | 火 | 無効化[AP40以上]；防魔 | fire_1.json |
| 211 | グリマルキン | 地 | 援護[火地]；防魔 | earth_1.json |
| 218 | ジャングラバー | 地 | 防魔；秘術[G30・対象敵クリーチャーに呪い「移動不可」] | earth_1.json |
| 300 | アームドプリンセス | 風 | 援護[水風]；先制；防魔 | wind_1.json |
| 309 | クー・シー | 風 | 感応[水・AP+10、HP+20]；防魔 | wind_1.json |
| 408 | ギアリオン | 無 | 先制；防魔；無効化[巻物] | neutral_1.json |
| 423 | ストーンジゾウ | 無 | 防御型；防魔；秘術[G100・対象領地を無に変え、自壊] | neutral_1.json |
| 430 | ハーフリング | 無 | 全属性地形効果；防魔 | neutral_2.json |
| 434 | ビーストギア | 無 | 無効化[巻物]；防魔 | neutral_2.json |
| 147 | ルーンアデプト | 水 | 巻物強打；防魔；秘術[G100・自手札のスペルカードの効果を使用] | water_2.json |

---

## 対象クリーチャー一覧（秘術で防魔付与）

| ID | 名前 | 属性 | 秘術効果 | ファイル |
|----|------|------|----------|----------|
| 24 | ドモビー | 火 | G80・対象自領地に呪い防魔（クリーチャー呪い） | fire_1.json |
| 336 | パトロナス | 風 | G50・対象セプターに呪い「防魔」（プレイヤー呪い） | wind_2.json |

---

## 実装詳細

### 防魔チェックメソッド

```gdscript
# spell_protection.gd（新規作成）
class_name SpellProtection

static func is_protected_from_spells(target_data: Dictionary, context: Dictionary) -> bool:
	"""
	スペル対象が防魔かどうかを判定
	target_data: {type: "creature" or "player", tile_index or player_id}
	"""
	match target_data.get("type"):
		"creature":
			return _check_creature_protection(target_data.tile_index, context)
		"player":
			return _check_player_protection(target_data.player_id, context)
	return false

static func _check_creature_protection(tile_index: int, context: Dictionary) -> bool:
	var creature = context.creature_manager.get_data_ref(tile_index)
	if creature.is_empty():
		return false
	
	# 1. パッシブスキル「防魔」チェック
	var keywords = creature.get("ability_parsed", {}).get("keywords", [])
	if "防魔" in keywords:
		return true
	
	# 2. クリーチャー呪い「防魔」チェック
	var curse = creature.get("curse", {})
	if curse.get("curse_type") in ["spell_protection", "protection_wall"]:
		return true
	
	# 3. 世界呪い「呪い防魔化」チェック（呪い付きクリーチャーのみ）
	var world_curse = context.game_flow_manager.game_stats.get("world_curse", {})
	if world_curse.get("curse_type") == "cursed_protection":
		if creature.has("curse"):
			return true
	
	return false

static func _check_player_protection(player_id: int, context: Dictionary) -> bool:
	var player = context.player_system.players[player_id]
	
	# 1. プレイヤー呪い「防魔」チェック
	if not player.curse.is_empty():
		if player.curse.get("curse_type") == "spell_protection":
			return true
	
	# 2. 世界呪い「防魔」チェック
	var world_curse = context.game_flow_manager.game_stats.get("world_curse", {})
	if world_curse.get("curse_type") == "world_spell_protection":
		return true
	
	return false
```

### ターゲットフィルタリング統合

```gdscript
# spell_phase_handler.gd の _get_valid_targets() に追加
func _get_valid_targets(spell_data: Dictionary) -> Array:
	var targets = _get_base_targets(spell_data)
	
	# 防魔フィルター適用
	var filtered_targets = []
	for target in targets:
		if not SpellProtection.is_protected_from_spells(target, _get_context()):
			filtered_targets.append(target)
	
	return filtered_targets
```

---

## 呪いデータ構造

### プレイヤー呪い（バリアー）

```json
{
  "curse_type": "spell_protection",
  "name": "防魔",
  "duration": 5,
  "params": {}
}
```

### クリーチャー呪い（マジックシェルター）

```json
{
  "curse_type": "protection_wall",
  "name": "防魔壁",
  "duration": -1,
  "params": {
	"grants_defensive": true
  }
}
```

### 世界呪い（ミスティワールド）

```json
{
  "curse_type": "world_spell_protection",
  "name": "防魔",
  "duration": 6,
  "params": {}
}
```

### 世界呪い（アンチエレメント）

```json
{
  "curse_type": "cursed_protection",
  "name": "呪い防魔化",
  "duration": 6,
  "params": {}
}
```

---

## スペルJSON定義例

### 2071 バリアー

```json
{
  "id": 2071,
  "name": "バリアー",
  "effect_parsed": {
	"target_type": "player",
	"target_filter": "any",
	"effects": [
	  {
		"effect_type": "curse_player",
		"curse_type": "spell_protection",
		"name": "防魔",
		"duration": 5
	  }
	]
  }
}
```

### 2105 マジックシェルター

```json
{
  "id": 2105,
  "name": "マジックシェルター",
  "effect_parsed": {
	"target_type": "land",
	"target_filter": "creature",
	"effects": [
	  {
		"effect_type": "curse_creature",
		"curse_type": "protection_wall",
		"name": "防魔壁",
		"duration": -1,
		"grants_defensive": true
	  }
	]
  }
}
```

### 2110 ミスティワールド

```json
{
  "id": 2110,
  "name": "ミスティワールド",
  "effect_parsed": {
	"target_type": "world",
	"effects": [
	  {
		"effect_type": "curse_world",
		"curse_type": "world_spell_protection",
		"name": "防魔",
		"duration": 6
	  }
	]
  }
}
```

---

## 秘術JSON定義例

### ID 24 ドモビー秘術

```json
{
  "ability_parsed": {
	"keywords": ["秘術"],
	"mystic_arts": [
	  {
		"id": "domovoi_mystic_001",
		"name": "防魔付与",
		"description": "対象自領地に防魔を付与",
		"spell_id": 9020,
		"cost": 80
	  }
	]
  }
}
```

**spell_mystic.json追加**:
```json
{
  "id": 9020,
  "name": "防魔付与",
  "effect_parsed": {
	"target_type": "land",
	"target_info": {
	  "owner_filter": "own",
	  "target_filter": "creature"
	},
	"effects": [
	  {
		"effect_type": "curse_creature",
		"curse_type": "spell_protection",
		"name": "防魔",
		"duration": -1
	  }
	]
  }
}
```

### ID 336 パトロナス秘術

```json
{
  "ability_parsed": {
	"keywords": ["防魔", "秘術"],
	"mystic_arts": [
	  {
		"id": "patronas_mystic_001",
		"name": "防魔付与",
		"description": "対象セプターに呪い「防魔」",
		"spell_id": 9021,
		"cost": 50
	  }
	]
  }
}
```

**spell_mystic.json追加**:
```json
{
  "id": 9021,
  "name": "セプター防魔",
  "effect_parsed": {
	"target_type": "player",
	"target_filter": "any",
	"effects": [
	  {
		"effect_type": "curse_player",
		"curse_type": "spell_protection",
		"name": "防魔",
		"duration": 5
	  }
	]
  }
}
```

---

## 注意事項

1. **防魔 vs 無効化の違い**
   - 防魔: ターゲット選択段階でブロック（そもそも選べない）
   - 無効化: 効果適用段階で無効化（選べるが効果がない）

2. **マジックシェルターの特殊性**
   - 防魔と防御型の両方を付与する
   - 防御型は creature_type を変更する必要あり

3. **アンチエレメントの特殊性**
   - 世界呪いだが、効果は「呪い付きクリーチャーにのみ」適用
   - 呪いがないクリーチャーは影響を受けない

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025/12/02 | 1.0 | 初版作成 |

---

**作成日**: 2025年12月2日
