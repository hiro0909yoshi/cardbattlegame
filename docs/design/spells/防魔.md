# 防魔システム

**ステータス**: 実装完了（世界呪い除く）  
**最終更新**: 2025年12月2日

---

## 概要

防魔は**スペル/アルカナアーツの対象に選べなくなる**効果。ターゲット選択段階でフィルタリングされる。

---

## 防魔の種類

| 種類 | 対象 | 判定場所 |
|------|------|----------|
| パッシブスキル | クリーチャー | `ability_parsed.keywords` に "防魔" |
| クリーチャー呪い | クリーチャー | `curse.curse_type` が "spell_protection" or "protection_wall" |
| プレイヤー呪い | セプター | `player.curse.curse_type` が "spell_protection" |
| 世界呪い | 全体 | `game_stats.world_curse`（未実装） |

---

## 実装ファイル

| ファイル | 役割 |
|----------|------|
| `scripts/spells/spell_protection.gd` | 防魔判定ロジック（is_creature_protected, is_player_protected） |
| `scripts/game_flow/target_selection_helper.gd` | ターゲット取得時にフィルタ適用（get_valid_targets_core内） |
| `scripts/cpu_ai/cpu_target_resolver.gd` | CPUターゲット選択時にフィルタ適用（check_target_condition内） |
| `scripts/game_flow/spell_effect_executor.gd` | player_curse効果適用 |
| `scripts/spells/spell_curse.gd` | curse_player() でプレイヤー呪い付与 |

### フィルタ適用の仕組み

防魔フィルタは以下の2箇所で**自動的に**適用される：

1. **プレイヤー/effect_parsed経由**: `TargetSelectionHelper.get_valid_targets_core()`
   - 関数の最後で `SpellProtection.filter_protected_targets()` を呼び出し
   - `target_info.ignore_protection = true` でスキップ可能（ディスペルマジック等）

2. **CPU/target_condition経由**: `CPUTargetResolver.check_target_condition()`
   - 関数の最後で `_apply_protection_filter()` を呼び出し
   - 全てのtarget_conditionに対して一律適用

これにより、どのルートでターゲットを取得しても防魔持ちは自動的に除外される。

----------|------|
| `scripts/spells/spell_protection.gd` | 防魔判定ロジック |
| `scripts/game_flow/target_selection_helper.gd` | ターゲット取得時にフィルタ適用（586行目） |
| `scripts/game_flow/spell_phase_handler.gd` | player_curse効果適用（586行目） |
| `scripts/spells/spell_curse.gd` | curse_player() でプレイヤー呪い付与 |

---

## 実装済みスペル

| ID | 名前 | 対象 | 呪いタイプ | 期間 |
|----|------|------|-----------|------|
| 2071 | バリアー | セプター | spell_protection | 5R |
| 2105 | マジックシェルター | ドミニオ | protection_wall | 永続 |

### effect_parsed例

```json
// バリアー
{
  "target_type": "player",
  "target_info": {"target_filter": "any"},
  "effects": [{
	"effect_type": "player_curse",
	"curse_type": "spell_protection",
	"name": "防魔",
	"duration": 5
  }]
}

// マジックシェルター
{
  "target_type": "land",
  "target_info": {"owner_filter": "any", "target_filter": "creature"},
  "effects": [{
	"effect_type": "creature_curse",
	"curse_type": "protection_wall",
	"name": "防魔壁",
	"spell_protection": true,
	"defensive_form": true,
	"duration": -1
  }]
}
```

---

## 実装済みアルカナアーツ

| クリーチャー | spell_id | 対象 | 呪いタイプ |
|-------------|----------|------|-----------|
| ドモビー(24) | 9022 | 自ドミニオクリーチャー | spell_protection |
| パトロナス(336) | 9023 | セプター | spell_protection |

アルカナアーツ定義は `data/spell_mystic.json` に追加済み。

---

## 防魔持ちクリーチャー（11体）

| ID | 名前 | 属性 | ファイル |
|----|------|------|----------|
| 2 | アモン | 火 | fire_1.json |
| 11 | ケットシー | 火 | fire_1.json |
| 147 | ルーンアデプト | 水 | water_2.json |
| 211 | グリマルキン | 地 | earth_1.json |
| 218 | ジャングラバー | 地 | earth_1.json |
| 300 | アームドプリンセス | 風 | wind_1.json |
| 309 | クー・シー | 風 | wind_1.json |
| 336 | パトロナス | 風 | wind_2.json |
| 408 | ギアリオン | 無 | neutral_1.json |
| 423 | ストーンジゾウ | 無 | neutral_1.json |
| 430 | ハーフリング | 無 | neutral_2.json |
| 434 | ビーストギア | 無 | neutral_2.json |

全クリーチャーの `ability_parsed.keywords` に "防魔" を設定済み。

---

## 未実装

| ID | 名前 | 効果 | 備考 |
|----|------|------|------|
| 2048 | アンチエレメント | 呪い付きクリーチャーが防魔化(6R) | 世界呪い |
| 2110 | ミスティワールド | 全セプターが防魔化(6R) | 世界呪い |

世界呪いの仕組みが未決定のため保留。

---

## 注意事項

- **防魔 ≠ 無効化**: 防魔は「選べない」、無効化は「選べるが効果なし」
- **マジックシェルターの防御型**: 戦闘処理での対応が別途必要
- **ignore_protection**: target_infoに設定すると防魔を無視（ディスペルマジック等用）
