# 土地操作スペル効果

**バージョン**: 1.0  
**最終更新**: 2025年11月9日

---

## 概要

土地の属性変更、レベル操作、クリーチャー破壊などを担当するスペル効果モジュール。

**実装ファイル**: `scripts/spells/spell_land.gd`

**初期化**:
```gdscript
# GameFlowManager.setup_systems()
spell_land = SpellLand.new()
spell_land.setup(board_system, creature_manager, player_system)
```

---

## SpellPhaseHandlerへの統合 ✅

`SpellPhaseHandler`の`_apply_single_effect()`に以下の`effect_type`を追加：

| effect_type | 説明 | 対応メソッド |
|-------------|------|--------------|
| `change_element` | 土地属性変更 | `_apply_land_effect_change_element()` |
| `change_level` | 土地レベル変更 | `_apply_land_effect_change_level()` |
| `abandon_land` | 土地放棄 | `_apply_land_effect_abandon()` |
| `destroy_creature` | クリーチャー破壊 | `_apply_land_effect_destroy_creature()` |

**ターゲット選択**:
- `"land"`: 全ての所有地
- `"own_land"`: 自分の土地のみ
- `"enemy_land"`: 敵の土地のみ

**使用例（JSON定義）**:
```json
{
  "id": 2001,
  "name": "アースシフト",
  "effect_parsed": {
	"target_type": "own_land",
	"target_info": {"owner_filter": "own"},
	"effects": [
	  {
		"effect_type": "change_element",
		"element": "earth"
	  }
	]
  }
}
```

---

## メソッド一覧

### change_element(tile_index: int, new_element: String) -> bool

土地の属性を変更する。

**引数**:
- `tile_index`: タイルのインデックス（0-19）
- `new_element`: 新しい属性（"fire", "water", "earth", "wind", "neutral"）

**戻り値**:
- 成功した場合`true`

**使用例**:
```gdscript
# アースシフト（ID: 2001）
spell_land.change_element(5, "earth")  # タイル5を地属性に変更
```

**出力**:
```
[土地属性変更] タイル5: fire → earth
```

---

### change_level(tile_index: int, delta: int) -> bool

土地のレベルを増減する。

**引数**:
- `tile_index`: タイルのインデックス
- `delta`: レベル変化量（+1, -1等）

**制約**:
- レベルは1-5の範囲に制限される

**使用例**:
```gdscript
# アステロイド（ID: 2003）- レベルを1下げる
spell_land.change_level(10, -1)

# フラットランド（ID: 2085）- レベルを1上げる
spell_land.change_level(3, 1)
```

**出力**:
```
[土地レベル変更] タイル10: Lv3 → Lv2
[土地レベル変更] タイル3: Lv2 → Lv3
```

---

### set_level(tile_index: int, level: int) -> bool

土地のレベルを固定値に設定する。

**引数**:
- `tile_index`: タイルのインデックス
- `level`: 設定するレベル（1-5）

**使用例**:
```gdscript
# アステロイド合成版 - レベルを1に設定
spell_land.set_level(8, 1)
```

---

### destroy_creature(tile_index: int) -> bool

タイル上のクリーチャーを破壊する。

**使用例**:
```gdscript
# クリーチャー破壊スペル
if spell_land.destroy_creature(15):
	print("クリーチャーを破壊しました")
```

**出力**:
```
[クリーチャー破壊] タイル15: ゴブリンを破壊
```

---

### abandon_land(tile_index: int, player_id: int) -> int

土地を放棄し、価値の一部を魔力として得る。

**引数**:
- `tile_index`: タイルのインデックス
- `player_id`: 放棄するプレイヤーID

**戻り値**:
- 土地の価値（魔力換算）

**計算式**:
```
土地価値 = レベル × 基本価格（100）
```

**使用例**:
```gdscript
# ランドトランス（ID: 2118）- 価値の70%を得る
var land_value = spell_land.abandon_land(5, player_id)
var magic_gain = int(land_value * 0.7)
spell_magic.add_magic(player_id, magic_gain)
```

**出力**:
```
[土地放棄] タイル5: プレイヤー0 Lv3 earth 価値=300
```

---

### change_element_with_condition(tile_index: int, condition: Dictionary, new_element: String) -> bool

条件を満たす場合のみ属性を変更する。

**条件タイプ**:

| キー | 型 | 説明 |
|-----|-----|------|
| `max_level` | int | 最大レベル制限 |
| `required_elements` | Array | 必要な属性リスト |

**使用例**:
```gdscript
# クインテッセンス（ID: 2022）- レベル4以下のみ
var condition = {"max_level": 4}
spell_land.change_element_with_condition(tile_index, condition, "earth")

# ストームシフト（ID: 2040）- 風属性のみ
var condition = {"required_elements": ["air"], "max_level": 3}
spell_land.change_element_with_condition(tile_index, condition, "water")
```

---

### get_player_dominant_element(player_id: int) -> String

プレイヤーが最も多く所有している属性を取得する。

**使用例**:
```gdscript
# インフルエンス（ID: 2008）
var dominant = spell_land.get_player_dominant_element(tile.tile_owner)
spell_land.change_element(tile_index, dominant)
```

---

### change_level_multiple_with_condition(player_id: int, condition: Dictionary, delta: int) -> int

条件を満たす複数のタイルのレベルを一括変更する。

**条件タイプ**:

| キー | 型 | 説明 |
|-----|-----|------|
| `required_level` | int | 対象レベル |
| `required_elements` | Array | 対象属性リスト |

**戻り値**:
- 変更されたタイル数

**使用例**:
```gdscript
# フラットランド（ID: 2085）- レベル2の土地を全て1上げる
var condition = {"required_level": 2}
var changed_count = spell_land.change_level_multiple_with_condition(
	player_id, condition, 1
)

if changed_count >= 5:
	print("5つ以上の土地をレベルアップ！")
else:
	# 密命失敗、カードを手札に戻す
	pass
```

---

## 対応スペル一覧

### 属性変換スペル

| ID | 名前 | 効果 | 実装メソッド |
|----|------|------|-------------|
| 2001 | アースシフト | 対象自領地を地に変える | `change_element(tile, "earth")` |
| 2010 | ウォーターシフト | 対象自領地を水に変える | `change_element(tile, "water")` |
| 2011 | エアーシフト | 対象自領地を風に変える | `change_element(tile, "air")` |
| 2074 | ファイアーシフト | 対象自領地を火に変える | `change_element(tile, "fire")` |
| 2022 | クインテッセンス | レベル4以下の対象領地を無に | `change_element_with_condition()` |
| 2008 | インフルエンス | 最多属性に変換 | `get_player_dominant_element()` + `change_element()` |

### レベル操作スペル

| ID | 名前 | 効果 | 実装メソッド |
|----|------|------|-------------|
| 2003 | アステロイド | 対象領地のレベルを1下げる | `change_level(tile, -1)` |
| 2029 | サドンインパクト | 密命；レベル4領地を1下げる | 条件チェック + `change_level()` |
| 2030 | サブサイド | 最高レベル領地を1下げる | 検索 + `change_level()` |
| 2085 | フラットランド | 密命；レベル2領地×5を1上げる | `change_level_multiple_with_condition()` |

### 土地放棄スペル

| ID | 名前 | 効果 | 実装メソッド |
|----|------|------|-------------|
| 2118 | ランドトランス | 対象自領地を手放し、価値の70%を得る | `abandon_land()` |

---

## システム統合

### GameFlowManagerでの初期化

```gdscript
# game_flow_manager.gd
var spell_land: SpellLand

func setup_systems(...):
	# ... 他のシステム初期化
	
	# SpellLandの初期化
	spell_land = SpellLand.new()
	spell_land.setup(board_system, creature_manager, player_system)
```

### SpellPhaseHandlerでの使用

```gdscript
# spell_phase_handler.gd
func _execute_spell_effect(spell_data: Dictionary, target_tile: int):
	var effect_type = spell_data.get("effect_type", "")
	
	match effect_type:
		"change_element":
			var new_element = spell_data.get("element", "earth")
			spell_land.change_element(target_tile, new_element)
		
		"change_level":
			var delta = spell_data.get("delta", -1)
			spell_land.change_level(target_tile, delta)
		
		"destroy_creature":
			spell_land.destroy_creature(target_tile)
```

---

## 技術的な注意事項

### 1. タイルインデックスの検証

すべてのメソッドで0-19の範囲チェックを実施。

### 2. レベルの範囲制限

レベルは常に1-5の範囲に制限される（`clamp`使用）。

### 3. 所有者チェック

`abandon_land()`では所有者の一致を確認。

### 4. ビジュアル更新

属性・レベル変更後、必ず`_update_tile_visual()`を呼び出す。

### 5. プレイヤーデータの更新

土地放棄時、`player.lands_owned`を更新する。

---

## エラーハンドリング

### 無効なタイルインデックス

```gdscript
if not _validate_tile_index(tile_index):
	return false
```

### 無効な属性

```gdscript
if not _validate_element(new_element):
	push_error("SpellLand: 無効な属性 '%s'" % new_element)
	return false
```

### 所有者不一致

```gdscript
if tile.tile_owner != player_id:
	push_error("SpellLand: プレイヤー%dはタイル%dを所有していません" % [player_id, tile_index])
	return 0
```

---

## 今後の拡張

### 実装済みメソッド（追加）

```gdscript
# 最高/最低レベルの土地を検索 ✅
func find_highest_level_land(player_id: int) -> int
func find_lowest_level_land(player_id: int) -> int
```

**使用例**:
```gdscript
# サブサイド（ID: 2030）- 最高レベル領地のレベルを1下げる
var highest_tile = spell_land.find_highest_level_land(enemy_player_id)
if highest_tile != -1:
	spell_land.change_level(highest_tile, -1)
```

### 追加予定メソッド

```gdscript
# 複数タイルの一括属性変更
func change_element_multiple(tile_indices: Array, new_element: String) -> int

# 隣接タイルの属性変更
func change_adjacent_elements(center_tile: int, new_element: String) -> int
```

---

## デバッグログ

土地操作時には以下のログが出力される:

```
[土地属性変更] タイル5: fire → earth
[土地レベル変更] タイル10: Lv3 → Lv2
[土地レベル設定] タイル8: Lv4 → Lv1
[クリーチャー破壊] タイル15: ゴブリンを破壊
[土地放棄] タイル5: プレイヤー0 Lv3 earth 価値=300
[条件付き属性変更] タイル3: レベル条件不一致（Lv5 > Lv4）
```

---

## 関連ドキュメント

- [スペルシステム設計](../spells_design.md) - 全体設計
- [カードドロー効果](./カードドロー.md) - SpellDrawシステム
- [魔力増減効果](./魔力増減.md) - SpellMagicシステム

---

**最終更新**: 2025年11月9日（v1.0）
