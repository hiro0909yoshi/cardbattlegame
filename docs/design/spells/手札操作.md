# 手札操作スペル効果

**バージョン**: 3.4  
**最終更新**: 2025年11月27日

---

## 概要

カードドロー、手札破壊、手札交換・盗みなどの手札操作を担当するスペル効果モジュール。

**実装ファイル**:
- `scripts/spells/spell_draw.gd` - データ処理（ドロー、破壊、奪取）
- `scripts/spells/card_selection_handler.gd` - UI制御（敵手札選択、デッキカード選択）

**初期化**:
```gdscript
# GameFlowManager.setup_systems()
spell_draw = SpellDraw.new()
spell_draw.setup(card_system, player_system)
```

---

## 前提システム: 順位取得 ✅実装済み

ギフト（ID: 2020）は順位に応じた効果を持つため、順位システムを実装済み。

**実装場所**: `scripts/ui_components/player_info_panel.gd`

**メソッド**:
```gdscript
func get_player_ranking(player_id: int) -> int:
	var rankings = calculate_all_rankings()
	if player_id >= 0 and player_id < rankings.size():
		return rankings[player_id]
	return 0

func calculate_all_rankings() -> Array:
	# 総魔力で降順ソート、同率は同順位
```

**順位の定義**:
- 総魔力（`calculate_total_assets(player_id)`）で降順ソート
- 同率の場合は同順位（例: 1位, 1位, 3位）

**SpellPhaseHandlerからの呼び出し**:
```gdscript
func _get_player_ranking(player_id: int) -> int:
	if ui_manager and ui_manager.player_info_panel:
		return ui_manager.player_info_panel.get_player_ranking(player_id)
	return 1
```

---

## SpellPhaseHandlerへの統合

`SpellPhaseHandler`の`_apply_single_effect()`に追加予定の`effect_type`:

| effect_type | 説明 | 対応メソッド | 実装状況 |
|-------------|------|--------------|---------|
| `draw_cards` | 固定枚数ドロー | `spell_draw.draw_cards()` | ✅ 実装済み |
| `draw_by_rank` | 順位に応じたドロー | `spell_draw.draw_cards()` + 順位取得 | ✅ 実装済み |
| `gain_magic` | 固定額の魔力獲得 | `spell_magic.add_magic()` | ✅ 実装済み |
| `gain_magic_by_rank` | 順位×multiplierの魔力獲得 | `spell_magic.add_magic()` | ✅ 実装済み |
| `discard_and_draw_plus` | 手札全捨て+枚数+1枚ドロー | カード破棄 + ドロー | ✅ 実装済み |
| `check_hand_elements` | 密命：手札属性チェック | 条件分岐処理 | ✅ 実装済み |
| `draw_from_top` | デッキ上部から選択 | `draw_from_top_selection()` | ⏳ 未実装 |
| `draw_by_type` | タイプ指定ドロー | `draw_by_type()` | ⏳ 未実装 |
| `destroy_hand_card` | 手札破壊 | `destroy_hand_card()` | ⏳ 未実装 |
| `destroy_duplicate_cards` | 重複カード破壊 | `destroy_duplicate_cards()` | ✅ 実装済み |
| `destroy_curse_cards` | 呪いカード破壊 | `destroy_curse_cards()` | ✅ 実装済み |
| `destroy_expensive_cards` | 高コストカード破壊 | `destroy_expensive_cards()` | ✅ 実装済み |
| `destroy_from_deck` | デッキからカード破壊 | `destroy_from_deck()` | ⏳ 未実装 |
| `destroy_selected_card` | 敵手札から選択破壊 | `start_enemy_card_selection()` | ✅ 実装済み |
| `steal_card` | カード奪取 | `steal_card()` | ⏳ 未実装 |

---

## 既存メソッド一覧

### draw_one(player_id: int) -> Dictionary

ターン開始時の1枚ドロー。

```gdscript
var drawn = spell_draw.draw_one(current_player.id)
```

### draw_cards(player_id: int, count: int) -> Array

固定枚数ドロー（スペルカード用）。

```gdscript
var cards = spell_draw.draw_cards(player_id, 2)  # 2枚引く
```

### draw_until(player_id: int, target_hand_size: int) -> Array

指定枚数まで補充（トゥームストーン用）。

**動作例**:
- 手札2枚、target=6 → 4枚引く
- 手札6枚、target=6 → 0枚（引かない）

```gdscript
var cards = spell_draw.draw_until(player_id, 6)  # 6枚まで補充
```

### exchange_all_hand(player_id: int) -> Array

手札を全て捨てて同じ枚数引き直す。

```gdscript
var new_cards = spell_draw.exchange_all_hand(player_id)
```

---

## 追加予定メソッド

### draw_by_rank(player_id: int) -> Dictionary

順位に応じた枚数をドローし、順位×G50を得る（ギフト用）。

**処理内容**:
1. プレイヤーの現在順位を取得
2. 順位と同じ枚数のカードを引く
3. 順位×G50の魔力を付与

```gdscript
# ギフト（ID: 2020）
var result = spell_draw.draw_by_rank(player_id)
# result = {"cards": [...], "gold": 150, "rank": 3}
```

### draw_conditional(player_id: int, condition: Dictionary, success_count: int, fail_count: int) -> Array

条件を満たす場合と満たさない場合で異なる枚数をドロー。

**条件タイプ**:

| condition_type | 説明 | パラメータ |
|----------------|------|-----------|
| `has_synthesis` | 合成カードが手札にあるか | なし |
| `has_elements` | 指定属性カードが手札にあるか | `elements: Array` |

```gdscript
# フィロソフィー（ID: 2077）- 合成持ちなら3枚、なければ2枚
var condition = {"condition_type": "has_synthesis"}
var cards = spell_draw.draw_conditional(player_id, condition, 3, 2)
```

### draw_from_top_selection(player_id: int, look_count: int) -> void

デッキ上部の指定枚数を見て、1枚を選んでドロー（UI必要）。

**処理内容**:
1. デッキ上部`look_count`枚を取得
2. 選択UIを表示
3. 選んだ1枚を手札に追加
4. 残りをデッキに戻す

```gdscript
# フォーサイト（ID: 2078）- 上6枚から1枚選ぶ
spell_draw.draw_from_top_selection(player_id, 6)
```

### draw_by_type(player_id: int, card_type: String) -> Dictionary

指定タイプのカードをデッキから検索してドロー。

**card_type**:
- `"creature"`: クリーチャーカード
- `"item"`: アイテムカード
- `"spell"`: スペルカード

```gdscript
# プロフェシー（ID: 2090）
var card = spell_draw.draw_by_type(player_id, "creature")
```

### discard_and_draw_plus(player_id: int, bonus: int) -> Array

手札を全て捨て、その枚数+bonus枚のカードを引く。

```gdscript
# リンカネーション（ID: 2127）- 手札枚数+1枚引く
var cards = spell_draw.discard_and_draw_plus(player_id, 1)
```

### destroy_hand_card(target_player_id: int, card_filter: Dictionary) -> Dictionary

対象プレイヤーの手札から条件に合うカードを破壊。

**フィルター**:

| キー | 説明 |
|-----|------|
| `card_types` | 対象カードタイプ（Array） |
| `selection_mode` | "random" / "player_select" / "owner_select" |

```gdscript
# シャッター（ID: 2034）- アイテムかスペルを選んで破壊
var filter = {"card_types": ["item", "spell"], "selection_mode": "player_select"}
var destroyed = spell_draw.destroy_hand_card(enemy_id, filter)
```

### destroy_duplicate_cards(target_player_id: int) -> Dictionary

対象プレイヤーの手札から重複カード（同名カードが2枚以上）を全て破壊。

**戻り値**:
- `total_destroyed`: int（破壊した総枚数）
- `duplicates`: Array（破壊したカード名のリスト）

```gdscript
# エロージョン（ID: 2017）
var result = spell_draw.destroy_duplicate_cards(target_player_id)
# result = {"total_destroyed": 4, "duplicates": ["ファイアドレイク", "ホープ"]}
```

### destroy_curse_cards() -> Dictionary

全プレイヤーの手札から呪いカードを破壊。

**戻り値**:
- `total_destroyed`: int（破壊した総枚数）
- `by_player`: Array（プレイヤーごとの破壊枚数）

```gdscript
# レイオブパージ（ID: 2128）
var result = spell_draw.destroy_curse_cards()
# result = {"total_destroyed": 3, "by_player": [1, 2, 0, 0]}
```

### destroy_expensive_cards(cost_threshold: int) -> Dictionary

全プレイヤーの手札から指定コスト以上のカードを破壊。

**戻り値**:
- `total_destroyed`: int（破壊した総枚数）
- `by_player`: Array（プレイヤーごとの破壊枚数）

```gdscript
# レイオブロウ（ID: 2129）- G100以上を破壊
var result = spell_draw.destroy_expensive_cards(100)
# result = {"total_destroyed": 5, "by_player": [2, 1, 1, 1]}
```

### destroy_from_deck(target_player_id: int, look_count: int) -> Dictionary

デッキ上部を見て1枚を選んで破壊（UI必要）。

```gdscript
# ポイズンマインド（ID: 2093）- 上6枚から1枚破壊、その後1枚ドロー
var destroyed = spell_draw.destroy_from_deck(enemy_id, 6)
spell_draw.draw_cards(current_player_id, 1)
```

### steal_card(from_player_id: int, to_player_id: int, card_filter: Dictionary) -> Dictionary

対象プレイヤーの手札からカードを奪う。

```gdscript
# セフト（ID: 2046）- スペルを1枚奪う
var filter = {"card_types": ["spell"], "selection_mode": "player_select"}
var stolen = spell_draw.steal_card(enemy_id, current_player_id, filter)
```

---

## 対応スペル一覧

### カードドロー系（6個）

| ID | 名前 | 効果 | 実装メソッド | 実装状況 |
|----|------|------|-------------|---------|
| 2095 | ホープ | カードを2枚引く | `draw_cards(player_id, 2)` | ✅ 実装完了 |
| 2020 | ギフト | 順位×G50を得る；順位と同じ枚数ドロー | `draw_by_rank()` | ✅ 実装完了 |
| 2078 | フォーサイト | デッキ上6枚から1枚選んでドロー | `draw_from_top_selection()` | ⏳ 実装予定 |
| 2090 | プロフェシー | 指定タイプのカードを1枚ドロー | `draw_by_type()` | ⏳ 実装予定 |
| 2004 | アセンブルカード | 密命；手札に火水風地があればG500、なければ2枚ドロー | 条件チェック + `draw_cards()` | ✅ 実装完了 |
| 2127 | リンカネーション | 手札を全て捨て、枚数+1枚を引く | `discard_and_draw_plus()` | ✅ 実装完了 |

### 保留中（システム未実装）

| ID | 名前 | 効果 | 保留理由 |
|----|------|------|---------|
| 2077 | フィロソフィー | 合成持ちなら3枚、なければ2枚引く | 合成システム未実装 |
| 2112 | ミラクルコール | ブリードカードがあれば1枚、なければ2枚ドロー | ブリードカード不存在 |

### 手札破壊系（6個）

| ID | 名前 | 効果 | 実装メソッド | 実装状況 |
|----|------|------|-------------|---------|
| 2128 | レイオブパージ | 全手札の呪いカードを破壊 | `destroy_curse_cards()` | ✅ 実装完了 |
| 2129 | レイオブロウ | 全手札のG100以上カードを破壊 | `destroy_expensive_cards(100)` | ✅ 実装完了 |
| 2017 | エロージョン | 重複カードを全て破壊 | `destroy_duplicate_cards()` | ✅ 実装完了 |
| 2034 | シャッター | 敵手札のアイテム/スペルを1枚選んで破壊 | `destroy_selected_card` | ✅ 実装完了 |
| 2038 | スクイーズ | 手札1枚を選んで破壊、対象にG150を与える | `destroy_selected_card` + 魔力付与 | ✅ 実装完了 |
| 2093 | ポイズンマインド | デッキ上6枚から1枚破壊、1枚ドロー | `destroy_from_deck_selection` | ✅ 実装完了 |

### 手札交換・盗み系（2個）

| ID | 名前 | 効果 | 実装メソッド | 実装状況 |
|----|------|------|-------------|---------|
| 2046 | セフト | 敵手札のスペルを1枚奪う | `steal_selected_card` | ✅ 実装完了 |
| 2042 | スニークハンド | 密命；アイテム2枚以上持つ敵から1枚奪う | 条件チェック + `steal_card()` | ⏳ 未実装 |

---
追加。秘術項目
31,26,405,129,130,136,310,346
## 実装優先度

### 前提: 順位システム実装
- **PlayerInfo**に`get_player_ranking(player_id: int) -> int`を追加
- 総魔力でソート（1位=1, 2位=2...）
- ギフト（2020）で使用

### Phase 1: 基本ドロー
1. **2095: ホープ** - 最も単純、`draw_cards()`で即実装可能
2. **2127: リンカネーション** - `discard_and_draw_plus()`追加

### Phase 2: 順位・条件付きドロー
3. **2020: ギフト** - 順位取得と魔力付与の連携
4. **2004: アセンブルカード** - 密命 + 手札クリーチャー属性判定

### Phase 3: UI必要系（最後）
5. **2078: フォーサイト** - デッキ上6枚取得 + カード選択UI
6. **2090: プロフェシー** - タイプ選択UI + デッキ検索

### Phase 4: 手札破壊系（UI不要）✅完了
7. **2128: レイオブパージ** - 全手札の呪いカード破壊（`spell_type`で判定）✅
8. **2129: レイオブロウ** - 全手札のG100以上破壊（`cost.mp`で判定）✅
9. **2017: エロージョン** - 重複カード2枚とも破壊 ✅

### Phase 5: 手札選択・盗み系（UI必要）
10. **2038: スクイーズ** - 対象の手札1枚を選んで破壊+G150付与
11. **2034: シャッター** - 敵手札のアイテム/スペル選択破壊
12. **2046: セフト** - 敵手札のスペル1枚奪取
13. **2093: ポイズンマインド** - デッキ上6枚から1枚破壊

---

## Phase 5 詳細仕様: カード選択システム ✅実装完了

### 概要

敵手札選択（シャッター、スクイーズ、セフト）およびデッキカード選択（ポイズンマインド）の共通システム。

### 実装ファイル一覧

| ファイル | 役割 |
|---------|------|
| `scripts/spells/card_selection_handler.gd` | **UI制御・状態管理（新規）** |
| `scripts/spells/spell_draw.gd` | データ処理（破壊、奪取、デッキ操作） |
| `scripts/ui_components/hand_display.gd` | 手札表示制御 |
| `scripts/ui_components/card_selection_ui.gd` | カード選択UI |
| `scripts/game_flow_manager.gd` | `on_card_selected()` でハンドラーに委譲 |

### CardSelectionHandler クラス

**状態**:
```gdscript
enum State {
	INACTIVE,
	SELECTING_ENEMY_CARD,  # 敵手札選択中
	SELECTING_DECK_CARD    # デッキカード選択中
}
```

**主要メソッド**:
| メソッド | 説明 |
|---------|------|
| `start_enemy_card_selection(target_id, filter_mode, callback, is_steal)` | 敵手札選択開始 |
| `on_enemy_card_selected(card_index)` | 敵手札からカード選択時 |
| `start_deck_card_selection(target_id, look_count, callback)` | デッキカード選択開始 |
| `on_deck_card_selected(card_index)` | デッキカード選択時 |

### filter_mode 定義

| filter_mode | 説明 | 対象スペル |
|-------------|------|-----------|
| `destroy_item_spell` | アイテム/スペルのみ | シャッター |
| `destroy_any` | 全カード | スクイーズ、デッキ選択 |
| `destroy_spell` | スペルのみ | セフト |

### SpellDraw 追加メソッド

```gdscript
# 手札操作
func destroy_card_at_index(player_id, card_index) -> Dictionary
func steal_card_at_index(from_id, to_id, card_index) -> Dictionary
func has_cards_matching_filter(player_id, filter_mode) -> bool

# デッキ操作
func get_top_cards_from_deck(player_id, count) -> Array
func destroy_deck_card_at_index(player_id, card_index) -> Dictionary
```

### 対応スペル一覧

| ID | 名前 | 効果 | effect_type |
|----|------|------|-------------|
| 2034 | シャッター | 敵手札のアイテム/スペル選択破壊 | `destroy_selected_card` |
| 2038 | スクイーズ | 敵手札選択破壊 + G150付与 | `destroy_selected_card` |
| 2046 | セフト | 敵手札のスペル奪取 | `steal_selected_card` |
| 2093 | ポイズンマインド | デッキ上6枚から選択破壊 + 1ドロー | `destroy_from_deck_selection` |

### 処理フロー（敵手札選択）

```
1. スペル使用 → 2. プレイヤー選択 → 3. CardSelectionHandler.start_enemy_card_selection()
   ↓
4. 敵手札表示 → 5. filter_mode設定 → 6. カード選択待ち
   ↓
7. on_enemy_card_selected() → 8. 破壊/奪取実行 → 9. 完了シグナル発火
```

### 処理フロー（デッキカード選択）

```
1. スペル使用 → 2. プレイヤー選択 → 3. CardSelectionHandler.start_deck_card_selection()
   ↓
4. デッキ上部カード取得・表示 → 5. カード選択待ち
   ↓
6. on_deck_card_selected() → 7. デッキから破壊 → 8. 追加効果（ドロー等） → 9. 完了シグナル発火
```

### 密命カード・エラーケース

- 敵手札の密命カードは**裏向き表示**（選択可能だが内容不明）
- 条件に合うカードがない場合、メッセージ表示後に処理続行（魔力消費済み）

### JSON定義（実際の実装）

**シャッター（ID: 2034）**:
```json
{
  "id": 2034,
  "name": "シャッター",
  "effect_parsed": {
	"target_type": "player",
	"target_filter": "enemy",
	"effects": [
	  {
		"effect_type": "destroy_selected_card",
		"filter_mode": "destroy_item_spell"
	  }
	]
  }
}
```

**スクイーズ（ID: 2038）**:
```json
{
  "id": 2038,
  "name": "スクイーズ",
  "effect_parsed": {
	"target_type": "player",
	"target_filter": "any",
	"effects": [
	  {
		"effect_type": "destroy_selected_card",
		"filter_mode": "destroy_any",
		"magic_bonus": 150
	  }
	]
  }
}
```

**セフト（ID: 2046）**:
```json
{
  "id": 2046,
  "name": "セフト",
  "effect_parsed": {
	"target_type": "player",
	"target_filter": "enemy",
	"effects": [
	  {
		"effect_type": "steal_selected_card",
		"filter_mode": "destroy_spell"
	  }
	]
  }
}
```

**ポイズンマインド（ID: 2093）**:
```json
{
  "id": 2093,
  "name": "ポイズンマインド",
  "effect_parsed": {
	"target_type": "player",
	"target_filter": "enemy",
	"effects": [
	  {
		"effect_type": "destroy_from_deck_selection",
		"look_count": 6,
		"draw_after": 1
	  }
	]
  }
}
```

---

## JSON定義例

### ホープ（ID: 2095）- 基本ドロー

```json
{
  "id": 2095,
  "name": "ホープ",
  "type": "spell",
  "cost": 20,
  "rarity": "N",
  "effect_parsed": {
	"target_type": "self",
	"effects": [
	  {
		"effect_type": "draw_cards",
		"count": 2
	  }
	]
  }
}
```

### ギフト（ID: 2020）- 順位連動

```json
{
  "id": 2020,
  "name": "ギフト",
  "type": "spell",
  "cost": 30,
  "rarity": "N",
  "effect_parsed": {
	"target_type": "self",
	"effects": [
	  {
		"effect_type": "draw_by_rank"
	  },
	  {
		"effect_type": "gain_magic_by_rank",
		"multiplier": 50
	  }
	]
  }
}
```

### フィロソフィー（ID: 2077）- 条件分岐

```json
{
  "id": 2077,
  "name": "フィロソフィー",
  "type": "spell",
  "cost": 30,
  "rarity": "R",
  "effect_parsed": {
	"target_type": "self",
	"effects": [
	  {
		"effect_type": "draw_conditional",
		"condition": {
		  "condition_type": "has_synthesis"
		},
		"success_count": 3,
		"fail_count": 2
	  }
	]
  }
}
```

### シャッター（ID: 2034）- 手札破壊（選択式）

```json
{
  "id": 2034,
  "name": "シャッター",
  "type": "spell",
  "cost": 50,
  "rarity": "R",
  "effect_parsed": {
	"target_type": "player",
	"target_filter": "enemy",
	"effects": [
	  {
		"effect_type": "destroy_hand_card",
		"card_types": ["item", "spell"],
		"selection_mode": "player_select",
		"count": 1
	  }
	]
  }
}
```

### レイオブパージ（ID: 2128）- 呪いカード全破壊

```json
{
  "id": 2128,
  "name": "レイオブパージ",
  "type": "spell",
  "spell_type": "カード破壊",
  "cost": {"mp": 80},
  "rarity": "R",
  "effect_parsed": {
	"target_type": "all_players",
	"effects": [
	  {
		"effect_type": "destroy_curse_cards"
	  }
	]
  }
}
```

### レイオブロウ（ID: 2129）- 高コストカード全破壊

```json
{
  "id": 2129,
  "name": "レイオブロウ",
  "type": "spell",
  "spell_type": "カード破壊",
  "cost": {"mp": 80},
  "rarity": "R",
  "effect_parsed": {
	"target_type": "all_players",
	"effects": [
	  {
		"effect_type": "destroy_expensive_cards",
		"cost_threshold": 100
	  }
	]
  }
}
```

### エロージョン（ID: 2017）- 重複カード破壊

```json
{
  "id": 2017,
  "name": "エロージョン",
  "type": "spell",
  "spell_type": "カード破壊",
  "cost": {"mp": 60},
  "rarity": "R",
  "effect_parsed": {
	"target_type": "player",
	"target_filter": "any",
	"effects": [
	  {
		"effect_type": "destroy_duplicate_cards"
	  }
	]
  }
}
```

### スクイーズ（ID: 2038）- 手札破壊+魔力付与

```json
{
  "id": 2038,
  "name": "スクイーズ",
  "type": "spell",
  "spell_type": "手札操作",
  "cost": {"mp": 50},
  "rarity": "R",
  "effect_parsed": {
	"target_type": "player",
	"target_filter": "any",
	"effects": [
	  {
		"effect_type": "destroy_hand_card",
		"selection_mode": "caster_select",
		"count": 1
	  },
	  {
		"effect_type": "gain_magic_to_target",
		"amount": 150
	  }
	]
  }
}
```

**注意**: スクイーズは使用者が対象の手札を選んで破壊するため、カード選択UIが必要。

### リンカネーション（ID: 2127）- 手札入れ替え

```json
{
  "id": 2127,
  "name": "リンカネーション",
  "type": "spell",
  "cost": 20,
  "rarity": "N",
  "effect_parsed": {
	"target_type": "self",
	"effects": [
	  {
		"effect_type": "discard_and_draw",
		"bonus": 1
	  }
	]
  }
}
```

### アセンブルカード（ID: 2004）- 密命

```json
{
  "id": 2004,
  "name": "アセンブルカード",
  "type": "spell",
  "cost": 0,
  "rarity": "R",
  "is_secret": true,
  "effect_parsed": {
	"target_type": "self",
	"mission": {
	  "condition_type": "has_all_elements",
	  "elements": ["fire", "water", "earth", "wind"],
	  "success_effects": [
		{
		  "effect_type": "gain_magic",
		  "amount": 500
		}
	  ],
	  "fail_effects": [
		{
		  "effect_type": "draw_cards",
		  "count": 2
		}
	  ]
	}
  }
}
```

---

## 技術的な注意事項

### 1. UI必要なスペル

以下のスペルはプレイヤーによるカード選択UIが必要:
- フォーサイト（デッキ上部からの選択）
- プロフェシー（タイプ選択）
- シャッター（敵手札からの選択）
- ポイズンマインド（敵デッキからの選択）
- セフト（敵手札からの選択）

**実装方針**: `TargetSelectionHelper`を拡張するか、専用のカード選択UIを作成

### 2. 敵手札の参照

敵手札を参照するスペル（シャッター、セフト等）では:
- 密命カードは内容を見せない（真っ黒表示）
- 選択可能なカードのみハイライト

### 3. 合成カード判定

フィロソフィーで使用する合成判定:
```gdscript
func has_synthesis_card(player_id: int) -> bool:
	var hand = card_system.get_hand_for_player(player_id)
	for card in hand:
		if card.get("synthesis", null) != null:
			return true
	return false
```

### 4. 手札クリーチャー属性判定

アセンブルカードで使用する属性判定（手札のクリーチャーカードの属性）:
```gdscript
func has_all_elements_in_hand(player_id: int) -> bool:
	var hand = card_system.get_hand_for_player(player_id)
	var found_elements = {}
	for card in hand:
		if card.get("type") == "creature":
			var element = card.get("element", "")
			if element in ["fire", "water", "earth", "wind"]:
				found_elements[element] = true
	return found_elements.size() >= 4
```

### 5. 呪いカード判定

レイオブパージで使用する呪いカード判定。`spell_type` フィールドで判定。

**呪いカードの定義**:
以下の `spell_type` を持つスペルカードが呪いカード:
- `複数特殊能力付与`（例: ディラニー）
- `世界呪い`（例: ウェイストワールド）
- `単体特殊能力付与`（例: バイタリティ、グリード）

```gdscript
const CURSE_SPELL_TYPES = [
	"複数特殊能力付与",
	"世界呪い",
	"単体特殊能力付与"
]

func is_curse_card(card: Dictionary) -> bool:
	if card.get("type") != "spell":
		return false
	return card.get("spell_type", "") in CURSE_SPELL_TYPES
```

---

## CardSystemとの連携

SpellDrawは**CardSystemのラッパー**。内部で以下を使用：
- `draw_card_for_player()`: 1枚ドロー
- `draw_cards_for_player()`: 複数枚ドロー
- `get_hand_for_player()`: 手札取得
- `get_hand_size_for_player()`: 手札枚数取得
- `discard_card()`: カード破棄
- `player_decks[]`: デッキ直接アクセス（検索用）

### 戻り値

- 1枚 → `Dictionary`（CardSystemと統一）
- 複数枚 → `Array`（CardSystemと統一）

---

## 関連ドキュメント

- [スペルシステム設計](../spells_design.md) - 全体設計
- [領地変更効果](./領地変更.md) - SpellLandシステム
- [魔力増減効果](./魔力増減.md) - SpellMagicシステム

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025/11/03 | 1.0 | 初版作成（基本メソッドのみ） |
| 2025/11/26 | 2.0 | 全15スペルの実装計画追加、メソッド設計、JSON定義例追加 |
| 2025/11/26 | 2.1 | 実装対象整理: ブリード(2112)削除、合成(2077)保留、順位システム追加 |
| 2025/11/26 | 2.2 | 実装完了: ホープ(2095)、ギフト(2020)、リンカネーション(2127)、アセンブルカード(2004) |
| 2025/11/27 | 3.0 | 手札破壊系追加: 呪いカード判定（spell_type方式）、Phase4-5実装計画、JSON定義例追加 |
| 2025/11/27 | 3.1 | Phase4実装完了: レイオブパージ、レイオブロウ、エロージョン。スクイーズをPhase5に移動（UI必要） |
| 2025/11/27 | 3.2 | Phase5詳細仕様追加: 敵手札選択破壊システム設計（HandDisplay流用、filter_mode追加、処理フロー定義） |
| 2025/11/27 | 3.3 | Phase5実装: シャッター（2034）、スクイーズ（2038）実装完了。敵手札選択システム、filter_mode追加 |

---

**最終更新**: 2025年11月27日（v3.3）
