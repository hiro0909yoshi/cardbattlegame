# 手札操作スペル効果

**バージョン**: 4.1  
**最終更新**: 2025年12月2日

---

## 概要

カードドロー、手札破壊、手札奪取などの手札操作を担当するモジュール。

**実装ファイル**:
| ファイル | 役割 |
|---------|------|
| `scripts/spells/spell_draw.gd` | ディスパッチャー（エフェクト振り分け） |
| `scripts/spells/spell_draw/basic_draw_handler.gd` | 基本ドロー処理 |
| `scripts/spells/spell_draw/destroy_handler.gd` | カード破壊処理 |
| `scripts/spells/spell_draw/steal_handler.gd` | カード奪取・交換処理 |
| `scripts/spells/spell_draw/deck_handler.gd` | デッキ操作処理 |
| `scripts/spells/spell_draw/condition_handler.gd` | 条件チェック・変換処理 |
| `scripts/spells/card_selection_handler.gd` | UI制御（敵手札選択、デッキカード選択） |
| `scripts/ui_components/spell_and_mystic_ui.gd` | タイプ選択UI（プロフェシー用） |

---

## アーキテクチャ

```
SpellDraw (ディスパッチャー)
├── BasicDrawHandler    (draw, draw_by_type, add_specific_card等)
├── DestroyHandler      (destroy_curse_cards, destroy_selected_card等)
├── StealHandler        (steal_selected_card, swap_creature等)
├── DeckHandler         (reset_deck, draw_from_deck_selection等)
└── ConditionHandler    (check_hand_elements, transform_to_card等)
```

**設計方針**:
- 各ハンドラーは`can_handle(effect_type)`で処理可能か判定
- ディスパッチャーは適切なハンドラーに処理を委譲
- 後方互換性のため、既存の公開APIはディスパッチャーが維持

---

## 実装完了スペル一覧（16個）

### ドロー系（6個）

| ID | 名前 | effect_type | 概要 |
|----|------|-------------|------|
| 2095 | ホープ | `draw_cards` | 2枚ドロー |
| 2020 | ギフト | `draw_by_rank` | 順位枚ドロー + 順位×50EP |
| 2127 | リンカネーション | `discard_and_draw_plus` | 手札全捨て+枚数+1ドロー |
| 2004 | アセンブルカード | `check_hand_elements` | 密命：4属性あれば500EP、なければ2ドロー |
| 2078 | フォーサイト | `draw_from_deck_selection` | デッキ上6枚から1枚選択ドロー |
| 2090 | プロフェシー | `draw_by_type` | タイプ選択→そのタイプを1枚ドロー |

### 破壊系（6個）

| ID | 名前 | effect_type | 概要 |
|----|------|-------------|------|
| 2128 | レイオブパージ | `destroy_curse_cards` | 全手札の呪いカード破壊 |
| 2129 | レイオブロウ | `destroy_expensive_cards` | 全手札の100EP以上破壊 |
| 2017 | エロージョン | `destroy_duplicate_cards` | 対象の重複カード全破壊 |
| 2034 | シャッター | `destroy_selected_card` | 敵手札のアイテム/スペル選択破壊 |
| 2038 | スクイーズ | `destroy_selected_card` | 敵手札選択破壊 + 対象に150EP |
| 2093 | ポイズンマインド | `destroy_from_deck_selection` | 敵デッキ上6枚から選択破壊 + 1ドロー |

### 奪取系（2個）

| ID | 名前 | effect_type | 概要 |
|----|------|-------------|------|
| 2046 | セフト | `steal_selected_card` | 敵手札のスペル1枚奪取 |
| 2042 | スニークハンド | `steal_item_conditional` | 密命：アイテム2枚以上持つ敵から1枚奪取 |

### 変換・初期化系（2個）

| ID | 名前 | effect_type | 概要 |
|----|------|-------------|------|
| 2113 | メタモルフォシス | `transform_to_card` | 敵手札+デッキの選択カード同名を全てホーリーワード6に変換 |
| 2122 | リバイバル | `reset_deck` | 対象ブックを元の構成で初期化 |

---

## SpellDraw 主要メソッド

### ディスパッチャー（spell_draw.gd）

```gdscript
# メインエントリポイント
func apply_effect(effect: Dictionary, player_id: int, context: Dictionary = {}) -> Dictionary
```

### BasicDrawHandler

```gdscript
# 1枚ドロー（ターン開始用）
func draw_one(player_id: int) -> Dictionary

# 固定枚数ドロー
func draw_cards(player_id: int, count: int) -> Array

# 指定枚数まで補充
func draw_until(player_id: int, target_hand_size: int) -> Array

# タイプ指定ドロー（プロフェシー用）
func draw_card_by_type(player_id: int, card_type: String) -> Dictionary

# 手札全捨て+元枚数ドロー（リンカネーション用）
func discard_and_draw_plus(player_id: int) -> Array

# 特定カード生成（ハイプクイーン用）
func add_specific_card_to_hand(player_id: int, card_id: int) -> Dictionary
```

### DestroyHandler

```gdscript
# 全プレイヤーの呪いカード破壊
func destroy_curse_cards() -> Dictionary

# 全プレイヤーの高コストカード破壊
func destroy_expensive_cards(cost_threshold: int) -> Dictionary

# 重複カード破壊
func destroy_duplicate_cards(target_player_id: int) -> Dictionary

# 指定インデックスのカード破壊
func destroy_card_at_index(target_player_id: int, card_index: int) -> Dictionary

# デッキ上部のカード破壊
func destroy_deck_card_at_index(player_id: int, card_index: int) -> Dictionary
```

### StealHandler

```gdscript
# カード奪取
func steal_card_at_index(from_id: int, to_id: int, card_index: int) -> Dictionary

# アイテム枚数カウント
func count_items_in_hand(player_id: int) -> int

# フィルター条件に合うカードがあるか
func has_cards_matching_filter(player_id: int, filter_mode: String) -> bool
```

### DeckHandler

```gdscript
# デッキ上部取得（UI表示用）
func get_top_cards_from_deck(player_id: int, count: int) -> Array

# デッキから選択ドロー（フォーサイト用）
func draw_from_deck_at_index(player_id: int, card_index: int) -> Dictionary

# デッキを元の構成で再構築（リバイバル用）
func reset_deck_to_original(target_player_id: int) -> Dictionary
```

### ConditionHandler

```gdscript
# 手札のクリーチャー属性を取得
func get_hand_creature_elements(player_id: int) -> Array

# 手札に指定属性が全てあるか
func has_all_elements(player_id: int, required_elements: Array) -> bool

# 同名カードを全て変換（メタモルフォシス用）
func transform_cards_to_specific(target_player_id: int, selected_card_name: String, selected_card_id: int, transform_to_id: int) -> Dictionary

# アイテムまたはスペルがあるか
func has_item_or_spell_in_hand(player_id: int) -> bool
```

---

## CardSelectionHandler 使い方

### 敵手札選択（シャッター、セフト等）

```gdscript
# 開始
card_selection_handler.start_enemy_card_selection(
	target_player_id,  # 対象プレイヤーID
	filter_mode,       # "destroy_item_spell", "destroy_any", "destroy_spell", "item"
	callback,          # 選択完了時のコールバック
	is_steal           # true=奪取、false=破壊
)

# 選択時（game_flow_manager.on_card_selected()から自動呼び出し）
card_selection_handler.on_enemy_card_selected(card_index)
```

### デッキカード選択（ポイズンマインド、フォーサイト）

```gdscript
# 破壊モード
card_selection_handler.start_deck_card_selection(target_id, look_count, callback)

# ドローモード（フォーサイト用）
card_selection_handler.start_deck_draw_selection(player_id, look_count, callback)
```

### カード変換選択（メタモルフォシス）

```gdscript
# 敵手札からアイテム/スペルを選択し、同名カードを全て変換
card_selection_handler.start_transform_card_selection(target_id, "item_or_spell", transform_to_id)
```

### filter_mode 一覧

| filter_mode | 対象 | 使用スペル |
|-------------|------|-----------|
| `destroy_item_spell` | アイテム/スペル | シャッター |
| `destroy_any` | 全カード | スクイーズ |
| `destroy_spell` | スペルのみ | セフト |
| `item` | アイテムのみ | スニークハンド |
| `item_or_spell` | アイテム/スペル | メタモルフォシス |

---

## インフォパネル連携

スペル使用後のカード選択時に、選択したカードの詳細をインフォパネルで表示する。

### 実装ファイル

| ファイル | 役割 |
|---------|------|
| `scripts/card.gd` | ワンクリック判定（`_is_handler_card_selection_active()`） |
| `scripts/ui_manager.gd` | カード選択ハンドラー経由のルーティング |
| `scripts/spells/card_selection_handler.gd` | インフォパネル表示・確認処理 |
| `scripts/ui_components/spell_info_panel_ui.gd` | スペル情報パネル |
| `scripts/ui_components/item_info_panel_ui.gd` | アイテム情報パネル |
| `scripts/ui_components/creature_info_panel_ui.gd` | クリーチャー情報パネル |

### フロー

1. カードをクリック → `card.gd`が`_is_handler_card_selection_active()`でハンドラー選択中か判定
2. ハンドラー選択中なら`ui_manager._on_card_button_pressed()`が`game_flow_manager.on_card_selected()`経由で処理
3. `card_selection_handler`の`on_enemy_card_selected()`等が呼ばれる
4. `_request_card_confirmation()`でインフォパネル表示
5. 確認ボタン → アクション実行、キャンセル → 選択画面に戻る（戻るボタン再登録）

### 対象フィルター

`card.gd`の`_is_handler_card_selection_active()`は以下のフィルターを検出：
- `destroy_*`（destroy_item_spell, destroy_any, destroy_spell）
- `item_or_spell`

### 注意点

- 異なるカードを選択した場合、既存パネルを閉じてから新しいパネルを表示
- キャンセル時は戻るボタンを再登録して選択画面に戻れるようにする
- パネル内のカード表示は`remove_child()`で即座に削除（`queue_free()`だけでは遅延あり）

---

## タイプ選択UI（プロフェシー用）

`SpellAndMysticUI.show_type_selection()` を使用。

```gdscript
# SpellPhaseHandler._execute_draw_by_type()
spell_and_mystic_ui.show_type_selection()  # クリーチャー/アイテム/スペル
var selected_type = await spell_and_mystic_ui.type_selected
spell_draw.draw_card_by_type(player_id, selected_type)
```

---

## JSON定義パターン

### 基本ドロー（ホープ）
```json
"effect_parsed": {
  "target_type": "self",
  "effects": [{ "effect_type": "draw_cards", "count": 2 }]
}
```

### 敵手札選択破壊（シャッター）
```json
"effect_parsed": {
  "target_type": "player",
  "target_filter": "enemy",
  "effects": [{
	"effect_type": "destroy_selected_card",
	"filter_mode": "destroy_item_spell"
  }]
}
```

### 条件付き奪取（スニークハンド）
```json
"effect_parsed": {
  "target_type": "player",
  "target_filter": "enemy",
  "effects": [{
	"effect_type": "steal_item_conditional",
	"required_item_count": 2,
	"filter_mode": "item"
  }]
}
```

### デッキ選択ドロー（フォーサイト）
```json
"effect_parsed": {
  "target_type": "self",
  "effects": [{ "effect_type": "draw_from_deck_selection", "look_count": 6 }]
}
```

### タイプ選択ドロー（プロフェシー）
```json
"effect_parsed": {
  "target_type": "self",
  "effects": [{ "effect_type": "draw_by_type" }]
}
```

### カード変換（メタモルフォシス）
```json
"effect_parsed": {
  "target_type": "player",
  "target_filter": "enemy",
  "effects": [{
	"effect_type": "transform_to_card",
	"filter_mode": "item_or_spell",
	"transform_to_id": 2100
  }]
}
```

### デッキ初期化（リバイバル）
```json
"effect_parsed": {
  "target_type": "player",
  "target_filter": "any",
  "effects": [{ "effect_type": "reset_deck" }]
}
```

---

## 秘術・スキルでの再利用

### SpellDrawメソッドの直接呼び出し

```gdscript
# 秘術からドロー効果を使う例
var spell_draw = game_flow_manager.spell_draw
spell_draw.draw_cards(player_id, 2)
```

### CardSelectionHandlerの利用

```gdscript
# 敵手札選択UIを起動
var handler = spell_phase_handler.card_selection_handler
handler.start_enemy_card_selection(enemy_id, "item", callback, true)
```

### タイプ選択UIの利用

```gdscript
var ui = ui_manager.get_node_or_null("SpellAndMysticUI")
ui.show_type_selection()
var type = await ui.type_selected
```

---

## 関連ドキュメント

- [スペルシステム設計](../spells_design.md)
- [領地変更効果](./領地変更.md)
- [EP増減効果](./EP増減.md)

---

## 変更履歴

| 日付 | Ver | 内容 |
|------|-----|------|
| 2026/01/16 | 5.0 | **リファクタリング** - Strategy分割（5ハンドラー） |
| 2025/12/02 | 4.1 | メタモルフォシス(2113)・リバイバル(2122)追加 |
| 2025/11/27 | 4.0 | **完成版** - 全14スペル実装完了 |

---

## 【作業中】クリーチャー秘術・スキル実装タスク

> ⚠️ このセクションは実装完了後に削除予定

### Phase 1: 秘術持ちクリーチャー（5体）

spell_mystic.jsonにspell_id追加 → クリーチャーのability_parsedから参照

| ID | 名前 | 属性 | 秘術効果 | effect_type | 状態 |
|----|------|------|---------|-------------|------|
| 136 | フェイト | 水 | 40EP・カードを1枚引く | `draw_cards` | ⏳ |
| 405 | アイアンモンガー | 無 | 50EP・アイテムを1枚引く | `draw_by_type` (item) | ⏳ |
| 31 | ハイプクイーン | 火 | 20EP・ハイプワーカーを手札に加える | `add_specific_card` (新規) | ⏳ |
| 310 | クラウドギズモ | 風 | 20EP・対象手札1枚破壊+対象1枚ドロー | `destroy_and_draw` (新規) | ⏳ |
| 346 | レムレース | 風 | 50EP・対象クリーチャー奪取+自分が対象手札へ | `swap_creature` (新規) | ⏳ |

**実装順序**:
1. フェイト、アイアンモンガー（既存effect_type流用）
2. ハイプクイーン（特定カード追加）
3. クラウドギズモ（破壊+ドロー複合）
4. レムレース（交換系・複雑）

### Phase 2: カード獲得スキル（3体）✅ 実装完了

バトル中「生き残り」時にspell_mystic.jsonのスキル効果を発動

| ID | 名前 | 属性 | spell_mystic_id | スキル効果 | 発動条件 | 状態 |
|----|------|------|-----------------|-----------|---------|------|
| 26 | ネビロス | 火 | 9002 | 5枚になるまでドロー | 生き残り | ✅ |
| 129 | テンタクルズ | 水 | 9002 | 5枚になるまでドロー | 生き残り | ✅ |
| 130 | トリトン | 水 | 9003 | 1枚ドロー | 生き残り + 自分アイテム使用 | ✅ |

**発動タイミング**: バトル終了直前（通行料計算前）、攻撃側・防衛側どちらでも発動

**実装ファイル**:
- `data/spell_mystic.json`: 9002, 9003追加
- `data/fire_2.json`: ネビロスに`skill_ids: [9002]`追加
- `data/water_2.json`: テンタクルズ・トリトンに`skill_ids`追加
- `scripts/battle/battle_special_effects.gd`: `check_on_survive_effects()`追加
- `scripts/battle/battle_execution.gd`: バトル終了前に呼び出し追加

### 必要な新規effect_type

| effect_type | 説明 | 使用クリーチャー |
|-------------|------|-----------------|
| `add_specific_card` | 特定カードを手札に追加 | ハイプクイーン |
| `destroy_and_draw` | 対象手札破壊+対象ドロー | クラウドギズモ |
| `swap_creature` | クリーチャー交換 | レムレース |
| `draw_until` | 指定枚数になるまでドロー | ネビロス、テンタクルズ（既存メソッド流用） |
| `draw_cards` | 固定枚数ドロー | トリトン（既存メソッド流用） |
