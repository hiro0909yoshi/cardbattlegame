# 変身効果 設計書

**プロジェクト**: カルドセプト風カードバトルゲーム  
**バージョン**: 1.0  
**作成日**: 2025年10月24日  
**ステータス**: 設計中

---

## 📋 目次

1. [概要](#概要)
2. [変身の種類とパターン](#変身の種類とパターン)
3. [初期実装対象](#初期実装対象)
4. [データ構造設計](#データ構造設計)
5. [実装フロー](#実装フロー)
6. [今後の実装予定](#今後の実装予定)

---

## 概要

### 目的
クリーチャーを別のクリーチャーに変身させる効果を実装する。変身はクリーチャースキル、アイテム、スペルの全てで使用される。

### 基本仕様
- **変身の本質**: クリーチャーデータそのものを別のクリーチャーに置き換える
- **効果のリセット**: permanent_effects、temporary_effectsは変身時にクリア
- **位置の維持**: 変身前と同じタイルに配置
- **所有者の維持**: 変身しても所有者は変わらない

---

## 変身の種類とパターン

### 1. ランダム変身
**例**: ハルゲンダース（ID: 432）

```json
{
  "ability": "変身",
  "ability_detail": "変身[ランダム]"
}
```

**仕様**:
- 全クリーチャーからランダムに1体選択
- 召喚直後に自動発動
- プレイヤーの選択不要

---

### 2. 特定クリーチャーへの変身
**例**: シルフ（ID: 319）→ガルーダ

```json
{
  "ability": "無効化・秘術",
  "ability_detail": "無効化[MHP40以上]；秘術[G60・ガルーダに変身]"
}
```

**仕様**:
- 指定されたクリーチャーに変身
- 秘術（魔力コスト必要）で発動
- プレイヤーが任意のタイミングで使用

---

### 3. 対象を強制変身
**例**: コカトリス（ID: 215）→敵をストーンウォールに

```json
{
  "ability": "強制変化",
  "ability_detail": "強制変化[ストーンウォール]"
}
```

**仕様**:
- 召喚時に発動
- 戦闘相手を指定クリーチャーに変身させる
- 戦闘前に効果発動（相手の能力を無効化）

---

### 4. 同じクリーチャーへの変身（コピー）
**例**: シェイプシフター（ID: 417）

```json
{
  "ability": "秘術",
  "ability_detail": "秘術[G70・対象と同じクリーチャーに変身]"
}
```

**仕様**:
- 対象を選択
- 対象と同じクリーチャーに変身
- HP/APも同じ状態で変身

---

### 5. 条件付き変身
**例**: ジャッカロープ（ID: 217）→スペル破壊時にグレートタスカーに

```json
{
  "ability": "援護・変身",
  "ability_detail": "援護[火地]；スペル破壊時、グレートタスカーに変身"
}
```

**仕様**:
- 特定条件（スペル破壊）を満たすと発動
- 自動的に変身
- 変身後は元に戻らない

---

### 6. グループから選択変身
**例**: ドラゴンオーブ（ID: 1041・アイテム）

```json
{
  "effect": "変身[いずれかのドラゴン]"
}
```

**仕様**:
- 指定グループ（ドラゴン系）から選択
- プレイヤーが選択
- アイテム使用時に発動

---

### 7. 合成変身
**例**: バイロクルス（ID: 33）

```json
{
  "ability": "合成・無効化",
  "ability_detail": "合成[タスペル・ヘルバイロンに変身]；無効化[巻物]"
}
```

**仕様**:
- 特定クリーチャー（タスペル）を生贄に召喚
- 召喚時にヘルバイロンに変身
- 生贄の条件を満たす必要がある

---

## 初期実装対象

### Phase 1: 基本実装（2体）

| ID | 名前 | パターン | 実装理由 |
|---|---|---|---|
| **432** | ハルゲンダース | ランダム変身 | 最もシンプル、基本メカニズムの確立 |
| **215** | コカトリス | 強制変化 | 対象指定型変身の基本 |

**実装内容**:
1. 変身メカニズムの基本実装
2. クリーチャーデータの置き換え処理
3. 召喚時の自動発動処理

---

## データ構造設計

### ability_parsedの構造

```gdscript
{
  "keywords": ["変身"],
  "effects": [
    {
      "effect_type": "transform",
      "trigger": "on_summon",           # 発動タイミング
      "target": "self",                  # 対象（self/opponent/select）
      "transform_type": "random",        # 変身タイプ
      "creature_id": null,               # 特定IDへの変身時
      "creature_group": null,            # グループ選択時
      "conditions": []                   # 発動条件
    }
  ]
}
```

### 変身タイプ（transform_type）

| タイプ | 説明 | 例 |
|---|---|---|
| `random` | 全クリーチャーからランダム | ハルゲンダース |
| `specific` | 特定IDに変身 | シルフ→ガルーダ |
| `forced` | 対象を強制変身 | コカトリス |
| `copy` | 対象と同じに変身 | シェイプシフター |
| `group` | グループから選択 | ドラゴンオーブ |
| `synthesis` | 合成条件付き | バイロクルス |

### 発動タイミング（trigger）

| タイミング | 説明 |
|---|---|
| `on_summon` | 召喚時即座に発動 |
| `on_spell_destroyed` | スペル破壊時 |
| `on_skill_use` | 秘術使用時（魔力消費） |
| `before_battle` | 戦闘前 |

---

## 実装フロー

### 1. 召喚時の自動変身（ハルゲンダース）

```
1. クリーチャーを召喚
   ↓
2. ability_parsedをチェック
   ↓
3. effect_type == "transform" && trigger == "on_summon"
   ↓
4. 変身処理を実行
   ├─ transform_type == "random"
   ├─ 全クリーチャーリストを取得
   ├─ ランダムに1体選択
   └─ クリーチャーデータを置き換え
   ↓
5. 変身完了
```

### 2. 強制変身（コカトリス）

```
1. コカトリスを召喚
   ↓
2. 戦闘相手を確認
   ↓
3. ability_parsedをチェック
   ↓
4. effect_type == "transform" && target == "opponent"
   ↓
5. 戦闘前に相手を変身
   ├─ transform_type == "forced"
   ├─ creature_id を取得（ストーンウォールのID）
   └─ 相手のクリーチャーデータを置き換え
   ↓
6. 変身後、戦闘開始
```

### 3. クリーチャーデータの置き換え処理

```gdscript
func transform_creature(tile: Tile, new_creature_id: int) -> void:
	# 新しいクリーチャーデータを取得
	var new_creature_data = CardDatabase.get_creature(new_creature_id)
	
	# 重要: IDとオーナーを保持
	var owner_id = tile.creature_data["owner_id"]
	
	# クリーチャーデータを完全置き換え
	tile.creature_data = new_creature_data.duplicate(true)
	tile.creature_data["owner_id"] = owner_id
	
	# 効果をリセット
	tile.creature_data["permanent_effects"] = []
	tile.creature_data["temporary_effects"] = []
	
	# UIを更新
	update_creature_visual(tile)
```

---

## 今後の実装予定

### Phase 2: 秘術変身（4体）
- シルフ（ID: 319）→ ガルーダ
- ヒッポカンパス（ID: 135）→ ケルピー
- ミストウィング（ID: 142）→ アクアホーン
- アクアホーン（ID: 104）→ ミストウィング

**追加実装**:
- 秘術システムとの連携
- 魔力消費処理
- プレイヤーによる任意発動

### Phase 3: 条件付き変身（3体）
- ジャッカロープ（ID: 217）→ スペル破壊時
- ブランチアーミー（ID: 236）→ 秘術
- その他条件付き変身

### Phase 4: 高度な変身（5体）
- シェイプシフター（ID: 417）→ コピー変身
- イド（ID: 112）→ 合成変身
- バイロクルス（ID: 33）→ 合成変身
- スカラベンドラ（ID: 320）→ 合成変身
- その他

### Phase 5: アイテム・スペル変身
- ドラゴンオーブ（ID: 1041）
- ツインスパイク（ID: 1036）
- ネクロプラズマ（ID: 1047）
- 今後追加されるスペル

---

## 検討事項

### 未決定事項

1. **変身時のアイテム処理**
   - 装備アイテムをどうするか
   - 保持 or ドロップ or 破壊
   - → 次回チャットで決定

2. **変身時のマーク処理**
   - 土地に付与されたマーク（◯など）の扱い
   - 保持 or 削除
   - → 次回チャットで決定

3. **変身の取り消し**
   - 変身を元に戻す手段の有無
   - スペル等での実装可否
   - → 将来的に検討

4. **変身時のアニメーション**
   - UI/UX設計
   - → 実装時に決定

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025/10/24 | 1.0 | 初版作成 - 変身効果の基本設計 |

---

**最終更新**: 2025年10月24日（v1.0）
