# 制限解除

**バージョン**: 1.0  
**最終更新**: 2025年1月15日

---

## 概要

プレイヤーの「召喚条件」や「アイテム使用制限」を解除する呪いシステム。

| 呪い名 | curse_type | 効果 | 対象 |
|-------|-----------|------|------|
| 制限解除 | `restriction_release` | アイテム制限と配置制限を無視 | プレイヤー |

### 関連スペル

| ID | 名前 | 効果 | 期間 |
|----|------|------|------|
| 2125 | リリース | 使用者に呪い「制限解除」 | 4R |
| 2081 | ブライトワールド | 世界呪い「召喚条件解除」（全員） | 6R |

※ブライトワールドは世界呪いのため `spell_world_curse.gd` で実装済み

---

## アーキテクチャ

```
SpellRestriction（静的クラス）
├── 判定: has_restriction_release(player)
├── 判定: is_item_restriction_released(player)
└── 判定: is_summon_condition_released(player)

SpellEffectExecutor
└── "player_curse" → SpellCurse.curse_player() で呪い付与

各所からの呼び出し
├── TileActionProcessor._is_summon_condition_ignored()
├── CardSelectionUI._check_lands_required()
├── CPUTerritoryAI._is_summon_condition_ignored()
└── ItemPhaseHandler._show_item_selection_ui()
```

---

## SpellRestriction API

`scripts/spells/spell_restriction.gd` - 全メソッドstatic

```gdscript
## 制限解除呪いを持っているかチェック
## @param player: プレイヤーデータ（player_system.players[id]）
## @return bool: 制限解除呪いを持っているか
static func has_restriction_release(player: Dictionary) -> bool

## アイテム制限が解除されているかチェック
## cannot_use（武器/防具/巻物/道具使用不可）を無視できるか
static func is_item_restriction_released(player: Dictionary) -> bool

## 召喚条件が解除されているかチェック
## cost_lands_required（土地条件）、cost_cards_sacrifice（カード犠牲）を無視できるか
static func is_summon_condition_released(player: Dictionary) -> bool
```

---

## 制限解除の対象

### 1. 召喚条件（summon_condition）

| 制限タイプ | 説明 | 例 |
|-----------|------|-----|
| cost_lands_required | 配置に必要な土地条件 | 火×2領地必要 |
| cost_cards_sacrifice | 配置に必要なカード犠牲 | 手札1枚破棄 |
| cannot_summon | 特定属性タイルへの配置制限 | 火属性配置不可 |

### 2. アイテム制限（item_restriction）

| 制限タイプ | 説明 | 例 |
|-----------|------|-----|
| cannot_use | 特定アイテムタイプ使用不可 | 武器使用不可、防具使用不可 |

---

## 処理フロー

### スペル使用時

```
1. リリース使用
   └→ SpellEffectExecutor._execute_single_effect()
       └→ "player_curse" → SpellCurse.curse_player()
           └→ player.curse = {
                curse_type: "restriction_release",
                params: {
                  ignore_item_restriction: true,
                  ignore_summon_condition: true
                },
                duration: 4
              }
```

### 召喚時チェック

```
1. プレイヤーがクリーチャーカードを選択
   └→ CardSelectionUI._check_lands_required()
       └→ SpellRestriction.is_summon_condition_released(player)
           └→ true → 土地条件をスキップ

2. CPU召喚判定
   └→ TileActionProcessor._is_summon_condition_ignored()
       └→ SpellRestriction.is_summon_condition_released(player)
```

### アイテム使用時チェック

```
1. バトル中アイテムフェーズ
   └→ ItemPhaseHandler._show_item_selection_ui()
       └→ SpellRestriction.is_item_restriction_released(player)
           └→ true → cannot_useチェックをスキップ
```

---

## JSON定義

```json
{
  "id": 2125,
  "name": "リリース",
  "rarity": "R",
  "type": "spell",
  "spell_type": "単体特殊能力付与",
  "cost": { "mp": 50 },
  "effect": "使用者に呪い\"制限解除\"(4R間、クリーチャーのアイテム制限と配置制限を無視)",
  "effect_parsed": {
    "target_type": "self",
    "effects": [
      {
        "effect_type": "player_curse",
        "curse_type": "restriction_release",
        "name": "制限解除",
        "description": "アイテム制限と配置制限を無視",
        "ignore_item_restriction": true,
        "ignore_summon_condition": true,
        "duration": 4
      }
    ]
  },
  "cpu_rule": {
    "pattern": "immediate",
    "priority": "medium"
  }
}
```

---

## 実装ファイル一覧

| ファイル | 役割 |
|----------|------|
| `spell_restriction.gd` | 制限解除判定API（静的メソッド） |
| `spell_effect_executor.gd` | player_curse効果でパラメータ保存 |
| `spell_curse.gd` | curse_player()で呪い付与 |
| `tile_action_processor.gd` | 召喚条件判定で呼び出し |
| `card_selection_ui.gd` | 土地条件チェックで呼び出し |
| `cpu_territory_ai.gd` | CPU召喚判定で呼び出し |
| `item_phase_handler.gd` | アイテム制限チェックで呼び出し |

---

## 世界呪いとの違い

| 項目 | リリース (2125) | ブライトワールド (2081) |
|------|----------------|------------------------|
| 呪いタイプ | プレイヤー呪い | 世界呪い |
| 対象 | 使用者のみ | 全プレイヤー |
| 効果範囲 | 召喚条件 + アイテム制限 | 召喚条件のみ |
| 実装 | `spell_restriction.gd` | `spell_world_curse.gd` |

---

## 変更履歴

| 日付 | Ver | 内容 |
|------|-----|------|
| 2025/01/15 | 1.0 | 初版（リリース実装） |
