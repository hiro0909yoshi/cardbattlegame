# 土地操作スペル効果

**バージョン**: 1.3  
**最終更新**: 2025年11月11日

---

## 概要

土地の属性変更、レベル操作、クリーチャー破壊などを担当するスペル効果モジュール。

**実装ファイル**: `scripts/spells/spell_land_new.gd`

**初期化**:
```gdscript
# GameFlowManager.setup_systems()
spell_land = SpellLand.new()
spell_land.setup(board_system, creature_manager, player_system)
```

---

## SpellPhaseHandlerへの統合 ✅

`SpellPhaseHandler`の`_apply_single_effect()`に以下の`effect_type`を追加済み：

| effect_type | 説明 | 対応メソッド |
|-------------|------|--------------|
| `change_element` | 土地属性変更 | `_apply_land_effect_change_element()` |
| `change_element_bidirectional` | 双方向属性変更 | `_apply_land_effect_change_element_bidirectional()` |
| `change_level` | 土地レベル変更 | `_apply_land_effect_change_level()` |
| `abandon_land` | 土地放棄 | `_apply_land_effect_abandon()` |
| `destroy_creature` | クリーチャー破壊 | `_apply_land_effect_destroy_creature()` |
| `mission_level_up_multiple` | 密命：複数レベルアップ | `_apply_mission_level_up_multiple()` |
| `mission_align_mismatched_lands` | 密命：属性不一致土地の整合 | `_apply_mission_align_mismatched_lands()` |

### ターゲット選択システム（ドミニオオーダーと統一）

**選択方式**:
- `TargetSelectionHelper`による統一的な選択システム
- カーソルキー（↑↓）で対象切り替え、Enterで確定
- カメラが自動的に選択中の土地に追従
- 選択マーカー（黄色の光るリング）を表示
- 数字キーで直接選択も可能

**対象タイプ**:
- `"land"`: 全ての所有地（owner_filter: "any"）
- `"own_land"`: 自分の土地のみ（owner_filter: "own"）
- `"enemy_land"`: 敵の土地のみ（owner_filter: "enemy"）

**実装詳細**:
```gdscript
# SpellPhaseHandler内
func _show_target_selection_ui(target_type: String, target_info: Dictionary):
	# 有効な対象を取得
	var targets = _get_valid_targets(target_type, target_info)
	
	# ドミニオオーダーと同じ方式で選択開始
	available_targets = targets
	current_target_index = 0
	current_state = State.SELECTING_TARGET
	
	# TargetSelectionHelperで視覚的に選択
	TargetSelectionHelper.select_target_visually(self, targets[0])
```

**JSON定義例**:
```json
{
  "id": 2001,
  "name": "アースシフト",
  "effect_parsed": {
	"target_type": "own_land",
	"target_info": {"owner_filter": "own"},
	"effects": [
	  {
		"effect_type": "change_element",
		"element": "earth"
	  }
	]
  }
}
```

---

## メソッド一覧

### change_element(tile_index: int, new_element: String) -> bool

土地の属性を変更する。内部的に`BoardSystem3D.change_tile_terrain()`を使用。

**引数**:
- `tile_index`: タイルのインデックス（0-19）
- `new_element`: 新しい属性（"fire", "water", "earth", "wind", "neutral"）
  - ⚠️ 注意: "wind"が正しい属性名（"air"ではない）

**戻り値**:
- 成功した場合`true`

**使用例**:
```gdscript
# アースシフト（ID: 2001）
spell_land.change_element(5, "earth")  # タイル5を地属性に変更
```

**出力**:
```
[土地属性変更] タイル5: fire → earth
```

---

### change_level(tile_index: int, delta: int) -> bool

土地のレベルを増減する。

**引数**:
- `tile_index`: タイルのインデックス
- `delta`: レベル変化量（+1, -1等）

**制約**:
- レベルは1-5の範囲に制限される

**使用例**:
```gdscript
# アステロイド（ID: 2003）- レベルを1下げる
spell_land.change_level(10, -1)

# フラットランド（ID: 2085）- レベルを1上げる
spell_land.change_level(3, 1)
```

**出力**:
```
[土地レベル変更] タイル10: Lv3 → Lv2
[土地レベル変更] タイル3: Lv2 → Lv3
```

---

### set_level(tile_index: int, level: int) -> bool

土地のレベルを固定値に設定する。

**引数**:
- `tile_index`: タイルのインデックス
- `level`: 設定するレベル（1-5）

**使用例**:
```gdscript
# アステロイド合成版 - レベルを1に設定
spell_land.set_level(8, 1)
```

---

### destroy_creature(tile_index: int) -> bool

タイル上のクリーチャーを破壊する。

**処理内容**:
1. `CreatureManager.has_creature()`でクリーチャー存在確認
2. `CreatureManager.set_data(tile_index, {})`でデータ削除
3. `BoardSystem3D.remove_creature()`で3D表示削除
   - 内部で`BaseTile.remove_creature()`を呼び、3Dカード（`creature_card_3d`）を削除

**使用例**:
```gdscript
# クリーチャー破壊スペル
if spell_land.destroy_creature(15):
	print("クリーチャーを破壊しました")
```

**出力**:
```
[クリーチャー破壊] タイル15: ゴブリンを破壊
```

**重要な修正（2025年11月9日）**:
- `BoardSystem3D.remove_creature()`が正しく`BaseTile.remove_creature()`を呼ぶように修正
- これにより3Dカードの表示が正しく削除されるようになった

---

### abandon_land(tile_index: int, return_rate: float = 0.7) -> int

土地を放棄し、価値の一部をEPとして得る。

**引数**:
- `tile_index`: タイルのインデックス
- `return_rate`: 価値の返却率（デフォルト: 0.7 = 70%）

**戻り値**:
- 実際に得られるEP量

**処理内容**:
1. タイルの所有者を取得
2. 土地価値を計算: `level × 100 × return_rate`
3. クリーチャーがいれば破壊
4. 所有権を放棄（owner_id = -1）
5. EPを付与

**計算式**:
```
獲得EP = レベル × 100 × return_rate
```

**使用例**:
```gdscript
# ランドトランス（ID: 2118）- 価値の70%を得る
# メソッド内で自動的にEP付与される
spell_land.abandon_land(5, 0.7)
```

**効果パラメータ（JSON）**:
```json
{
  "effect_type": "abandon_land",
  "return_rate": 0.7
}
```

**出力**:
```
[土地放棄] タイル5: プレイヤー0 Lv3 earth 価値=300
```

---

### change_element_with_condition(tile_index: int, condition: Dictionary, new_element: String) -> bool

条件を満たす場合のみ属性を変更する。

**条件タイプ**:

| キー | 型 | 説明 |
|-----|-----|------|
| `max_level` | int | 最大レベル制限 |
| `required_elements` | Array | 必要な属性リスト |

**使用例**:
```gdscript
# クインテッセンス（ID: 2022）- レベル4以下のみ
var condition = {"max_level": 4}
spell_land.change_element_with_condition(tile_index, condition, "earth")

# ストームシフト（ID: 2040）- 風属性のみ
var condition = {"required_elements": ["air"], "max_level": 3}
spell_land.change_element_with_condition(tile_index, condition, "water")
```

---

### change_element_bidirectional(tile_index: int, element_a: String, element_b: String) -> bool

2つの属性間で相互に変換する（双方向属性変更）。

**引数**:
- `tile_index`: タイルのインデックス
- `element_a`: 変換元/先の属性A
- `element_b`: 変換元/先の属性B

**処理内容**:
- 現在の属性が`element_a`なら`element_b`に変換
- 現在の属性が`element_b`なら`element_a`に変換
- どちらでもない場合は変換しない

**使用例**:
```gdscript
# ストームシフト（ID: 2040）- 水⇔風の相互変換
spell_land.change_element_bidirectional(tile_index, "water", "wind")

# マグマシフト（ID: 2103）- 火⇔地の相互変換
spell_land.change_element_bidirectional(tile_index, "fire", "earth")
```

**出力**:
```
[土地属性変更] タイル5: water → wind
[相互属性変更] タイル10: 現在の属性earthは対象外
```

---

### get_player_dominant_element(player_id: int) -> String

プレイヤーが最も多く所有している属性を取得する。

**使用例**:
```gdscript
# インフルエンス（ID: 2008）
var dominant = spell_land.get_player_dominant_element(tile.tile_owner)
spell_land.change_element(tile_index, dominant)
```

---

### change_level_multiple_with_condition(player_id: int, condition: Dictionary, delta: int) -> int

条件を満たす複数のタイルのレベルを一括変更する。

**条件タイプ**:

| キー | 型 | 説明 |
|-----|-----|------|
| `required_level` | int | 対象レベル |
| `required_elements` | Array | 対象属性リスト |

**戻り値**:
- 変更されたタイル数

**使用例**:
```gdscript
# フラットランド（ID: 2085）- レベル2の土地を全て1上げる
var condition = {"required_level": 2}
var changed_count = spell_land.change_level_multiple_with_condition(
	player_id, condition, 1
)

if changed_count >= 5:
	print("5つ以上の土地をレベルアップ！")
else:
	# 密命失敗、カードを手札に戻す
	pass
```

---

## 対応スペル一覧

### 属性変換スペル（実装済み）

| ID | 名前 | 効果 | 実装メソッド | 実装状況 |
|----|------|------|-------------|---------|
| 2001 | アースシフト | 対象自ドミニオを地に変える | `change_element(tile, "earth")` | ✅ JSON定義済み |
| 2010 | ウォーターシフト | 対象自ドミニオを水に変える | `change_element(tile, "water")` | ✅ 基盤実装済み |
| 2011 | エアーシフト | 対象自ドミニオを風に変える | `change_element(tile, "wind")` | ✅ 基盤実装済み |
| 2074 | ファイアーシフト | 対象自ドミニオを火に変える | `change_element(tile, "fire")` | ✅ 基盤実装済み |
| 2022 | クインテッセンス | レベル4以下の対象ドミニオを無に | `change_element_with_condition()` | ✅ 基盤実装済み |
| 2008 | インフルエンス | 最多属性に変換 | `get_player_dominant_element()` + `change_element()` | ✅ 基盤実装済み |
| 2040 | ストームシフト | レベル3以下の水⇔風相互変換 | `change_element_bidirectional(tile, "water", "wind")` | ✅ 実装完了 |
| 2103 | マグマシフト | レベル3以下の火⇔地相互変換 | `change_element_bidirectional(tile, "fire", "earth")` | ✅ 実装完了 |

**注意**: エアーシフトの内部属性名は`"wind"`（`"air"`ではない）

### レベル操作スペル（実装済み）

| ID | 名前 | 効果 | 実装メソッド | 実装状況 |
|----|------|------|-------------|---------|
| 2003 | アステロイド | 対象ドミニオのレベルを1下げる | `change_level(tile, -1)` | ✅ JSON定義済み |
| 2029 | サドンインパクト | 密命；レベル4ドミニオを1下げる | 条件チェック + `change_level()` | ✅ 基盤実装済み |
| 2030 | サブサイド | 最高レベルドミニオを1下げる | `find_highest_level_land()` + `change_level()` | ✅ 基盤実装済み |
| 2085 | フラットランド | 密命；レベル2ドミニオ×5を1上げる | `change_level_multiple_with_condition()` | ✅ 実装完了・動作確認済み |

### 土地放棄スペル（実装済み）

| ID | 名前 | 効果 | 実装メソッド | 実装状況 |
|----|------|------|-------------|---------|
| 2118 | ランドトランス | 対象自ドミニオを手放し、価値の70%を得る | `abandon_land(tile, 0.7)` | ✅ JSON定義済み |

### 密命スペル（実装済み）

| ID | 名前 | 効果 | 実装メソッド | 実装状況 |
|----|------|------|-------------|---------|
| 2029 | サドンインパクト | 密命；レベル4ドミニオを1下げる | 条件チェック + `change_level()` | ✅ 実装完了 |
| 2085 | フラットランド | 密命；レベル2ドミニオ×5を1上げる | `change_level_multiple_with_condition()` | ✅ 実装完了・動作確認済み |
| 2096 | ホームグラウンド | 密命；属性違いドミニオ×4を合う属性に変化 | `find_mismatched_element_lands()` + `align_lands_to_creature_elements()` | ✅ 実装完了 |

**密命の仕様**:
- **成功条件**: 指定された条件を満たす場合に効果発動
- **失敗時**: `return_spell_to_deck()` でデッキのランダムな位置に復帰[ブック]
- **ホームグラウンドの詳細**:
  - 条件: 属性不一致の土地（クリーチャーの属性と土地の属性が異なる）を4つ以上所有
  - 成功時: そのうち**4つ**の土地をクリーチャーの属性に合わせる
  - 失敗時: スペルカードをデッキに戻す

---

## システム統合

### GameFlowManagerでの初期化 ✅

```gdscript
# game_flow_manager.gd
var spell_land: SpellLand

func _setup_spell_systems(board_system: BoardSystem3D):
	# SpellDraw初期化
	spell_draw = SpellDraw.new()
	spell_draw.setup(card_system, player_system)
	
	# SpellMagic初期化
	spell_magic = SpellMagic.new()
	spell_magic.setup(player_system)
	
	# SpellLand初期化（CreatureManagerも参照）
	spell_land = SpellLand.new()
	var creature_mgr = board_system.get_node_or_null("CreatureManager")
	spell_land.setup(board_system, creature_mgr, player_system)
```

### SpellPhaseHandlerでの統合 ✅

```gdscript
# spell_phase_handler.gd
func _apply_single_effect(effect: Dictionary, target_data: Dictionary):
	var effect_type = effect.get("effect_type", "")
	
	match effect_type:
		"change_element":
			_apply_land_effect_change_element(effect, target_data)
		
		"change_level":
			_apply_land_effect_change_level(effect, target_data)
		
		"abandon_land":
			_apply_land_effect_abandon(effect, target_data)
		
		"destroy_creature":
			_apply_land_effect_destroy_creature(effect, target_data)

# 各効果の実装
func _apply_land_effect_change_element(effect: Dictionary, target_data: Dictionary):
	var tile_index = target_data.get("tile_index", -1)
	var new_element = effect.get("element", "")
	if tile_index >= 0 and not new_element.is_empty():
		game_flow_manager.spell_land.change_element(tile_index, new_element)

func _apply_land_effect_change_level(effect: Dictionary, target_data: Dictionary):
	var tile_index = target_data.get("tile_index", -1)
	var level_change = effect.get("value", 0)
	if tile_index >= 0:
		game_flow_manager.spell_land.change_level(tile_index, level_change)

func _apply_land_effect_abandon(effect: Dictionary, target_data: Dictionary):
	var tile_index = target_data.get("tile_index", -1)
	var return_rate = effect.get("return_rate", 0.7)
	if tile_index >= 0:
		game_flow_manager.spell_land.abandon_land(tile_index, return_rate)

func _apply_land_effect_destroy_creature(_effect: Dictionary, target_data: Dictionary):
	var tile_index = target_data.get("tile_index", -1)
	if tile_index >= 0:
		game_flow_manager.spell_land.destroy_creature(tile_index)
```

---

## 技術的な注意事項

### 1. タイルインデックスの検証

すべてのメソッドで`_validate_tile_index()`により0-19の範囲チェックを実施。

### 2. レベルの範囲制限

レベルは常に1-5の範囲に制限される（`clamp`使用）。

### 3. 属性の検証

`_validate_element()`で有効な属性かチェック。有効な属性は以下の5種類：
- `"fire"` - 火
- `"water"` - 水
- `"earth"` - 地
- `"wind"` - 風（⚠️ "air"ではない）
- `"neutral"` - 無

### 4. ビジュアル更新

- `change_element()`: `BoardSystem3D.change_tile_terrain()`が自動的に更新
- `change_level()`: `TileDataManager.update_all_displays()`を呼び出し
- `set_level()`: `tile.update_visual()`を呼び出し
- `abandon_land()`: `tile.update_visual()`を呼び出し

### 5. ソリッドワールド（世界呪い）対応 ⚠️

**重要**: 土地変性を行う新機能（スペル/スキル/バトルトリガー等）を実装する際は、必ず以下のメソッドを経由すること。

| 操作 | 経由すべきメソッド | ブロック条件 |
|------|-------------------|-------------|
| 土地属性変更 | `SpellLand.change_element()` | ソリッドワールド発動中 |
| 土地レベルダウン | `SpellLand.change_level(delta)` | delta < 0 かつ ソリッドワールド発動中 |
| 土地属性変更（ランドコマンド） | `BoardSystem3D.change_tile_terrain()` | ソリッドワールド発動中 |

**内部チェックメソッド**:
```gdscript
# SpellLand内
func _is_land_change_blocked() -> bool:
	if not game_flow_manager_ref:
		return false
	var game_stats = game_flow_manager_ref.game_stats
	var world_curse = game_stats.get("world_curse", {})
	return world_curse.get("curse_type") == "land_protect"
```

**新規実装時の注意**:
- バトル中のスキルで土地属性を変更する場合 → `SpellLand.change_element()`を使用
- バトル中のスキルで土地レベルを下げる場合 → `SpellLand.change_level()`を使用
- 直接`tile.tile_type`や`tile.level`を変更しないこと（ソリッドワールドがバイパスされる）

**関連ドキュメント**: [世界呪い.md](./世界呪い.md) - ソリッドワールド（ID: 2047）

### 5. 3Dカード削除の実装

`destroy_creature()`の実行フロー：
1. `CreatureManager.set_data(tile_index, {})`でデータ削除
2. `BoardSystem3D.remove_creature(tile_index)`を呼び出し
3. 内部で`BaseTile.remove_creature()`が実行される
4. `creature_card_3d.queue_free()`により3D表示が削除される

**重要**: 2025年11月9日の修正により、`BoardSystem3D.remove_creature()`が正しく`BaseTile.remove_creature()`を呼ぶようになり、3Dカードが正しく削除されるようになった。

### 6. EPの自動付与

`abandon_land()`はメソッド内で自動的に`player_system.add_magic()`を呼び出すため、呼び出し側で追加の処理は不要。

---

## エラーハンドリング

### 無効なタイルインデックス

```gdscript
if not _validate_tile_index(tile_index):
	return false
```

### 無効な属性

```gdscript
if not _validate_element(new_element):
	push_error("SpellLand: 無効な属性 '%s'" % new_element)
	return false
```

### 所有者不一致

```gdscript
if tile.tile_owner != player_id:
	push_error("SpellLand: プレイヤー%dはタイル%dを所有していません" % [player_id, tile_index])
	return 0
```

---

## 検索メソッド（実装済み）

### find_highest_level_land(player_id: int) -> int

プレイヤーが所有する最高レベルの土地を検索。

**戻り値**:
- 最高レベル土地のタイルインデックス
- 土地を所有していない場合は -1

**使用例**:
```gdscript
# サブサイド（ID: 2030）- 最高レベルドミニオのレベルを1下げる
var highest_tile = spell_land.find_highest_level_land(enemy_player_id)
if highest_tile != -1:
	spell_land.change_level(highest_tile, -1)
```

### find_lowest_level_land(player_id: int) -> int

プレイヤーが所有する最低レベルの土地を検索。

**戻り値**:
- 最低レベル土地のタイルインデックス
- 土地を所有していない場合は -1

### find_mismatched_element_lands(player_id: int) -> Array

プレイヤーが所有する土地のうち、クリーチャーの属性と土地の属性が異なる土地を検索（ホームグラウンド用）。

**戻り値**:
- 属性不一致の土地のタイルインデックス配列

**使用例**:
```gdscript
# ホームグラウンド（ID: 2096）- 属性不一致の土地を検索
var mismatched_tiles = spell_land.find_mismatched_element_lands(player_id)
if mismatched_tiles.size() >= 4:
	# 4つだけを変更
	var tiles_to_change = mismatched_tiles.slice(0, 4)
	spell_land.align_lands_to_creature_elements(tiles_to_change)
```

**詳細**:
- 自分が所有する土地で、クリーチャーが配置されている土地のみを対象
- クリーチャーの属性（`element`）と土地の属性（`tile_type`）を比較
- 無属性（`"neutral"`）も含めて不一致と判定

### align_lands_to_creature_elements(tile_indices: Array) -> int

指定された土地の属性を、配置されているクリーチャーの属性に合わせる（複数）。

**引数**:
- `tile_indices`: 変更する土地のタイルインデックス配列

**戻り値**:
- 実際に変更された土地の数

**使用例**:
```gdscript
# ホームグラウンド - 属性不一致の土地をクリーチャーの属性に合わせる
var changed_count = spell_land.align_lands_to_creature_elements(tile_indices)
print("%d個の土地をクリーチャーの属性に合わせました" % changed_count)
```

### return_spell_to_deck(player_id: int, spell_card: Dictionary) -> bool

スペルカードをデッキのランダムな位置に戻す（密命失敗時の復帰[ブック]）。

**引数**:
- `player_id`: プレイヤーID
- `spell_card`: 戻すスペルカードのデータ

**戻り値**:
- 成功した場合`true`

**使用例**:
```gdscript
# 密命失敗時
if game_flow_manager.spell_land.return_spell_to_deck(current_player_id, selected_spell_card):
	mission_failed = true
```

**処理内容**:
1. 手札からカードを削除
2. 捨て札からも削除（既に捨て札に入っている場合）
3. デッキのランダムな位置に挿入（`item_return`スキルと同じ方式）

---

## 今後の拡張予定

### 追加予定メソッド

```gdscript
# 複数タイルの一括属性変更
func change_element_multiple(tile_indices: Array, new_element: String) -> int

# 隣接タイルの属性変更
func change_adjacent_elements(center_tile: int, new_element: String) -> int

---

## デバッグログ

土地操作時には以下のログが出力される:

```
[土地属性変更] タイル5: fire → earth
[土地レベル変更] タイル10: Lv3 → Lv2
[土地レベル設定] タイル8: Lv4 → Lv1
[クリーチャー破壊] タイル15: ゴブリンを破壊
[土地放棄] タイル5: プレイヤー0 Lv3 earth 価値=300
[条件付き属性変更] タイル3: レベル条件不一致（Lv5 > Lv4）
```

---

## 関連ドキュメント

- [スペルシステム設計](../spells_design.md) - 全体設計
- [カードドロー効果](./カードドロー.md) - SpellDrawシステム
- [EP増減効果](./EP増減.md) - SpellMagicシステム

---

**最終更新**: 2025年11月10日（v1.1）

---

## 変更履歴

### v1.3 (2025年11月11日)
- **フラットランド（ID: 2085）動作確認完了**：密命スペル・レベル2の土地を5つ以上持つ場合すべてレベルアップ
- **ホームグラウンド（ID: 2096）実装完了**：密命スペル
  - `find_mismatched_element_lands()` メソッド実装：属性不一致の土地を検索
  - `align_lands_to_creature_elements()` メソッド実装：土地をクリーチャーの属性に合わせる
  - `return_spell_to_deck()` メソッド実装：密命失敗時のデッキ復帰
  - `_apply_mission_align_mismatched_lands()` 実装：SpellPhaseHandler統合
- 密命スペルのセクション追加：サドンインパクト、フラットランド、ホームグラウンド
- CardSystemの `player_decks` への直接アクセスに修正（`get_deck()` メソッドは存在しない）
- 変更数の制限実装：条件数（4つ）だけを変更するよう修正

### v1.2 (2025年11月10日)
- `change_element_bidirectional()`メソッド実装（双方向属性変換）
- ストームシフト（ID: 2040）実装完了：水⇔風の相互変換
- マグマシフト（ID: 2103）実装完了：火⇔地の相互変換
- SpellPhaseHandlerのバグ修正：`tile_info.get("type")`→`tile_info.get("element")`に修正
  - 土地属性のフィルタリングが正しく動作するように修正

### v1.1 (2025年11月10日)
- ターゲット選択システムをドミニオオーダーと統一（TargetSelectionHelper使用）
- `abandon_land()`に`return_rate`引数を追加
- 属性名を"air"から"wind"に修正
- 3Dカード削除の不具合修正を文書化
- 実装状況列を追加して、各スペルの状態を明確化
- 検索メソッド（find_highest_level_land, find_lowest_level_land）を独立セクション化

### v1.0 (2025年11月9日)
- 初版作成
- 基本メソッド10個実装
- GameFlowManager・SpellPhaseHandler統合完了
