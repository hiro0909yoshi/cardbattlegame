# ダメージ操作システム

**ステータス**: ✅ 実装完了  
**最終更新**: 2025年11月27日

---

## 概要

クリーチャーへのダメージ・回復処理を行うスペル・秘術システム。

---

## 実装済み一覧

### スペル（13種）

| ID | 名前 | 効果 |
|----|------|------|
| 2106 | マジックボルト | 対象敵HP-20 |
| 2033 | シャイニングガイザー | 対象敵HP-30 |
| 2041 | ストーンブラスト | 対象敵地/風HP-30 |
| 2088 | ブレイズスプラッシュ | 対象敵火/水HP-30 |
| 2031 | サンダークラップ | 召喚条件あり対象敵HP-30 |
| 2065 | バーニングベイル | 全水/風HP-20 |
| 2086 | フリーズサイクロン | 全火/地HP-20 |
| 2037 | スウォーム | HP減少中全HP-20 |
| 2016 | エレメンタルラス | 属性不一致全HP-20 |
| 2023 | クラスターバースト | 最多属性全HP-20 |
| 2053 | ディザスター | ダウン中MHP50以上全HP-30 |
| 2121 | リストア | ダウン解除＋HP全回復 |
| 2116 | ライフストリーム | 全自クリーチャーHP全回復 |

### 秘術（6種）

| クリーチャー | 効果 | コスト | spell_id |
|-------------|------|--------|----------|
| エルフアーチャー (304) | 対象敵HP-10 | G20 | 9004 |
| ハードロックドラゴン (231) | 対象敵火/風HP-20 | G60 | 9005 |
| ライトニングドラゴン (344) | 対象敵水/地HP-20 | G60 | 9006 |
| アーマードラゴン (404) | 対象敵無HP-30 | G80 | 9007 |
| ニルーバーナ (428) | 呪い付き全HP-20 | G100 | 9008 |
| ヒーラー (233) | 対象自HP30回復 | G10 | 9009 |

---

## 効果タイプ

| effect_type | 説明 |
|-------------|------|
| `damage` | ダメージ（value指定） |
| `heal` | 固定値回復（value指定） |
| `full_heal` | HP全回復 |
| `clear_down` | ダウン解除 |

---

## ターゲット条件（target_info）

| フィールド | 説明 | 使用例 |
|-----------|------|--------|
| `owner_filter` | `"own"`, `"enemy"`, `"any"` | 全スペル |
| `creature_elements` | クリーチャー属性制限 | ストーンブラスト |
| `has_curse` | 呪い付きのみ | ニルーバーナ |
| `has_summon_condition` | 召喚条件ありのみ | サンダークラップ |
| `hp_reduced` | HP減少中のみ | スウォーム |
| `is_down` | ダウン中のみ | ディザスター |
| `mhp_check` | MHP条件 | ディザスター |
| `element_mismatch` | 領地属性と不一致 | エレメンタルラス |
| `most_common_element` | 最多属性のみ | クラスターバースト |

---

## JSON構造

### スペル（単体ダメージ）
```json
{
  "effect_parsed": {
	"target_type": "creature",
	"target_info": { "owner_filter": "enemy" },
	"effects": [{ "effect_type": "damage", "value": 20 }]
  }
}
```

### スペル（全体ダメージ）
```json
{
  "effect_parsed": {
	"target_type": "all_creatures",
	"target_info": { "owner_filter": "any", "has_curse": true },
	"effects": [{ "effect_type": "damage", "value": 20 }]
  }
}
```

### 秘術（クリーチャーJSON）
```json
{
  "mystic_arts": [{
	"name": "ダメージボルト",
	"spell_id": 9004,
	"cost": 20
  }]
}
```

秘術はspell_mystic.jsonの`spell_id`を参照して効果を実行。

---

## 処理フロー

### 単体
1. ターゲット選択（↑↓キー）
2. カメラフォーカス
3. `spell_damage.apply_damage()` / `apply_heal()`
4. 通知表示＋クリック待ち（7秒タイムアウト）
5. HP<=0なら撃破処理

### 全体
1. `TargetSelectionHelper.get_valid_targets()`で対象取得
2. 1体ずつループ（カメラ→処理→通知→クリック待ち）
3. 全員完了後、スペルフェーズ終了

---

## HP計算

```
MHP = creature["hp"] + creature.get("base_up_hp", 0)
現在HP = creature.get("current_hp", MHP)
```

- ダメージ: `current_hp = max(0, current_hp - value)`
- 回復: `current_hp = min(current_hp + value, MHP)`
- 撃破時: レベル維持、クリーチャーのみ削除

---

---

## 呪い効果スペル

### プレイグ（2087）✅ 実装済み

| 項目 | 内容 |
|------|------|
| コスト | 100MP |
| 対象 | 全領地（敵味方問わず） |
| 効果 | 呪い"衰弱"付与 |
| 呪いタイプ | `plague` |

**呪い効果**:
- バトル終了後（マップに戻った時）にダメージ適用
- ダメージ量: MHP/2（切り上げ）
- HP0以下でクリーチャー破壊
- 戦闘に勝っても衰弱ダメージで死ぬことがある

**処理フロー**:
1. バトル終了 → `_on_battle_completed()` / `_on_move_battle_completed()`
2. `SpellDamage.apply_plague_damage()` で呪いチェック＋ダメージ適用
3. 通知表示（「【衰弱】○○に△△ダメージ！」）

---

## 未実装スペル

### マスファンタズム（2108）

| 項目 | 内容 |
|------|------|
| コスト | 70MP |
| 対象 | 全領地（敵味方問わず） |
| 効果 | 呪い"HP効果無効"付与 |
| 呪いタイプ | `hp_effect_nullify` |

**仕様詳細**:
- バトル中のHP増減効果（回復、ダメージ、バフ等）を無効化
- 移動で消滅

**実装方針**:
1. SpellCurseに`hp_effect_nullify`呪いタイプ追加
2. BattleCurseApplierで呪い検出時にフラグ設定
3. BattleExecutionでHP変動処理前にフラグチェック

---

## 関連ファイル

| ファイル | 役割 |
|---------|------|
| `scripts/spells/spell_damage.gd` | ダメージ・回復の効果処理（単体/全体共通） |
| `scripts/game_flow/spell_phase_handler.gd` | スペル実行制御（呼び出しのみ） |
| `scripts/game_flow/target_selection_helper.gd` | ターゲットフィルタ |
| `scripts/spells/spell_mystic_arts.gd` | 秘術実行（呼び出しのみ） |
| `data/spell_1.json`, `data/spell_2.json` | スペル定義 |
| `data/spell_mystic.json` | 秘術用スペル効果（ID: 9001〜） |
