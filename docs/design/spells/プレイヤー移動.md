# プレイヤー移動スペル

**最終更新**: 2025年12月2日 | **実装状況**: ✅ 完了

---

## 概要

プレイヤー（セプター）の位置移動・移動制御に関するスペル群。

**実装ファイル**: `scripts/spells/spell_player_move.gd`

---

## スペル一覧

| ID | 名前 | コスト | 効果 | effect_type |
|----|------|--------|------|-------------|
| 2014 | エスケープ | 30MP | 最寄り空地にワープ | `warp_to_nearest_vacant` |
| 2079 | フォームポータル | 40MP | 最寄りゲートにワープ | `warp_to_nearest_gate` |
| 2104 | マジカルリープ | 60MP | 1〜4マス先の土地にワープ | `warp_to_target` |
| 2019 | カオスパニック | 60MP | 全員に反転呪い（1ターン） | `curse_movement_reverse` |
| 2123 | リミッション | 50MP | 未通過ゲートを通過扱い | `gate_pass` |
| 9021 | 方向選択権付与 | 40G | 次移動時に方向選択可能 | `grant_direction_choice` |

※ 9021はクロックアウル（ID:412）のアルカナアーツ

---

## 効果別詳細

### ワープ系

#### エスケープ / フォームポータル / マジカルリープ

**共通仕様**:
- 距離計算: BFSによるすごろく経路上のタイル数
- ワープ後: 方向選択権付与、移動フェーズはスキップ

**個別仕様**:

| スペル | 対象 | ワープ先での効果 |
|--------|------|-----------------|
| エスケープ | 最寄り空地 | なし |
| フォームポータル | 最寄りゲート | チェックポイント通過処理（シグナル取得・EPボーナス・周回判定）+ ダウン解除 |
| マジカルリープ | 選択した土地（1〜4マス） | ワープ先がチェックポイントの場合、通過処理 + ダウン解除 |

**チェックポイントワープ時の処理**（`_warp_player`内）:
- ワープ先がチェックポイントタイルの場合、`on_player_passed`を呼び出し
- LapSystem経由でシグナル取得判定（未訪問ならEPボーナス付与）
- 訪問済み・未訪問に関わらずダウン解除を実行

---

### 反転（カオスパニック）

**動作**:
1. 全プレイヤーに `movement_reverse` 呪いを付与（duration=1）
2. 移動時に `is_reversed` フラグで方向を一時的に逆転
3. `current_direction` は変更しない（呪い解除後に元に戻る）

**呪いデータ**:
```gdscript
player.curse = {
	"curse_type": "movement_reverse",
	"name": "反転",
	"duration": 1
}
```

**実装ポイント**:
- `MovementController.move_player()` で `_has_movement_reverse_curse()` をチェック
- `_move_steps_with_branch()` と `_get_next_tile_with_branch()` に `is_reversed` パラメータを渡す
- 呪い解除は `SpellCurse.update_player_curse()` でターン終了時に自動処理

---

### ナビゲート

**動作**:
1. 対象プレイヤーに `direction_choice_pending = true` を設定
2. 次の移動開始時に方向選択UIを表示
3. 選択後にフラグを消費

**バフデータ**:
```gdscript
player.buffs["direction_choice_pending"] = true
```

**付与タイミング**:
| タイミング | 処理場所 |
|------------|---------|
| ゲーム開始時 | `GameFlowManager.start_game()` |
| ワープ後 | `SpellPlayerMove._warp_player()` |
| クロックアウルアルカナアーツ | `SpellPlayerMove.grant_direction_choice()` |

---

### ゲート通過（リミッション）

**動作**:
1. 未通過ゲートから選択（1周完了になるゲートは除外）
2. 周回フラグのみ更新（移動なし、ボーナスなし）

**選択制限の例（2ゲート: N, S）**:

| 現在の状態 | 選択可能 |
|------------|----------|
| N=false, S=false | N, S |
| N=true, S=false | なし（Sを選ぶと1周完了） |

---

## JSON定義例

```json
// カオスパニック
{
  "id": 2019,
  "effect_parsed": {
	"target_type": "all_players",
	"effects": [{"effect_type": "curse_movement_reverse", "duration": 1}]
  }
}

// クロックアウルアルカナアーツ
{
  "id": 9021,
  "effect_parsed": {
	"target_type": "player",
	"target_info": {"target_filter": "any"},
	"effects": [{"effect_type": "grant_direction_choice", "duration": 1}]
  }
}
```

---

## クラス構成

```
SpellPlayerMove (scripts/spells/spell_player_move.gd)
├── warp_to_nearest_vacant(player_id) → Dictionary
├── warp_to_nearest_gate(player_id) → Dictionary
├── warp_to_target(player_id, tile_index) → Dictionary
├── apply_movement_reverse_curse(duration)
├── trigger_gate_pass(player_id, gate_key) → Dictionary
├── grant_direction_choice(player_id, duration)
└── get_selectable_gates(player_id) → Array

MovementController (scripts/movement_controller.gd)
├── _has_movement_reverse_curse(player_id) → bool
├── _check_direction_choice_pending(player_id) → bool
└── _consume_direction_choice(player_id)
```

---

## 注意事項

- **ワープ先での停止効果**: チェックポイントの場合はシグナル取得・ダウン解除が発動
- **距離計算**: `tile_neighbor_system.get_sequential_neighbors`がタイルの`connections`配列を使用（分岐マップ対応）
- **反転 + 方向選択権**: 選んだ方向が逆転される（順方向選択→実際は逆方向）
- **ゲート対応**: 4方向対応済み（N, S, E, W）。`checkpoint_tile._get_checkpoint_type_string()`で文字列取得

---

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2025/12/01 | 初版作成 |
| 2025/12/02 | 全スペル実装完了、反転の`is_reversed`方式に変更 |
| 2026/02/10 | 距離計算をconnectionsベースに修正（分岐マップ対応） |
| 2026/02/10 | ワープ先チェックポイント処理追加（シグナル取得・ダウン解除） |
| 2026/02/10 | チェックポイントタイプ判定を4方向対応（N/S/E/W） |
