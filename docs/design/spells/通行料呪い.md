# 通行料呪いシステム

**最終更新**: 2025年11月23日 | **実装状況**: ✅ 実装完了

---

## スペル一覧

### セプター呪い（プレイヤー対象）

| ID | 名前 | 効果 | 対象 | 期間 |
|----|------|------|------|------|
| 2061 | ドリームトレイン | 敵の通行料の50%を獲得 | 自分（self） | 5T |
| 2084 | ブラックアウト | 通行料を支払わない（0G） | 敵プレイヤー | 2T |
| 2115 | ユニフォーミティ | 通行料を200Gに固定 | 敵プレイヤー | 3T |

### 領地呪い（クリーチャー対象）

| ID | 名前 | 効果 | 対象 | 期間 |
|----|------|------|------|------|
| 2024 | グリード | 通行料1.5倍 | クリーチャー | 永続 |
| 2072 | ピース | 敵移動除外＋戦闘不可＋通行料0 | クリーチャー | 永続 |

### クリーチャースキルによる呪い付与

| ID | 名前 | 効果 | 条件 |
|----|------|------|------|
| 124 | スキュラ | 敵に通行料無効呪い | 両者生存時 |

---

## 実装の流れ

### 呪い付与
1. スペルをセルフターゲット（`target_filter: "self"`）で使用 → UI表示なし、自動適用
2. `SpellCurse.curse_player()` で呪い情報を保存（`caster_id` 含む）
3. 呪い情報には duration で有効期間管理

### 呪い判定・計算
**タイミング**: `GameFlowManager.end_turn()` → `check_and_pay_toll_on_enemy_land()`

**処理**:
```
base_toll = board_system_3d.calculate_toll(current_tile_index)
  ↓
toll_info = spell_curse_toll.calculate_final_toll(
	tile_index,          // クリーチャーの呪いチェック
	payer_id,            // 支払い側の呪いチェック
	receiver_id,         // 受取側の呪いチェック
	base_toll
)
  ↓
main_toll = toll_info.get("main_toll")           // 主通行料
bonus_toll = toll_info.get("bonus_toll")         // 副収入（toll_share）
bonus_receiver_id = toll_info.get("bonus_receiver_id")

// 支払い実行
player_system.pay_toll(payer_id, receiver_id, main_toll)
if bonus_toll > 0:
	player_system.pay_toll(payer_id, bonus_receiver_id, bonus_toll)
```

### ターン経過時に呪いカウントダウン
`SpellCurse.update_all_curses()` で duration を減算、0 になると自動削除

---

## 各呪いの仕様

### セプター呪い

| 呪い | スペル | 効果 | 実装場所 |
|------|--------|------|---------|
| **toll_share** | ドリームトレイン | 支払った通行料の50%を獲得（副収入） | `calculate_final_toll()` |
| **toll_disable** | ブラックアウト | 支払い = 0G | `calculate_final_toll()` |
| **toll_fixed** | ユニフォーミティ | 支払い = 200G（固定値） | `calculate_final_toll()` |

**実装**: `SpellCurseToll.calculate_final_toll()` で全て判定し、Dictionary で戻す
```gdscript
{
  "main_toll": 最終通行料,
  "bonus_toll": 副収入額（toll_share時のみ > 0）,
  "bonus_receiver_id": 副収入受取プレイヤーID
}
```

### 領地呪い

| 呪い | スペル/スキル | 効果 | 実装場所 |
|------|--------------|------|---------|
| **toll_multiplier** | グリード | 通行料 × 1.5 | `calculate_final_toll()` で判定 |
| **peace** | ピース | 敵移動除外 + 戦闘不可 + 通行料0 | 複数箇所（移動制御、戦闘UI、支払い判定） |
| **creature_toll_disable** | スキュラ | 通行料 = 0 | `calculate_final_toll()` で判定 |

---

## 実装ファイル

| ファイル | 役割 |
|---------|------|
| `scripts/spells/spell_curse_toll.gd` | 呪い判定・計算（`calculate_final_toll()` で統一） |
| `scripts/game_flow/spell_phase_handler.gd` | `_apply_single_effect()` で toll_* 効果を処理 |
| `scripts/game_flow_manager.gd` | `check_and_pay_toll_on_enemy_land()` で支払い実行 |
| `scripts/spells/spell_curse.gd` | 呪い情報保存（player.curse） |

---

## 重要なポイント

### toll_share の仕組み

1. **スペル使用時**: ドリームトレイン（セルフターゲット）を使う
2. **呪い付与**: `SpellCurse.curse_player()` で spell_curse_toll の `caster_id` に「使用者ID」を保存
3. **支払い時**: `calculate_final_toll()` で `caster_id` から副収入受取者を判定
4. **支払い実行**: main_toll をプレイヤーに、bonus_toll を副収入受取者に支払い

### peace の複数処理

敵領地への移動・戦闘・支払いの各フェーズで peace 呪いをチェック：
- **移動時**: 候補から除外（移動不可）
- **戦闘判定**: 戦闘UIを表示しない（戦闘不可）
- **支払い判定**: 通行料を0にする

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025/11/23 | 3.0 | **記録用に簡潔化** - 実装完了に伴い、スペル一覧と仕様概要のみに簡潔化 |
| 2025/11/23 | 2.1 | peace実装方針更新・支払い処理一本化対応 |
| 2025/11/13 | 1.0 | 初版作成 |
| 2025/12/01 | 3.1 | スキュラ（creature_toll_disable）追加 |

---

**最終更新**: 2025年12月1日 | **実装状況**: ✅ 完全実装
