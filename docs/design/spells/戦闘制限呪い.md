# 戦闘制限呪い

**バージョン**: 3.1  
**最終更新**: 2025年12月1日

---

## 概要

バトル中のクリーチャーに影響を与える呪いシステム。

| 呪い名 | curse_type | 効果 |
|-------|-----------|------|
| 戦闘能力不可 | `skill_nullify` | 戦闘スキル無効化 |
| 戦闘行動不可 | `battle_disable` | 攻撃・アイテム・援護使用不可 |
| 地形効果無効 | `land_effect_disable` | ランドボーナス無効 |
| 地形効果付与 | `land_effect_grant` | ランドボーナス付与 |
| メタルフォーム | `metal_form` | 無効化[通常攻撃]、防具使用不可 |
| マジックバリア | `magic_barrier` | 無効化[通常攻撃]、攻撃無効化時に敵へG100 |
| 戦闘後破壊 | `destroy_after_battle` | 次の戦闘で生き残った場合、戦闘後に破壊 |
| 通行料無効 | `creature_toll_disable` | その領地の通行料が0になる |

---

## アーキテクチャ

```
SpellCurseBattle（静的クラス）
├── 呪い判定: has_xxx(creature_data)
├── 呪い付与: apply_xxx(creature_data)
└── 地形効果判定: can_get_land_bonus()

SpellPhaseHandler
└── _apply_battle_curse() → SpellCurseBattle.apply_xxx() を呼び出し

BattleCurseApplier
└── apply_creature_curses() → 呪いをtemporary_effectsに変換
```

---

## SpellCurseBattle API

`scripts/spells/spell_curse_battle.gd` - 全メソッドstatic

```gdscript
# 判定
has_skill_nullify(creature_data) -> bool
has_battle_disable(creature_data) -> bool
has_land_effect_disable(creature_data) -> bool
has_land_effect_grant(creature_data) -> bool
has_metal_form(creature_data) -> bool
has_magic_barrier(creature_data) -> bool
has_destroy_after_battle(creature_data) -> bool
has_creature_toll_disable(creature_data) -> bool

# 付与
apply_skill_nullify(creature_data, name)
apply_battle_disable(creature_data, name)
apply_land_effect_disable(creature_data, name)
apply_land_effect_grant(creature_data, grant_elements, name)
apply_metal_form(creature_data, name)
apply_magic_barrier(creature_data, name)
apply_destroy_after_battle(creature_data, name)
apply_creature_toll_disable(creature_data, name)

# 地形効果
can_get_land_bonus(creature_data, tile_element) -> bool
get_extra_land_elements(creature_data) -> Array
```

---

## 地形効果システム

### ルール

| タイル属性 | ボーナス条件 |
|-----------|-------------|
| 火/水/風/地 | クリーチャー属性一致時 |
| 無属性 | 全クリーチャー |

ボーナス値: `レベル × 10`

### 判定フロー（can_get_land_bonus）

1. `land_effect_disable`呪い → false
2. 無属性タイル → true
3. クリーチャー属性一致 → true
4. `extra_land_elements`に含まれる → true
5. `land_effect_grant`呪い → true

### 対象カード

| ID | 名前 | 効果 |
|----|------|------|
| 2055 | ディスエレメント | 地形効果無効付与 |
| 220 | スクリーマー | 秘術: 敵に地形効果無効 |
| 431 | ハイドビハインド | 秘術: 自に地形効果付与 |
| 224 | スプラウトリング | 固有: 火から地形効果 |
| 316 | サーペントフライ | 固有: 水から地形効果 |
| 430 | ハーフリング | 固有: 全属性地形効果 |

---

## メタルフォーム（2114）

### 効果
- **無効化[通常攻撃]**: 先制攻撃含む、巻物攻撃は対象外
- **防具使用不可**: アイテムフェーズで防具がグレーアウト

### 処理フロー

```
1. スペル使用
   └→ SpellPhaseHandler._apply_battle_curse()
	   └→ SpellCurseBattle.apply_metal_form()

2. バトル開始
   └→ BattleCurseApplier.apply_creature_curses()
	   └→ ability_parsed に無効化[通常攻撃]を追加

3. アイテムフェーズ
   └→ ItemPhaseHandler._show_item_selection_ui()
	   └→ has_metal_form → blocked_item_types = ["防具"]
	   └→ CardSelectionUI で防具をグレーアウト

4. 攻撃実行
   └→ BattleSpecialEffects.check_nullify()
	   └→ nullify_type: "normal_attack" → ダメージ無効
```

### JSON定義

```json
{
  "id": 2114,
  "name": "メタルフォーム",
  "effect_parsed": {
	"target_type": "land",
	"target_filter": "creature",
	"target_info": { "owner_filter": "any" },
	"effects": [{
	  "effect_type": "metal_form",
	  "name": "金属化",
	  "duration": -1
	}]
  }
}
```

---

## マジックバリア（2015 エナジーフィールド）

### 効果
- **無効化[通常攻撃]**: 先制攻撃含む、巻物攻撃は対象外
- **G100移動**: 攻撃無効化成功時、防御側から攻撃側へ

### 処理フロー

```
1. スペル使用
   └→ SpellCurseBattle.apply_magic_barrier()
	   └→ params: { gold_transfer: 100 }

2. バトル開始
   └→ BattleCurseApplier.apply_creature_curses()
	   └→ temporary_effects に gold_transfer_on_nullify を追加

3. 攻撃実行
   └→ check_nullify() → 無効化成立
   └→ _apply_gold_transfer_on_nullify()
	   └→ spell_magic.steal_magic(defender, attacker, 100)
```

### JSON定義

```json
{
  "id": 2015,
  "name": "エナジーフィールド",
  "effect_parsed": {
	"target_type": "land",
	"target_filter": "creature",
	"target_info": { "owner_filter": "any" },
	"effects": [{
	  "effect_type": "magic_barrier",
	  "name": "魔力結界",
	  "duration": -1,
	  "gold_transfer": 100
	}]
  }
}
```

---

## 戦闘後破壊（2032 シニリティ / 114 オトヒメ）

### 効果
- 呪いを持つクリーチャーが戦闘で**生き残った場合**、戦闘後に破壊

### 対象カード

| ID | 名前 | タイプ | 効果 |
|----|------|-------|------|
| 2032 | シニリティ | スペル | 対象領地に戦闘後破壊呪い付与 |
| 114 | オトヒメ | クリーチャー | 両者生存時、敵に呪い付与（キーワード: `戦闘後破壊`） |

### 処理
- スペル: `SpellCurseBattle.apply_destroy_after_battle()`
- クリーチャースキル: `battle_execution.gd`の`_check_apply_destroy_after_battle_skill()`
- 呪い発動: `battle_execution.gd`の`_check_destroy_after_battle()`

---

## 通行料無効（124 スキュラ）

### 効果
- 呪いを持つクリーチャーの領地の通行料が0になる

### 対象カード

| ID | 名前 | タイプ | 効果 |
|----|------|-------|------|
| 124 | スキュラ | クリーチャー | 両者生存時、敵に呪い付与（キーワード: `通行料無効付与`） |

### 処理
- 呪い付与: `SpellCurseBattle.apply_creature_toll_disable()`
- 通行料計算: `spell_curse_toll.gd`の`calculate_final_toll()`でチェック

---

## 実装ファイル一覧

| ファイル | 役割 |
|----------|------|
| `spell_curse_battle.gd` | 呪い判定・付与API |
| `spell_phase_handler.gd` | スペル使用時の呪い付与 |
| `battle_curse_applier.gd` | 呪いをバトル効果に変換 |
| `battle_special_effects.gd` | 無効化判定（check_nullify） |
| `battle_execution.gd` | G100移動、戦闘後破壊、スキル呪い付与 |
| `spell_curse_toll.gd` | 通行料無効判定 |
| `item_phase_handler.gd` | 防具使用不可判定 |
| `card_selection_ui.gd` | 防具グレーアウト表示 |
| `ui_manager.gd` | blocked_item_types変数 |

---

## 変更履歴

| 日付 | Ver | 内容 |
|------|-----|------|
| 2025/11/26 | 1.0 | 初版（skill_nullify, battle_disable） |
| 2025/11/30 | 2.0 | Phase 3完了（地形効果システム） |
| 2025/12/01 | 3.0 | Phase 4完了（メタルフォーム、マジックバリア）、完成図書化 |
| 2025/12/01 | 3.1 | 戦闘後破壊（シニリティ、オトヒメ）、通行料無効（スキュラ）追加 |
