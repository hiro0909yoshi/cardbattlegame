# 戦闘制限呪い

**バージョン**: 2.5  
**最終更新**: 2025年11月30日

---

## 概要

| 呪い名 | curse_type | 効果 | 実装 |
|-------|-----------|------|------|
| 戦闘能力不可 | `skill_nullify` | 戦闘スキル無効化 | ✅ |
| 戦闘行動不可 | `battle_disable` | 攻撃・アイテム・援護使用不可 | ✅ |
| 地形効果無効 | `land_effect_disable` | ランドボーナス無効 | ✅ |
| 地形効果付与 | `land_effect_grant` | ランドボーナス付与 | ✅ |
| メタルフォーム | `metal_form` | 無効化[通常攻撃]、防具不可 | ⏳ |
| マジックバリア | `magic_barrier` | 無効化[通常攻撃]、敵にG100 | ⏳ |
| HP効果無効 | `hp_effect_disable` | HP関連スペル効果無効 | ⏳ |

**共通クラス**: `scripts/spells/spell_curse_battle.gd`

---

## SpellCurseBattle API

すべてstaticメソッド。インスタンス化不要。

```gdscript
# チェック
SpellCurseBattle.has_battle_disable(creature_data)      # 戦闘行動不可
SpellCurseBattle.has_skill_nullify(creature_data)       # 戦闘能力不可
SpellCurseBattle.has_land_effect_disable(creature_data) # 地形効果無効
SpellCurseBattle.has_land_effect_grant(creature_data)   # 地形効果付与

# 単体付与
SpellCurseBattle.apply_battle_disable(creature_data)
SpellCurseBattle.apply_skill_nullify(creature_data)
SpellCurseBattle.apply_land_effect_disable(creature_data)
SpellCurseBattle.apply_land_effect_grant(creature_data, grant_elements)

# 地形効果判定（統合メソッド）
SpellCurseBattle.can_get_land_bonus(creature_data, tile_element)
SpellCurseBattle.get_extra_land_elements(creature_data)

# 攻撃成功時の呪い付与（ナイキー、バインドウィップ用）
SpellCurseBattle.check_and_apply_on_attack_success(attacker_data, defender_data)
```

---

## 地形効果システム

### 基本ルール

| タイル属性 | 地形効果 |
|-----------|---------|
| 火/水/風/地 | クリーチャー属性一致時にボーナス（レベル×10） |
| 無属性 | 全クリーチャーにボーナス（レベル×10） |

### 地形効果判定フロー

`SpellCurseBattle.can_get_land_bonus()`で統合判定：

1. **地形効果無効呪い**チェック → あればfalse
2. **無属性タイル**チェック → 全クリーチャーにボーナス
3. **通常属性一致**チェック → クリーチャー属性 == タイル属性
4. **追加属性**チェック → `extra_land_elements`に含まれるか
5. **地形効果付与呪い**チェック → 指定属性からボーナス

### 実装箇所

| ファイル | 処理 |
|----------|------|
| `scripts/spells/spell_curse_battle.gd` | 地形効果判定・呪い付与 |
| `scripts/battle/battle_preparation.gd` | `calculate_land_bonus()` |
| `scripts/tile_data_manager.gd` | タイル属性取得（"element"キー） |

---

## 地形効果無効（land_effect_disable）

### 効果
- 全ての地形効果（ランドボーナス）を無効化
- 無属性タイルからのボーナスも無効

### 対象カード

| ID | 名前 | 種別 | 対象 |
|----|------|------|------|
| 2055 | ディスエレメント | スペル | 任意領地 |
| 220 | スクリーマー | クリーチャー秘術 | 敵領地 |

### データ構造

```json
// スペル（2055）
"effect_parsed": {
  "target_type": "land",
  "target_filter": "creature",
  "target_info": { "owner_filter": "any" },
  "effects": [{
    "effect_type": "land_effect_disable",
    "name": "地形効果無効",
    "duration": -1
  }]
}

// 秘術（9018）
"effect_parsed": {
  "target_type": "land",
  "target_filter": "creature",
  "target_info": { "owner_filter": "enemy" },
  "effects": [{
    "effect_type": "land_effect_disable",
    "name": "地形効果無効",
    "duration": -1
  }]
}
```

---

## 地形効果付与（land_effect_grant）

### 効果
- 指定属性からの地形効果を付与
- `grant_elements`が空の場合は全属性

### 対象カード

| ID | 名前 | 種別 | 対象 |
|----|------|------|------|
| 431 | ハイドビハインド | クリーチャー秘術 | 自領地 |

### データ構造

```json
// 秘術（9019）
"effect_parsed": {
  "target_type": "land",
  "target_filter": "creature",
  "target_info": { "owner_filter": "own" },
  "effects": [{
    "effect_type": "land_effect_grant",
    "name": "地形効果",
    "duration": -1,
    "grant_elements": []
  }]
}
```

---

## 地形効果拡張スキル（固有スキル）

### 効果
- 追加の属性からも地形効果を得られる
- `ability_parsed.extra_land_elements`で定義

### 対象カード

| ID | 名前 | 属性 | 追加地形効果 |
|----|------|-----|-------------|
| 224 | スプラウトリング | 地 | 火 |
| 316 | サーペントフライ | 風 | 水 |
| 430 | ハーフリング | 無 | 火/水/風/地（全属性） |

### データ構造

```json
// クリーチャーJSON
"ability_parsed": {
  "keywords": [],
  "effects": [],
  "extra_land_elements": ["fire", "water", "earth", "wind"]
}
```

---

## 秘術定義

### JSON構造

クリーチャーJSONで秘術を定義：

```json
// クリーチャー直下（推奨）
"mystic_arts": {
  "cost": 40,
  "spell_id": 9018
}

// または ability_parsed 内
"ability_parsed": {
  "mystic_arts": [...]
}
```

### 秘術スペル（spell_mystic.json）

| ID | 名前 | 効果 |
|----|------|------|
| 9018 | 地形効果無効（スクリーマー） | 敵クリーチャーに地形効果無効付与 |
| 9019 | 地形効果付与（ハイドビハインド） | 自クリーチャーに地形効果付与 |
| 9020 | オールドウィロウ変身（スプラウトリング） | 変身 |

---

## 実装タスク

### Phase 3: 地形効果システム ✅ 完了

| ID | 名前 | タイプ | 効果 | 状態 |
|----|------|-------|------|------|
| 2055 | ディスエレメント | スペル | 地形効果無効 | ✅ |
| 220 | スクリーマー | 秘術 | 敵に地形効果無効 | ✅ |
| 224 | スプラウトリング | 固有スキル | 火から地形効果 | ✅ |
| 316 | サーペントフライ | 固有スキル | 水から地形効果 | ✅ |
| 430 | ハーフリング | 固有スキル | 全属性地形効果 | ✅ |
| 431 | ハイドビハインド | 秘術 | 自に地形効果付与 | ✅ |

### Phase 4: 戦闘制限呪い拡張

| ID | 名前 | curse_type | 効果 | 状態 |
|----|------|-----------|------|------|
| 2114 | メタルフォーム | `metal_form` | 無効化[通常攻撃]、防具不可 | ⏳ |
| 2015 | エナジーフィールド | `magic_barrier` | 無効化[通常攻撃]、敵にG100 | ⏳ |
| 2108 | マスファンタズム | `hp_effect_disable` | HP効果無効（全領地） | ⏳ |

---

## メタルフォーム（metal_form）

### 効果
- 無効化[通常攻撃]：通常攻撃を無効化（スキル無効化と同様の処理）
- 防具使用不可：呪いがかかったクリーチャー自身が防具を使用できない

### 対象
- 任意領地のクリーチャー（敵味方問わず）

### 実装箇所
| ファイル | 処理 |
|----------|------|
| `scripts/spells/spell_curse_battle.gd` | `has_metal_form()`, `apply_metal_form()` |
| `scripts/battle/skills/skill_special_creature.gd` | 無効化[通常攻撃]判定（既存の無効化処理を参考） |
| `scripts/game_flow/item_phase_handler.gd` | 防具使用不可判定 |

---

## エナジーフィールド（magic_barrier）

### 効果
- 無効化[通常攻撃]：通常攻撃を無効化
- 攻撃無効化時に攻撃側へ100G移動

### 対象
- 任意領地のクリーチャー（敵味方問わず）

### 実装箇所
| ファイル | 処理 |
|----------|------|
| `scripts/spells/spell_curse_battle.gd` | `has_magic_barrier()`, `apply_magic_barrier()` |
| `scripts/battle/skills/skill_special_creature.gd` | 無効化[通常攻撃]判定 |
| `scripts/battle/battle_execution.gd` | 攻撃無効化時のG100移動処理 |

---

## マスファンタズム（hp_effect_disable）

### 効果
- HP関連スペル効果を無効化（マップ上スペルのみ）
- 対象にはなるが効果が打ち消される
- 打ち消し時にコメント表示

### 無効化する効果
| effect_type | 効果 |
|-------------|------|
| `damage` | ダメージ → 0になる |
| `permanent_hp_change` | MHP増減 → 無効 |
| `base_up_hp`関連 | ベースアップHP → 無効 |
| HP回復系 | 回復 → 無効 |

### 無効化しない効果
- 戦闘中のスキル（再生、反射ダメージ等）
- HP以外の効果（AP増減、魔力操作等）

### 呪い上書き
- 別の呪いをかけられると`hp_effect_disable`は消える（通常の呪い上書きルール）

### 対象
- 全領地のクリーチャー（target_type: all_creatures）

### 実装箇所
| ファイル | 処理 |
|----------|------|
| `scripts/spells/spell_curse_battle.gd` | `has_hp_effect_disable()`, `apply_hp_effect_disable()` |
| `scripts/game_flow/spell_phase_handler.gd` | HP効果適用前チェック、コメント表示 |
| `scripts/spells/spell_damage.gd` | ダメージ無効化判定 |

---

## 実装チェックリスト

### 2114 メタルフォーム
- [ ] `has_metal_form()` / `apply_metal_form()` 追加
- [ ] 無効化[通常攻撃] → skill_special_creature.gd で判定
- [ ] 防具使用不可 → item_phase_handler.gd で判定
- [ ] spell_2.json: effect_parsed 定義

### 2015 エナジーフィールド
- [ ] `has_magic_barrier()` / `apply_magic_barrier()` 追加
- [ ] 無効化[通常攻撃] → skill_special_creature.gd で判定
- [ ] 攻撃無効化時にG100移動 → battle_execution.gd
- [ ] spell_1.json: effect_parsed 定義

### 2108 マスファンタズム
- [ ] `has_hp_effect_disable()` / `apply_hp_effect_disable()` 追加
- [ ] HP効果無効化判定 → spell_phase_handler.gd
- [ ] ダメージ無効化 → spell_damage.gd
- [ ] 打ち消しコメント表示
- [ ] spell_2.json: effect_parsed 定義（target_type: all_creatures）

---

## 変更履歴

| 日付 | Ver | 内容 |
|------|-----|------|
| 2025/11/26 | 1.0 | 初版 |
| 2025/11/26 | 2.0 | battle_disable 実装完了 |
| 2025/11/26 | 2.1 | SpellCurseBattleクラス追加 |
| 2025/11/27 | 2.2 | 全体ターゲット処理をTargetSelectionHelper委譲 |
| 2025/11/30 | 2.3 | Phase 3タスク追加 |
| 2025/11/30 | 2.4 | Phase 3完了（地形効果関連6件） |
| 2025/11/30 | 2.5 | ドキュメント構成見直し、地形効果システム詳細追加 |
| 2025/11/30 | 2.6 | Phase 4詳細仕様追加（メタルフォーム、エナジーフィールド、マスファンタズム） |