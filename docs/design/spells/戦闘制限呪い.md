# 戦闘制限呪い

**バージョン**: 2.2  
**最終更新**: 2025年11月27日

---

## 概要

| 呪い名 | curse_type | 効果 | 実装 |
|-------|-----------|------|------|
| 戦闘能力不可 | `skill_nullify` | 戦闘スキル無効化 | ✅ |
| 戦闘行動不可 | `battle_disable` | 攻撃・アイテム・援護使用不可 | ✅ |

**共通クラス**: `scripts/spells/spell_curse_battle.gd`

---

## SpellCurseBattle API

すべてstaticメソッド。インスタンス化不要。

```gdscript
# チェック
SpellCurseBattle.has_battle_disable(creature_data)  # 戦闘行動不可
SpellCurseBattle.has_skill_nullify(creature_data)   # 戦闘能力不可

# 単体付与
SpellCurseBattle.apply_battle_disable(creature_data)
SpellCurseBattle.apply_skill_nullify(creature_data)

# 全体付与（条件付き）- ディラニー等
SpellCurseBattle.apply_to_all_creatures(board_system, effect, target_info)
# → 内部でTargetSelectionHelper.get_all_creatures()を使用

# 攻撃成功時の呪い付与（ナイキー、バインドウィップ用）
SpellCurseBattle.check_and_apply_on_attack_success(attacker_data, defender_data)
```

### 全体ターゲット処理

`apply_to_all_creatures()`は内部で`TargetSelectionHelper.get_all_creatures()`を使用：

```gdscript
static func apply_to_all_creatures(board_system, effect: Dictionary, target_info: Dictionary) -> int:
    var condition = target_info.get("condition", {})
    var targets = TargetSelectionHelper.get_all_creatures(board_system, condition)
    
    for target in targets:
        var creature = target["creature"]
        match effect.get("effect_type", ""):
            "battle_disable":
                apply_battle_disable(creature, effect.get("name", "戦闘行動不可"))
            "skill_nullify":
                apply_skill_nullify(creature, effect.get("name", "戦闘能力不可"))
    
    return targets.size()
```

---

## 戦闘能力不可（skill_nullify）

### 効果
- 全能力を無効化（先制、強打、貫通、無効化、再生、反射、即死、変身、応援など）
- 基礎ステータス（AP/HP）とランドボーナスは有効

### 対象カード
| ID | 名前 | 種別 |
|----|------|------|
| 2094 | ボーテックス | スペル |

### 実装箇所
| ファイル | 処理 |
|----------|------|
| `scripts/spells/spell_curse_battle.gd` | `has_skill_nullify()`, `apply_skill_nullify()` |
| `scripts/game_flow/spell_phase_handler.gd` | 呪い付与 |
| `scripts/battle/battle_skill_processor.gd` | 戦闘開始時チェック |
| `scripts/battle/skills/skill_special_creature.gd` | 能力無効化処理 |

---

## 戦闘行動不可（battle_disable）

### 効果
| 項目 | 状態 |
|------|------|
| 攻撃 | ❌ スキップ |
| アイテム使用 | ❌ 強制パス |
| 援護使用 | ❌ 強制パス |
| 基礎ステータス | ✅ 有効 |
| ランドボーナス | ✅ 有効 |
| 応援（ステータス）| ✅ 有効 |

**重要**: 攻撃を「受ける」ことは可能（HPは減る）

### 対象カード
| ID | 名前 | 種別 | 付与タイミング |
|----|------|------|--------------|
| 2068 | バインドミスト | スペル | マップ上 |
| 2057 | ディラニー | スペル | マップ上（MHP30以下全体） |
| 1050 | バインドウィップ | アイテム | 攻撃成功時 |
| 132 | ハイド | クリーチャー | マップ上（秘術） |
| 332 | ナイキー | クリーチャー | 攻撃成功時 |

### 実装箇所
| ファイル | 処理 |
|----------|------|
| `scripts/spells/spell_curse_battle.gd` | `has_battle_disable()`, `apply_battle_disable()`, `apply_to_all_creatures()`, `check_and_apply_on_attack_success()` |
| `scripts/game_flow/spell_phase_handler.gd` | 呪い付与（単体スペル）、全体効果の発動制御 |
| `scripts/game_flow/target_selection_helper.gd` | `get_all_creatures()` - 条件付き全クリーチャー取得 |
| `scripts/game_flow/item_phase_handler.gd` | アイテム・援護強制パス |
| `scripts/battle/battle_execution.gd` | 攻撃スキップ、攻撃成功時呪い付与 |

---

## データ構造

### クリーチャー呪い
```json
{
  "curse_type": "battle_disable",
  "name": "戦闘行動不可",
  "duration": -1,
  "params": {}
}
```

### スペル effect_parsed（単体）
```json
"effect_parsed": {
  "target_type": "land",
  "target_info": {
	"owner_filter": "any",
	"target_filter": "creature"
  },
  "effects": [{
	"effect_type": "battle_disable",
	"name": "戦闘行動不可",
	"duration": -1
  }]
}
```

### スペル effect_parsed（全体条件付き）
```json
"effect_parsed": {
  "target_type": "all_creatures",
  "target_info": {
	"condition": {
	  "condition_type": "mhp_check",
	  "operator": "<=",
	  "value": 30
	}
  },
  "effects": [{
	"effect_type": "battle_disable",
	"name": "戦闘行動不可",
	"duration": -1
  }]
}
```

### クリーチャー/アイテム（攻撃成功時）
```json
"effects": [{
  "effect_type": "on_attack_success_curse",
  "curse_type": "battle_disable",
  "name": "戦闘行動不可"
}]
```

---

## 変更履歴

| 日付 | Ver | 内容 |
|------|-----|------|
| 2025/11/26 | 1.0 | 初版 |
| 2025/11/26 | 2.0 | battle_disable 実装完了 |
| 2025/11/26 | 2.1 | SpellCurseBattleクラス追加、ファイルパス修正 |
| 2025/11/27 | 2.2 | 全体ターゲット処理をTargetSelectionHelper.get_all_creatures()に委譲 |
