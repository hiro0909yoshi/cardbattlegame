# 戦闘制限呪い

**バージョン**: 2.2  
**最終更新**: 2025年11月27日

---

## 概要

| 呪い名 | curse_type | 効果 | 実装 |
|-------|-----------|------|------|
| 戦闘能力不可 | `skill_nullify` | 戦闘スキル無効化 | ✅ |
| 戦闘行動不可 | `battle_disable` | 攻撃・アイテム・援護使用不可 | ✅ |

**共通クラス**: `scripts/spells/spell_curse_battle.gd`

---

## SpellCurseBattle API

すべてstaticメソッド。インスタンス化不要。

```gdscript
# チェック
SpellCurseBattle.has_battle_disable(creature_data)  # 戦闘行動不可
SpellCurseBattle.has_skill_nullify(creature_data)   # 戦闘能力不可

# 単体付与
SpellCurseBattle.apply_battle_disable(creature_data)
SpellCurseBattle.apply_skill_nullify(creature_data)

# 全体付与（条件付き）- ディラニー等
SpellCurseBattle.apply_to_all_creatures(board_system, effect, target_info)
# → 内部でTargetSelectionHelper.get_all_creatures()を使用

# 攻撃成功時の呪い付与（ナイキー、バインドウィップ用）
SpellCurseBattle.check_and_apply_on_attack_success(attacker_data, defender_data)
```

### 全体ターゲット処理

`apply_to_all_creatures()`は内部で`TargetSelectionHelper.get_all_creatures()`を使用：

```gdscript
static func apply_to_all_creatures(board_system, effect: Dictionary, target_info: Dictionary) -> int:
	var condition = target_info.get("condition", {})
	var targets = TargetSelectionHelper.get_all_creatures(board_system, condition)
	
	for target in targets:
		var creature = target["creature"]
		match effect.get("effect_type", ""):
			"battle_disable":
				apply_battle_disable(creature, effect.get("name", "戦闘行動不可"))
			"skill_nullify":
				apply_skill_nullify(creature, effect.get("name", "戦闘能力不可"))
	
	return targets.size()
```

---

## 戦闘能力不可（skill_nullify）

### 効果
- 全能力を無効化（先制、強打、貫通、無効化、再生、反射、即死、変身、応援など）
- 基礎ステータス（AP/HP）とランドボーナスは有効

### 対象カード
| ID | 名前 | 種別 |
|----|------|------|
| 2094 | ボーテックス | スペル |

### 実装箇所
| ファイル | 処理 |
|----------|------|
| `scripts/spells/spell_curse_battle.gd` | `has_skill_nullify()`, `apply_skill_nullify()` |
| `scripts/game_flow/spell_phase_handler.gd` | 呪い付与 |
| `scripts/battle/battle_skill_processor.gd` | 戦闘開始時チェック |
| `scripts/battle/skills/skill_special_creature.gd` | 能力無効化処理 |

---

## 戦闘行動不可（battle_disable）

### 効果
| 項目 | 状態 |
|------|------|
| 攻撃 | ❌ スキップ |
| アイテム使用 | ❌ 強制パス |
| 援護使用 | ❌ 強制パス |
| 基礎ステータス | ✅ 有効 |
| ランドボーナス | ✅ 有効 |
| 応援（ステータス）| ✅ 有効 |

**重要**: 攻撃を「受ける」ことは可能（HPは減る）

### 対象カード
| ID | 名前 | 種別 | 付与タイミング |
|----|------|------|--------------|
| 2068 | バインドミスト | スペル | マップ上 |
| 2057 | ディラニー | スペル | マップ上（MHP30以下全体） |
| 1050 | バインドウィップ | アイテム | 攻撃成功時 |
| 132 | ハイド | クリーチャー | マップ上（秘術） |
| 332 | ナイキー | クリーチャー | 攻撃成功時 |

### 実装箇所
| ファイル | 処理 |
|----------|------|
| `scripts/spells/spell_curse_battle.gd` | `has_battle_disable()`, `apply_battle_disable()`, `apply_to_all_creatures()`, `check_and_apply_on_attack_success()` |
| `scripts/game_flow/spell_phase_handler.gd` | 呪い付与（単体スペル）、全体効果の発動制御 |
| `scripts/game_flow/target_selection_helper.gd` | `get_all_creatures()` - 条件付き全クリーチャー取得 |
| `scripts/game_flow/item_phase_handler.gd` | アイテム・援護強制パス |
| `scripts/battle/battle_execution.gd` | 攻撃スキップ、攻撃成功時呪い付与 |

---

## データ構造

### クリーチャー呪い
```json
{
  "curse_type": "battle_disable",
  "name": "戦闘行動不可",
  "duration": -1,
  "params": {}
}
```

### スペル effect_parsed（単体）
```json
"effect_parsed": {
  "target_type": "land",
  "target_info": {
	"owner_filter": "any",
	"target_filter": "creature"
  },
  "effects": [{
	"effect_type": "battle_disable",
	"name": "戦闘行動不可",
	"duration": -1
  }]
}
```

### スペル effect_parsed（全体条件付き）
```json
"effect_parsed": {
  "target_type": "all_creatures",
  "target_info": {
	"condition": {
	  "condition_type": "mhp_check",
	  "operator": "<=",
	  "value": 30
	}
  },
  "effects": [{
	"effect_type": "battle_disable",
	"name": "戦闘行動不可",
	"duration": -1
  }]
}
```

### クリーチャー/アイテム（攻撃成功時）
```json
"effects": [{
  "effect_type": "on_attack_success_curse",
  "curse_type": "battle_disable",
  "name": "戦闘行動不可"
}]
```

---

## 実装タスク

### Phase 3: 戦闘制限呪い拡張（4スペル + 3クリーチャー秘術）

#### スペル

| ID | 名前 | curse_type | 効果 | 状態 |
|----|------|-----------|------|------|
| 2015 | エナジーフィールド | `magic_barrier` | 無効化[通常攻撃]、敵にG100を与える | ⏳ |
| 2055 | ディスエレメント | `land_effect_disable` | 地形効果無効 | ⏳ |
| 2108 | マスファンタズム | `hp_effect_disable` | HP効果無効（全領地） | ⏳ |
| 2114 | メタルフォーム | `metal_form` | 無効化[通常攻撃]、防具使用不可 | ⏳ |

#### クリーチャー（地形効果関連）

| ID | 名前 | 属性 | 効果 | タイプ | 状態 |
|----|------|-----|------|-------|------|
| 220 | スクリーマー | 地 | G40・敵に呪い"地形効果無効" | 秘術 | ⏳ |
| 224 | スプラウトリング | 地 | 火から地形効果を得る | 固有スキル | ⏳ |
| 316 | サーペントフライ | 風 | 水からも地形効果を得る | 固有スキル | ⏳ |
| 430 | ハーフリング | 無 | 全属性地形効果 | 固有スキル | ⏳ |
| 431 | ハイドビハインド | 無 | G40・自クリーチャーに呪い"地形効果" | 秘術 | ⏳ |

#### 実装チェックリスト

**共通**:
- [ ] SpellCurseBattle に新しい curse_type 追加
- [ ] spell_phase_handler.gd で効果処理
- [ ] JSONにeffect_parsed追加
- [ ] 秘術用spell_mystic.jsonに定義追加（9000番台）

---

**2055 ディスエレメント / 220 スクリーマー秘術（land_effect_disable）**:
- [ ] `has_land_effect_disable()` / `apply_land_effect_disable()` 追加
- [ ] ランドボーナス無効化 → battle_preparation で判定
- [ ] spell_1.json: 2055 effect_parsed 定義
- [ ] spell_mystic.json: 9010（スクリーマー秘術用）定義
- [ ] earth_1.json: スクリーマーにmystic_arts追加

**431 ハイドビハインド秘術（land_effect_grant）**:
- [ ] `apply_land_effect_grant()` 追加（地形効果を付与）
- [ ] spell_mystic.json: 9011 定義
- [ ] neutral_2.json: ハイドビハインドにmystic_arts追加

**地形効果拡張スキル（224, 316, 430）**:
- [ ] `get_extra_land_elements()` 追加（追加で地形効果を得る属性リスト）
- [ ] battle_preparation でランドボーナス計算時に判定
- [ ] 224 スプラウトリング: 火から地形効果 → `extra_land_elements: ["fire"]`
- [ ] 316 サーペントフライ: 水から地形効果 → `extra_land_elements: ["water"]`
- [ ] 430 ハーフリング: 全属性 → `extra_land_elements: ["fire", "water", "earth", "wind"]`
- [ ] 各クリーチャーJSONにability_parsed追加

---

**2015 エナジーフィールド（magic_barrier）**:
- [ ] `has_magic_barrier()` / `apply_magic_barrier()` 追加
- [ ] 無効化[通常攻撃] → battle_skill_processor で判定
- [ ] 敵にG100を与える → battle_execution で魔力移動
- [ ] spell_1.json: effect_parsed 定義

**2108 マスファンタズム（hp_effect_disable）**:
- [ ] `has_hp_effect_disable()` / `apply_hp_effect_disable()` 追加
- [ ] HP増減効果無効化 → battle_skill_processor で判定
- [ ] 全領地対象 → target_type: all_creatures
- [ ] spell_2.json: effect_parsed 定義

**2114 メタルフォーム（metal_form）**:
- [ ] `has_metal_form()` / `apply_metal_form()` 追加
- [ ] 無効化[通常攻撃] → battle_skill_processor で判定
- [ ] 防具使用不可 → item_phase_handler で判定
- [ ] spell_2.json: effect_parsed 定義

---

## 変更履歴

| 日付 | Ver | 内容 |
|------|-----|------|
| 2025/11/26 | 1.0 | 初版 |
| 2025/11/26 | 2.0 | battle_disable 実装完了 |
| 2025/11/26 | 2.1 | SpellCurseBattleクラス追加、ファイルパス修正 |
| 2025/11/27 | 2.2 | 全体ターゲット処理をTargetSelectionHelper.get_all_creatures()に委譲 |
| 2025/11/30 | 2.3 | Phase 3タスク追加（スペル4種 + クリーチャー秘術3種） |
