# ゴブリンズレア実装ガイド - プレイヤー位置判定

**対象**: スペル ID 2028「ゴブリンズレア」  
**条件**: 使用者が空き地に停止しているか判定  
**処理タイミング**: スペル発動時（SpellPhaseHandler.gd）

---

## 判定ロジック

### 1. プレイヤーの現在位置を取得

```gdscript
var player_id = player_system.current_player_index  # または呼び出し元から取得
var current_tile = player_system.get_player_position(player_id)  # tile_index を返す
```

**データソース**:
- `PlayerSystem.players[player_id].current_tile` - 現在位置（tile_index）
- `PlayerSystem.get_player_position(player_id)` - ラッパーメソッド

**更新タイミング**:
- MovementController3D が移動完了時に更新
- スペル発動時点で最新値

---

### 2. 現在地のタイルが空き地か確認

```gdscript
var tile = board_system.tile_nodes[current_tile]
var is_empty = tile.creature_data.is_empty()  # true = 空き地, false = クリーチャーあり
```

**データソース**:
- `BaseTile.creature_data` - Dictionary（空のDictionaryなら空き地）
- クリーチャーデータは CreatureManager により管理

**チェック方法**:
```gdscript
# ✅ 推奨: is_empty() メソッド使用
var is_empty = tile.creature_data.is_empty()

# ✅ 代替: has_creature フラグ
var has_creature = tile.get("has_creature", false)

# ❌ 避けるべき: creature_id チェック（NULLチェック不確実）
```

---

## スペル発動フロー

### ゴブリンズレア（条件付き配置）

```
スペル発動要求
  ├─ 1. プレイヤー位置を取得
  │   └─ player_system.get_player_position(current_player_index)
  │
  ├─ 2. そのタイルが空き地か確認
  │   └─ tile_nodes[current_tile].creature_data.is_empty()
  │
  ├─ YES → クリーチャー配置成功
  │   ├─ place_creature(current_tile, creature_data, current_player_index)
  │   └─ スペルUIを非表示
  │
  └─ NO → 効果なし（クリーチャーあり）
      └─ スペルUIを非表示
      
  ┌─────────────────────────
  └─→ 最後に復帰[手札]実行（成功・失敗問わず）
      └─ spell_card を手札に戻す
```

---

## 実装パターン（SpellCreaturePlaceクラス内）

```gdscript
func place_creature_conditional(
    board_system: BoardSystem3D,
    player_system: PlayerSystem,
    player_id: int,
    creature_id: int
) -> bool:
    """条件付き配置（ゴブリンズレア用）"""
    
    # 1. プレイヤー位置を取得
    var current_tile = player_system.get_player_position(player_id)
    if current_tile < 0:
        print("[警告] プレイヤー位置が取得できません")
        return false
    
    # 2. 空き地判定
    var tile = board_system.tile_nodes.get(current_tile)
    if not tile:
        print("[警告] タイルが見つかりません: ", current_tile)
        return false
    
    if not tile.creature_data.is_empty():
        print("[条件判定] 失敗 - タイル%dにはクリーチャーが配置されています" % current_tile)
        return false  # 条件不成立（効果なし）
    
    # 3. クリーチャー配置（条件成立）
    print("[条件判定] 成功 - タイル%dは空き地です" % current_tile)
    place_creature_direct(board_system, current_tile, creature_id, player_id)
    return true  # 条件成立（配置成功）
    
    # 注: 成功・失敗問わず、呼び出し元で復帰[手札]を実行
```

---

## 関連ファイル

| ファイル | 役割 |
|---------|------|
| `scripts/player_system.gd` | プレイヤー位置管理（current_tile） |
| `scripts/board_system_3d.gd` | タイル・クリーチャー管理（tile_nodes） |
| `scripts/game_flow/spell_phase_handler.gd` | スペル発動制御（条件チェック箇所） |
| `scripts/spells/spell_creature_place.gd` | 配置処理実装（新規作成） |
| `data/spell_1.json` | スペル定義（return_to_hand） |

---

## 注意事項

### ⚠️ 空き地判定の信頼性

`creature_data.is_empty()` は CreatureManager により厳密に管理されるため、信頼性が高い。

**SSoT（Single Source of Truth）**:
- 唯一の情報源: `CreatureManager.creatures[tile_index]`
- 同期元: `BaseTile.creature_data` → CreatureManager.set_data() 経由

### ⚠️ タイミングの確認

ゴブリンズレアの発動タイミング：
- 移動完了直後 → プレイヤー位置が確定
- タイル着地処理中 → 位置は最新

**実装位置**:
- SpellPhaseHandler._execute_spell() 内で place_creature_conditional() を呼び出し
- 戻り値（成功/失敗）に関わらず、その後で return_to_hand 処理を実行

---

## テストケース

```
テスト1: 空き地停止時
  - プレイヤーがタイル5（空き地）に停止
  - ゴブリンズレア発動 → ゴブリン配置成功 → 手札に戻す
  期待結果: ✅ クリーチャー配置 + 手札復帰

テスト2: クリーチャー上停止時
  - プレイヤーがタイル3（敵クリーチャー）に停止
  - ゴブリンズレア発動 → 条件不成立（効果なし） → 手札に戻す
  期待結果: ❌ クリーチャー配置なし + 手札復帰

テスト3: 境界値
  - プレイヤーがタイル0（チェックポイント・空地）に停止
  - ゴブリンズレア発動
  期待結果: ✅ クリーチャー配置（チェックポイントは空地扱い）+ 手札復帰

テスト4: 配置可能タイルなし
  - プレイヤーが全タイルにクリーチャーが配置済みの盤面で移動
  - ゴブリンズレア発動（稀有なケース）
  期待結果: ⚠️ 「配置可能なタイルがありません」メッセージ表示 + 手札復帰
```

---

## 実装時の参考

**SpellCreaturePlaceクラスから呼ばれる処理フロー（SpellPhaseHandler内）**:

```gdscript
# ゴブリンズレアの処理
var spell_id = 2028
var creature_id = 414  # ゴブリン

# 条件判定 + 配置
var success = spell_creature_place.place_creature_conditional(
    board_system, player_system, current_player_id, creature_id
)

# 成功・失敗問わず復帰[手札]を実行
spell_creature_place.return_to_hand(spell_card, current_player_id, card_system)

# UI更新（呼び出し元で処理）
if not success:
    ui_manager.show_message("配置可能なタイルがありません")
```