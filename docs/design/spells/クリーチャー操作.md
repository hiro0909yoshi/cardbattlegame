# クリーチャー移動システム

**バージョン**: 2.0  
**最終更新**: 2025年11月29日  
**ステータス**: 実装完了

---

## 概要

クリーチャーをマップ上で移動させるスペル・アルカナアーツのシステム。移動時は呪いが消滅する。

---

## 実装済みスペル・アルカナアーツ

### スペル

| ID | 名前 | 効果 | 効果タイプ |
|----|------|------|-----------|
| 2002 | アウトレイジ | 対象クリーチャーを隣接敵ドミニオに移動 | `move_to_adjacent_enemy` |
| 2006 | イモビライズ | 全ドミニオに移動不可呪い付与 | `creature_curse` |
| 2045 | スピリットウォーク | 対象ドミニオに遠隔移動呪い付与 | `creature_curse` |
| 2052 | チャリオット | 自クリーチャーを2マス移動；復帰[ブック] | `move_steps` |

### アルカナアーツ

| ID | クリーチャー | 効果 | 効果タイプ |
|----|-------------|------|-----------|
| 10 | クリーピングフレイム | 30EP・1マス移動（防御型） | `move_self` |
| 21 | デスリーチ | 80EP・HP減少+ダウンした敵を破壊し移動 | `destroy_and_move` |
| 218 | ジャングラバー | 30EP・敵に移動不可呪い付与 | `creature_curse` |
| 28 | バードメイデン | 50EP・自クリーチャーに遠隔移動呪い付与 | `creature_curse` |
| 322 | スレイプニール | 60EP・自クリーチャーを1~2マス移動 | `move_steps` |

---

## 呪いシステム

### 移動不可呪い（move_disable）

- **付与**: ジャングラバーアルカナアーツ（spell_id: 9013）
- **効果**: 通常移動・スペル/アルカナアーツ移動すべて不可
- **チェック箇所**:
  - MovementHelper: 通常移動時
  - SpellCreatureMove: スペル/アルカナアーツ移動時
  - TargetSelectionHelper: 移動系スペルの対象選択時（`can_move: true`）
  - SpellMysticArts: 移動系アルカナアーツの使用可否

### 遠隔移動呪い（remote_move）

- **付与**: バードメイデンアルカナアーツ（spell_id: 9014）
- **効果**: ドミニオオーダーで全空き地に移動可能
- **チェック箇所**: MovementHelper._detect_move_type()

### 呪い消滅

移動すると呪いは消滅する。処理箇所：
- LandActionHelper.confirm_move(): ドミニオオーダー移動時
- SpellCreatureMove._execute_move(): スペル/アルカナアーツ移動時
- MovementHelper.execute_creature_move(): 汎用移動時

---

## 処理フロー

### 空き地への移動

```
SpellCreatureMove._apply_move_*()
  → 移動先候補取得
  → 移動先選択UI
  → _execute_move()
	→ 呪い消滅
	→ クリーチャー移動
	→ ダウン状態設定
```

### 敵ドミニオへの移動（戦闘発生）

```
SpellCreatureMove._apply_move_*()
  → 移動先候補取得
  → 移動先選択UI
  → { trigger_battle: true } を返す

SpellPhaseHandler._apply_single_effect()
  → BattleSystem.execute_3d_battle_with_data(from_tile_index)

BattleSystem._apply_post_battle_effects()
  → 勝利: 移動先に配置、移動元削除
  → 敗北: 移動元のクリーチャー削除
  → 相打ち: 両方削除
```

---

## JSON定義

### アウトレイジ（2002）

```json
{
  "effect_parsed": {
	"target_type": "creature",
	"target_info": {
	  "owner_filter": "any",
	  "has_adjacent_enemy": true,
	  "can_move": true
	},
	"effects": [{ "effect_type": "move_to_adjacent_enemy" }]
  }
}
```

### チャリオット（2052）

```json
{
  "effect_parsed": {
	"target_type": "creature",
	"target_info": { "owner_filter": "own", "can_move": true },
	"return_to_deck": true,
	"effects": [{ "effect_type": "move_steps", "steps": 2, "exact_steps": true }]
  }
}
```

### クリーピングフレイムアルカナアーツ（10）

```json
{
  "ability_parsed": {
	"keywords": ["防御型", "アルカナアーツ"],
	"mystic_art": {
	  "name": "1マス移動",
	  "cost": 30,
	  "target_type": "self",
	  "effects": [{ "effect_type": "move_self", "steps": 1, "exclude_enemy_creatures": true }]
	}
  }
}
```

### デスリーチアルカナアーツ（21）

```json
{
  "ability_parsed": {
	"keywords": ["アルカナアーツ"],
	"mystic_art": {
	  "name": "破壊移動",
	  "cost": 80,
	  "target_type": "creature",
	  "target_info": { "owner_filter": "enemy", "hp_reduced": true, "is_down": true },
	  "effects": [{ "effect_type": "destroy_and_move" }]
	}
  }
}
```

### ジャングラバーアルカナアーツ（218）

```json
{
  "ability_parsed": {
	"keywords": ["防魔", "アルカナアーツ"],
	"mystic_art": { "name": "移動封じ", "cost": 30, "spell_id": 9013 }
  }
}
```

### バードメイデンアルカナアーツ（28）

```json
{
  "ability_parsed": {
	"keywords": ["不屈", "アルカナアーツ"],
	"mystic_art": { "name": "遠隔移動付与", "cost": 50, "spell_id": 9014 }
  }
}
```

### スレイプニールアルカナアーツ（322）

```json
{
  "ability_parsed": {
	"keywords": ["アルカナアーツ"],
	"mystic_art": {
	  "name": "1~2マス移動",
	  "cost": 60,
	  "target_type": "creature",
	  "target_info": { "owner_filter": "own", "can_move": true },
	  "effects": [{ "effect_type": "move_steps", "steps": 2, "exact_steps": false }]
	}
  }
}
```

---

## 関連ファイル

| ファイル | 役割 |
|---------|------|
| `scripts/spells/spell_creature_move.gd` | 移動効果の実装 |
| `scripts/game_flow/movement_helper.gd` | 移動先候補取得、呪いチェック |
| `scripts/game_flow/land_action_helper.gd` | ドミニオオーダー移動処理 |
| `scripts/spells/spell_mystic_arts.gd` | アルカナアーツの使用可否判定 |
| `scripts/game_flow/target_selection_helper.gd` | ターゲット選択時のフィルタリング |
| `data/spell_mystic.json` | 9013: 移動不可呪い、9014: 遠隔移動呪い |

---

## target_info条件一覧

| 条件 | 説明 |
|------|------|
| `can_move` | 移動不可呪いを持たないクリーチャーのみ |
| `has_adjacent_enemy` | 隣接敵ドミニオを持つクリーチャーのみ |
| `hp_reduced` | HPが最大値未満のクリーチャーのみ |
| `is_down` | ダウン状態のクリーチャーのみ |
| `exclude_enemy_creatures` | 敵クリーチャーがいるタイルを除外（防御型用） |

---

## 特記事項

- **チェックポイント・ワープ**: 通過可能だが停止不可
- **復帰[ブック]**: `return_to_deck: true`で使用後デッキに戻る
- **防御型の移動**: 敵クリーチャーがいるタイルには移動不可
- **アルカナアーツの2段階選択**: スレイプニールは移動対象→移動先の順で選択
