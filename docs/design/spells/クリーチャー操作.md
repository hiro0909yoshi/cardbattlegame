# クリーチャー操作（位置移動・交換）

**バージョン**: 1.2  
**最終更新**: 2025年11月29日

---

## 概要

マップ上のクリーチャーの位置を操作するスペル・秘術。「移動」と「交換」の2種類がある。

---

## 対象スペル・秘術一覧

### スペル（3個）

| ID | 名前 | 効果 | ステータス |
|----|------|------|-----------|
| 2002 | アウトレイジ | 対象クリーチャーを隣接する敵領地に移動させる | [ ] 未実装 |
| 2052 | チャリオット | 対象自クリーチャーを2マス移動させる；復帰[ブック] | [ ] 未実装 |
| 2126 | リリーフ | 2体の対象自クリーチャーを交換；復帰[ブック] | [ ] 未実装 |

### 秘術（4個）

| クリーチャー | ID | 秘術名 | 効果 | ステータス |
|-------------|-----|--------|------|-----------|
| クリーピングフレイム | 10 | 1マス移動 | 秘術[G30・1マス移動] | [ ] 未実装 |
| デスリーチ | 21 | 破壊移動 | 秘術[G80・HPが減少しダウンした対象クリーチャーを破壊し、そこに移動] | [ ] 未実装 |
| スレイプニール | 322 | 1~2マス移動 | 秘術[G60・対象自クリーチャーを1~2マス移動] | [ ] 未実装 |
| レムレース | 346 | クリーチャー交換 | 秘術[G50・対象敵手札のクリーチャーを1枚奪い、これが対象の手札に移動] | [x] 実装済み（手札交換） |

---

## 効果タイプ分類

### 1. 移動系（move_creature）

クリーチャーを別のタイルに移動させる。

| 効果タイプ | 説明 | 対象スペル/秘術 |
|-----------|------|----------------|
| `move_to_adjacent_enemy` | 隣接する敵領地に移動 | アウトレイジ |
| `move_steps` | 指定マス数移動 | チャリオット、スレイプニール秘術 |
| `move_self` | 自分自身を移動 | クリーピングフレイム秘術 |
| `destroy_and_move` | 条件付き破壊後、その場所に移動 | デスリーチ秘術 |

### 2. 交換系（swap_creatures）

2体のクリーチャーの位置を入れ替える。

| 効果タイプ | 説明 | 対象スペル |
|-----------|------|-----------|
| `swap_own_creatures` | 自クリーチャー2体を交換 | リリーフ |

### 3. 手札交換系（swap_creature）※実装済み

配置済みクリーチャーと手札クリーチャーを交換（秘術）。

| 効果タイプ | 説明 | 対象秘術 |
|-----------|------|---------|
| `swap_creature` | 手札のクリーチャーを交換 | レムレース |

---

## 設計検討：クラス構成

### 案1: 単一クラス（SpellCreatureMove）

```
SpellCreatureMove
├── move_to_adjacent_enemy()  # アウトレイジ
├── move_steps()              # チャリオット
└── swap_own_creatures()      # リリーフ
```

**メリット**: 
- シンプル、ファイル数が少ない
- 移動も交換も「クリーチャー位置操作」という共通概念

**デメリット**: 
- クラスが肥大化する可能性

### 案2: 分離クラス

```
SpellCreatureMove    # 移動専用
├── move_to_adjacent_enemy()
└── move_steps()

SpellCreatureSwap    # 交換専用
└── swap_own_creatures()
```

**メリット**: 
- 単一責任の原則
- 将来的な拡張に対応しやすい

**デメリット**: 
- ファイル数が増える
- 3個のスペルに対して2クラスは過剰かもしれない

### 推奨: 案1（単一クラス）

対象スペルが3個と少なく、全て「クリーチャーの位置」に関する操作のため、単一クラスで十分。

---

## JSON定義案

### アウトレイジ（2002）

```json
{
  "id": 2002,
  "name": "アウトレイジ",
  "effect_parsed": {
    "target_type": "creature",
    "target_info": {
      "owner_filter": "any"
    },
    "effects": [
      {
        "effect_type": "move_to_adjacent_enemy",
        "description": "隣接する敵領地に移動"
      }
    ]
  }
}
```

### チャリオット（2052）

```json
{
  "id": 2052,
  "name": "チャリオット",
  "effect_parsed": {
    "target_type": "creature",
    "target_info": {
      "owner_filter": "own"
    },
    "effects": [
      {
        "effect_type": "move_steps",
        "steps": 2,
        "return_to_deck_on_fail": true
      }
    ]
  }
}
```

### リリーフ（2126）

```json
{
  "id": 2126,
  "name": "リリーフ",
  "effect_parsed": {
    "target_type": "creature_pair",
    "target_info": {
      "owner_filter": "own",
      "select_count": 2
    },
    "effects": [
      {
        "effect_type": "swap_own_creatures",
        "return_to_deck_on_fail": true
      }
    ]
  }
}
```

---

## 実装上の課題

### 1. 移動先の選択

- **アウトレイジ**: 隣接する敵領地が複数ある場合、どれを選ぶか
  - 案A: ランダム選択
  - 案B: プレイヤーが選択
  - 案C: 最初に見つかった敵領地

- **チャリオット**: 2マス移動の方向選択
  - マップの接続情報を利用
  - 移動可能な経路を列挙し、プレイヤーが選択

### 2. 復帰[ブック]条件

- **チャリオット**: 自クリーチャーがいない場合
- **リリーフ**: 自クリーチャーが2体未満の場合

### 3. 2体選択UI（リリーフ）

- 既存のターゲット選択UIを拡張
- 1体目選択 → 2体目選択 の2段階UI

### 4. BoardSystem3Dとの連携

- クリーチャー移動メソッドの確認
- 呪い消滅処理の連携（移動で呪いが消える）

---

## 依存関係

| 依存先 | 用途 |
|--------|------|
| BoardSystem3D | タイル情報、隣接タイル取得、クリーチャー移動 |
| **MovementHelper** | **移動先候補取得、移動実行（共通処理）** |
| CreatureManager | クリーチャーデータ管理 |
| SpellCurse | 移動時の呪い消滅処理 |
| TargetSelectionHelper | ターゲット選択UI |

---

## MovementHelperとの連携

### 概要

`scripts/helpers/movement_helper.gd`には、空地移動・敵地移動スキルで使用されている共通の移動処理が実装済み。スペル/秘術による強制移動でもこれを活用する。

**参照ドキュメント**: `docs/design/skills/vacant_move_skill.md`

### 既存メソッド

```gdscript
# 移動先候補取得（共通処理）
static func get_move_destinations(
    board_system: Node,
    creature_data: Dictionary,
    from_tile_index: int,
    move_type_override: String = ""  # スペルで強制的に移動タイプを指定
) -> Array

# 移動実行（共通処理）
static func execute_creature_move(
    board_system: Node,
    from_tile: int,
    to_tile: int,
    creature_data: Dictionary = {}
) -> void
```

### スペルからの呼び出し例

```gdscript
# チャリオット（2マス移動）
func execute_chariot(target_tile: int) -> void:
    var creature = board_system.tile_nodes[target_tile].creature_data
    # 移動先候補を取得（2マス移動用のタイプを指定）
    var destinations = MovementHelper.get_move_destinations(
        board_system, creature, target_tile, "two_tiles"
    )
    # UI表示して選択させた後、移動実行
    MovementHelper.execute_creature_move(
        board_system, target_tile, selected_destination
    )
```

### 新規実装が必要な移動タイプ

| move_type_override | 用途 | 実装状態 |
|-------------------|------|---------|
| `"vacant_move"` | 空地移動（属性制限あり） | [x] 実装済み |
| `"enemy_move"` | 敵地移動 | [x] 実装済み |
| `"adjacent"` | 隣接タイルのみ | [x] 実装済み |
| `"one_tile"` | 1マス移動（クリーピングフレイム） | [ ] 要追加 |
| `"two_tiles"` | 2マス移動（チャリオット、スレイプニール） | [ ] 要追加 |
| `"adjacent_enemy"` | 隣接する敵領地のみ（アウトレイジ） | [ ] 要追加 |

### execute_creature_move()の特徴

- **duplicate()を使わない**: base_up_ap/hp等のバフを保持
- **ダウン状態設定**: 不屈チェック含む
- **owner_id更新**: 移動元クリア、移動先設定

---

## 実装計画

### Phase 1: 基盤構築
- [x] `spell_creature_move.gd` クラス作成
- [x] 基本メソッド定義
- [x] MovementHelperに新規移動タイプ追加（`one_tile`, `two_tiles`, `adjacent_enemy`）
- [x] SpellPhaseHandlerへの統合

### Phase 2: アウトレイジ実装（スペル）
- [ ] `move_to_adjacent_enemy()` 実装
- [ ] MovementHelper連携（`adjacent_enemy`タイプ）
- [ ] JSON定義追加
- [ ] テスト

### Phase 3: チャリオット実装（スペル）
- [ ] `move_steps()` 実装
- [ ] MovementHelper連携（`two_tiles`タイプ）
- [ ] 移動先選択UI
- [ ] 復帰[ブック]処理
- [ ] JSON定義追加
- [ ] テスト

### Phase 4: リリーフ実装（スペル）
- [ ] `swap_own_creatures()` 実装
- [ ] 2体選択UI
- [ ] 復帰[ブック]処理
- [ ] JSON定義追加
- [ ] テスト

### Phase 5: 秘術の移動系実装
- [ ] クリーピングフレイム秘術（1マス移動・自己移動）
- [ ] スレイプニール秘術（1~2マス移動・対象移動）
- [ ] デスリーチ秘術（破壊+移動・特殊）

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025/11/29 | 1.0 | 初版作成 |
| 2025/11/29 | 1.1 | 秘術追加（クリーピングフレイム、デスリーチ、スレイプニール）、MovementHelper連携セクション追加 |
| 2025/11/29 | 1.2 | Phase 1完了（SpellCreatureMove作成、MovementHelper拡張、SpellPhaseHandler統合） |
