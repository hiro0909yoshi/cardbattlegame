# 刻印効果システム設計

**バージョン**: 2.0  
**最終更新**: 2025年12月16日

---

## 概要

複数ターンにわたって効果が持続する「刻印」システム。クリーチャー/プレイヤー/世界の3種類。

**現状**: ✅ **実装済み**。`scripts/spells/spell_curse.gd`で管理。関連モジュールとして`spell_curse_stat.gd`、`spell_curse_battle.gd`、`spell_curse_toll.gd`も実装済み。

---

## 刻印の種類

| 対象 | 保存場所 | 消滅条件 | 同時適用 |
|------|---------|---------|---------|
| **クリーチャー** | `creature_data.curse` | 移動、交換、撃破、ターン経過、上書き | 1つのみ（上書き） |
| **プレイヤー** | `player.curse` | ターン経過、上書き | 1つのみ（上書き） |
| **世界呪** | `GameFlowManager.world_curse` | ターン経過、上書き | 1つのみ（上書き） |

**重要**: 
- **土地刻印は廃止** → クリーチャー刻印として実装
- クリーチャー刻印は**移動で消える**
- プレイヤー/世界呪は移動で消えない
- 全ての刻印は**上書きで消える**（同じ対象には1つのみ）

---

## ターゲットタイプ

刻印スペルの対象指定方法：

| ターゲットタイプ | 対応する刻印 | 選択UI | 例 |
|----------------|-----------|--------|-----|
| `creature` | クリーチャー刻印（タイル指定） | 上下キー選択 | グリード（通行料倍率） |
| `land` | クリーチャー刻印（タイル指定） | 上下キー選択 | ピース（安寧） |
| `all_creatures` | 全クリーチャー（条件付き） | なし（自動適用） | ディラニー（MHP30以下） |
| `player` | プレイヤー刻印 | 上下キー選択 または `self` | ドリームトレイン（`self`指定） |
| `world` | 世界呪 | なし | 太陽 |

**セルフターゲット** (`target_filter: "self"`):
- ターゲット選択UI なし
- 使用者自身に自動適用
- 例: ドリームトレイン、ジャーニー
- 実装: `target_type: "player"` + `target_filter: "self"`

**全体ターゲット** (`target_type: "all_creatures"`):
- ターゲット選択UI なし
- 条件に合致する全クリーチャーに自動適用
- 実装:
  - `TargetSelectionHelper.get_all_creatures()` で条件付きクリーチャー取得（汎用）
  - 各spellモジュールで効果適用（刻印、ダメージ等）
- 条件例:
  ```json
  "target_info": {
	"condition": {
	  "condition_type": "mhp_check",
	  "operator": "<=",
	  "value": 30
	}
  }
  ```
- 使用例:
  ```gdscript
  var targets = TargetSelectionHelper.get_all_creatures(board_system, condition)
  for target in targets:
	  # target = {tile_index: int, creature: Dictionary}
	  SpellCurseBattle.apply_battle_disable(target.creature, "消沈")
  ```

---

## データ構造

### 基本構造

```gdscript
{
  "curse_type": "dice_fixed",     # 刻印タイプ（識別子）
  "name": "ダイス6",              # 表示名
  "duration": 1,                  # 残りターン数（-1=無期限）
  "params": {                     # 効果パラメータ
	"value": 6
  }
}
```

### 保存場所（確定）

```gdscript
# クリーチャー刻印
# CreatureManagerが管理する各クリーチャー辞書に追加
creature_data["curse"] = {...}  # 単一オブジェクト（辞書）

# プレイヤー刻印
# PlayerSystemが管理するPlayerDataクラスのプロパティ
player_system.players[player_id].curse = {...}  # 単一オブジェクト（クラスプロパティ）

# 世界呪
# GameFlowManagerのgame_stats辞書に追加
game_stats["world_curse"] = {...}  # 単一オブジェクト
```

**参照**:
- CreatureManager: クリーチャーデータ管理（`docs/design/tile_creature_separation_plan.md`参照）
- 破壊カウント: `game_stats["total_creatures_destroyed"]`（同じ辞書）
- HP管理構造: `docs/design/hp_structure.md`
- 効果システム: `docs/design/effect_system.md`

### duration の扱い（確定）

- `duration > 0`: 指定ターン数で消滅（ターン終了時にカウントダウン）
- `duration = 0`: 即座に消滅（通常は使用しない）
- `duration = -1`: 無期限（上書きされるまで持続）

**処理タイミング**:
- カウントダウン: `GameFlowManager.end_turn()` 内で実行
- 消滅判定: `duration == 0` になった時点で削除

**例**:
- 2100: ホーリーワード6 → `duration: 1`（1ターン後に消える）
- 2072: 安寧 → `duration: -1`（無期限）

---

## 刻印タイプ一覧

### クリーチャー刻印（実装済み）

| curse_type | 名前 | 効果 | params |
|-----------|------|------|--------|
| `stat_boost` | 暁光 | AP&HP+20 | `value: 20` ✅ |
| `stat_reduce` | 衰月 | AP&HP-20 | `value: -20` ✅ |
| `skill_nullify` | 錯乱 | スキル無効化 | - ✅ |
| `battle_disable` | 消沈 | 戦闘不可 | - ✅ |
| `ap_nullify` | AP=0 | APを0にする | - ✅ |
| `mystic_grant` | アルカナアーツ付与 | アルカナアーツを付与 | `spell_id`, `cost` ✅ |
| `random_stat` | 狂星 | AP&HPランダム化 | `min`, `max` ✅ |
| `command_growth` | 昇華 | LvUP/地形変化でMHP+20 | `hp_bonus: 20` ✅ |
| `plague` | 衰弱 | 戦闘終了時HP -= MHP/2 | - ✅ |
| `bounty` | 賞金 | 武器破壊時に術者がG獲得 | `reward`, `caster_id` ✅ |
| `land_trap` | 土地刻印 | 敵停止時に発動 | `curse_effects` ✅ |
| `forced_stop` | 停滞 | 移動中のプレイヤーを拘束 | `uses_remaining` ✅ |
| `indomitable` | 奮闘 | ダウン状態にならない | - ✅ |
| `land_effect_disable` | 暗転 | 地形効果を無効化 | - ✅ |
| `land_effect_grant` | 恩寵 | 指定属性の地形効果を付与 | `grant_elements` ✅ |
| `metal_form` | メタルフォーム | 巻物無効化 | - ✅ |
| `magic_barrier` | マジックバリア | スペル対象にならない | - ✅ |
| `destroy_after_battle` | 崩壊 | 戦闘後に自滅 | - ✅ |
| `toll_multiplier` | 通行料倍率 | 通行料×倍率 | `multiplier` ✅ |
| `peace` | 安寧 | 休戦+通行料0 | - ✅ |
| `immobilize` | 枷 | 移動・交換不可 | - ✅ |

### プレイヤー刻印（実装済み）

| curse_type | 名前 | params | 実装場所 |
|-----------|------|--------|---------|
| `dice_fixed` | ダイス固定 | `value: 6` | ダイスシステム ✅ |
| `dice_range` | ダイス範囲 | `min: 6, max: 8` | ダイスシステム ✅ |
| `dice_range_magic` | 範囲+EP | `min: 2, max: 4, magic: 50` | ダイスシステム ✅ |
| `protection` | 結界 | - | SpellPhaseHandler ✅ |
| `toll_disable` | 免罪 | - | MovementController ✅ |
| `toll_share` | 通行料共有 | `ratio: 0.5`, `caster_id` | MovementController ✅ |
| `toll_fixed` | 通行料固定 | `value: 200` | MovementController ✅ |

### 世界呪（実装済み）

| curse_type | 名前 | params | 実装場所 |
|-----------|------|--------|---------|
| `cost_increase` | 太陽 | `multiplier: 1.5` | CardSystem ✅ |
| `summon_free` | 愚者 | - | BoardSystem3D ✅ |
| `invasion_disable` | 休戦 | - | BoardSystem3D ✅ |

---

## 実装方針（確定）

### SpellCurse クラス設計

**ファイル**: `scripts/spells/spell_curse.gd`

```gdscript
class_name SpellCurse

# 参照（確定）
var board_system: BoardSystem3D
var creature_manager: CreatureManager
var player_system: PlayerSystem
var game_flow_manager: GameFlowManager

# 初期化（GameFlowManager._ready()で呼ばれる）
func setup(board: BoardSystem3D, creature: CreatureManager, player: PlayerSystem, flow: GameFlowManager):
	board_system = board
	creature_manager = creature
	player_system = player
	game_flow_manager = flow
	
	print("[SpellCurse] 初期化完了")
```

### 重要な実装の違い

**クリーチャーデータ vs プレイヤーデータ**:

| 対象 | データ型 | アクセス方法 | 判定方法 | 理由 |
|------|---------|------------|---------|------|
| **クリーチャー** | Dictionary | `creature["curse"]` | `creature.has("curse")` | 辞書として管理 |
| **プレイヤー** | PlayerData (class) | `player.curse` | `not player.curse.is_empty()` | クラスプロパティ |

**注意**: PlayerDataはクラスなので、辞書の`has()`や`erase()`メソッドは使えません。

### 統合ポイント（確定）

#### 1. GameFlowManager統合
```gdscript
# GameFlowManager._ready()
spell_curse = SpellCurse.new()
spell_curse.setup(board_system, creature_manager, player_system, self)

# GameFlowManager.end_turn()
spell_curse.update_all_curses()  # ターン経過処理
```

#### 2. BoardSystem3D統合（移動時削除）
```gdscript
# BoardSystem3D.move_creature()
# 移動開始時に刻印を削除
if spell_curse:
	spell_curse.remove_curse_from_creature(from_tile)
```

#### 3. BattlePreparation統合（刻印適用）
```gdscript
# battle_preparation.gd
func prepare_participants(...):
	# ... 既存処理 ...
	
	# クリーチャー刻印を適用
	if spell_curse:
		_apply_creature_curse(attacker, attacker_tile_index)
		_apply_creature_curse(defender, defender_tile_index)
```

#### 4. ログ出力（確定）
- 刻印付与時: `print("[刻印付与] ", curse_name, " → ", target_name)`
- 刻印消滅時: `print("[刻印消滅] ", curse_name, " (duration=0)")`
- 刻印上書き時: `print("[刻印上書き] ", old_curse, " → ", new_curse)`


#### クリーチャー刻印

```gdscript
func curse_creature(tile_index: int, curse_type: String, duration: int = -1, params: Dictionary = {}):
	var creature = creature_manager.get_data_ref(tile_index)  # ← get_data_ref() を使用
	if creature.is_empty():  # ← 空辞書チェック
		return
	
	# 上書き（1つのみ）
	creature["curse"] = {
		"curse_type": curse_type,
		"name": params.get("name", ""),
		"duration": duration,
		"params": params
	}

func get_creature_curse(tile_index: int) -> Dictionary:
	var creature = creature_manager.get_data_ref(tile_index)  # ← get_data_ref() を使用
	if creature:
		return creature.get("curse", {})
	return {}

func remove_curse_from_creature(tile_index: int):
	var creature = creature_manager.get_data_ref(tile_index)  # ← get_data_ref() を使用
	if creature and creature.has("curse"):
		creature.erase("curse")
```

**注意**: CreatureManagerは`get_data_ref()`メソッドを使用します（`get_data()`は存在しません）。

#### プレイヤー刻印

```gdscript
func curse_player(player_id: int, curse_type: String, duration: int = -1, params: Dictionary = {}):
	var player = player_system.players[player_id]
	
	# 上書き（1つのみ）
	player.curse = {  # ← プロパティアクセス（辞書アクセスではない）
		"curse_type": curse_type,
		"name": params.get("name", ""),
		"duration": duration,
		"params": params
	}

func get_player_curse(player_id: int) -> Dictionary:
	return player_system.players[player_id].curse  # ← プロパティアクセス

func remove_curse_from_player(player_id: int):
	var player = player_system.players[player_id]
	if not player.curse.is_empty():  # ← has() ではなく is_empty() を使用
		player.curse = {}  # ← erase() ではなく空辞書を代入
```

**注意**: PlayerDataはクラスなので、`player["curse"]`や`player.has()`は使えません。

#### 世界呪

```gdscript
func curse_world(curse_type: String, duration: int = 6, params: Dictionary = {}):
	# 上書き（1つのみ）
	game_flow_manager.world_curse = {
		"curse_type": curse_type,
		"name": params.get("name", ""),
		"duration": duration,
		"params": params
	}

func get_world_curse() -> Dictionary:
	return game_flow_manager.get("world_curse", {})

func remove_world_curse():
	if game_flow_manager.has("world_curse"):
		game_flow_manager.erase("world_curse")
```

### 使用例

```gdscript
# バイタリティ（暁光、5ターン）
spell_curse.curse_creature(tile_index, "stat_boost", 5, {
	"name": "バイタリティ",
	"value": 20
})

# ホーリーワード6（ダイス固定、1ターン）
spell_curse.curse_player(player_id, "dice_fixed", 1, {
	"name": "ダイス6",
	"value": 6
})

# 太陽（世界呪、6ターン）
spell_curse.curse_world("cost_increase", 6, {
	"name": "太陽",
	"multiplier": 1.5
})

# 安寧（無期限）
spell_curse.curse_creature(tile_index, "peace", -1, {
	"name": "安寧"
})
```

**実装上の注意点まとめ**:

1. **CreatureManager**: `get_data_ref()` を使用（`get_data()`は存在しない）
2. **クリーチャーデータ**: Dictionary → `has()`, `erase()` が使える
3. **PlayerData**: クラス → プロパティアクセス `.curse` のみ、`has()`や`erase()`は使えない
4. **判定**: クラスは `not player.curse.is_empty()` を使用
5. **削除**: クラスは `player.curse = {}` で空辞書を代入

---

## ターン経過処理

### GameFlowManager統合

```gdscript
# GameFlowManager.end_turn()内
func end_turn():
	# 既存処理...
	
	# 刻印 duration 減算
	if spell_curse:
		spell_curse.update_all_curses()
	
	# プレイヤー切り替え...
```

### SpellCurse.update_all_curses()

```gdscript
func update_all_curses():
	# クリーチャー刻印（辞書なのでhas()が使える）
	for tile_index in range(20):  # 0-19の全タイル
		var creature = creature_manager.get_data_ref(tile_index)
		if creature and creature.has("curse"):
			_update_curse_duration(creature.curse)
			if creature.curse.get("duration", 0) == 0:
				creature.erase("curse")
	
	# プレイヤー刻印（クラスなのでプロパティアクセス）
	for player in player_system.players:
		if not player.curse.is_empty():  # ← has() ではなく is_empty()
			_update_curse_duration(player.curse)
			if player.curse.get("duration", 0) == 0:
				player.curse = {}  # ← erase() ではなく空辞書を代入
	
	# 世界呪（辞書なのでhas()が使える）
	if game_flow_manager.game_stats.has("world_curse"):
		_update_curse_duration(game_flow_manager.game_stats["world_curse"])
		if game_flow_manager.game_stats["world_curse"].get("duration", 0) == 0:
			game_flow_manager.game_stats.erase("world_curse")

func _update_curse_duration(curse: Dictionary):
	var duration = curse.get("duration", -1)
	if duration > 0:
		curse["duration"] = duration - 1
```

---

## バトルシステム統合

### battle_preparation.gdでの刻印適用

```gdscript
func prepare_participants(...):
	# ... 既存処理 ...
	
	# クリーチャー刻印を適用
	if spell_curse:
		_apply_creature_curse(attacker, attacker_tile_index)
		_apply_creature_curse(defender, defender_tile_index)

func _apply_creature_curse(participant: BattleParticipant, tile_index: int):
	var curse = spell_curse.get_creature_curse(tile_index)
	if curse.is_empty():
		return
	
	var curse_type = curse.get("curse_type", "")
	var params = curse.get("params", {})
	
	match curse_type:
		"stat_boost":
			var value = params.get("value", 20)
			participant.temporary_bonus_hp += value
			participant.temporary_bonus_ap += value
		
		"stat_reduce":
			var value = params.get("value", -20)
			participant.temporary_bonus_hp += value
			participant.temporary_bonus_ap += value
		
		"battle_disable":
			participant.can_attack = false
```

### BoardSystem3Dでの移動時削除

```gdscript
func move_creature(from_tile: int, to_tile: int):
	# クリーチャー移動処理...
	
	# クリーチャー刻印を削除
	if spell_curse:
		spell_curse.remove_curse_from_creature(from_tile)
```

---

## 各システムでの刻印判定

### ダイスシステム

```gdscript
func roll_dice(player_id: int) -> int:
	var curse = spell_curse.get_player_curse(player_id)
	
	# ダイス固定
	if curse.get("curse_type") == "dice_fixed":
		return curse.get("params", {}).get("value", 6)
	
	# ダイス範囲
	if curse.get("curse_type") == "dice_range":
		var min_val = curse.get("params", {}).get("min", 1)
		var max_val = curse.get("params", {}).get("max", 6)
		return randi() % (max_val - min_val + 1) + min_val
	
	# 通常処理
	return randi() % 6 + 1
```

### SpellPhaseHandler（結界）

```gdscript
func can_target_player(player_id: int) -> bool:
	var curse = spell_curse.get_player_curse(player_id)
	if curse.get("curse_type") == "protection":
		return false
	return true
```

### CardSystem（太陽）

```gdscript
func get_spell_cost(spell_card: Dictionary) -> int:
	var cost = spell_card.get("cost", {}).get("mp", 0)
	
	var curse = spell_curse.get_world_curse()
	if curse.get("curse_type") == "cost_increase":
		var multiplier = curse.get("params", {}).get("multiplier", 1.0)
		cost = int(cost * multiplier)
	
	return cost
```

---

## 実装状況

### Phase 1: 基盤構築 ✅ 完了

- [x] `spell_curse.gd` クラス作成
- [x] GameFlowManager統合（setup, update_all_curses）
- [x] 基本メソッド実装
  - [x] `curse_creature()` - クリーチャー刻印付与
  - [x] `curse_player()` - プレイヤー刻印付与
  - [x] `curse_world()` - 世界呪付与
  - [x] `get_creature_curse()` - 取得
  - [x] `get_player_curse()` - 取得
  - [x] `get_world_curse()` - 取得
  - [x] `remove_curse_from_creature()` - 削除
  - [x] `update_all_curses()` - ターン経過処理
  - [x] `update_player_curse()` - 個別プレイヤー刻印更新
  - [x] `trigger_command_growth()` - 昇華トリガー

### Phase 2: クリーチャー刻印の統合 ✅ 完了

- [x] battle_preparation.gd統合（刻印適用）
- [x] BoardSystem3D統合（移動時削除）
- [x] `apply_effect()` - 汎用エフェクト適用
- [x] `apply_to_all_creatures()` - 全クリーチャー対象刻印

### Phase 3: プレイヤー刻印の実装 ✅ 完了

- [x] ダイスシステム統合
- [x] 通行料刻印統合（spell_curse_toll.gd）

### Phase 4: 世界呪の実装 ✅ 完了

- [x] CardSystem統合（コスト計算）
- [x] 休戦/愚者

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025/11/12 | 1.0 | 初版作成 |
| 2025/11/12 | 1.3 | 実装状況確認、完全未実装と判明 |
| 2025/11/12 | 1.4 | 実装仕様確定 - 保存場所、統合ポイント、優先度を明確化 |
| 2025/11/12 | 1.5 | 実装後の修正 - PlayerDataクラスとCreatureManager辞書の違いを明記 |
| 2025/12/16 | 2.0 | 実装完了を反映 - 全刻印タイプ一覧更新、Phase全完了 |

---

**作成日**: 2025年11月12日  
**最終更新**: 2025年12月16日（v2.0）
