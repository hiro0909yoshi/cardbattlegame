# 呪い効果システム設計

**バージョン**: 1.3  
**最終更新**: 2025年11月12日

---

## 概要

複数ターンにわたって効果が持続する「呪い」システム。クリーチャー/プレイヤー/世界の3種類。

**現状**: 完全に未実装。BattleParticipantに変数定義のみ存在（計算式の骨組みあり）。

---

## 呪いの種類

| 対象 | 保存場所 | 消滅条件 | 同時適用 |
|------|---------|---------|---------|
| **クリーチャー** | `creature_data.curse` | 移動、交換、撃破、ターン経過、上書き | 1つのみ（上書き） |
| **プレイヤー** | `player.curse` | ターン経過、上書き | 1つのみ（上書き） |
| **世界呪** | `GameFlowManager.world_curse` | ターン経過、上書き | 1つのみ（上書き） |

**重要**: 
- **土地呪いは廃止** → クリーチャー呪いとして実装
- クリーチャー呪いは**移動で消える**
- プレイヤー/世界呪は移動で消えない
- 全ての呪いは**上書きで消える**（同じ対象には1つのみ）

---

## データ構造

### 基本構造

```gdscript
{
  "curse_type": "dice_fixed",     # 呪いタイプ（識別子）
  "name": "ダイス6",              # 表示名
  "duration": 1,                  # 残りターン数（-1=無期限）
  "params": {                     # 効果パラメータ
    "value": 6
  }
}
```

### 保存場所

```gdscript
# クリーチャー呪い（新規）
creature_data["curse"] = {...}  # 単一オブジェクト

# プレイヤー呪い（新規）
player.curse = {...}  # 単一オブジェクト

# 世界呪（新規）
GameFlowManager.world_curse = {...}  # 単一オブジェクト
```

### duration の扱い

- `duration > 0`: 指定ターン数で消滅
- `duration = -1`: 無期限（上書きされるまで持続）
- 例：2072 平和 → `duration: -1`

---

## 呪いタイプ一覧

### クリーチャー呪い（要実装）

| curse_type | 名前 | 効果 | params |
|-----------|------|------|--------|
| `stat_boost` | 能力値+20 | ST&HP+20 | `value: 20` |
| `stat_reduce` | 能力値-20 | ST&HP-20 | `value: -20` |
| `battle_disable` | 戦闘行動不可 | 戦闘不可 | - |
| `immobilize` | 移動不可 | 移動・交換不可 | - |
| `weakness` | 衰弱 | 戦闘終了時HP減少 | `damage_percent: 50` |

### プレイヤー呪い（要実装）

| curse_type | 名前 | params | 実装場所 |
|-----------|------|--------|---------|
| `dice_fixed` | ダイス固定 | `value: 6` | ダイスシステム |
| `dice_range` | ダイス範囲 | `min: 6, max: 8` | ダイスシステム |
| `protection` | 防魔 | - | SpellPhaseHandler |
| `toll_disable` | 通行料無効 | - | BoardSystem3D |

### 世界呪（要実装）

| curse_type | 名前 | params | 実装場所 |
|-----------|------|--------|---------|
| `cost_increase` | コスト上昇 | `multiplier: 1.5` | CardSystem |
| `summon_free` | 召喚条件解除 | - | BoardSystem3D |
| `invasion_disable` | 侵略不可 | - | BoardSystem3D |

---

## 実装方針

### SpellCurse クラス設計

```gdscript
class_name SpellCurse

# 参照
var board_system: BoardSystem3D
var creature_manager: CreatureManager
var player_system: PlayerSystem
var game_flow_manager: GameFlowManager

# 初期化
func setup(board: BoardSystem3D, creature: CreatureManager, player: PlayerSystem, flow: GameFlowManager):
    board_system = board
    creature_manager = creature
    player_system = player
    game_flow_manager = flow
```

#### クリーチャー呪い

```gdscript
func curse_creature(tile_index: int, curse_type: String, duration: int = -1, params: Dictionary = {}):
    var creature = creature_manager.get_data(tile_index)
    if not creature:
        return
    
    # 上書き（1つのみ）
    creature["curse"] = {
        "curse_type": curse_type,
        "name": params.get("name", ""),
        "duration": duration,
        "params": params
    }

func get_creature_curse(tile_index: int) -> Dictionary:
    var creature = creature_manager.get_data(tile_index)
    if creature:
        return creature.get("curse", {})
    return {}

func remove_curse_from_creature(tile_index: int):
    var creature = creature_manager.get_data(tile_index)
    if creature and creature.has("curse"):
        creature.erase("curse")
```

#### プレイヤー呪い

```gdscript
func curse_player(player_id: int, curse_type: String, duration: int = -1, params: Dictionary = {}):
    var player = player_system.players[player_id]
    
    # 上書き（1つのみ）
    player["curse"] = {
        "curse_type": curse_type,
        "name": params.get("name", ""),
        "duration": duration,
        "params": params
    }

func get_player_curse(player_id: int) -> Dictionary:
    return player_system.players[player_id].get("curse", {})

func remove_curse_from_player(player_id: int):
    var player = player_system.players[player_id]
    if player.has("curse"):
        player.erase("curse")
```

#### 世界呪

```gdscript
func curse_world(curse_type: String, duration: int = 6, params: Dictionary = {}):
    # 上書き（1つのみ）
    game_flow_manager.world_curse = {
        "curse_type": curse_type,
        "name": params.get("name", ""),
        "duration": duration,
        "params": params
    }

func get_world_curse() -> Dictionary:
    return game_flow_manager.get("world_curse", {})

func remove_world_curse():
    if game_flow_manager.has("world_curse"):
        game_flow_manager.erase("world_curse")
```

### 使用例

```gdscript
# バイタリティ（能力値+20、5ターン）
spell_curse.curse_creature(tile_index, "stat_boost", 5, {
    "name": "バイタリティ",
    "value": 20
})

# ホーリーワード6（ダイス固定、1ターン）
spell_curse.curse_player(player_id, "dice_fixed", 1, {
    "name": "ダイス6",
    "value": 6
})

# コスト上昇（世界呪、6ターン）
spell_curse.curse_world("cost_increase", 6, {
    "name": "コスト上昇",
    "multiplier": 1.5
})

# 平和（無期限）
spell_curse.curse_creature(tile_index, "peace", -1, {
    "name": "平和"
})
```

---

## ターン経過処理

### GameFlowManager統合

```gdscript
# GameFlowManager.end_turn()内
func end_turn():
    # 既存処理...
    
    # 呪い duration 減算
    if spell_curse:
        spell_curse.update_all_curses()
    
    # プレイヤー切り替え...
```

### SpellCurse.update_all_curses()

```gdscript
func update_all_curses():
    # クリーチャー呪い
    for tile_index in board_system.tile_nodes.keys():
        var creature = creature_manager.get_data(tile_index)
        if creature and creature.has("curse"):
            _update_curse_duration(creature.curse)
            if creature.curse.get("duration", 0) == 0:
                creature.erase("curse")
    
    # プレイヤー呪い
    for player in player_system.players:
        if player.has("curse"):
            _update_curse_duration(player.curse)
            if player.curse.get("duration", 0) == 0:
                player.erase("curse")
    
    # 世界呪
    if game_flow_manager.has("world_curse"):
        _update_curse_duration(game_flow_manager.world_curse)
        if game_flow_manager.world_curse.get("duration", 0) == 0:
            game_flow_manager.erase("world_curse")

func _update_curse_duration(curse: Dictionary):
    var duration = curse.get("duration", -1)
    if duration > 0:
        curse["duration"] = duration - 1
```

---

## バトルシステム統合

### battle_preparation.gdでの呪い適用

```gdscript
func prepare_participants(...):
    # ... 既存処理 ...
    
    # クリーチャー呪いを適用
    if spell_curse:
        _apply_creature_curse(attacker, attacker_tile_index)
        _apply_creature_curse(defender, defender_tile_index)

func _apply_creature_curse(participant: BattleParticipant, tile_index: int):
    var curse = spell_curse.get_creature_curse(tile_index)
    if curse.is_empty():
        return
    
    var curse_type = curse.get("curse_type", "")
    var params = curse.get("params", {})
    
    match curse_type:
        "stat_boost":
            var value = params.get("value", 20)
            participant.temporary_bonus_hp += value
            participant.temporary_bonus_ap += value
        
        "stat_reduce":
            var value = params.get("value", -20)
            participant.temporary_bonus_hp += value
            participant.temporary_bonus_ap += value
        
        "battle_disable":
            participant.can_attack = false
```

### BoardSystem3Dでの移動時削除

```gdscript
func move_creature(from_tile: int, to_tile: int):
    # クリーチャー移動処理...
    
    # クリーチャー呪いを削除
    if spell_curse:
        spell_curse.remove_curse_from_creature(from_tile)
```

---

## 各システムでの呪い判定

### ダイスシステム

```gdscript
func roll_dice(player_id: int) -> int:
    var curse = spell_curse.get_player_curse(player_id)
    
    # ダイス固定
    if curse.get("curse_type") == "dice_fixed":
        return curse.get("params", {}).get("value", 6)
    
    # ダイス範囲
    if curse.get("curse_type") == "dice_range":
        var min_val = curse.get("params", {}).get("min", 1)
        var max_val = curse.get("params", {}).get("max", 6)
        return randi() % (max_val - min_val + 1) + min_val
    
    # 通常処理
    return randi() % 6 + 1
```

### SpellPhaseHandler（防魔）

```gdscript
func can_target_player(player_id: int) -> bool:
    var curse = spell_curse.get_player_curse(player_id)
    if curse.get("curse_type") == "protection":
        return false
    return true
```

### CardSystem（コスト上昇）

```gdscript
func get_spell_cost(spell_card: Dictionary) -> int:
    var cost = spell_card.get("cost", {}).get("mp", 0)
    
    var curse = spell_curse.get_world_curse()
    if curse.get("curse_type") == "cost_increase":
        var multiplier = curse.get("params", {}).get("multiplier", 1.0)
        cost = int(cost * multiplier)
    
    return cost
```

---

## 実装優先度

### Phase 1: 基盤構築（今回）
- [ ] `spell_curse.gd` クラス作成
- [ ] GameFlowManager統合（setup, update_all_curses）
- [ ] 基本メソッド実装（curse_*, get_*, remove_*）
- [ ] テスト用の簡単な呪い

### Phase 2: クリーチャー呪い
- [ ] battle_preparation.gd統合（呪い適用）
- [ ] BoardSystem3D統合（移動時削除）
- [ ] 2066: バイタリティ（能力値+20）
- [ ] 2054: ディジーズ（能力値-20）

### Phase 3: プレイヤー呪い
- [ ] 2100: ホーリーワード6（ダイス固定）
- [ ] 2091: ヘイスト（ダイス範囲）

### Phase 4: 世界呪
- [ ] 2009: ウェイストワールド（コスト上昇）

---

**作成日**: 2025年11月12日  
**更新**: v1.3 - 実装状況確認、完全未実装と判明