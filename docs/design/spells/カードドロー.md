# カードドロー・手札操作スペル効果

**バージョン**: 2.0  
**最終更新**: 2025年11月26日

---

## 概要

カードドロー、手札破壊、手札交換・盗みなどの手札操作を担当するスペル効果モジュール。

**実装ファイル**: `scripts/spells/spell_draw.gd`

**初期化**:
```gdscript
# GameFlowManager.setup_systems()
spell_draw = SpellDraw.new()
spell_draw.setup(card_system, player_system)
```

---

## 前提システム: 順位取得

ギフト（ID: 2020）は順位に応じた効果を持つため、先に順位システムを実装する。

**実装場所**: `scripts/ui_components/player_info.gd`

**メソッド**:
```gdscript
func get_player_ranking(player_id: int) -> int:
    # 総魔力でソート、1位=1, 2位=2...
```

**順位の定義**:
- 総魔力（`player_system.get_magic(player_id)`）で降順ソート
- 同率の場合は同順位（例: 1位, 1位, 3位）

---

## SpellPhaseHandlerへの統合

`SpellPhaseHandler`の`_apply_single_effect()`に追加予定の`effect_type`:

| effect_type | 説明 | 対応メソッド | 実装状況 |
|-------------|------|--------------|---------|
| `draw_cards` | 固定枚数ドロー | `draw_cards()` | ✅ 実装済み |
| `draw_by_rank` | 順位に応じたドロー | `draw_by_rank()` | ⏳ 未実装 |
| `draw_conditional` | 条件付きドロー | `draw_conditional()` | ⏳ 未実装 |
| `draw_from_top` | デッキ上部から選択 | `draw_from_top_selection()` | ⏳ 未実装 |
| `draw_by_type` | タイプ指定ドロー | `draw_by_type()` | ⏳ 未実装 |
| `discard_and_draw` | 手札入れ替え | `exchange_all_hand()` | ✅ 実装済み |
| `destroy_hand_card` | 手札破壊 | `destroy_hand_card()` | ⏳ 未実装 |
| `destroy_duplicate_cards` | 重複カード破壊 | `destroy_duplicate_cards()` | ⏳ 未実装 |
| `destroy_curse_cards` | 呪いカード破壊 | `destroy_curse_cards()` | ⏳ 未実装 |
| `destroy_expensive_cards` | 高コストカード破壊 | `destroy_expensive_cards()` | ⏳ 未実装 |
| `destroy_from_deck` | デッキからカード破壊 | `destroy_from_deck()` | ⏳ 未実装 |
| `steal_card` | カード奪取 | `steal_card()` | ⏳ 未実装 |

---

## 既存メソッド一覧

### draw_one(player_id: int) -> Dictionary

ターン開始時の1枚ドロー。

```gdscript
var drawn = spell_draw.draw_one(current_player.id)
```

### draw_cards(player_id: int, count: int) -> Array

固定枚数ドロー（スペルカード用）。

```gdscript
var cards = spell_draw.draw_cards(player_id, 2)  # 2枚引く
```

### draw_until(player_id: int, target_hand_size: int) -> Array

指定枚数まで補充（トゥームストーン用）。

**動作例**:
- 手札2枚、target=6 → 4枚引く
- 手札6枚、target=6 → 0枚（引かない）

```gdscript
var cards = spell_draw.draw_until(player_id, 6)  # 6枚まで補充
```

### exchange_all_hand(player_id: int) -> Array

手札を全て捨てて同じ枚数引き直す。

```gdscript
var new_cards = spell_draw.exchange_all_hand(player_id)
```

---

## 追加予定メソッド

### draw_by_rank(player_id: int) -> Dictionary

順位に応じた枚数をドローし、順位×G50を得る（ギフト用）。

**処理内容**:
1. プレイヤーの現在順位を取得
2. 順位と同じ枚数のカードを引く
3. 順位×G50の魔力を付与

```gdscript
# ギフト（ID: 2020）
var result = spell_draw.draw_by_rank(player_id)
# result = {"cards": [...], "gold": 150, "rank": 3}
```

### draw_conditional(player_id: int, condition: Dictionary, success_count: int, fail_count: int) -> Array

条件を満たす場合と満たさない場合で異なる枚数をドロー。

**条件タイプ**:

| condition_type | 説明 | パラメータ |
|----------------|------|-----------|
| `has_synthesis` | 合成カードが手札にあるか | なし |
| `has_elements` | 指定属性カードが手札にあるか | `elements: Array` |

```gdscript
# フィロソフィー（ID: 2077）- 合成持ちなら3枚、なければ2枚
var condition = {"condition_type": "has_synthesis"}
var cards = spell_draw.draw_conditional(player_id, condition, 3, 2)
```

### draw_from_top_selection(player_id: int, look_count: int) -> void

デッキ上部の指定枚数を見て、1枚を選んでドロー（UI必要）。

**処理内容**:
1. デッキ上部`look_count`枚を取得
2. 選択UIを表示
3. 選んだ1枚を手札に追加
4. 残りをデッキに戻す

```gdscript
# フォーサイト（ID: 2078）- 上6枚から1枚選ぶ
spell_draw.draw_from_top_selection(player_id, 6)
```

### draw_by_type(player_id: int, card_type: String) -> Dictionary

指定タイプのカードをデッキから検索してドロー。

**card_type**:
- `"creature"`: クリーチャーカード
- `"item"`: アイテムカード
- `"spell"`: スペルカード

```gdscript
# プロフェシー（ID: 2090）
var card = spell_draw.draw_by_type(player_id, "creature")
```

### discard_and_draw_plus(player_id: int, bonus: int) -> Array

手札を全て捨て、その枚数+bonus枚のカードを引く。

```gdscript
# リンカネーション（ID: 2127）- 手札枚数+1枚引く
var cards = spell_draw.discard_and_draw_plus(player_id, 1)
```

### destroy_hand_card(target_player_id: int, card_filter: Dictionary) -> Dictionary

対象プレイヤーの手札から条件に合うカードを破壊。

**フィルター**:

| キー | 説明 |
|-----|------|
| `card_types` | 対象カードタイプ（Array） |
| `selection_mode` | "random" / "player_select" / "owner_select" |

```gdscript
# シャッター（ID: 2034）- アイテムかスペルを選んで破壊
var filter = {"card_types": ["item", "spell"], "selection_mode": "player_select"}
var destroyed = spell_draw.destroy_hand_card(enemy_id, filter)
```

### destroy_duplicate_cards(target_player_id: int, scope: String) -> int

重複カードを全て破壊。

**scope**:
- `"target"`: 対象プレイヤーの手札のみ
- `"all"`: 全プレイヤーの手札

```gdscript
# エロージョン（ID: 2017）
var destroyed_count = spell_draw.destroy_duplicate_cards(target_id, "target")
```

### destroy_curse_cards() -> int

全プレイヤーの手札から呪いカードを破壊。

```gdscript
# レイオブパージ（ID: 2128）
var destroyed_count = spell_draw.destroy_curse_cards()
```

### destroy_expensive_cards(cost_threshold: int) -> int

全プレイヤーの手札から指定コスト以上のカードを破壊。

```gdscript
# レイオブロウ（ID: 2129）- G100以上を破壊
var destroyed_count = spell_draw.destroy_expensive_cards(100)
```

### destroy_from_deck(target_player_id: int, look_count: int) -> Dictionary

デッキ上部を見て1枚を選んで破壊（UI必要）。

```gdscript
# ポイズンマインド（ID: 2093）- 上6枚から1枚破壊、その後1枚ドロー
var destroyed = spell_draw.destroy_from_deck(enemy_id, 6)
spell_draw.draw_cards(current_player_id, 1)
```

### steal_card(from_player_id: int, to_player_id: int, card_filter: Dictionary) -> Dictionary

対象プレイヤーの手札からカードを奪う。

```gdscript
# セフト（ID: 2046）- スペルを1枚奪う
var filter = {"card_types": ["spell"], "selection_mode": "player_select"}
var stolen = spell_draw.steal_card(enemy_id, current_player_id, filter)
```

---

## 対応スペル一覧

### カードドロー系（6個）

| ID | 名前 | 効果 | 実装メソッド | 実装状況 |
|----|------|------|-------------|---------|
| 2095 | ホープ | カードを2枚引く | `draw_cards(player_id, 2)` | ⏳ 実装予定 |
| 2020 | ギフト | 順位×G50を得る；順位と同じ枚数ドロー | `draw_by_rank()` | ⏳ 実装予定 |
| 2078 | フォーサイト | デッキ上6枚から1枚選んでドロー | `draw_from_top_selection()` | ⏳ 実装予定 |
| 2090 | プロフェシー | 指定タイプのカードを1枚ドロー | `draw_by_type()` | ⏳ 実装予定 |
| 2004 | アセンブルカード | 密命；手札に火水風地があればG500、なければ2枚ドロー | 条件チェック + `draw_cards()` | ⏳ 実装予定 |
| 2127 | リンカネーション | 手札を全て捨て、枚数+1枚を引く | `discard_and_draw_plus()` | ⏳ 実装予定 |

### 保留中（システム未実装）

| ID | 名前 | 効果 | 保留理由 |
|----|------|------|---------|
| 2077 | フィロソフィー | 合成持ちなら3枚、なければ2枚引く | 合成システム未実装 |
| 2112 | ミラクルコール | ブリードカードがあれば1枚、なければ2枚ドロー | ブリードカード不存在 |

### 手札破壊系（6個）

| ID | 名前 | 効果 | 実装メソッド | 実装状況 |
|----|------|------|-------------|---------|
| 2034 | シャッター | 敵手札のアイテム/スペルを1枚選んで破壊 | `destroy_hand_card()` | ⏳ 未実装 |
| 2017 | エロージョン | 重複カードを全て破壊 | `destroy_duplicate_cards()` | ⏳ 未実装 |
| 2038 | スクイーズ | 手札1枚を破壊、対象にG150を与える | `destroy_hand_card()` + 魔力付与 | ⏳ 未実装 |
| 2128 | レイオブパージ | 全手札の呪いカードを破壊 | `destroy_curse_cards()` | ⏳ 未実装 |
| 2129 | レイオブロウ | 全手札のG100以上カードを破壊 | `destroy_expensive_cards(100)` | ⏳ 未実装 |
| 2093 | ポイズンマインド | デッキ上6枚から1枚破壊、1枚ドロー | `destroy_from_deck()` + `draw_cards()` | ⏳ 未実装 |

### 手札交換・盗み系（2個）

| ID | 名前 | 効果 | 実装メソッド | 実装状況 |
|----|------|------|-------------|---------|
| 2046 | セフト | 敵手札のスペルを1枚奪う | `steal_card()` | ⏳ 未実装 |
| 2042 | スニークハンド | 密命；アイテム2枚以上持つ敵から1枚奪う | 条件チェック + `steal_card()` | ⏳ 未実装 |

---

## 実装優先度

### 前提: 順位システム実装
- **PlayerInfo**に`get_player_ranking(player_id: int) -> int`を追加
- 総魔力でソート（1位=1, 2位=2...）
- ギフト（2020）で使用

### Phase 1: 基本ドロー
1. **2095: ホープ** - 最も単純、`draw_cards()`で即実装可能
2. **2127: リンカネーション** - `discard_and_draw_plus()`追加

### Phase 2: 順位・条件付きドロー
3. **2020: ギフト** - 順位取得と魔力付与の連携
4. **2004: アセンブルカード** - 密命 + 手札クリーチャー属性判定

### Phase 3: UI必要系（最後）
5. **2078: フォーサイト** - デッキ上6枚取得 + カード選択UI
6. **2090: プロフェシー** - タイプ選択UI + デッキ検索

### 手札破壊・盗み系（別途計画）
- Phase 4以降で実装予定

---

## JSON定義例

### ホープ（ID: 2095）- 基本ドロー

```json
{
  "id": 2095,
  "name": "ホープ",
  "type": "spell",
  "cost": 20,
  "rarity": "N",
  "effect_parsed": {
    "target_type": "self",
    "effects": [
      {
        "effect_type": "draw_cards",
        "count": 2
      }
    ]
  }
}
```

### ギフト（ID: 2020）- 順位連動

```json
{
  "id": 2020,
  "name": "ギフト",
  "type": "spell",
  "cost": 30,
  "rarity": "N",
  "effect_parsed": {
    "target_type": "self",
    "effects": [
      {
        "effect_type": "draw_by_rank"
      },
      {
        "effect_type": "gain_magic_by_rank",
        "multiplier": 50
      }
    ]
  }
}
```

### フィロソフィー（ID: 2077）- 条件分岐

```json
{
  "id": 2077,
  "name": "フィロソフィー",
  "type": "spell",
  "cost": 30,
  "rarity": "R",
  "effect_parsed": {
    "target_type": "self",
    "effects": [
      {
        "effect_type": "draw_conditional",
        "condition": {
          "condition_type": "has_synthesis"
        },
        "success_count": 3,
        "fail_count": 2
      }
    ]
  }
}
```

### シャッター（ID: 2034）- 手札破壊

```json
{
  "id": 2034,
  "name": "シャッター",
  "type": "spell",
  "cost": 50,
  "rarity": "R",
  "effect_parsed": {
    "target_type": "player",
    "target_filter": "enemy",
    "effects": [
      {
        "effect_type": "destroy_hand_card",
        "card_types": ["item", "spell"],
        "selection_mode": "player_select",
        "count": 1
      }
    ]
  }
}
```

### リンカネーション（ID: 2127）- 手札入れ替え

```json
{
  "id": 2127,
  "name": "リンカネーション",
  "type": "spell",
  "cost": 20,
  "rarity": "N",
  "effect_parsed": {
    "target_type": "self",
    "effects": [
      {
        "effect_type": "discard_and_draw",
        "bonus": 1
      }
    ]
  }
}
```

### アセンブルカード（ID: 2004）- 密命

```json
{
  "id": 2004,
  "name": "アセンブルカード",
  "type": "spell",
  "cost": 0,
  "rarity": "R",
  "is_secret": true,
  "effect_parsed": {
    "target_type": "self",
    "mission": {
      "condition_type": "has_all_elements",
      "elements": ["fire", "water", "earth", "wind"],
      "success_effects": [
        {
          "effect_type": "gain_magic",
          "amount": 500
        }
      ],
      "fail_effects": [
        {
          "effect_type": "draw_cards",
          "count": 2
        }
      ]
    }
  }
}
```

---

## 技術的な注意事項

### 1. UI必要なスペル

以下のスペルはプレイヤーによるカード選択UIが必要:
- フォーサイト（デッキ上部からの選択）
- プロフェシー（タイプ選択）
- シャッター（敵手札からの選択）
- ポイズンマインド（敵デッキからの選択）
- セフト（敵手札からの選択）

**実装方針**: `TargetSelectionHelper`を拡張するか、専用のカード選択UIを作成

### 2. 敵手札の参照

敵手札を参照するスペル（シャッター、セフト等）では:
- 密命カードは内容を見せない（真っ黒表示）
- 選択可能なカードのみハイライト

### 3. 合成カード判定

フィロソフィーで使用する合成判定:
```gdscript
func has_synthesis_card(player_id: int) -> bool:
    var hand = card_system.get_hand_for_player(player_id)
    for card in hand:
        if card.get("synthesis", null) != null:
            return true
    return false
```

### 4. 手札クリーチャー属性判定

アセンブルカードで使用する属性判定（手札のクリーチャーカードの属性）:
```gdscript
func has_all_elements_in_hand(player_id: int) -> bool:
    var hand = card_system.get_hand_for_player(player_id)
    var found_elements = {}
    for card in hand:
        if card.get("type") == "creature":
            var element = card.get("element", "")
            if element in ["fire", "water", "earth", "wind"]:
                found_elements[element] = true
    return found_elements.size() >= 4
```

### 5. 呪いカード判定

レイオブパージで使用する呪いカード判定:
```gdscript
func is_curse_card(card: Dictionary) -> bool:
    var effects = card.get("effect_parsed", {}).get("effects", [])
    for effect in effects:
        if effect.get("is_curse", false):
            return true
    return false
```

---

## CardSystemとの連携

SpellDrawは**CardSystemのラッパー**。内部で以下を使用：
- `draw_card_for_player()`: 1枚ドロー
- `draw_cards_for_player()`: 複数枚ドロー
- `get_hand_for_player()`: 手札取得
- `get_hand_size_for_player()`: 手札枚数取得
- `discard_card()`: カード破棄
- `player_decks[]`: デッキ直接アクセス（検索用）

### 戻り値

- 1枚 → `Dictionary`（CardSystemと統一）
- 複数枚 → `Array`（CardSystemと統一）

---

## 関連ドキュメント

- [スペルシステム設計](../spells_design.md) - 全体設計
- [領地変更効果](./領地変更.md) - SpellLandシステム
- [魔力増減効果](./魔力増減.md) - SpellMagicシステム

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025/11/03 | 1.0 | 初版作成（基本メソッドのみ） |
| 2025/11/26 | 2.0 | 全15スペルの実装計画追加、メソッド設計、JSON定義例追加 |
| 2025/11/26 | 2.1 | 実装対象整理: ブリード(2112)削除、合成(2077)保留、順位システム追加 |

---

**最終更新**: 2025年11月26日（v2.1）
