# カードドロー効果

**バージョン**: 1.0  
**最終更新**: 2025年11月3日

---

## 概要

カードドロー処理の汎用化モジュール。バトル外のマップ効果として使用。

**実装ファイル**: `scripts/spells/spell_draw.gd`

**初期化**:
```gdscript
# GameFlowManager.setup_systems()
spell_draw = SpellDraw.new()
spell_draw.setup(card_system)
```

---

## メソッド一覧

### draw_one(player_id: int) -> Dictionary

ターン開始時の1枚ドロー。

```gdscript
var drawn = spell_draw.draw_one(current_player.id)
```

### draw_cards(player_id: int, count: int) -> Array

固定枚数ドロー（スペルカード用）。

```gdscript
var cards = spell_draw.draw_cards(player_id, 2)  # 2枚引く
```

### draw_until(player_id: int, target_hand_size: int) -> Array

指定枚数まで補充（トゥームストーン用）。

**動作例**:
- 手札2枚、target=6 → 4枚引く
- 手札6枚、target=6 → 0枚（引かない）

```gdscript
var cards = spell_draw.draw_until(player_id, 6)  # 6枚まで補充
```

### exchange_all_hand(player_id: int) -> Array

手札を全て捨てて同じ枚数引き直す。

```gdscript
var new_cards = spell_draw.exchange_all_hand(player_id)
```

---

## 実装アイテム

### トゥームストーン（ID: 1038）

**効果**: 自破壊時、手札6枚までカードを引く

**JSON定義**:
```json
{
  "effect_type": "draw_cards_on_death",
  "trigger": "on_death",
  "target_hand_size": 6
}
```

**実装場所**: `battle_special_effects.gd - check_on_death_effects()`

```gdscript
"draw_cards_on_death":
	var drawn_cards = spell_draw_ref.draw_until(player_id, target_hand_size)
```

**発動フロー**:
```
バトル敗北（トゥームストーン装備）
  → check_on_death_effects()
  → spell_draw.draw_until(player_id, 6)
  → 手札6枚まで補充
```

---

## 重要な仕様

### 手札上限の扱い

- **ドロー時**: 手札上限チェック不要（何枚でも引ける）
- **ターン終了時**: 6枚超過分を捨てる（`GameFlowManager.check_and_discard_excess_cards()`）

### CardSystemとの関係

SpellDrawは**CardSystemのラッパー**。内部で以下を使用：
- `draw_card_for_player()`
- `draw_cards_for_player()`
- `get_hand_size_for_player()`
- `discard_card()`

CardSystemの既存メソッドは下位互換性のため維持。

### 戻り値

- 1枚 → `Dictionary`（CardSystemと統一）
- 複数枚 → `Array`（CardSystemと統一）

---

## 今後の拡張

### 追加メソッド候補

```gdscript
# 条件付きドロー
func draw_if_hand_below(player_id, threshold, draw_count) -> Array

# 特定タイプのみドロー
func draw_cards_by_type(player_id, card_type, count) -> Array
```

---

**最終更新**: 2025年11月3日（v1.0）
