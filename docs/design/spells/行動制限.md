# 行動制限システム完成図書

**ステータス**: ✅ 実装完了  
**最終更新**: 2025年11月30日

---

## 概要

クリーチャーの行動状態を操作するシステム。移動制限（足どめ）とダウン状態操作（不屈・ダウン解除）を管理する。

**実装ファイル**: `scripts/spells/spell_movement.gd`

---

## 効果タイプ一覧

| effect_type | 効果 | 対象 | 消滅条件 |
|-------------|------|------|---------|
| `forced_stop` | 通過時に強制停止 | クリーチャー | 1回発動 |
| `indomitable` | ダウン状態にならない | クリーチャー | ターン経過 |
| `down_clear` | ダウン状態を解除 | 全自クリーチャー | 即時 |
| `clear_down` | ダウン状態を解除 | 単体クリーチャー | 即時 |

---

## 実装済みスペル・アルカナアーツ

| ID | 名前 | 効果 | effect_type |
|----|------|------|-------------|
| 2067 | ハイパーアクティブ | 対象領地に呪い"不屈"（5R間） | `indomitable` |
| 2005 | アラーム | 全自クリーチャーのダウンを解除 | `down_clear` |
| 207 | キャプテンコック（アルカナアーツ） | 対象自クリーチャーのダウンを解除 | `clear_down` |

---

## データ構造

### 不屈呪い
```gdscript
creature["curse"] = {
	"curse_type": "indomitable",
	"name": "不屈",
	"duration": 5,  # ターン数（-1で無期限）
	"params": {}
}
```

### 足どめ呪い
```gdscript
creature["curse"] = {
	"curse_type": "forced_stop",
	"name": "強制停止",
	"duration": 2,
	"params": { "uses_remaining": 1 }
}
```

---

## JSON定義例

### ハイパーアクティブ（2067）
```json
{
	"effect_parsed": {
		"target_type": "land",
		"target_info": {
			"owner_filter": "any",
			"target_filter": "creature"
		},
		"effects": [{
			"effect_type": "indomitable",
			"name": "不屈",
			"duration": 5
		}]
	}
}
```

### アラーム（2005）
```json
{
	"effect_parsed": {
		"target_type": "self",
		"effects": [{
			"effect_type": "down_clear",
			"target": "own_creatures"
		}]
	}
}
```

### キャプテンコックアルカナアーツ（207）
```json
{
	"ability_parsed": {
		"keywords": ["不屈", "アルカナアーツ"],
		"mystic_arts": [{
			"name": "ダウン解除",
			"cost": 60,
			"target_type": "land",
			"target_info": {
				"owner_filter": "own",
				"target_filter": "creature",
				"is_down": true
			},
			"effects": [{ "effect_type": "clear_down" }]
		}]
	}
}
```

---

## ターゲットフィルター

| フィルター | 説明 | 使用例 |
|-----------|------|--------|
| `is_down: true` | ダウン状態のクリーチャーのみ | キャプテンコックアルカナアーツ |

---

## 不屈判定の仕組み

不屈スキル（元々持っている）と不屈呪い（スペルで付与）を統合判定。

**判定メソッド**: `PlayerBuffSystem.has_unyielding(creature_data)`

```gdscript
static func has_unyielding(creature_data: Dictionary) -> bool:
	# 1. 不屈スキル判定
	if "不屈" in creature_data.get("ability_detail", ""):
		return true
	# 2. 不屈呪い判定
	if SpellMovement.has_indomitable_curse(creature_data):
		return true
	return false
```

**判定箇所**:
- 召喚後（TileActionProcessor）
- レベルアップ後（LandActionHelper）
- アルカナアーツ発動後（SpellMysticArts）
- 移動後（MovementHelper）

---

## SpellMovement メソッド

| メソッド | 説明 |
|---------|------|
| `apply_indomitable_curse(tile_index, duration)` | 不屈呪い付与 |
| `has_indomitable_curse(creature)` | 不屈呪い判定（静的） |
| `clear_down_state_for_player(player_id, tile_nodes)` | 全自クリーチャーのダウン解除 |
| `apply_forced_stop_curse(tile_index, duration)` | 足どめ呪い付与 |
| `check_forced_stop(tile_index, player_id)` | 足どめ判定 |

---

## 関連ファイル

| ファイル | 役割 |
|---------|------|
| `scripts/spells/spell_movement.gd` | 行動制限処理の実装 |
| `scripts/spells/spell_curse.gd` | 呪い効果のルーティング |
| `scripts/player_buff_system.gd` | 不屈判定（統合） |
| `scripts/spells/spell_mystic_arts.gd` | アルカナアーツの不屈判定 |
| `scripts/game_flow/target_selection_helper.gd` | is_downフィルター |

---

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2025/11/30 | 初版作成・実装完了 |
