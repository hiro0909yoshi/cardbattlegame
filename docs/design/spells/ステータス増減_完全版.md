# ステータス増減スペル設計

**最終更新**: 2025年11月12日 | **実装状況**: ❌ 未実装

---

## 概要

クリーチャーのST/HPを一時的に増減させるスペル。  
呪いシステムと既存のeffect_systemを統合して実装。

**特徴**:
- クリーチャー呪いとして付与
- バトル時に`temporary_effects`に変換
- 既存の`apply_effect_arrays()`が自動適用
- 移動・交換・撃破で消滅

---

## 実装スペル一覧

| ID | 名前 | コスト | 効果 | 追加効果 | レアリティ |
|----|------|--------|------|---------|-----------|
| 2066 | バイタリティ | 30MP | ST&HP+20 | カードドロー | R |
| 2054 | ディジーズ | 30MP | ST&HP-20 | カードドロー | R |

**共通仕様**:
- `target_type: "land"` - 土地を対象
- `target_filter: "creature"` - クリーチャーがいる土地のみ
- 呪いは移動で消滅

---

## 呪いタイプ詳細

### stat_boost（能力値上昇）

**効果**: ST&HPを増加

**パラメータ**:
- `value`: 増加量（例: 20）
- `duration`: 持続ターン（-1=無期限）

**JSON例**:
```json
{
  "effect_type": "stat_boost",
  "value": 20,
  "duration": -1
}
```

### stat_reduce（能力値減少）

**効果**: ST&HPを減少

**パラメータ**:
- `value`: 減少量（例: -20）
- `duration`: 持続ターン（-1=無期限）

**JSON例**:
```json
{
  "effect_type": "stat_reduce",
  "value": -20,
  "duration": -1
}
```

---

## アーキテクチャ

### クラス構成

**SpellCurse** (`spell_curse.gd`):
- 呪いの基盤管理（汎用）
- `curse_creature()`, `get_creature_cure()`, `remove_curse_from_creature()`
- duration管理

**SpellCurseStat** (`spell_curse_stat.gd`):
- ステータス増減の実装
- 呪い付与（SpellCurseを使用）
- 呪い→temporary_effects変換

**BattlePreparation**:
- SpellCurseStatを呼び出し（1-2行）
- 既存の`apply_effect_arrays()`が自動適用

**BoardSystem3D**:
- 移動時に`spell_curse.remove_curse_from_creature()`

### データフロー

```
【スペル使用時】
SpellPhaseHandler
  ↓
SpellCurseStat.apply_stat_boost(tile_index, effect)
  ↓
SpellCurse.curse_creature(tile_index, "stat_boost", duration, params)
  ↓
creature_data["curse"] = {
  "curse_type": "stat_boost",
  "name": "能力値+20",
  "duration": -1,
  "params": {"value": 20}
}

【バトル発生時】
BattlePreparation.prepare_participants()
  ↓
SpellCurseStat.apply_to_creature_data(attacker_tile_index)
SpellCurseStat.apply_to_creature_data(defender_tile_index)
  ↓
creature_data["temporary_effects"].append({
  "type": "stat_bonus",
  "stat": "hp",
  "value": 20,
  "source": "curse"
})
creature_data["temporary_effects"].append({
  "type": "stat_bonus",
  "stat": "ap",
  "value": 20,
  "source": "curse"
})
  ↓
apply_effect_arrays(attacker)  # 既存システム
apply_effect_arrays(defender)
  ↓
participant.temporary_bonus_hp += 20
participant.temporary_bonus_ap += 20
```

---

## 実装詳細

### 1. SpellCurseStat クラス

**ファイル**: `scripts/spells/spell_curse_stat.gd`

```gdscript
extends Node
class_name SpellCurseStat

var spell_curse: SpellCurse
var creature_manager: CreatureManager

func setup(curse: SpellCurse, creature_mgr: CreatureManager):
	spell_curse = curse
	creature_manager = creature_mgr
	print("[SpellCurseStat] 初期化完了")

# ========================================
# スペル使用時（SpellPhaseHandlerから）
# ========================================

func apply_stat_boost(tile_index: int, effect: Dictionary):
	"""能力値上昇呪いを付与"""
	var value = effect.get("value", 20)
	var duration = effect.get("duration", -1)
	var name = effect.get("name", "能力値+20")
	
	spell_curse.curse_creature(tile_index, "stat_boost", duration, {
		"name": name,
		"value": value
	})

func apply_stat_reduce(tile_index: int, effect: Dictionary):
	"""能力値減少呪いを付与"""
	var value = effect.get("value", -20)
	var duration = effect.get("duration", -1)
	var name = effect.get("name", "能力値-20")
	
	spell_curse.curse_creature(tile_index, "stat_reduce", duration, {
		"name": name,
		"value": value
	})

# ========================================
# バトル時（BattlePreparationから）
# ========================================

func apply_to_creature_data(tile_index: int):
	"""呪いをtemporary_effectsに変換"""
	var curse = spell_curse.get_creature_curse(tile_index)
	if curse.is_empty():
		return
	
	var creature = creature_manager.get_data_ref(tile_index)
	if creature.is_empty():
		return
	
	var curse_type = curse.get("curse_type", "")
	var params = curse.get("params", {})
	
	match curse_type:
		"stat_boost":
			var value = params.get("value", 20)
			creature["temporary_effects"].append({
				"type": "stat_bonus",
				"stat": "hp",
				"value": value,
				"source": "curse",
				"source_name": curse.get("name", "")
			})
			creature["temporary_effects"].append({
				"type": "stat_bonus",
				"stat": "ap",
				"value": value,
				"source": "curse",
				"source_name": curse.get("name", "")
			})
		
		"stat_reduce":
			var value = params.get("value", -20)
			creature["temporary_effects"].append({
				"type": "stat_bonus",
				"stat": "hp",
				"value": value,
				"source": "curse",
				"source_name": curse.get("name", "")
			})
			creature["temporary_effects"].append({
				"type": "stat_bonus",
				"stat": "ap",
				"value": value,
				"source": "curse",
				"source_name": curse.get("name", "")
			})
```

---

### 2. BattlePreparation 統合

**ファイル**: `scripts/battle/battle_preparation.gd`

**変更箇所**: `prepare_participants()` 内に追加

```gdscript
func prepare_participants(...):
	# ... 既存処理 ...
	
	# 呪いをtemporary_effectsに変換
	if spell_curse_stat:
		spell_curse_stat.apply_to_creature_data(attacker_tile_index)
		spell_curse_stat.apply_to_creature_data(defender_tile_index)
	
	# 既存システムが自動適用
	apply_effect_arrays(attacker)
	apply_effect_arrays(defender)
	
	return [attacker, defender]
```

---

### 3. SpellPhaseHandler 統合

**ファイル**: `scripts/game_flow/spell_phase_handler.gd`

**変更箇所**: `_apply_single_effect()` 内に追加

```gdscript
func _apply_single_effect(effect: Dictionary, target_data: Dictionary):
	match effect.get("effect_type", ""):
		"stat_boost":
			if target_data.get("type") == "land":
				var tile_index = target_data.get("tile_index", -1)
				if game_flow_manager and game_flow_manager.spell_curse_stat:
					game_flow_manager.spell_curse_stat.apply_stat_boost(tile_index, effect)
		
		"stat_reduce":
			if target_data.get("type") == "land":
				var tile_index = target_data.get("tile_index", -1)
				if game_flow_manager and game_flow_manager.spell_curse_stat:
					game_flow_manager.spell_curse_stat.apply_stat_reduce(tile_index, effect)
```

---

### 4. GameFlowManager 初期化

**ファイル**: `scripts/game_flow_manager.gd`

**変更箇所**: `_setup_spell_systems()` 内に追加

```gdscript
func _setup_spell_systems():
	# ... 既存のSpellDraw, SpellMagic等 ...
	
	# SpellCurseStat初期化
	spell_curse_stat = SpellCurseStat.new()
	spell_curse_stat.setup(spell_curse, creature_manager)
	add_child(spell_curse_stat)
```

---

## スペルJSON設計

### バイタリティ（ID: 2066）

```json
{
  "id": 2066,
  "name": "バイタリティ",
  "cost": {"mp": 30},
  "effect_parsed": {
    "target_type": "land",
    "target_filter": "creature",
    "effects": [
      {
        "effect_type": "stat_boost",
        "name": "能力値+20",
        "value": 20,
        "duration": -1
      },
      {
        "effect_type": "draw",
        "count": 1
      }
    ]
  }
}
```

### ディジーズ（ID: 2054）

```json
{
  "id": 2054,
  "name": "ディジーズ",
  "cost": {"mp": 30},
  "effect_parsed": {
    "target_type": "land",
    "target_filter": "creature",
    "effects": [
      {
        "effect_type": "stat_reduce",
        "name": "能力値-20",
        "value": -20,
        "duration": -1
      },
      {
        "effect_type": "draw",
        "count": 1
      }
    ]
  }
}
```

---

## 使用例

### バイタリティの使用フロー

```
1. プレイヤーがバイタリティ使用（30MP）
2. 土地選択UI（クリーチャーがいる土地のみ）
3. tile_index=5を選択
4. SpellCurseStat.apply_stat_boost(5, effect)
5. creature_data["curse"] = {呪いデータ}
6. カードドロー
7. バトル発生（tile=5）
8. SpellCurseStat.apply_to_creature_data(5)
9. temporary_effectsに追加
10. apply_effect_arrays() → ST+20, HP+20
11. 戦闘実行（強化状態）
12. 呪いは残る（duration=-1）
13. 移動 → 呪い消滅
```

---

## 実装チェックリスト

### Phase 1: SpellCurseStat作成
- [ ] `scripts/spells/spell_curse_stat.gd` 作成
- [ ] `setup()` 実装
- [ ] `apply_stat_boost()` 実装
- [ ] `apply_stat_reduce()` 実装
- [ ] `apply_to_creature_data()` 実装

### Phase 2: 統合
- [ ] GameFlowManager - 初期化
- [ ] SpellPhaseHandler - effect_type追加
- [ ] BattlePreparation - 呼び出し追加

### Phase 3: JSON設定
- [ ] 2066: バイタリティ - effect_parsed
- [ ] 2054: ディジーズ - effect_parsed

### Phase 4: テスト
- [ ] バイタリティでST/HP+20確認
- [ ] ディジーズでST/HP-20確認
- [ ] temporary_effects変換確認
- [ ] 移動で呪い消滅確認

---

## トラブルシューティング

### 呪いがバトルに反映されない

**原因**: `apply_to_creature_data()` が呼ばれていない

**確認**:
1. BattlePreparationに統合されているか
2. spell_curse_statが初期化されているか
3. ログ `[呪い変換]` が出力されているか

### temporary_effectsが空

**原因**: creature_dataに配列がない

**解決**: creature_data初期化時に空配列を設定

### 移動しても呪いが消えない

**原因**: BoardSystem3Dに削除処理がない

**確認**: `move_creature()` に `remove_curse_from_creature()`

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025/11/12 | 初版 - SpellCurseStat設計、temporary_effects統合 |
