# HP効果無効（HP Effect Immune）

## 概要

HP効果無効は、スペルや秘術による直接的なHP/MHP変更効果を無効化する能力。
この能力を持つクリーチャーは、HP変更系スペル/秘術の対象に選択できない。

---

## 効果範囲

| 分類 | 無効化 |
|------|--------|
| スペルによるHP/MHP増減 | ✓ |
| 秘術によるHP/MHP変更 | ✓ |
| 呪い付与スペル | ✗ |
| 呪い効果の発動 | ✗ |
| 戦闘ダメージ | ✗ |
| スキル・アイテム効果 | ✗ |

---

## 対象スペル一覧

### spell_1.json（10件）
| ID | 名前 | 効果 |
|----|------|------|
| 2016 | エレメンタルラス | 領地と属性の合わない全クリーチャーのHP-20 |
| 2023 | クラスターバースト | 最多属性の全クリーチャーのHP-20 |
| 2026 | グロースボディ | 対象クリーチャーのMHP+10 |
| 2031 | サンダークラップ | 召喚条件のある対象敵クリーチャーのHP-30 |
| 2033 | シャイニングガイザー | 対象敵クリーチャーのHP-30 |
| 2037 | スウォーム | HPが減少している全クリーチャーのHP-20 |
| 2041 | ストーンブラスト | 対象地風のHP-30 |
| 2050 | タイニーアーミー | MHP30以下5体配置時、MHP+10 |
| 2053 | ディザスター | ダウンしたMHP50以上の全クリーチャーのHP-30 |
| 2058 | デビリティ | AP=0、合成でMHP-20追加 |

### spell_2.json（8件）
| ID | 名前 | 効果 |
|----|------|------|
| 2065 | バーニングベイル | 全水風のHP-20 |
| 2075 | ファットボディ | MHP+20、AP-20 |
| 2086 | フリーズサイクロン | 全火地のHP-20 |
| 2088 | ブレイズスプラッシュ | 対象火水のHP-30 |
| 2106 | マジックボルト | 対象敵クリーチャーのHP-20 |
| 2107 | マスグロース | 全クリーチャーのMHP+5 |
| 2116 | ライフストリーム | 全自クリーチャーのHP全回復 |
| 2121 | リストア | HP全回復、ダウン解除 |

### spell_mystic.json（8件）
| ID | 名前 |
|----|------|
| 9004 | ダメージ10（敵単体） |
| 9005 | ダメージ20（敵火風） |
| 9006 | ダメージ20（敵水地） |
| 9007 | ダメージ30（敵無属性） |
| 9008 | ダメージ20（呪い付き全体） |
| 9009 | 回復30（自クリーチャー） |
| 9010 | MHP増加（敵味方問わず） |
| 9034 | MHP変換（ドゥームデボラー） |

---

## HP効果無効を持つクリーチャー

| 属性 | 名前 | 能力 |
|------|------|------|
| 地 | オドラデク | 援護；HP効果無効 |
| 水 | アクアデューク | 援護[水]；防具使用時、無効化[通常攻撃]；HP効果無効 |
| 水 | アンフィビアン | 戦闘地が水風の場合、AP+20；HP効果無効 |
| 風 | ソードプリンセス | 先制；HP効果無効；秘術[60EP・アームドプリンセスに変身] |

---

## HP効果無効を付与するスペル

| ID | 名前 | 効果 |
|----|------|------|
| 2108 | マスファンタズム | 全領地に呪い"HP効果無効" |

---

## 実装仕様

### データフラグ

**スペル/秘術側**
```json
"effect_parsed": {
  "affects_hp": true
}
```

**クリーチャー側（固有能力）**
```json
"ability_parsed": {
  "keywords": ["HP効果無効"]
}
```

**クリーチャー側（呪い付与）**
```json
"curse": {
  "curse_type": "hp_effect_immune",
  "name": "HP効果無効"
}
```

### 判定関数

`SpellHpImmune.has_hp_effect_immune(creature_data)` で判定。
- keywords に "HP効果無効" を含む → true
- curse_type が "hp_effect_immune" → true

### 処理フロー

1. スペル使用時、`affects_hp: true` をチェック
2. ターゲット選択時、HP効果無効持ちを除外
3. 全体スペルは `get_valid_targets` でフィルタリング済み

---

## 関連ファイル

| ファイル | 役割 |
|----------|------|
| scripts/spells/spell_hp_immune.gd | HP効果無効判定クラス |
| scripts/game_flow/target_selection_helper.gd | ターゲット選択時の除外処理（get_valid_targets_core内） |
| scripts/cpu_ai/cpu_spell_target_selector.gd | CPUターゲット選択時の除外処理（get_default_targets内） |
| scripts/spells/spell_curse.gd | マスファンタズム呪い付与 |
| scripts/game_flow/spell_effect_executor.gd | apply_curse エフェクト処理 |

### フィルタ適用の仕組み

HP効果無効フィルタは以下で**自動的に**適用される：

1. **ターゲット選択時**: `TargetSelectionHelper.get_valid_targets_core()`
   - `target_info.affects_hp = true` の場合、HP効果無効持ちを除外
   - `SpellHpImmune.has_hp_effect_immune()` で判定

スペル/秘術のJSONに `"affects_hp": true` を設定すれば、自動的にHP効果無効持ちが除外される。