# 召喚制限システム

**ステータス**: ✅ 実装完了  
**最終更新**: 2026年1月14日

---

## 概要

クリーチャーの召喚・配置・使用に関する制限システム。4種類の制限が存在し、それぞれ独立してチェックされる。

**実装ファイル**: `scripts/tile_action_processor.gd`

---

## 制限タイプ一覧

| 制限名 | フィールド | 効果 | デバッグフラグ |
|--------|-----------|------|---------------|
| 土地条件 | `cost.lands_required` | 特定属性の土地を所有していないと召喚不可 | `debug_disable_lands_required` |
| 配置制限 | `restrictions.cannot_summon` | 特定属性の土地には配置不可 | `debug_disable_cannot_summon` |
| カード犠牲 | `cost.cards_sacrifice` | 召喚時に手札を1枚犠牲にする | `debug_disable_card_sacrifice` |
| 使用制限 | `restrictions.cannot_use` | 特定属性の土地ではアイテム使用不可 | `debug_disable_cannot_use` |

---

## 1. 土地条件（lands_required）

### 概要
召喚に必要な属性土地の所有条件。指定された属性の土地を所有していないと召喚できない。

### JSONデータ構造
```json
{
  "cost": {
	"mp": 80,
	"lands_required": ["fire", "fire"]
  }
}
```

### 正規化後のフィールド
```gdscript
card_data["cost_lands_required"] = ["fire", "fire"]  # 火属性の土地が2つ必要
```

### チェックメソッド
```gdscript
func check_lands_required(card_data: Dictionary, player_id: int) -> Dictionary:
	# 戻り値: {"passed": bool, "message": String}
```

### 対象クリーチャー例
| ID | 名前 | 条件 |
|----|------|------|
| 101 | フェニックス | 火×2 |
| 201 | リヴァイアサン | 水×2 |

---

## 2. 配置制限（cannot_summon）

### 概要
特定属性の土地には配置できない制限。クリーチャーの特性により、相性の悪い属性の土地には召喚できない。

### JSONデータ構造
```json
{
  "restrictions": {
	"cannot_summon": ["water"]
  }
}
```

### チェックメソッド
```gdscript
func check_cannot_summon(card_data: Dictionary, tile_element: String) -> Dictionary:
	# 戻り値: {"passed": bool, "message": String}
```

### 適用箇所
- 召喚時（空き地）
- 侵略時（敵ドミニオ）
- 移動時（ドミニオオーダー）
- クリーチャー交換時

### 対象クリーチャー例
| ID | 名前 | 配置不可属性 |
|----|------|-------------|
| 102 | ファイアドレイク | 水 |
| 202 | ウォーターエレメンタル | 火 |

---

## 3. カード犠牲（cards_sacrifice）

### 概要
召喚時に手札からカードを1枚犠牲にする必要がある。犠牲カードによってはクリーチャー合成が発生する。

### JSONデータ構造
```json
{
  "cost": {
	"mp": 50,
	"cards_sacrifice": 1
  }
}
```

### 正規化後のフィールド
```gdscript
card_data["cost_cards_sacrifice"] = 1
```

### 処理フロー

#### プレイヤーの場合
1. 召喚カード選択
2. 犠牲カード選択UI表示
3. プレイヤーが犠牲カードを選択
4. 合成条件チェック → 合成成立なら変身
5. 犠牲カードを破棄
6. 召喚実行

#### CPUの場合
1. `CPUSacrificeSelector`が自動選択
2. レート最低のカードを選択（合成条件がある場合は条件に合うカードを優先）

### 関連クラス
- `CardSacrificeHelper` - プレイヤー用の犠牲カード選択UI
- `CPUSacrificeSelector` - CPU用の自動選択ロジック
- `CreatureSynthesis` - クリーチャー合成判定・適用

### 対象クリーチャー例
| ID | 名前 | 犠牲数 | 合成効果 |
|----|------|--------|---------|
| 301 | イド | 1 | 犠牲クリーチャーに変身 |
| 302 | グレムリン | 1 | 同名カードで強化 |

---

## 4. 使用制限（cannot_use）

### 概要
特定属性の土地ではアイテムを使用できない制限。

### JSONデータ構造
```json
{
  "restrictions": {
	"cannot_use": ["fire", "water"]
  }
}
```

### チェック箇所
- アイテムフェーズでのアイテム選択時
- 該当アイテムはグレーアウト表示

### 対象アイテム例
| ID | 名前 | 使用不可属性 |
|----|------|-------------|
| 501 | アイスシールド | 火 |

---

## フールズフリーダム（愚者）

### 概要
ワールド刻印スペル「フールズフリーダム」発動中は、全ての召喚条件が無視される。

### 対象となる制限
- ✅ 土地条件（lands_required）
- ✅ 配置制限（cannot_summon）
- ✅ カード犠牲（cards_sacrifice）

### 判定メソッド
```gdscript
func _is_summon_condition_ignored() -> bool:
	if not game_flow_manager:
		return false
	var game_stats = game_flow_manager.game_stats
	return SpellWorldCurse.is_summon_condition_ignored(game_stats)
```

---

## デバッグフラグ

`tile_action_processor.gd` の冒頭で定義：

```gdscript
var debug_disable_card_sacrifice: bool = true  # true=カード犠牲を無効化
var debug_disable_lands_required: bool = true  # true=土地条件を無効化
var debug_disable_cannot_summon: bool = true   # true=配置制限を無効化
var debug_disable_cannot_use: bool = true      # true=アイテム使用制限を無効化
```

**注意**: 本番環境では全て `false` に設定すること。

---

## 移動時の配置制限チェック

ドミニオオーダーの移動機能でも配置制限がチェックされる。

### 実装箇所

#### MovementHelper（プレイヤー・CPU共通）
`scripts/game_flow/movement_helper.gd`

```gdscript
static func _filter_invalid_destinations(board_system, tile_indices, current_player_id, creature_data = {}) -> Array:
	# 配置制限チェック（cannot_summon）
	if not creature_data.is_empty() and board_system.tile_action_processor:
		var tile_element = tile.tile_type
		var cannot_summon_result = board_system.tile_action_processor.check_cannot_summon(creature_data, tile_element)
		if not cannot_summon_result.get("passed", true):
			continue  # 配置制限で枷
```

#### CPUTerritoryAI
`scripts/cpu_ai/cpu_territory_ai.gd`

```gdscript
func _can_place_creature(creature_data, land, player_id) -> bool:
	# cannot_summon チェック
	if tile_action_processor and not tile_action_processor.debug_disable_cannot_summon:
		var cannot_summon_result = tile_action_processor.check_cannot_summon(creature_data, tile_element)
		if not cannot_summon_result.can_summon:
			return false
```

---

## 関連ファイル

| ファイル | 役割 |
|---------|------|
| `scripts/tile_action_processor.gd` | 制限チェックのメイン実装 |
| `scripts/game_flow/movement_helper.gd` | 移動時の配置制限フィルタリング |
| `scripts/cpu_ai/cpu_territory_ai.gd` | CPU移動時の配置制限チェック |
| `scripts/cpu_ai/cpu_sacrifice_selector.gd` | CPU用犠牲カード自動選択 |
| `scripts/spells/card_sacrifice_helper.gd` | プレイヤー用犠牲カード選択UI |
| `scripts/spells/creature_synthesis.gd` | クリーチャー合成処理 |
| `scripts/spells/spell_world_curse.gd` | フールズフリーダム判定 |

---

## ドミニオ交換時の配置制限チェック

ドミニオオーダーの交換機能では、**交換対象タイル**の属性で配置制限をチェックする。

### 実装箇所

`scripts/ui_components/card_selection_ui.gd` の `_get_current_tile_element()`

```gdscript
# 交換モード時は交換対象タイルの属性を返す
if selection_mode == "swap" and game_flow_manager_ref.dominio_command_handler:
	var dominio = game_flow_manager_ref.dominio_command_handler
	# _swap_tile_indexから属性を取得（プレイヤー位置ではない）
```

**注意**: 交換時はプレイヤーの現在位置ではなく、交換対象タイルの属性で判定する。

---

## 方向/分岐選択時の到着予想に基づく配置制限表示

移動前の方向選択・分岐選択時に、到着予想タイルの属性に基づいて手札カードの配置制限（禁止マーク）を動的に更新する。

### 仕様
- 方向や分岐を切り替えるたびに到着予想タイルを再計算し、手札の禁止マーク表示を更新
- 到着予想タイルが複数ある場合、**1つでも配置不可なら禁止マーク表示**（厳しい判定）
- 選択確定時に到着予想制限をクリア

### 実装箇所

| ファイル | 役割 |
|---------|------|
| `scripts/ui_components/card_selection_ui.gd` | `predicted_destination_tiles`で複数タイル判定、`update_restriction_for_destinations()`で制限表示更新 |
| `scripts/movement_controller.gd` | 方向/分岐切り替え時に到着予想計算→`_update_hand_restriction_for_destinations()`で反映 |

### card_selection_ui.gd

```gdscript
var predicted_destination_tiles: Array = []  # 到着予想タイルインデックス配列

# _check_cannot_summon内で到着予想タイルが設定されている場合は複数タイルでチェック
if not predicted_destination_tiles.is_empty():
	for tile_index in predicted_destination_tiles:
		var tile = board.tile_nodes.get(tile_index)
		if tile and tile.tile_type in cannot_summon:
			return false  # 1つでも配置不可なら不可
	return true
```

### movement_controller.gd

```gdscript
# 方向選択切り替え時（_update_direction_selection_ui内）
var destinations = predict_all_destinations(first_tile, _current_remaining_steps - 1, ct)
_update_hand_restriction_for_destinations(destinations)

# 分岐選択切り替え時（_update_branch_selection_ui内）
var destinations = predict_all_destinations(selected_tile, steps_after_branch, current_branch_tile)
_update_hand_restriction_for_destinations(destinations)

# 確定時にクリア
_update_hand_restriction_for_destinations([])
```

---

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2026/01/14 | 初版作成、移動時の配置制限チェック追加 |
| 2026/02/10 | 交換時の配置制限チェック修正（プレイヤー位置→交換対象タイル）、方向/分岐選択時の到着予想に基づく配置制限表示追加 |
