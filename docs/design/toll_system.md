# 通行料システム設計書

**プロジェクト**: カルドセプト風カードバトルゲーム  
**バージョン**: 1.0  
**作成日**: 2025年11月20日  
**ステータス**: 設計確定

---

## 📋 目次

1. [概要](#概要)
2. [通行料の基本概念](#通行料の基本概念)
3. [通行料の計算方式](#通行料の計算方式)
4. [通行料の料金体系](#通行料の料金体系)
5. [通行料呪いとの連携](#通行料呪いとの連携)
6. [実装仕様](#実装仕様)
7. [使用例](#使用例)

---

## 概要

通行料システムは、プレイヤーが他プレイヤーの領地に移動する際に、その領地の所有者に支払う金銭システムです。

---

## 通行料の基本概念

### 通行料発生条件

- プレイヤーが **他プレイヤーの領地** に移動した場合
- 移動元がスタートポジションの場合、通行料は発生しない
- 同じプレイヤーの領地移動に通行料なし

### 通行料支払いプレイヤー

- 移動を実行するプレイヤーが支払う

### 通行料受取プレイヤー

- 領地の所有者（領地にいるセプター）

---

## 通行料の計算方式

### 基本計算式

```
通行料 = 基本料金 × 土地レベル係数 × 修正係数
```

### 基本料金

```
基本料金 = 土地の元々のクリーチャーのMP値
```

**例:**
- ガスクラウド（MP値: 20）の領地 → 基本料金: 20G
- キメラ（MP値: 40）の領地 → 基本料金: 40G

### 土地レベル係数

| 土地レベル | 係数 | 計算例 |
|----------|------|--------|
| Lv1 | 1.0 | 20G × 1.0 = 20G |
| Lv2 | 1.2 | 20G × 1.2 = 24G |
| Lv3 | 1.5 | 20G × 1.5 = 30G |
| Lv4 | 2.0 | 20G × 2.0 = 40G |

### 修正係数

#### 呪いなし（通常状態）
```
修正係数 = 1.0
```

#### 呪いあり
詳細は「通行料呪いとの連携」を参照

---

## 通行料の料金体系

### パターン分類

#### 1. 標準通行料
- 通常の通行料計算
- 修正係数: 1.0

**計算:**
```
通行料 = MP × 土地レベル係数 × 1.0
```

**例:**
```
ガスクラウド（MP:20）Lv3領地
通行料 = 20 × 1.5 = 30G
```

---

#### 2. 割増通行料（倍率）
- 呪いによる倍率修正
- 修正係数: 1.5, 2.0 など

**計算:**
```
通行料 = MP × 土地レベル係数 × 倍率
```

**例:**
```
通行料1.5倍呪い
通行料 = 20 × 1.5 × 1.5 = 45G
```

---

#### 3. 固定通行料
- 呪いによる固定値設定
- レベル係数を無視し、固定値となる

**計算:**
```
通行料 = 固定値
```

**例:**
```
通行料固定200G呪い
通行料 = 200G（レベル関係なし）
```

---

#### 4. 通行料無効
- 呪いによる無効化
- 通行料なし

**計算:**
```
通行料 = 0G
```

---

#### 5. 通行料共有
- 呪いによる共有化
- 支払った通行料の一定割合を呪いプレイヤーが得る

**計算:**
```
通常の通行料が発生
一定割合（例: 50%）が呪いプレイヤーに配分
```

**例:**
```
通行料共有（50%）呪い
通常の通行料: 30G
元領地オーナー: 15G取得
呪いプレイヤー: 15G取得
```

---

## 通行料呪いとの連携

### 通行料呪いの種類

| 呪いタイプ | 効果 | 実装ファイル |
|----------|------|----------|
| `toll_multiplier` | 通行料倍率 | spell_curse_toll.gd |
| `toll_fixed` | 通行料固定 | spell_curse_toll.gd |
| `toll_disable` | 通行料無効 | spell_curse_toll.gd |
| `toll_share` | 通行料共有 | spell_curse_toll.gd |
| `peace` | 侵略不可+通行料0 | spell_curse_toll.gd |

### 呪い適用ロジック

#### 支払い側（移動プレイヤー）の呪い

**toll_disable（通行料無効）:**
```
移動プレイヤーが呪いを持つ
→ 通行料を支払わない（0G）
```

**peace（平和）:**
```
移動プレイヤーが呪いを持つ
→ 侵略不可 + 通行料0G
```

#### 受取側（領地所有者）の呪い

**toll_share（通行料共有）:**
```
領地所有者が呪いを持つ
→ 支払われた通行料の50%を呪いプレイヤーに配分
```

**toll_fixed（通行料固定）:**
```
領地所有者が呪いを持つ
→ 通行料を固定値（例: 200G）に変更
```

**toll_multiplier（通行料倍率）:**
```
領地所有者が呪いを持つ
→ 通行料を1.5倍に変更
```

---

## 実装仕様

### 通行料計算タイミング

1. **ターン終了時（スタート通過時）**
   - 移動が完了してから通行料を計算
   - 呪いの影響を確認
   - 金銭の移動を実行

### 計算フロー

```
1. 移動完了
   ↓
2. 移動先の領地オーナー確認
   ↓
3. 自領地？ → Yes: 通行料なし
   ↓ No
4. 基本料金計算（MP値）
   ↓
5. 土地レベル係数適用
   ↓
6. 呪い確認
   ├─ 支払い側の呪い
   │  ├─ toll_disable → 通行料 = 0G
   │  └─ peace → 通行料 = 0G
   ├─ 受取側の呪い
   │  ├─ toll_fixed → 通行料 = 固定値
   │  ├─ toll_multiplier → 通行料 × 倍率
   │  └─ toll_share → 割合配分
   └─ 修正後の通行料確定
   ↓
7. 金銭移動
   ├─ 支払いプレイヤー: -通行料
   ├─ 領地オーナー: +通行料（またはその一部）
   └─ 呪いプレイヤー: +配分額（該当時のみ）
   ↓
8. ログ出力
```

### 実装ファイル

**主要ファイル:**
- `scripts/game_flow/movement_controller.gd` - 通行料計算・支払い
- `scripts/spells/spell_curse_toll.gd` - 通行料呪いの実装

**関連ファイル:**
- `scripts/game_flow/land_action_helper.gd` - 土地情報取得
- `scripts/ui_components/` - UI表示

---

## 使用例

### 例1: 基本的な通行料

```
シナリオ:
- ガスクラウド（MP:20）が Lv3 で配置
- プレイヤーB がプレイヤーA の領地に移動

計算:
基本料金 = 20G
土地レベル係数 = 1.5（Lv3）
通行料 = 20 × 1.5 = 30G

結果:
プレイヤーB: -30G
プレイヤーA: +30G
```

### 例2: 通行料倍率呪い

```
シナリオ:
- キメラ（MP:40）が Lv2 で配置
- 領地オーナー がプレイヤーに「通行料1.5倍呪い」をかけている
- プレイヤーC が領地に移動

計算:
基本料金 = 40G
土地レベル係数 = 1.2（Lv2）
呪いによる倍率 = 1.5
通行料 = 40 × 1.2 × 1.5 = 72G

結果:
プレイヤーC: -72G
領地オーナー: +72G
```

### 例3: 通行料共有呪い

```
シナリオ:
- ピュトン（MP:30）が Lv3 で配置
- 領地オーナー がプレイヤーに「通行料共有（50%）呪い」をかけている
- プレイヤーD が領地に移動

計算:
基本料金 = 30G
土地レベル係数 = 1.5（Lv3）
通常通行料 = 30 × 1.5 = 45G
共有比率 = 50%

結果:
プレイヤーD: -45G
領地オーナー: +22G（45G × 50%）
呪いプレイヤー: +23G（45G × 50% + 端数）
```

### 例4: 通行料固定呪い

```
シナリオ:
- クリーチャー（MP:50）が Lv4 で配置
- 領地オーナー がプレイヤーに「通行料固定200G呪い」をかけている
- プレイヤーE が領地に移動

計算:
通常の計算は無視
固定値: 200G

結果:
プレイヤーE: -200G
領地オーナー: +200G

※ Lv1-4、MP値に関わらず200G固定
```

### 例5: 通行料無効呪い

```
シナリオ:
- クリーチャー が配置
- プレイヤーF が「通行料無効呪い」を持っている
- プレイヤーF がプレイヤーG の領地に移動

計算:
通常の通行料計算が無視される
通行料 = 0G

結果:
プレイヤーF: 金銭変化なし
プレイヤーG: 金銭変化なし
```

---

## 設計上の注意事項

### 1. 複数呪いの場合

- 支払い側の呪い が優先される
- 支払い側の呪いがない場合のみ受取側の呪い を適用

### 2. レベルアップ時の通行料再計算

- 土地レベルが上昇すると、次の移動時から新しい係数が適用される

### 3. 呪い解除時

- 呪い解除後は通常の計算に戻る
- 既に支払った通行料は返金されない

### 4. マイナス金銭対応

- プレイヤーの金銭がマイナスになる可能性
- 実装時に「支払い不可」ルールを検討が必要

---

## 関連ドキュメント

- [通行料呪いスペル設計](spells/通行料呪い.md) - 呪いの詳細仕様
- [ランドシステム](land_system.md) - 土地レベル、クリーチャー配置
- [呪い効果](spells/呪い効果.md) - 呪い全般

---

**最終更新**: 2025年11月20日
