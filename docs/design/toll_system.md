# 通行料システム設計書

**プロジェクト**: カルドセプト風カードバトルゲーム  
**バージョン**: 1.0  
**作成日**: 2025年11月20日  
**ステータス**: 設計確定

---

## 📋 目次

1. [概要](#概要)
2. [通行料の基本概念](#通行料の基本概念)
3. [通行料の計算方式](#通行料の計算方式)
4. [通行料の料金体系](#通行料の料金体系)
5. [通行料呪いとの連携](#通行料呪いとの連携)
6. [実装仕様](#実装仕様)
7. [使用例](#使用例)

---

## 概要

通行料システムは、プレイヤーが他プレイヤーの領地に移動する際に、その領地の所有者に支払う金銭システムです。

---

## 通行料の基本概念

### 通行料発生条件

- プレイヤーが **他プレイヤーの領地** に移動した場合
- 移動元がスタートポジションの場合、通行料は発生しない
- 同じプレイヤーの領地移動に通行料なし

### 通行料支払いプレイヤー

- 移動を実行するプレイヤーが支払う

### 通行料受取プレイヤー

- 領地の所有者（領地にいるセプター）

---

## 通行料の計算方式

### 基本計算式

```
通行料 = 基本料金 × 土地レベル係数 × 修正係数
```

### 基本料金

```
基本料金 = 土地の元々のクリーチャーのMP値
```

**例:**
- ガスクラウド（MP値: 20）の領地 → 基本料金: 20G
- キメラ（MP値: 40）の領地 → 基本料金: 40G

### 土地レベル係数

| 土地レベル | 係数 | 計算例 |
|----------|------|--------|
| Lv1 | 1.0 | 20G × 1.0 = 20G |
| Lv2 | 1.2 | 20G × 1.2 = 24G |
| Lv3 | 1.5 | 20G × 1.5 = 30G |
| Lv4 | 2.0 | 20G × 2.0 = 40G |

### 修正係数

#### 呪いなし（通常状態）
```
修正係数 = 1.0
```

#### 呪いあり
詳細は「通行料呪いとの連携」を参照

---

## 通行料の料金体系

### パターン分類

#### 1. 標準通行料
- 通常の通行料計算
- 修正係数: 1.0

**計算:**
```
通行料 = MP × 土地レベル係数 × 1.0
```

**例:**
```
ガスクラウド（MP:20）Lv3領地
通行料 = 20 × 1.5 = 30G
```

---

#### 2. 割増通行料（倍率）
- 呪いによる倍率修正
- 修正係数: 1.5, 2.0 など

**計算:**
```
通行料 = MP × 土地レベル係数 × 倍率
```

**例:**
```
通行料1.5倍呪い
通行料 = 20 × 1.5 × 1.5 = 45G
```

---

#### 3. 固定通行料
- 呪いによる固定値設定
- レベル係数を無視し、固定値となる

**計算:**
```
通行料 = 固定値
```

**例:**
```
通行料固定200G呪い
通行料 = 200G（レベル関係なし）
```

---

#### 4. 通行料無効
- 呪いによる無効化
- 通行料なし

**計算:**
```
通行料 = 0G
```

---

#### 5. 通行料共有
- 呪いによる共有化
- 支払った通行料の一定割合を呪いプレイヤーが得る

**計算:**
```
通常の通行料が発生
一定割合（例: 50%）が呪いプレイヤーに配分
```

**例:**
```
通行料共有（50%）呪い
通常の通行料: 30G
元領地オーナー: 15G取得
呪いプレイヤー: 15G取得
```

---

## 通行料呪いとの連携

### 通行料呪いの種類

| 呪いタイプ | 効果 | 実装ファイル |
|----------|------|----------|
| `toll_multiplier` | 通行料倍率 | spell_curse_toll.gd |
| `toll_fixed` | 通行料固定 | spell_curse_toll.gd |
| `toll_disable` | 通行料無効 | spell_curse_toll.gd |
| `toll_share` | 通行料共有 | spell_curse_toll.gd |
| `peace` | 侵略不可+通行料0 | spell_curse_toll.gd |

### 呪い適用ロジック

#### 支払い側（移動プレイヤー）の呪い

**toll_disable（通行料無効）:**
```
移動プレイヤーが呪いを持つ
→ 通行料を支払わない（0G）
```

**peace（平和）:**
```
移動プレイヤーが呪いを持つ
→ 侵略不可 + 通行料0G
```

#### 受取側（領地所有者）の呪い

**toll_share（通行料共有）:**
```
領地所有者が呪いを持つ
→ 支払われた通行料の50%を呪いプレイヤーに配分
```

**toll_fixed（通行料固定）:**
```
領地所有者が呪いを持つ
→ 通行料を固定値（例: 200G）に変更
```

**toll_multiplier（通行料倍率）:**
```
領地所有者が呪いを持つ
→ 通行料を1.5倍に変更
```

---

## 実装仕様

### 通行料支払いの統一タイミング

**統一原則**: `end_turn()` 実行時に敵地判定・支払い

```
ターン内のすべてのアクション完了
  ↓
end_turn() 呼び出し
  ↓
check_and_pay_toll_on_enemy_land() 実行 ← ★ここで判定
  ├─ 敵地にいるか確認
  ├─ 敵地ならば支払い計算
  └─ 支払い処理実行
  ↓
その他のターン終了処理
```

**パスアクション時**:
- `on_action_pass()` は支払い処理なし
- `tile_action_completed` シグナル → `end_turn()` へ

**戦闘敗北時**:
- `_on_battle_completed()` から `end_turn()` へ
- どのシーンでも同じ敵地判定フロー

### 計算フロー（end_turn()内）

```
end_turn() 実行フロー:

1. 初期チェック（重複防止）
2. UI/ランドコマンド閉じる
3. ★手札調整実行
   └─ check_and_discard_excess_cards()
   
4. ★敵地判定・支払い実行 ← ここで実行
   ├─ 敵地判定
   │  ├─ 現在のプレイヤー位置を取得
   │  ├─ 位置の所有者を確認
   │  └─ 敵地か？ → No: 支払いなし（終了）
   │
   ├─ Yes: 敵地にいる場合
   │  ├─ 領地のタイル情報取得
   │  ├─ 通行料計算
   │  │  └─ board_system.calculate_toll()
   │  └─ 呪い確認（将来実装）
   │
   └─ 支払い実行
       ├─ player_system.pay_toll(payer, receiver, amount)
       ├─ 魔力不足時は持っている分だけ支払い
       └─ ログ出力
   
5. 呪い処理（duration更新）
6. プレイヤー切り替え
7. カメラ移動
8. フェーズリセット
9. 次ターン開始
```

### 実装ファイル

**主要ファイル:**
- `scripts/game_flow_manager.gd` - **敵地判定・支払い実装**
  - `end_turn()` 内に `check_and_pay_toll_on_enemy_land()` 追加
  - ターン終了前に必ず敵地チェック
  
**削除するファイル:**
- `scripts/battle_system.gd` - `pay_toll_3d()` を削除
- `scripts/tile_action_processor.gd` - `on_action_pass()` から支払いロジック削除

**参照するファイル:**
- `scripts/tile_data_manager.gd` - `calculate_toll()` で通行料計算
- `scripts/player_system.gd` - `pay_toll()` で金銭移動
- `scripts/game_constants.gd` - 定数定義

---

## 使用例

### 例1: 基本的な通行料

```
シナリオ:
- ガスクラウド（MP:20）が Lv3 で配置
- プレイヤーB がプレイヤーA の領地に移動

計算:
基本料金 = 20G
土地レベル係数 = 1.5（Lv3）
通行料 = 20 × 1.5 = 30G

結果:
プレイヤーB: -30G
プレイヤーA: +30G
```

### 例2: 通行料倍率呪い

```
シナリオ:
- キメラ（MP:40）が Lv2 で配置
- 領地オーナー がプレイヤーに「通行料1.5倍呪い」をかけている
- プレイヤーC が領地に移動

計算:
基本料金 = 40G
土地レベル係数 = 1.2（Lv2）
呪いによる倍率 = 1.5
通行料 = 40 × 1.2 × 1.5 = 72G

結果:
プレイヤーC: -72G
領地オーナー: +72G
```

### 例3: 通行料共有呪い

```
シナリオ:
- ピュトン（MP:30）が Lv3 で配置
- 領地オーナー がプレイヤーに「通行料共有（50%）呪い」をかけている
- プレイヤーD が領地に移動

計算:
基本料金 = 30G
土地レベル係数 = 1.5（Lv3）
通常通行料 = 30 × 1.5 = 45G
共有比率 = 50%

結果:
プレイヤーD: -45G
領地オーナー: +22G（45G × 50%）
呪いプレイヤー: +23G（45G × 50% + 端数）
```

### 例4: 通行料固定呪い

```
シナリオ:
- クリーチャー（MP:50）が Lv4 で配置
- 領地オーナー がプレイヤーに「通行料固定200G呪い」をかけている
- プレイヤーE が領地に移動

計算:
通常の計算は無視
固定値: 200G

結果:
プレイヤーE: -200G
領地オーナー: +200G

※ Lv1-4、MP値に関わらず200G固定
```

### 例5: 通行料無効呪い

```
シナリオ:
- クリーチャー が配置
- プレイヤーF が「通行料無効呪い」を持っている
- プレイヤーF がプレイヤーG の領地に移動

計算:
通常の通行料計算が無視される
通行料 = 0G

結果:
プレイヤーF: 金銭変化なし
プレイヤーG: 金銭変化なし
```

---

---

## 変更履歴（2025/11/23）

### v2.2 アップデート：end_turn()への完全集約

**最終実装方針**:
1. **end_turn()に敵地判定を一本化**
   - 新規関数 `check_and_pay_toll_on_enemy_land()` をend_turn()内に追加
   - ターン終了時に**必ず**敵地判定を実行
2. **on_action_pass()から支払い削除**
   - パスボタンは支払い処理なし
   - シグナル発火で end_turn() へ
3. **battle_system.gd から pay_toll_3d() 削除**
   - バトルシステムから支払いロジック完全削除
4. **シグナル不要**
   - tile_action_completed で十分
   - end_turn()は必ず呼ばれるため接続忘れなし

**改善効果**:
- ✅ コードの重複排除（完全版）
- ✅ 判定ロジックが1箇所に統一
- ✅ バトル/パス/敗北で同じ処理
- ✅ シグナル管理不要で単純化
- ✅ 見落とし防止（end_turn()は必ず呼ばれる）

---

## 設計上の注意事項

### 1. 複数呪いの場合

- 支払い側の呪い が優先される
- 支払い側の呪いがない場合のみ受取側の呪い を適用

### 2. レベルアップ時の通行料再計算

- 土地レベルが上昇すると、次の移動時から新しい係数が適用される

### 3. 呪い解除時

- 呪い解除後は通常の計算に戻る
- 既に支払った通行料は返金されない

### 4. マイナス金銭対応

- プレイヤーの金銭がマイナスになる可能性
- 実装時に「支払い不可」ルールを検討が必要

---

## 関連ドキュメント

- [通行料呪いスペル設計](spells/通行料呪い.md) - 呪いの詳細仕様
- [ランドシステム](land_system.md) - 土地レベル、クリーチャー配置
- [呪い効果](spells/呪い効果.md) - 呪い全般

---

**最終更新**: 2025年11月20日
