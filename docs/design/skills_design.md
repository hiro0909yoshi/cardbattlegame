# 🎮 スキルシステム設計書

**プロジェクト**: カルドセプト風カードバトルゲーム  
**バージョン**: 1.8  
**最終更新**: 2025年10月24日

---

## 📋 目次

1. [スキルシステム概要](#スキルシステム概要)
2. [実装済みスキル一覧](#実装済みスキル一覧)
3. [個別スキル仕様書へのリンク](#スキル詳細仕様) ⭐NEW
4. [スキル適用順序](#スキル適用順序)
5. [BattleParticipantとHP管理](#battleparticipantとhp管理)
6. [スキル条件システム](#スキル条件システム)
7. [将来実装予定のスキル](#将来実装予定のスキル)

---

## スキルシステム概要

### アーキテクチャ

```
SkillSystem (マネージャー)
  ├── ConditionChecker (条件判定)
  │   ├── build_battle_context()
  │   ├── evaluate_conditions()
  │   └── 各種条件評価メソッド
  │
  └── EffectCombat (効果適用)
	  ├── apply_power_strike()
	  ├── apply_first_strike()
	  └── その他効果メソッド
```

### バトルでのスキル適用フロー

1. **BattleParticipant作成** - 基本ステータス設定、先制判定
2. **ability_parsed解析** - keywords配列チェック、条件取得
3. **条件判定** (ConditionChecker) - バトルコンテキスト構築、各条件を評価
4. **効果適用** (EffectCombat) - 感応・強打等のスキル適用
5. **バトル実行** - 修正後のAP/HPで戦闘

詳細は **[battle_system.md](battle_system.md)** を参照

---

## 実装済みスキル一覧

| スキル名 | タイプ | 効果 | 実装状況 |
|---------|--------|------|---------|
| 感応 | パッシブ | 特定属性の土地所有でAP/HP上昇 | ✅ 完全実装 |
| 応援 | パッシブ | 盤面のクリーチャーにバフ付与 | ✅ 完全実装 |
| 貫通 | パッシブ | 防御側の土地ボーナス無効化 | ✅ 完全実装 |
| 強打 | パッシブ | 条件下でAP増幅 | ✅ 完全実装 |
| 先制 | パッシブ | 先攻権獲得 | ✅ 完全実装 |
| 後手 | パッシブ | 相手が先攻 | ✅ 完全実装 |
| 再生 | パッシブ | バトル後にHP全回復 | ✅ 完全実装 |
| 土地数比例 | パッシブ | 土地数×倍率でAP/HP上昇 | ✅ 完全実装 |
| 不屈 | パッシブ | アクション後もダウンしない | ✅ 完全実装 |
| 2回攻撃 | パッシブ | 1回のバトルで2回攻撃 | ✅ 完全実装 |
| 即死 | アクティブ | 確率で相手を即死 | ✅ 完全実装 |
| 防魔 | パッシブ | スペル無効化 | 🔶 部分実装 |
| ST変動 | パッシブ | 土地数でAP変動 | ✅ 完全実装 |
| HP変動 | パッシブ | 土地数でHP変動 | 🔶 部分実装 |
| 無効化 | パッシブ | 特定攻撃/属性の無効化 | ✅ 完全実装 |
| 巻物攻撃 | パッシブ | 巻物使用時の特殊攻撃 | ✅ 完全実装 |
| 反射 | リアクティブ | 受けたダメージを攻撃者に返す | ✅ 完全実装 |
| 反射無効 | パッシブ | 相手の反射を無効化 | ✅ 完全実装 |
| 援護 | アイテムフェーズ | 手札クリーチャーをAP/HP加算に使用 | ✅ 完全実装 |
| 変身 | アクティブ | 自身または相手を別のクリーチャーに変身 | ✅ 完全実装 |
| 死者復活 | リアクティブ | 撃破時に別のクリーチャーとして復活 | ✅ 完全実装 |
| アイテム破壊 | バトル前 | 相手のアイテムを破壊 | ✅ 完全実装 |
| アイテム盗み | バトル前 | 相手のアイテムを奪う | ✅ 完全実装 |

## スキル適用順序

バトル前のスキル適用は以下の順序で実行される:

```
1. 応援スキル適用 (apply_support_skills_to_all) ✨NEW
   ├─ 盤面の応援持ちクリーチャーを取得
   ├─ 条件を満たすバトル参加者にバフ付与
   └─ 動的ボーナス（隣接自領地数）を計算
   
2. 巻物攻撃判定 (check_scroll_attack)
3. 感応スキル (apply_resonance_skill)
4. 土地数比例効果 (apply_land_count_effects)
   ├─ プレイヤーの土地所有状況を確認
   ├─ 条件を満たせばAPとHPを上昇
   └─ resonance_bonus_hpフィールドに加算
   
5. 強打スキル (apply_power_strike)
   ├─ 感応適用後のAPを基準に計算
   ├─ 条件を満たせばAPを増幅
   └─ 例: 基本20 → 感応+30=50 → 強打×1.5=75
   
6. 2回攻撃判定 (_check_double_attack)
   ├─ 2回攻撃スキル保持チェック
   └─ attack_count = 2 に設定
   
7. 攻撃シーケンス (_execute_attack_sequence)
   ├─ 攻撃順決定（先制・後手判定）
   ├─ 各攻撃ごとにダメージ適用
   └─ **攻撃後に即死判定** (_check_instant_death)
	  ├─ 即死スキル保持チェック
	  ├─ 条件判定（属性、ST、立場など）
	  ├─ 確率判定
	  └─ 成功時: instant_death_flag = true, HP = 0
   
8. バトル結果判定 (_resolve_battle_result)
   ├─ HPチェック
   └─ 勝敗決定
   
9. バトル後処理 (_apply_post_battle_effects)
   ├─ 再生スキル適用（生存者のみ）
   │  └─ HP > 0 の場合のみ発動
   ├─ 土地奪取 or カード破壊 or 手札復帰
   └─ クリーチャーHP更新

**注**: 不屈スキルはバトル処理とは独立して動作し、アクション後のダウン判定時に適用される。バトルフロー内では関与しない。
```

### 設計思想

この順序により、複数スキルを持つクリーチャーは相乗効果を得られる。

**例: 感応+強打の組み合わせ**
```
モルモ（感応[火]+30、強打×1.5を仮定）

基本AP: 20
  ↓ 感応発動（火土地1個所有）
AP: 50 (+30)
  ↓ 強打発動（隣接自領地あり）
AP: 75 (×1.5)

→ 最終的にAP: 75で攻撃！
```



## BattleParticipantとHP管理

詳細は **[battle_system.md](battle_system.md)** を参照してください。

---

## スキル条件システム

### 実装済み条件一覧

| 条件タイプ | 説明 | 使用例 |
|-----------|------|--------|
| `on_element_land` | 特定属性の土地 | 火土地で強打 |
| `has_item_type` | アイテム装備 | 武器装備時強打 |
| `land_level_check` | 土地レベル判定 | レベル3以上で強打 |
| `element_land_count` | 属性土地数 | 火土地3個以上で強打 |
| `adjacent_ally_land` | 隣接自領地判定 | 隣接に自土地あり |
| `enemy_is_element` | 敵属性判定 | 敵が水属性で貫通 |
| `attacker_st_check` | 攻撃力判定 | ST40以上で貫通 |

### adjacent_ally_land条件（詳細）

#### 定義
バトル発生タイルの物理的な隣接タイルに、攻撃プレイヤーの領地が存在するか判定。

#### 評価フロー

```
1. BattleSystem
   ├─ battle_tile_index (バトル発生タイル)
   ├─ player_id (攻撃プレイヤー)
   └─ board_system参照

2. ConditionChecker
   └─ adjacent_ally_land条件を検出

3. TileNeighborSystem
   ├─ get_spatial_neighbors(battle_tile)
   │  └─ 物理座標ベースで隣接タイル取得
   ├─ 各隣接タイルのownerをチェック
   └─ 自領地があれば true

4. 効果発動
   └─ 強打等のスキルが発動
```

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025/01/12 | 1.0 | 初版作成 - design.mdから分離 |
| 2025/01/12 | 1.1 | 🆕 再生スキル追加（11体実装） |
| 2025/01/12 | 1.2 | 🆕 2回攻撃スキル追加（1体実装、拡張性考慮） |
| 2025/01/13 | 1.3 | 🆕 即死スキル追加（6体実装）、後手スキル追加（1体実装） |
| 2025/10/23 | 1.4 | 🆕 応援スキル追加（9体実装）、種族システム先行実装、無効化スキルへの参照追加 |
| 2025/10/23 | 1.5 | 🆕 反射スキル追加（6種類実装完了：反射100%、反射50%、反射[巻物]、反射[全]、反射無効） |
| 2025/10/24 | 1.6 | 🆕 援護スキル追加（18体実装完了、全属性対応5体・特定属性13体） |
| 2025/10/25 | 1.7 | 🔄 スキル詳細仕様セクションをリファクタリング - 個別ファイル（14個）へのリンク集に置き換え |
| 2025/10/24 | 1.8 | 🆕 変身スキル追加（2体実装：バルダンダース、コカトリス）|
| 2025/10/24 | 1.9 | 🆕 死者復活スキル追加（4体+1アイテム実装済み）、バグ修正（リビングアムルのcreature_id、アイテムカテゴリチェック）|

---

**最終更新**: 2025年10月24日（v1.9）
