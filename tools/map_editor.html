<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒƒãƒ—ã‚¨ãƒ‡ã‚£ã‚¿ - Card Battle Game</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
            display: flex;
            gap: 20px;
        }
        
        /* å·¦ãƒ‘ãƒãƒ« - ã‚¨ãƒ‡ã‚£ã‚¿ */
        .editor-panel {
            flex: 1;
            max-width: 800px;
        }
        
        /* å³ãƒ‘ãƒãƒ« - JSON */
        .json-panel {
            width: 400px;
            display: flex;
            flex-direction: column;
        }
        
        h1 {
            margin: 0 0 20px 0;
            color: #00d4ff;
        }
        
        h2 {
            margin: 10px 0;
            color: #00d4ff;
            font-size: 16px;
        }
        
        /* ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å…¥åŠ› */
        .meta-section {
            background: #16213e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .meta-section label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #aaa;
        }
        
        .meta-section input, .meta-section textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #0f0f23;
            color: #eee;
        }
        
        .meta-row {
            display: flex;
            gap: 10px;
        }
        
        .meta-row > div {
            flex: 1;
        }
        
        /* ã‚¿ã‚¤ãƒ«ãƒ‘ãƒ¬ãƒƒãƒˆ */
        .palette {
            background: #16213e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .palette-tiles {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .palette-tile {
            width: 50px;
            height: 50px;
            border: 2px solid #333;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .palette-tile:hover {
            transform: scale(1.1);
        }
        
        .palette-tile.selected {
            border-color: #00d4ff;
            box-shadow: 0 0 10px #00d4ff;
        }
        
        .palette-tile.eraser {
            background: #333;
            color: #fff;
        }
        
        .tile-fire { background: #e74c3c; color: #fff; }
        .tile-water { background: #3498db; color: #fff; }
        .tile-earth { background: #8b4513; color: #fff; }
        .tile-wind { background: #2ecc71; color: #fff; }
        .tile-neutral { background: #95a5a6; color: #fff; }
        .tile-checkpoint { background: #f39c12; color: #fff; }
        .tile-warp { background: #9b59b6; color: #fff; }
        .tile-warpstop { background: #8e44ad; color: #fff; }
        .tile-magic { background: #e91e63; color: #fff; }
        .tile-cardbuy { background: #00bcd4; color: #fff; }
        .tile-branch { background: #ff9800; color: #fff; }
        .tile-base { background: #ffeb3b; color: #333; }
        
        /* ã‚°ãƒªãƒƒãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿ */
        .grid-container {
            background: #16213e;
            padding: 15px;
            border-radius: 8px;
            overflow: auto;
        }
        
        .grid {
            display: grid;
            gap: 2px;
            background: #0f0f23;
            padding: 10px;
            border-radius: 4px;
            width: fit-content;
        }
        
        .grid-cell {
            width: 40px;
            height: 40px;
            background: #1a1a2e;
            border: 1px solid #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: bold;
            transition: background 0.2s;
            position: relative;
        }
        
        .grid-cell:hover {
            border-color: #00d4ff;
        }
        
        .grid-cell .tile-index {
            position: absolute;
            top: 1px;
            left: 2px;
            font-size: 8px;
            color: rgba(255,255,255,0.7);
        }
        
        /* ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºè¨­å®š */
        .grid-size {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .grid-size input {
            width: 60px;
            padding: 5px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #0f0f23;
            color: #eee;
        }
        
        .grid-size button {
            padding: 5px 15px;
            background: #00d4ff;
            border: none;
            border-radius: 4px;
            color: #000;
            cursor: pointer;
            font-weight: bold;
        }
        
        /* JSONãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
        .json-preview {
            flex: 1;
            background: #0f0f23;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 11px;
            overflow: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        /* ãƒœã‚¿ãƒ³ */
        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #00d4ff;
            color: #000;
        }
        
        .btn-secondary {
            background: #333;
            color: #fff;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: #fff;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        /* ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ */
        .drop-zone {
            border: 2px dashed #333;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            transition: all 0.2s;
        }
        
        .drop-zone.dragover {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
        }
        
        /* ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆè¨­å®š */
        .checkpoint-select {
            margin-top: 5px;
        }
        
        .checkpoint-select select {
            padding: 5px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #0f0f23;
            color: #eee;
        }
        
        /* Warpãƒšã‚¢è¨­å®š */
        .warp-config {
            margin-top: 10px;
            padding: 10px;
            background: #0f0f23;
            border-radius: 4px;
        }
        
        .warp-pair {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }
        
        .warp-pair input {
            width: 60px;
            padding: 5px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #1a1a2e;
            color: #eee;
        }

        /* æ¥ç¶šè¨­å®š */
        .connection-section {
            background: #16213e;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .connection-list {
            max-height: 150px;
            overflow-y: auto;
        }

        .connection-item {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 5px;
        }

        .connection-item input {
            width: 60px;
            padding: 5px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #0f0f23;
            color: #eee;
        }

        .connection-item button {
            padding: 3px 8px;
            background: #e74c3c;
            border: none;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
        }

        /* æ¥ç¶šãƒ¢ãƒ¼ãƒ‰ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .connection-mode-active {
            background: rgba(255, 165, 0, 0.2);
            border: 2px solid #ffa500;
        }

        .grid-cell.connection-source {
            border: 3px solid #00ff00 !important;
            box-shadow: 0 0 10px #00ff00;
        }

        .grid-cell.connection-target {
            border: 3px solid #ff00ff !important;
            box-shadow: 0 0 10px #ff00ff;
        }

        .connection-status {
            padding: 10px;
            background: #0f0f23;
            border-radius: 4px;
            margin-bottom: 10px;
            display: none;
        }

        .connection-status.active {
            display: block;
            background: rgba(255, 165, 0, 0.2);
            border: 1px solid #ffa500;
        }

        .connection-status .step {
            font-weight: bold;
            color: #ffa500;
        }
    </style>
</head>
<body>
    <div class="editor-panel">
        <h1>ğŸ—ºï¸ ãƒãƒƒãƒ—ã‚¨ãƒ‡ã‚£ã‚¿</h1>
        
        <!-- ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ -->
        <div class="drop-zone" id="dropZone">
            ğŸ“ æ—¢å­˜ã®ãƒãƒƒãƒ—JSONã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã€ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦èª­ã¿è¾¼ã¿
            <input type="file" id="fileInput" accept=".json" style="display: none;">
        </div>
        
        <!-- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ -->
        <div class="meta-section">
            <h2>ğŸ“‹ ãƒãƒƒãƒ—æƒ…å ±</h2>
            <div class="meta-row">
                <div>
                    <label>ãƒãƒƒãƒ—ID</label>
                    <input type="text" id="mapId" placeholder="map_forest_30">
                </div>
                <div>
                    <label>ãƒãƒƒãƒ—å</label>
                    <input type="text" id="mapName" placeholder="æ£®ã®ã‚¹ãƒ†ãƒ¼ã‚¸">
                </div>
            </div>
            <label>èª¬æ˜</label>
            <textarea id="mapDesc" rows="2" placeholder="ãƒãƒƒãƒ—ã®èª¬æ˜"></textarea>
            <div class="meta-row">
                
                <div>
                    <label>ãƒœãƒ¼ãƒŠã‚¹ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
                    <input type="text" id="bonusPreset" value="standard">
                </div>
                <div>
                    <label>ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
                    <input type="text" id="checkpointPreset" value="standard">
                </div>
            </div>
        </div>
        
        <!-- ã‚¿ã‚¤ãƒ«ãƒ‘ãƒ¬ãƒƒãƒˆ -->
        <div class="palette">
            <h2>ğŸ¨ ã‚¿ã‚¤ãƒ«ãƒ‘ãƒ¬ãƒƒãƒˆ</h2>
            <div class="palette-tiles">
                <div class="palette-tile eraser selected" data-type="eraser" title="æ¶ˆã—ã‚´ãƒ ">âœ•</div>
                <div class="palette-tile tile-fire" data-type="Fire" title="ç«">Fire</div>
                <div class="palette-tile tile-water" data-type="Water" title="æ°´">Water</div>
                <div class="palette-tile tile-earth" data-type="Earth" title="åœŸ">Earth</div>
                <div class="palette-tile tile-wind" data-type="Wind" title="é¢¨">Wind</div>
                <div class="palette-tile tile-neutral" data-type="Neutral" title="ç„¡">Neutral</div>
                <div class="palette-tile tile-magic" data-type="Magic" title="é­”æ³•é™£">Magic</div>
                <div class="palette-tile tile-cardbuy" data-type="CardBuy" title="ã‚«ãƒ¼ãƒ‰è³¼å…¥">CardBuy</div>
                <div class="palette-tile tile-branch" data-type="BranchTile" title="åˆ†å²">Branch</div>
                <div class="palette-tile tile-base" data-type="SpecialBaseTile" title="ãƒ™ãƒ¼ã‚¹">Base</div>
            </div>
            
            <h3 style="margin: 15px 0 10px; font-size: 14px; color: #f39c12;">ğŸ“ ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆï¼ˆ4ç¨®ï¼‰</h3>
            <div class="palette-tiles">
                <div class="palette-tile tile-checkpoint" data-type="Checkpoint_N" title="ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆåŒ—">CP-N</div>
                <div class="palette-tile tile-checkpoint" data-type="Checkpoint_S" title="ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆå—">CP-S</div>
                <div class="palette-tile tile-checkpoint" data-type="Checkpoint_E" title="ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆæ±">CP-E</div>
                <div class="palette-tile tile-checkpoint" data-type="Checkpoint_W" title="ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆè¥¿">CP-W</div>
            </div>
            
            <h3 style="margin: 15px 0 10px; font-size: 14px; color: #9b59b6;">ğŸŒ€ ãƒ¯ãƒ¼ãƒ—ï¼ˆé€šéå‹ãƒšã‚¢ï¼‰</h3>
            <div class="palette-tiles">
                <div class="palette-tile tile-warp" data-type="Warp_A" title="ãƒ¯ãƒ¼ãƒ—é€šéA" style="border: 3px solid #ff6b6b;">WarpA</div>
                <div class="palette-tile tile-warp" data-type="Warp_B" title="ãƒ¯ãƒ¼ãƒ—é€šéB" style="border: 3px solid #ff6b6b;">WarpB</div>
            </div>
            
            <h3 style="margin: 15px 0 10px; font-size: 14px; color: #8e44ad;">ğŸ”® ãƒ¯ãƒ¼ãƒ—ã‚¹ãƒˆãƒƒãƒ—ï¼ˆåœæ­¢å‹ãƒšã‚¢ï¼‰</h3>
            <div class="palette-tiles">
                <div class="palette-tile tile-warpstop" data-type="WarpStop_A" title="ãƒ¯ãƒ¼ãƒ—åœæ­¢A" style="border: 3px solid #4ecdc4;">WStopA</div>
                <div class="palette-tile tile-warpstop" data-type="WarpStop_B" title="ãƒ¯ãƒ¼ãƒ—åœæ­¢B" style="border: 3px solid #4ecdc4;">WStopB</div>
            </div>
        </div>
        
        <!-- ã‚°ãƒªãƒƒãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿ -->
        <div class="grid-container">
            <h2>ğŸ”² ã‚°ãƒªãƒƒãƒ‰</h2>
            <div class="grid-size">
                <label>ã‚µã‚¤ã‚º:</label>
                <input type="number" id="gridWidth" value="15" min="5" max="30">
                <span>Ã—</span>
                <input type="number" id="gridHeight" value="15" min="5" max="30">
                <button onclick="resizeGrid()">ã‚°ãƒªãƒƒãƒ‰æ›´æ–°</button>
                <button onclick="clearGrid()" class="btn-danger" style="background:#e74c3c;">ã‚¯ãƒªã‚¢</button>
            </div>
            <div class="grid" id="grid"></div>
        </div>

        <!-- æ¥ç¶šè¨­å®š -->
        <div class="connection-section" id="connectionSection">
            <h2>ğŸ”— ã‚«ã‚¹ã‚¿ãƒ æ¥ç¶šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</h2>
            <p style="font-size: 12px; color: #888;">é€šå¸¸ã¯è‡ªå‹•ã§indexé †ã«æ¥ç¶šã•ã‚Œã¾ã™ã€‚åˆ†å²ç­‰ã®ç‰¹æ®Šæ¥ç¶šã®ã¿è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
            
            <!-- æ¥ç¶šãƒ¢ãƒ¼ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
            <div class="connection-status" id="connectionStatus">
                <span class="step" id="connectionStep">ã‚¹ãƒ†ãƒƒãƒ—1: æ¥ç¶šå…ƒã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯</span>
                <div id="connectionInfo" style="margin-top: 5px; font-size: 12px;"></div>
            </div>
            
            <div class="connection-list" id="connectionList"></div>
            <div id="connectionButtons">
                <button class="btn btn-secondary" id="addConnectionBtn" onclick="startConnectionMode()">+ æ¥ç¶šè¿½åŠ </button>
                <button class="btn btn-primary" id="finishConnectionBtn" onclick="finishConnection()" style="display: none;">âœ“ æ¥ç¶šç¢ºå®š</button>
                <button class="btn btn-danger" id="cancelConnectionBtn" onclick="cancelConnectionMode()" style="display: none;">âœ• ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>
    
    <div class="json-panel">
        <h2>ğŸ“„ JSONå‡ºåŠ›</h2>
        <div class="json-preview" id="jsonPreview">{}</div>
        <div class="buttons">
            <button class="btn btn-primary" onclick="downloadJson()">ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            <button class="btn btn-secondary" onclick="copyJson()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
        </div>
    </div>
    
    <script>
        // çŠ¶æ…‹ç®¡ç†
        let selectedType = 'eraser';
        let gridData = {}; // { "x,z": { type, order, ... } }
        let nextTileOrder = 0; // æ¬¡ã«é…ç½®ã™ã‚‹ã‚¿ã‚¤ãƒ«ã®é †åºç•ªå·
        let connections = {}; // ã‚«ã‚¹ã‚¿ãƒ æ¥ç¶š
        let warpPairs = {}; // { tileKey: pairTileKey }
        
        // æ¥ç¶šãƒ¢ãƒ¼ãƒ‰ç”¨çŠ¶æ…‹
        let connectionMode = false;
        let connectionSource = null; // { key, index }
        let connectionTargets = []; // [{ key, index }, ...]
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initPalette();
            resizeGrid();
            initDropZone();
        });
        
        // ãƒ‘ãƒ¬ãƒƒãƒˆåˆæœŸåŒ–
        function initPalette() {
            document.querySelectorAll('.palette-tile').forEach(tile => {
                tile.addEventListener('click', () => {
                    document.querySelectorAll('.palette-tile').forEach(t => t.classList.remove('selected'));
                    tile.classList.add('selected');
                    selectedType = tile.dataset.type;
                });
            });
        }
        
        // ã‚°ãƒªãƒƒãƒ‰ãƒªã‚µã‚¤ã‚º
        function resizeGrid() {
            const width = parseInt(document.getElementById('gridWidth').value);
            const height = parseInt(document.getElementById('gridHeight').value);
            const grid = document.getElementById('grid');
            
            grid.style.gridTemplateColumns = `repeat(${width}, 40px)`;
            grid.innerHTML = '';
            
            for (let z = 0; z < height; z++) {
                for (let x = 0; x < width; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.x = x * 4; // 4å˜ä½ã§é…ç½®
                    cell.dataset.z = z * 4;
                    
                    const key = `${x * 4},${z * 4}`;
                    if (gridData[key]) {
                        applyTileStyle(cell, gridData[key]);
                    }
                    
                    cell.addEventListener('click', () => onCellClick(cell));
                    cell.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        onCellRightClick(cell);
                    });
                    
                    grid.appendChild(cell);
                }
            }
            
            updateJson();
        }
        
        // ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯
        function onCellClick(cell) {
            const x = parseInt(cell.dataset.x);
            const z = parseInt(cell.dataset.z);
            const key = `${x},${z}`;
            
            // æ¥ç¶šãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
            if (connectionMode) {
                handleConnectionClick(cell, key);
                return;
            }
            
            if (selectedType === 'eraser') {
                // å‰Šé™¤ã™ã‚‹ã‚¿ã‚¤ãƒ«ã®orderã‚’å–å¾—
                const deletedOrder = gridData[key] ? gridData[key].order : -1;
                delete gridData[key];
                cell.className = 'grid-cell';
                cell.innerHTML = '';
                cell.style.borderColor = '';
                
                // å‰Šé™¤ã—ãŸã‚¿ã‚¤ãƒ«ã‚ˆã‚Šå¾Œã®orderã‚’è©°ã‚ã‚‹
                if (deletedOrder >= 0) {
                    Object.keys(gridData).forEach(k => {
                        if (gridData[k].order > deletedOrder) {
                            gridData[k].order--;
                        }
                    });
                    nextTileOrder--;
                    // ã‚°ãƒªãƒƒãƒ‰å…¨ä½“ã‚’å†æç”»ã—ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
                    refreshGridDisplay();
                }
            } else {
                // æ—¢ã«ã‚¿ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯ä¸Šæ›¸ãï¼ˆorderã¯ç¶­æŒï¼‰
                const existingOrder = gridData[key] ? gridData[key].order : nextTileOrder++;
                
                const tileData = { x, z, order: existingOrder };
                
                // ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆï¼ˆCheckpoint_N â†’ type: Checkpoint, checkpoint_type: Nï¼‰
                if (selectedType.startsWith('Checkpoint_')) {
                    tileData.type = 'Checkpoint';
                    tileData.checkpoint_type = selectedType.split('_')[1];
                }
                // ãƒ¯ãƒ¼ãƒ—é€šéå‹ï¼ˆWarp_A, Warp_Bï¼‰
                else if (selectedType.startsWith('Warp_')) {
                    tileData.type = 'Warp';
                    tileData.warp_group = selectedType.split('_')[1]; // A or B
                }
                // ãƒ¯ãƒ¼ãƒ—åœæ­¢å‹ï¼ˆWarpStop_A, WarpStop_Bï¼‰
                else if (selectedType.startsWith('WarpStop_')) {
                    tileData.type = 'WarpStop';
                    tileData.warp_group = selectedType.split('_')[1]; // A or B
                }
                else {
                    tileData.type = selectedType;
                }
                
                gridData[key] = tileData;
                applyTileStyle(cell, tileData);
            }
            
            updateJson();
        }
        
        // ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç•ªå·ã®å†æç”»ï¼‰
        function refreshGridDisplay() {
            document.querySelectorAll('.grid-cell').forEach(cell => {
                const key = `${cell.dataset.x},${cell.dataset.z}`;
                if (gridData[key]) {
                    applyTileStyle(cell, gridData[key]);
                }
            });
        }
        
        // å³ã‚¯ãƒªãƒƒã‚¯ï¼ˆã‚¿ã‚¤ãƒ«æƒ…å ±è¡¨ç¤ºï¼‰
        function onCellRightClick(cell) {
            const key = `${cell.dataset.x},${cell.dataset.z}`;
            const tile = gridData[key];
            
            if (tile) {
                alert(`ã‚¿ã‚¤ãƒ«æƒ…å ±:\n${JSON.stringify(tile, null, 2)}`);
            }
        }
        
        // ã‚¿ã‚¤ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
        function applyTileStyle(cell, data) {
            const baseType = data.type.toLowerCase();
            cell.className = 'grid-cell tile-' + baseType;
            
            let label = data.type.substring(0, 3);
            
            // ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ
            if (data.type === 'Checkpoint') {
                label = 'CP-' + (data.checkpoint_type || '?');
            }
            // ãƒ¯ãƒ¼ãƒ—ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤ºï¼‰
            else if (data.type === 'Warp') {
                label = 'Wp' + (data.warp_group || '?');
                // ã‚°ãƒ«ãƒ¼ãƒ—ã«å¿œã˜ã¦æ è‰²
                cell.style.borderColor = data.warp_group === 'A' ? '#ff6b6b' : '#6bff6b';
            }
            else if (data.type === 'WarpStop') {
                label = 'WS' + (data.warp_group || '?');
                cell.style.borderColor = data.warp_group === 'A' ? '#4ecdc4' : '#c44ecd';
            }
            else if (data.type === 'Magic') {
                label = 'Mag';
            } else if (data.type === 'BranchTile') {
                label = 'Brn';
            } else if (data.type === 'SpecialBaseTile') {
                label = 'Base';
            }
            
            // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç•ªå·ã‚’è¡¨ç¤ºï¼ˆå·¦ä¸Šã«å°ã•ãï¼‰
            const orderNum = data.order !== undefined ? data.order : '?';
            cell.innerHTML = `<span class="tile-index">${orderNum}</span>${label}`;
        }
        
        // ã‚°ãƒªãƒƒãƒ‰ã‚¯ãƒªã‚¢
        function clearGrid() {
            if (confirm('ã‚°ãƒªãƒƒãƒ‰ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                gridData = {};
                connections = {};
                nextTileOrder = 0;
                resizeGrid();
            }
        }
        
        // JSONæ›´æ–°
        function updateJson() {
            const mapData = {
                id: document.getElementById('mapId').value || 'map_new',
                name: document.getElementById('mapName').value || 'æ–°ã—ã„ãƒãƒƒãƒ—',
                description: document.getElementById('mapDesc').value || '',
                tile_count: Object.keys(gridData).length,
                lap_settings: {
                    bonus_preset: document.getElementById('bonusPreset').value || 'standard',
                    checkpoint_preset: document.getElementById('checkpointPreset').value || 'standard'
                },
                tiles: [],
                connections: connections
            };
            
            // ã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯é †ï¼ˆorderï¼‰ã§ã‚½ãƒ¼ãƒˆ
            const sortedKeys = Object.keys(gridData).sort((a, b) => {
                return (gridData[a].order || 0) - (gridData[b].order || 0);
            });
            
            // orderã‚’indexã¨ã—ã¦ä½¿ç”¨
            const tempTiles = [];
            sortedKeys.forEach((key) => {
                const tile = { ...gridData[key], index: gridData[key].order };
                tempTiles.push({ key, tile });
            });
            
            // ãƒ¯ãƒ¼ãƒ—ãƒšã‚¢ã‚’è‡ªå‹•è¨ˆç®—ï¼ˆåŒã˜warp_groupã§åŒã˜typeåŒå£«ã‚’ãƒšã‚¢ãƒªãƒ³ã‚°ï¼‰
            const warpGroups = { Warp: {}, WarpStop: {} };
            tempTiles.forEach(({ tile }) => {
                if ((tile.type === 'Warp' || tile.type === 'WarpStop') && tile.warp_group) {
                    const groupKey = tile.warp_group;
                    if (!warpGroups[tile.type][groupKey]) {
                        warpGroups[tile.type][groupKey] = [];
                    }
                    warpGroups[tile.type][groupKey].push(tile);
                }
            });
            
            // ãƒšã‚¢ãƒªãƒ³ã‚°è¨­å®š
            Object.values(warpGroups).forEach(groups => {
                Object.values(groups).forEach(tiles => {
                    if (tiles.length === 2) {
                        tiles[0].warp_pair = tiles[1].index;
                        tiles[1].warp_pair = tiles[0].index;
                    }
                });
            });
            
            // æœ€çµ‚ã‚¿ã‚¤ãƒ«é…åˆ—ã‚’ä½œæˆï¼ˆå†…éƒ¨ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å‡ºåŠ›ã‹ã‚‰é™¤å¤–ï¼‰
            tempTiles.forEach(({ tile }) => {
                const outputTile = { ...tile };
                delete outputTile.warp_group; // å†…éƒ¨ç”¨
                delete outputTile.order;      // å†…éƒ¨ç”¨ï¼ˆindexã«å¤‰æ›æ¸ˆã¿ï¼‰
                mapData.tiles.push(outputTile);
            });
            
            // ã‚¿ã‚¤ãƒ«æ•°æ›´æ–°
            mapData.tile_count = mapData.tiles.length;
            
            document.getElementById('jsonPreview').textContent = JSON.stringify(mapData, null, 2);
            
            return mapData;
        }
        
        // JSONãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadJson() {
            const mapData = updateJson();
            const blob = new Blob([JSON.stringify(mapData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = (mapData.id || 'map') + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // JSONã‚³ãƒ”ãƒ¼
        function copyJson() {
            const json = document.getElementById('jsonPreview').textContent;
            navigator.clipboard.writeText(json).then(() => {
                alert('JSONã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            });
        }
        
        // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³åˆæœŸåŒ–
        function initDropZone() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            
            dropZone.addEventListener('click', () => fileInput.click());
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) loadJsonFile(file);
            });
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) loadJsonFile(file);
            });
        }
        
        // JSONãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        function loadJsonFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    loadMapData(data);
                } catch (err) {
                    alert('JSONã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
                }
            };
            reader.readAsText(file);
        }
        
        // ãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadMapData(data) {
            // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
            document.getElementById('mapId').value = data.id || '';
            document.getElementById('mapName').value = data.name || '';
            document.getElementById('mapDesc').value = data.description || '';
            
            if (data.lap_settings) {
                document.getElementById('bonusPreset').value = data.lap_settings.bonus_preset || 'standard';
                document.getElementById('checkpointPreset').value = data.lap_settings.checkpoint_preset || 'standard';
            }
            
            // æ¥ç¶š
            connections = data.connections || {};
            
            // ã‚¿ã‚¤ãƒ«
            gridData = {};
            nextTileOrder = 0;
            
            if (data.tiles) {
                // ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
                let maxX = 0, maxZ = 0;
                data.tiles.forEach(tile => {
                    maxX = Math.max(maxX, tile.x);
                    maxZ = Math.max(maxZ, tile.z);
                });
                
                document.getElementById('gridWidth').value = Math.ceil((maxX + 4) / 4);
                document.getElementById('gridHeight').value = Math.ceil((maxZ + 4) / 4);
                
                // ãƒ¯ãƒ¼ãƒ—ãƒšã‚¢ã‹ã‚‰ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å¾©å…ƒã™ã‚‹ãŸã‚ã®ãƒãƒƒãƒ—
                const warpPairGroups = {};
                let groupCounter = { Warp: 0, WarpStop: 0 };
                const groupLabels = ['A', 'B', 'C', 'D', 'E', 'F'];
                
                // ã‚¿ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒªãƒƒãƒ‰ã«é…ç½®ï¼ˆindexã‚’orderã¨ã—ã¦ä½¿ç”¨ï¼‰
                data.tiles.forEach(tile => {
                    const key = `${tile.x},${tile.z}`;
                    gridData[key] = {
                        type: tile.type,
                        x: tile.x,
                        z: tile.z,
                        order: tile.index  // indexã‚’orderã¨ã—ã¦ä¿å­˜
                    };
                    
                    // nextTileOrderã‚’æ›´æ–°
                    nextTileOrder = Math.max(nextTileOrder, tile.index + 1);
                    
                    if (tile.checkpoint_type) {
                        gridData[key].checkpoint_type = tile.checkpoint_type;
                    }
                    
                    // ãƒ¯ãƒ¼ãƒ—ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å¾©å…ƒ
                    if ((tile.type === 'Warp' || tile.type === 'WarpStop') && tile.warp_pair !== undefined) {
                        const pairKey = [tile.index, tile.warp_pair].sort().join('-');
                        const typeKey = tile.type + '-' + pairKey;
                        
                        if (!warpPairGroups[typeKey]) {
                            warpPairGroups[typeKey] = groupLabels[groupCounter[tile.type]++] || '?';
                        }
                        gridData[key].warp_group = warpPairGroups[typeKey];
                    }
                });
            }
            
            resizeGrid();
            updateConnectionList();
        }
        
        // === æ¥ç¶šãƒ¢ãƒ¼ãƒ‰é–¢é€£ ===
        
        // æ¥ç¶šãƒ¢ãƒ¼ãƒ‰é–‹å§‹
        function startConnectionMode() {
            connectionMode = true;
            connectionSource = null;
            connectionTargets = [];
            
            // UIã‚’æ›´æ–°
            document.getElementById('connectionSection').classList.add('connection-mode-active');
            document.getElementById('connectionStatus').classList.add('active');
            document.getElementById('connectionStep').textContent = 'ã‚¹ãƒ†ãƒƒãƒ—1: æ¥ç¶šå…ƒã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯';
            document.getElementById('connectionInfo').textContent = '';
            document.getElementById('addConnectionBtn').style.display = 'none';
            document.getElementById('finishConnectionBtn').style.display = 'none';
            document.getElementById('cancelConnectionBtn').style.display = 'inline-block';
        }
        
        // æ¥ç¶šãƒ¢ãƒ¼ãƒ‰ã§ã®ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
        function handleConnectionClick(cell, key) {
            // ã‚¿ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
            if (!gridData[key]) {
                alert('ã‚¿ã‚¤ãƒ«ãŒé…ç½®ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            // ã‚¿ã‚¤ãƒ«ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
            const tileIndex = getTileIndexByKey(key);
            if (tileIndex === -1) {
                alert('ã‚¿ã‚¤ãƒ«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå–å¾—ã§ãã¾ã›ã‚“');
                return;
            }
            
            if (!connectionSource) {
                // ã‚¹ãƒ†ãƒƒãƒ—1: æ¥ç¶šå…ƒã‚’é¸æŠ
                connectionSource = { key, index: tileIndex };
                cell.classList.add('connection-source');
                
                document.getElementById('connectionStep').textContent = 'ã‚¹ãƒ†ãƒƒãƒ—2: æ¥ç¶šå…ˆã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆè¤‡æ•°å¯ï¼‰';
                document.getElementById('connectionInfo').textContent = `æ¥ç¶šå…ƒ: ã‚¿ã‚¤ãƒ« ${tileIndex}`;
                document.getElementById('finishConnectionBtn').style.display = 'inline-block';
            } else {
                // ã‚¹ãƒ†ãƒƒãƒ—2: æ¥ç¶šå…ˆã‚’è¿½åŠ 
                if (key === connectionSource.key) {
                    alert('æ¥ç¶šå…ƒã¨åŒã˜ã‚¿ã‚¤ãƒ«ã¯é¸æŠã§ãã¾ã›ã‚“');
                    return;
                }
                
                // æ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                const existingIndex = connectionTargets.findIndex(t => t.key === key);
                if (existingIndex !== -1) {
                    // é¸æŠè§£é™¤
                    connectionTargets.splice(existingIndex, 1);
                    cell.classList.remove('connection-target');
                } else {
                    // è¿½åŠ 
                    connectionTargets.push({ key, index: tileIndex });
                    cell.classList.add('connection-target');
                }
                
                // æƒ…å ±æ›´æ–°
                const targetIndices = connectionTargets.map(t => t.index).join(', ');
                document.getElementById('connectionInfo').textContent = 
                    `æ¥ç¶šå…ƒ: ã‚¿ã‚¤ãƒ« ${connectionSource.index} â†’ æ¥ç¶šå…ˆ: ${targetIndices || '(æœªé¸æŠ)'}`;
            }
        }
        
        // ã‚­ãƒ¼ã‹ã‚‰ã‚¿ã‚¤ãƒ«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆorderï¼‰ã‚’å–å¾—
        function getTileIndexByKey(key) {
            if (gridData[key] && gridData[key].order !== undefined) {
                return gridData[key].order;
            }
            return -1;
        }
        
        // æ¥ç¶šç¢ºå®š
        function finishConnection() {
            if (!connectionSource) {
                alert('æ¥ç¶šå…ƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            if (connectionTargets.length === 0) {
                alert('æ¥ç¶šå…ˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            // æ¥ç¶šã‚’è¿½åŠ 
            const targetIndices = connectionTargets.map(t => t.index);
            connections[connectionSource.index] = targetIndices;
            
            // ãƒ¢ãƒ¼ãƒ‰çµ‚äº†
            exitConnectionMode();
            updateConnectionList();
            updateJson();
        }
        
        // æ¥ç¶šãƒ¢ãƒ¼ãƒ‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelConnectionMode() {
            exitConnectionMode();
        }
        
        // æ¥ç¶šãƒ¢ãƒ¼ãƒ‰çµ‚äº†ï¼ˆå…±é€šå‡¦ç†ï¼‰
        function exitConnectionMode() {
            connectionMode = false;
            connectionSource = null;
            connectionTargets = [];
            
            // ã‚»ãƒ«ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ã‚¯ãƒªã‚¢
            document.querySelectorAll('.grid-cell').forEach(cell => {
                cell.classList.remove('connection-source', 'connection-target');
            });
            
            // UIã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('connectionSection').classList.remove('connection-mode-active');
            document.getElementById('connectionStatus').classList.remove('active');
            document.getElementById('addConnectionBtn').style.display = 'inline-block';
            document.getElementById('finishConnectionBtn').style.display = 'none';
            document.getElementById('cancelConnectionBtn').style.display = 'none';
        }
        
        // æ¥ç¶šãƒªã‚¹ãƒˆæ›´æ–°
        function updateConnectionList() {
            const list = document.getElementById('connectionList');
            list.innerHTML = '';
            
            Object.entries(connections).forEach(([from, toList]) => {
                const item = document.createElement('div');
                item.className = 'connection-item';
                item.innerHTML = `
                    <span>ã‚¿ã‚¤ãƒ« ${from} â†’ ${Array.isArray(toList) ? toList.join(', ') : toList}</span>
                    <button onclick="removeConnection('${from}')">å‰Šé™¤</button>
                `;
                list.appendChild(item);
            });
        }
        
        // æ¥ç¶šå‰Šé™¤
        function removeConnection(from) {
            delete connections[from];
            updateConnectionList();
            updateJson();
        }
        
        // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å¤‰æ›´æ™‚ã«JSONæ›´æ–°
        ['mapId', 'mapName', 'mapDesc', 'bonusPreset', 'checkpointPreset'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateJson);
        });
    </script>
</body>
</html>
