[gd_scene load_steps=2 format=3 uid="uid://jtdq4cxo60mv"]

[sub_resource type="GDScript" id="GDScript_8cj0n"]
script/source = "extends Node
class_name Game3D

# 3Dã‚²ãƒ¼ãƒ ãƒ¡ã‚¤ãƒ³ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

# ã‚·ã‚¹ãƒ†ãƒ å‚ç…§
var board_system_3d: BoardSystem3D
var player_system: PlayerSystem
var card_system: CardSystem
var battle_system: BattleSystem
var skill_system: SkillSystem
var ui_manager: UIManager
var special_tile_system: SpecialTileSystem
var debug_controller: DebugController

# è¨­å®š
var player_count = 2
var player_is_cpu = [false, true]  # Player1=äººé–“, Player2=CPU

func _ready():
	print(\"\\n=== 3Dã‚«ãƒ«ãƒ‰ã‚»ãƒ—ãƒˆé¢¨ã‚²ãƒ¼ãƒ é–‹å§‹ ===\")
	
	initialize_systems()
	setup_game()
	connect_signals()
	
	# åˆæœŸåŒ–å®Œäº†å¾…æ©Ÿ
	await get_tree().create_timer(0.5).timeout
	
	start_game()

# ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
func initialize_systems():
	print(\"ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...\")
	
	# BoardSystem3Dã‚’ä½œæˆ
	board_system_3d = BoardSystem3D.new()
	board_system_3d.name = \"BoardSystem3D\"
	add_child(board_system_3d)
	
	# PlayerSystemã‚’ä½œæˆ
	player_system = PlayerSystem.new()
	player_system.name = \"PlayerSystem\"
	add_child(player_system)
	
	# CardSystemã‚’ä½œæˆ
	card_system = CardSystem.new()
	card_system.name = \"CardSystem\"
	add_child(card_system)
	
	# BattleSystemã‚’ä½œæˆ
	battle_system = BattleSystem.new()
	battle_system.name = \"BattleSystem\"
	add_child(battle_system)
	
	# SkillSystemã‚’ä½œæˆ
	skill_system = SkillSystem.new()
	skill_system.name = \"SkillSystem\"
	add_child(skill_system)
	
	# SpecialTileSystemã‚’ä½œæˆ
	special_tile_system = SpecialTileSystem.new()
	special_tile_system.name = \"SpecialTileSystem\"
	add_child(special_tile_system)
	
	# UIManagerã‚’ä½œæˆ
	ui_manager = UIManager.new()
	ui_manager.name = \"UIManager\"
	add_child(ui_manager)
	
	# DebugControllerã‚’ä½œæˆ
	debug_controller = DebugController.new()
	debug_controller.name = \"DebugController\"
	add_child(debug_controller)
	
	print(\"å…¨ã‚·ã‚¹ãƒ†ãƒ ä½œæˆå®Œäº†\")

# ã‚²ãƒ¼ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
func setup_game():
	print(\"ã‚²ãƒ¼ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­...\")
	
	# 3Dã‚·ãƒ¼ãƒ³ã®ãƒãƒ¼ãƒ‰ã‚’åé›†
	var tiles_container = get_node_or_null(\"Tiles\")
	var players_container = get_node_or_null(\"Players\")
	var camera = get_node_or_null(\"Camera3D\")
	
	if tiles_container:
		board_system_3d.collect_tiles(tiles_container)
	else:
		print(\"ERROR: Tilesãƒãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\")
	
	if players_container:
		board_system_3d.collect_players(players_container)
	else:
		print(\"ERROR: Playersãƒãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\")
		
	if camera:
		board_system_3d.camera = camera
	else:
		print(\"WARNING: Camera3DãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\")
	
	# ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’åˆæœŸåŒ–
	player_system.initialize_players(player_count, self)
	
	# BoardSystem3Dã®è¨­å®š
	board_system_3d.player_count = player_count
	board_system_3d.player_is_cpu = player_is_cpu
	board_system_3d.current_player_index = 0
	
	# UIä½œæˆï¼ˆUILayerã‚‚ä½œæˆã•ã‚Œã‚‹ï¼‰
	ui_manager.create_ui(self)
	
	# ã‚·ã‚¹ãƒ†ãƒ å‚ç…§ã‚’è¨­å®š
	board_system_3d.setup_systems(player_system, card_system, battle_system, skill_system)
	board_system_3d.ui_manager = ui_manager  # UIManagerã‚’ç›´æ¥è¨­å®š
	board_system_3d.card_system = card_system  # CardSystemã‚‚ç›´æ¥è¨­å®š
	
	# DebugControllerã«ã‚·ã‚¹ãƒ†ãƒ å‚ç…§ã‚’è¨­å®š
	debug_controller.setup_systems(player_system, null, card_system, ui_manager)
	player_system.set_debug_controller(debug_controller)
	
	# åˆæœŸæ‰‹æœ­ã‚’é…ã‚‹ï¼ˆUILayerä½œæˆå¾Œï¼‰
	await get_tree().create_timer(0.1).timeout
	card_system.deal_initial_hands_all_players(player_count)
	
	print(\"åˆæœŸæ‰‹æœ­ã‚’é…ã‚Šã¾ã—ãŸ\")
	for i in range(player_count):
		print(\"ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼\", i + 1, \"ã®æ‰‹æœ­: \", card_system.get_hand_size_for_player(i), \"æš\")
	
	# UIã‚’åˆæœŸæ›´æ–°ï¼ˆé‡è¦ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºï¼‰
	await get_tree().create_timer(0.1).timeout
	ui_manager.update_player_info_panels()
	
	# ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ãƒ‘ãƒãƒ«ã®å¼·åˆ¶æ›´æ–°
	if ui_manager.player_info_panel and ui_manager.player_info_panel.has_method(\"update_all_panels\"):
		ui_manager.player_info_panel.update_all_panels()
		print(\"ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ãƒ‘ãƒãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ\")
	else:
		print(\"WARNING: player_info_panelãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\")

# ã‚·ã‚°ãƒŠãƒ«æ¥ç¶š
func connect_signals():
	print(\"ã‚·ã‚°ãƒŠãƒ«æ¥ç¶šä¸­...\")
	
	# PlayerSystemã®ã‚·ã‚°ãƒŠãƒ«
	player_system.dice_rolled.connect(_on_dice_rolled)
	player_system.movement_completed.connect(_on_movement_completed)
	player_system.magic_changed.connect(_on_magic_changed)
	player_system.player_won.connect(_on_player_won)
	
	# BoardSystem3Dã®ã‚·ã‚°ãƒŠãƒ«
	board_system_3d.tile_action_completed.connect(_on_tile_action_completed)
	board_system_3d.movement_started.connect(_on_movement_started)
	board_system_3d.movement_completed.connect(_on_board_movement_completed)
	
	# UIManagerã®ã‚·ã‚°ãƒŠãƒ«
	ui_manager.dice_button_pressed.connect(_on_dice_button_pressed)
	ui_manager.card_selected.connect(_on_card_selected)
	ui_manager.pass_button_pressed.connect(_on_pass_pressed)
	ui_manager.level_up_selected.connect(_on_level_up_selected)
	
	# CardSystemã®ã‚·ã‚°ãƒŠãƒ«
	card_system.card_drawn.connect(_on_card_drawn)
	card_system.card_used.connect(_on_card_used)
	card_system.hand_updated.connect(_on_hand_updated)
	
	print(\"ã‚·ã‚°ãƒŠãƒ«æ¥ç¶šå®Œäº†\")

# ã‚²ãƒ¼ãƒ é–‹å§‹
func start_game():
	print(\"\\n=== ã‚²ãƒ¼ãƒ é–‹å§‹ ===\")
	
	# æœ€åˆã®ã‚¿ãƒ¼ãƒ³é–‹å§‹
	start_turn()

# ã‚¿ãƒ¼ãƒ³é–‹å§‹
func start_turn():
	var current_player = player_system.get_current_player()
	print(\"\\n=== ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼\", current_player.id + 1, \"ã®ã‚¿ãƒ¼ãƒ³ ===\")
	
	# ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã®ã‚«ãƒ¼ãƒ‰ãƒ‰ãƒ­ãƒ¼ï¼ˆé‡è¦ï¼ï¼‰
	if card_system.get_hand_size_for_player(current_player.id) < 6:
		print(\"ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã®ãƒ‰ãƒ­ãƒ¼å‡¦ç†...\")
		var drawn = card_system.draw_card_for_player(current_player.id)
		if not drawn.is_empty():
			print(\"ã‚«ãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ­ãƒ¼: \", drawn.get(\"name\", \"ä¸æ˜\"))
			ui_manager.update_player_info_panels()
			
			# ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®å ´åˆã€æ‰‹æœ­è¡¨ç¤ºã‚’æ›´æ–°
			if current_player.id == 0:
				await get_tree().create_timer(0.1).timeout
		else:
			print(\"ãƒ‰ãƒ­ãƒ¼å¤±æ•—ï¼ˆãƒ‡ãƒƒã‚­åˆ‡ã‚Œï¼Ÿï¼‰\")
	else:
		print(\"æ‰‹æœ­ãŒä¸Šé™ã®ãŸã‚ãƒ‰ãƒ­ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—\")
	
	# CPUã‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹åˆ¤å®š
	if board_system_3d.player_is_cpu[current_player.id]:
		# CPUã®å ´åˆ
		ui_manager.set_dice_button_enabled(false)
		ui_manager.phase_label.text = \"CPUã®ã‚¿ãƒ¼ãƒ³...\"
		await get_tree().create_timer(1.0).timeout
		board_system_3d.start_dice_roll()
	else:
		# ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å ´åˆ
		ui_manager.set_dice_button_enabled(true)
		ui_manager.phase_label.text = \"ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã£ã¦ãã ã•ã„\"

# === ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© ===

func _on_dice_button_pressed():
	if not board_system_3d.is_moving:
		board_system_3d.start_dice_roll()

func _on_dice_rolled(value: int):
	print(\"ğŸ² ã‚µã‚¤ã‚³ãƒ­: \", value)
	ui_manager.show_dice_result(value, self)
	
	# 3Dç§»å‹•é–‹å§‹
	var current_player = player_system.get_current_player()
	board_system_3d.move_player_3d(current_player.id, value)

func _on_movement_started():
	ui_manager.set_dice_button_enabled(false)
	ui_manager.phase_label.text = \"ç§»å‹•ä¸­...\"

func _on_movement_completed(final_tile: int):
	# PlayerSystemã®ç§»å‹•å®Œäº†
	print(\"PlayerSystem: ãƒã‚¹\", final_tile, \"ã«åˆ°ç€\")

func _on_board_movement_completed(final_tile: int):
	# BoardSystem3Dã®ç§»å‹•å®Œäº†
	print(\"BoardSystem3D: ãƒã‚¹\", final_tile, \"ã«åˆ°ç€\")
	board_system_3d.process_tile_landing(final_tile)

func _on_tile_action_completed():
	print(\"ã‚¿ã‚¤ãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Œäº†\")
	# ã‚¿ãƒ¼ãƒ³çµ‚äº†å‡¦ç†ã‚’å‘¼ã¶
	board_system_3d.end_current_turn()
	# æ¬¡ã®ã‚¿ãƒ¼ãƒ³é–‹å§‹
	await get_tree().create_timer(0.5).timeout
	start_turn()

func _on_card_selected(card_index: int):
	board_system_3d.on_card_selected(card_index)

func _on_pass_pressed():
	board_system_3d.on_action_pass()

func _on_level_up_selected(target_level: int, cost: int):
	print(\"ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—é¸æŠ: Lv\", target_level, \" (\", cost, \"G)\")
	# TODO: ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—å‡¦ç†å®Ÿè£…

func _on_card_drawn(card_data: Dictionary):
	print(\"ã‚«ãƒ¼ãƒ‰å¼•ã„ãŸ: \", card_data.get(\"name\", \"ä¸æ˜\"))

func _on_card_used(card_data: Dictionary):
	print(\"ã‚«ãƒ¼ãƒ‰ä½¿ç”¨: \", card_data.get(\"name\", \"ä¸æ˜\"))
	ui_manager.update_player_info_panels()

func _on_hand_updated():
	var current_player = player_system.get_current_player()
	if current_player:
		print(\"æ‰‹æœ­æ›´æ–° - P\", current_player.id + 1, \": \", card_system.get_hand_size_for_player(current_player.id), \"æš\")

func _on_magic_changed(player_id: int, new_value: int):
	print(\"é­”åŠ›å¤‰åŒ– - P\", player_id + 1, \": \", new_value, \"G\")
	ui_manager.update_player_info_panels()

func _on_player_won(player_id: int):
	print(\"\\nğŸ‰ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼\", player_id + 1, \"ã®å‹åˆ©ï¼ ğŸ‰\")
	ui_manager.set_dice_button_enabled(false)
	ui_manager.phase_label.text = \"ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼\" + str(player_id + 1) + \"ã®å‹åˆ©ï¼\"

# ãƒ‡ãƒãƒƒã‚°å…¥åŠ›
func _input(event):
	if event is InputEventKey and event.pressed:
		match event.keycode:
			KEY_SPACE:
				_on_dice_button_pressed()
			KEY_6:
				debug_controller.set_debug_dice(6)
			KEY_7:
				debug_controller.set_debug_dice(1)
			KEY_8:
				debug_controller.set_debug_dice(2)
			KEY_9:
				debug_controller.set_debug_dice(3)
			KEY_0:
				debug_controller.clear_debug_dice()
			KEY_D:
				ui_manager.toggle_debug_mode()
"

[node name="Game" type="Node2D"]
script = SubResource("GDScript_8cj0n")

[node name="Hand" type="Node2D" parent="."]

[node name="BoardMap" type="Node2D" parent="."]
